<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PWA Mastery - Interactive Learning</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --primary: #6c5ce7;
  --primary-dark: #5a4bd1;
  --secondary: #00cec9;
  --accent: #fd79a8;
  --success: #00b894;
  --danger: #d63031;
  --warning: #fdcb6e;
  --bg: #0a0a1a;
  --bg-card: #12122a;
  --bg-card-alt: #1a1a3e;
  --bg-code: #0d0d22;
  --text: #e2e2f0;
  --text-dim: #8888aa;
  --border: #2a2a4a;
  --glow: rgba(108, 92, 231, 0.3);
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

/* Animated Background */
.bg-particles {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}

.particle {
  position: absolute;
  border-radius: 50%;
  animation: float linear infinite;
  opacity: 0.15;
}

@keyframes float {
  0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
  10% { opacity: 0.15; }
  90% { opacity: 0.15; }
  100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
}

/* Layout */
.app-container {
  position: relative;
  z-index: 1;
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 300px;
  background: var(--bg-card);
  border-right: 1px solid var(--border);
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  z-index: 100;
  transition: transform 0.3s ease;
}

.sidebar-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sidebar-header h1 { font-size: 1.4rem; font-weight: 800; }
.sidebar-header p { font-size: 0.8rem; opacity: 0.7; -webkit-text-fill-color: var(--text-dim); }

/* Progress */
.progress-container {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
}

.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  margin-bottom: 8px;
  color: var(--text-dim);
}

.progress-bar {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: 3px;
  transition: width 0.5s ease;
  width: 0%;
}

/* XP System */
.xp-display {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.85rem;
}

.xp-icon {
  width: 30px; height: 30px;
  background: linear-gradient(135deg, var(--warning), #e17055);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
}

.xp-amount {
  font-weight: 700;
  color: var(--warning);
  font-size: 1.1rem;
}

.streak-badge {
  margin-left: auto;
  background: rgba(253, 203, 110, 0.15);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  color: var(--warning);
}

/* Nav */
.nav-section {
  padding: 12px 0;
}

.nav-section-title {
  padding: 8px 20px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-dim);
  font-weight: 600;
}

.nav-item {
  display: flex;
  align-items: center;
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.2s;
  gap: 12px;
  border-left: 3px solid transparent;
  font-size: 0.9rem;
}

.nav-item:hover {
  background: rgba(108, 92, 231, 0.1);
  border-left-color: var(--primary);
}

.nav-item.active {
  background: rgba(108, 92, 231, 0.15);
  border-left-color: var(--primary);
  color: var(--primary);
  font-weight: 600;
}

.nav-item.completed .nav-icon { background: var(--success); }
.nav-item.locked { opacity: 0.4; pointer-events: none; }

.nav-icon {
  width: 28px; height: 28px;
  border-radius: 8px;
  background: var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  flex-shrink: 0;
}

.nav-check {
  margin-left: auto;
  color: var(--success);
  font-size: 0.9rem;
}

/* Main Content */
.main-content {
  margin-left: 300px;
  flex: 1;
  padding: 40px;
  max-width: 900px;
}

/* Sections */
.section {
  display: none;
  animation: fadeIn 0.4s ease;
}

.section.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Typography */
.section-badge {
  display: inline-block;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  padding: 4px 14px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
}

.section h2 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 8px;
  background: linear-gradient(135deg, #fff, var(--text));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.section-subtitle {
  color: var(--text-dim);
  font-size: 1.05rem;
  margin-bottom: 32px;
}

h3 {
  font-size: 1.3rem;
  margin: 32px 0 16px;
  color: var(--secondary);
  display: flex;
  align-items: center;
  gap: 10px;
}

h4 {
  font-size: 1.1rem;
  margin: 24px 0 12px;
  color: var(--text);
}

p { margin-bottom: 16px; color: var(--text); }

/* Cards */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  transition: all 0.3s;
}

.card:hover {
  border-color: var(--primary);
  box-shadow: 0 0 30px var(--glow);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.card-icon {
  width: 40px; height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.card-title { font-weight: 700; font-size: 1.05rem; }

/* Info Boxes */
.info-box {
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  border-left: 4px solid;
}

.info-box.concept {
  background: rgba(108, 92, 231, 0.1);
  border-color: var(--primary);
}

.info-box.tip {
  background: rgba(0, 184, 148, 0.1);
  border-color: var(--success);
}

.info-box.warning {
  background: rgba(214, 48, 49, 0.1);
  border-color: var(--danger);
}

.info-box.pitfall {
  background: rgba(253, 203, 110, 0.1);
  border-color: var(--warning);
}

.info-box-title {
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-box.concept .info-box-title { color: var(--primary); }
.info-box.tip .info-box-title { color: var(--success); }
.info-box.warning .info-box-title { color: var(--danger); }
.info-box.pitfall .info-box-title { color: var(--warning); }

/* Code Blocks */
.code-container {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin: 16px 0;
  overflow: hidden;
}

.code-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
  color: var(--text-dim);
}

.code-dots {
  display: flex; gap: 6px;
}

.code-dots span {
  width: 10px; height: 10px;
  border-radius: 50%;
}

.code-dots span:nth-child(1) { background: #ff5f57; }
.code-dots span:nth-child(2) { background: #ffbd2e; }
.code-dots span:nth-child(3) { background: #28ca42; }

.code-copy {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 4px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.75rem;
  transition: all 0.2s;
}

.code-copy:hover {
  border-color: var(--primary);
  color: var(--primary);
}

pre {
  padding: 20px;
  overflow-x: auto;
  font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
  font-size: 0.85rem;
  line-height: 1.8;
  tab-size: 2;
}

code {
  font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
}

/* Inline code */
p code, li code, .info-box code {
  background: rgba(108, 92, 231, 0.2);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.85em;
  color: var(--secondary);
}

/* Syntax Colors */
.kw { color: #c792ea; }
.fn { color: #82aaff; }
.str { color: #c3e88d; }
.num { color: #f78c6c; }
.cm { color: #546e7a; font-style: italic; }
.op { color: #89ddff; }
.prop { color: #f07178; }
.const { color: #ffcb6b; }
.tag { color: #f07178; }
.attr { color: #c792ea; }
.val { color: #c3e88d; }
.bool { color: #f78c6c; }
.obj { color: #ffcb6b; }

/* Lifecycle Diagram */
.lifecycle-diagram {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 30px;
  margin: 24px 0;
  position: relative;
  overflow: hidden;
}

.lifecycle-flow {
  display: flex;
  flex-direction: column;
  gap: 0;
  align-items: center;
}

.lifecycle-node {
  background: var(--bg-card-alt);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 16px 28px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 220px;
  position: relative;
  z-index: 2;
}

.lifecycle-node:hover, .lifecycle-node.active {
  border-color: var(--primary);
  box-shadow: 0 0 25px var(--glow);
  transform: scale(1.05);
}

.lifecycle-node.active { background: rgba(108, 92, 231, 0.15); }

.lifecycle-node .node-title {
  font-weight: 700;
  font-size: 0.95rem;
  margin-bottom: 4px;
}

.lifecycle-node .node-event {
  font-size: 0.75rem;
  color: var(--secondary);
  font-family: monospace;
}

.lifecycle-arrow {
  font-size: 1.5rem;
  color: var(--primary);
  padding: 4px 0;
  z-index: 1;
}

.lifecycle-detail {
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
  display: none;
  animation: fadeIn 0.3s ease;
}

.lifecycle-detail.visible { display: block; }

/* Interactive Demo */
.demo-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 24px 0;
}

.demo-header {
  padding: 16px 20px;
  background: rgba(108, 92, 231, 0.1);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
}

.demo-body { padding: 24px; }

.demo-controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.demo-output {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  min-height: 120px;
  font-family: monospace;
  font-size: 0.85rem;
  max-height: 300px;
  overflow-y: auto;
}

.demo-output .log-line {
  padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.log-time {
  color: var(--text-dim);
  font-size: 0.75rem;
  flex-shrink: 0;
}

.log-type {
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 0.7rem;
  font-weight: 600;
  flex-shrink: 0;
}

.log-type.info { background: rgba(108,92,231,0.3); color: var(--primary); }
.log-type.success { background: rgba(0,184,148,0.3); color: var(--success); }
.log-type.warn { background: rgba(253,203,110,0.3); color: var(--warning); }
.log-type.error { background: rgba(214,48,49,0.3); color: var(--danger); }

/* Buttons */
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
}

.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px var(--glow); }

.btn-secondary {
  background: var(--bg-card-alt);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--primary); }

.btn-success {
  background: linear-gradient(135deg, var(--success), #00a381);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #b71c1c);
  color: white;
}

.btn-small {
  padding: 6px 14px;
  font-size: 0.8rem;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Quiz */
.quiz-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 24px 0;
}

.quiz-header {
  padding: 16px 24px;
  background: linear-gradient(135deg, rgba(253,121,168,0.15), rgba(108,92,231,0.15));
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.quiz-progress-dots {
  display: flex;
  gap: 6px;
}

.quiz-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: var(--border);
  transition: all 0.3s;
}

.quiz-dot.current { background: var(--primary); transform: scale(1.3); }
.quiz-dot.correct { background: var(--success); }
.quiz-dot.wrong { background: var(--danger); }

.quiz-body { padding: 24px; }

.quiz-question {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 20px;
  line-height: 1.6;
}

.quiz-question code {
  background: rgba(108, 92, 231, 0.2);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.9em;
  color: var(--secondary);
}

.quiz-options { display: flex; flex-direction: column; gap: 10px; }

.quiz-option {
  background: var(--bg-card-alt);
  border: 2px solid var(--border);
  border-radius: 10px;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 12px;
}

.quiz-option:hover:not(.disabled) {
  border-color: var(--primary);
  background: rgba(108, 92, 231, 0.1);
}

.quiz-option.selected { border-color: var(--primary); background: rgba(108, 92, 231, 0.15); }
.quiz-option.correct { border-color: var(--success); background: rgba(0, 184, 148, 0.15); }
.quiz-option.wrong { border-color: var(--danger); background: rgba(214, 48, 49, 0.15); }
.quiz-option.disabled { pointer-events: none; }

.option-letter {
  width: 28px; height: 28px;
  border-radius: 50%;
  background: var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.8rem;
  flex-shrink: 0;
}

.quiz-option.correct .option-letter { background: var(--success); }
.quiz-option.wrong .option-letter { background: var(--danger); }

.quiz-explanation {
  margin-top: 16px;
  padding: 16px;
  border-radius: 10px;
  display: none;
  animation: fadeIn 0.3s;
}

.quiz-explanation.visible { display: block; }
.quiz-explanation.correct-exp { background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); }
.quiz-explanation.wrong-exp { background: rgba(214,48,49,0.1); border: 1px solid rgba(214,48,49,0.3); }

.quiz-actions {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.quiz-score { font-weight: 600; color: var(--secondary); }

/* Exercise */
.exercise-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 24px 0;
}

.exercise-header {
  padding: 16px 24px;
  background: linear-gradient(135deg, rgba(0,206,201,0.15), rgba(108,92,231,0.15));
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}

.exercise-body { padding: 24px; }

.exercise-prompt {
  font-size: 1rem;
  margin-bottom: 16px;
  line-height: 1.7;
}

.code-editor {
  width: 100%;
  min-height: 200px;
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  color: var(--text);
  font-family: 'Fira Code', 'Cascadia Code', monospace;
  font-size: 0.85rem;
  line-height: 1.8;
  resize: vertical;
  tab-size: 2;
}

.code-editor:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 15px var(--glow);
}

.exercise-actions {
  display: flex;
  gap: 10px;
  margin-top: 16px;
  align-items: center;
}

.exercise-result {
  margin-top: 16px;
  padding: 16px;
  border-radius: 10px;
  display: none;
  animation: fadeIn 0.3s;
}

.exercise-result.visible { display: block; }
.exercise-result.pass { background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); }
.exercise-result.fail { background: rgba(214,48,49,0.1); border: 1px solid rgba(214,48,49,0.3); }

/* Caching Strategy Cards */
.strategy-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin: 20px 0;
}

.strategy-card {
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
}

.strategy-card:hover {
  border-color: var(--secondary);
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.strategy-card.expanded {
  grid-column: 1 / -1;
  border-color: var(--secondary);
}

.strategy-name {
  font-weight: 700;
  font-size: 1rem;
  margin-bottom: 6px;
  color: var(--secondary);
}

.strategy-desc {
  font-size: 0.85rem;
  color: var(--text-dim);
}

.strategy-detail {
  display: none;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.strategy-card.expanded .strategy-detail { display: block; }

.strategy-visual {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: var(--bg-code);
  border-radius: 8px;
  margin: 12px 0;
  font-size: 0.85rem;
  flex-wrap: wrap;
}

.visual-step {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: var(--bg-card);
  border-radius: 6px;
  border: 1px solid var(--border);
}

.visual-arrow { color: var(--primary); font-size: 1.2rem; }

/* Manifest Builder */
.manifest-builder {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  margin: 24px 0;
}

.manifest-fields {
  padding: 24px;
  display: grid;
  gap: 16px;
}

.field-group { display: flex; flex-direction: column; gap: 6px; }

.field-group label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-dim);
}

.field-group input, .field-group select {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--text);
  font-size: 0.9rem;
  transition: all 0.2s;
}

.field-group input:focus, .field-group select:focus {
  outline: none;
  border-color: var(--primary);
}

.manifest-preview {
  border-top: 1px solid var(--border);
}

/* Tabs */
.tab-container {
  margin: 20px 0;
}

.tab-buttons {
  display: flex;
  border-bottom: 2px solid var(--border);
  gap: 0;
}

.tab-btn {
  padding: 10px 20px;
  background: none;
  border: none;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
}

.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

.tab-content { display: none; padding: 20px 0; }
.tab-content.active { display: block; animation: fadeIn 0.3s; }

/* Comparison Table */
.comparison-table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 0.85rem;
}

.comparison-table th {
  background: var(--bg-card-alt);
  padding: 12px 16px;
  text-align: left;
  border: 1px solid var(--border);
  color: var(--secondary);
  font-weight: 600;
}

.comparison-table td {
  padding: 12px 16px;
  border: 1px solid var(--border);
  background: var(--bg-card);
}

/* Badge/Chip */
.chip {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.chip-good { background: rgba(0,184,148,0.2); color: var(--success); }
.chip-bad { background: rgba(214,48,49,0.2); color: var(--danger); }
.chip-neutral { background: rgba(108,92,231,0.2); color: var(--primary); }

/* Checklist */
.checklist {
  list-style: none;
  margin: 16px 0;
}

.checklist li {
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
}

.checklist li::before {
  content: '‚òê';
  font-size: 1.1rem;
  color: var(--text-dim);
  flex-shrink: 0;
}

.checklist li.checked::before {
  content: '‚òë';
  color: var(--success);
}

/* Finish Screen */
.finish-screen {
  text-align: center;
  padding: 60px 20px;
}

.finish-trophy {
  font-size: 80px;
  margin-bottom: 24px;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-15px); }
}

.finish-title {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 12px;
}

.finish-stats {
  display: flex;
  gap: 24px;
  justify-content: center;
  margin: 32px 0;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px 30px;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stat-label { font-size: 0.85rem; color: var(--text-dim); margin-top: 4px; }

/* Hamburger (mobile) */
.hamburger {
  display: none;
  position: fixed;
  top: 16px;
  left: 16px;
  z-index: 200;
  background: var(--primary);
  border: none;
  color: white;
  width: 44px;
  height: 44px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 1.3rem;
}

/* Tooltip on XP gain */
.xp-popup {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, var(--warning), #e17055);
  color: #000;
  padding: 12px 24px;
  border-radius: 12px;
  font-weight: 700;
  z-index: 999;
  animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 1.7s;
  pointer-events: none;
}

@keyframes slideInRight {
  from { transform: translateX(100px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100px); opacity: 0; }
}

/* Lists */
ul, ol {
  margin: 12px 0 16px 24px;
  color: var(--text);
}

li { margin-bottom: 6px; }

/* Section complete banner */
.section-complete-banner {
  background: linear-gradient(135deg, rgba(0,184,148,0.1), rgba(108,92,231,0.1));
  border: 1px solid rgba(0,184,148,0.3);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  margin-top: 32px;
}

.section-complete-banner h3 { justify-content: center; color: var(--success); }

/* Responsive */
@media (max-width: 768px) {
  .hamburger { display: flex; align-items: center; justify-content: center; }
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main-content { margin-left: 0; padding: 20px; padding-top: 70px; }
  .strategy-grid { grid-template-columns: 1fr; }
  .finish-stats { flex-direction: column; align-items: center; }
}
</style>
</head>
<body>

<!-- Background Particles -->
<div class="bg-particles" id="particles"></div>

<!-- Mobile Hamburger -->
<button class="hamburger" id="hamburger" onclick="toggleSidebar()">‚ò∞</button>

<div class="app-container">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>‚ö° PWA Mastery</h1>
      <p>Progressive Web Apps Deep Dive</p>
    </div>

    <div class="progress-container">
      <div class="progress-label">
        <span>Overall Progress</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="xp-display">
      <div class="xp-icon">‚ö°</div>
      <div>
        <div style="font-size:0.75rem;color:var(--text-dim)">Experience</div>
        <div class="xp-amount" id="xpDisplay">0 XP</div>
      </div>
      <div class="streak-badge" id="streakBadge">üî• 0</div>
    </div>

    <nav class="nav-section">
      <div class="nav-section-title">Foundations</div>
      <div class="nav-item active" data-section="intro" onclick="navigateTo('intro')">
        <div class="nav-icon">üåê</div>
        <span>What Are PWAs?</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>
      <div class="nav-item" data-section="sw-basics" onclick="navigateTo('sw-basics')">
        <div class="nav-icon">‚öôÔ∏è</div>
        <span>Service Worker Basics</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>
      <div class="nav-item" data-section="sw-lifecycle" onclick="navigateTo('sw-lifecycle')">
        <div class="nav-icon">üîÑ</div>
        <span>SW Lifecycle</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>

      <div class="nav-section-title">Advanced</div>
      <div class="nav-item" data-section="caching" onclick="navigateTo('caching')">
        <div class="nav-icon">üíæ</div>
        <span>Caching Strategies</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>
      <div class="nav-item" data-section="offline" onclick="navigateTo('offline')">
        <div class="nav-icon">üì°</div>
        <span>Offline Support</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>
      <div class="nav-item" data-section="manifest" onclick="navigateTo('manifest')">
        <div class="nav-icon">üìã</div>
        <span>App Manifest</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>

      <div class="nav-section-title">Practice</div>
      <div class="nav-item" data-section="pitfalls" onclick="navigateTo('pitfalls')">
        <div class="nav-icon">‚ö†Ô∏è</div>
        <span>Pitfalls & Mistakes</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>
      <div class="nav-item" data-section="quiz-final" onclick="navigateTo('quiz-final')">
        <div class="nav-icon">üèÜ</div>
        <span>Final Challenge</span>
        <span class="nav-check" style="display:none">‚úì</span>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">

    <!-- ============================== -->
    <!-- SECTION 1: What Are PWAs? -->
    <!-- ============================== -->
    <div class="section active" id="section-intro">
      <div class="section-badge">Chapter 1</div>
      <h2>What Are Progressive Web Apps?</h2>
      <p class="section-subtitle">Understanding the bridge between web and native apps</p>

      <div class="card">
        <div class="card-header">
          <div class="card-icon" style="background:linear-gradient(135deg,#6c5ce7,#a29bfe)">üåê</div>
          <div class="card-title">The Big Picture</div>
        </div>
        <p>A <strong>Progressive Web App (PWA)</strong> is a web application that uses modern web technologies to deliver app-like experiences. PWAs are:</p>
        <ul>
          <li><strong>Progressive</strong> ‚Äî Work for every user, regardless of browser choice</li>
          <li><strong>Responsive</strong> ‚Äî Fit any form factor: desktop, mobile, tablet</li>
          <li><strong>Connectivity independent</strong> ‚Äî Work offline or on low-quality networks</li>
          <li><strong>App-like</strong> ‚Äî Feel like a native app with app-style interactions</li>
          <li><strong>Installable</strong> ‚Äî Users can "install" them on their home screen</li>
          <li><strong>Safe</strong> ‚Äî Served via HTTPS to prevent tampering</li>
        </ul>
      </div>

      <h3>üß± The Three Pillars of PWAs</h3>

      <div class="strategy-grid">
        <div class="card" style="margin:0">
          <h4 style="margin-top:0;color:var(--primary)">1. Service Workers</h4>
          <p style="margin:0;font-size:0.9rem">JavaScript files that run in the background, intercepting network requests, caching resources, and enabling offline functionality.</p>
        </div>
        <div class="card" style="margin:0">
          <h4 style="margin-top:0;color:var(--secondary)">2. Web App Manifest</h4>
          <p style="margin:0;font-size:0.9rem">A JSON file that tells the browser about your app ‚Äî name, icons, colors, display mode ‚Äî enabling installation.</p>
        </div>
        <div class="card" style="margin:0">
          <h4 style="margin-top:0;color:var(--accent)">3. HTTPS</h4>
          <p style="margin:0;font-size:0.9rem">PWAs must be served over HTTPS (except localhost for development). This ensures security and trust.</p>
        </div>
        <div class="card" style="margin:0">
          <h4 style="margin-top:0;color:var(--success)">4. App Shell Architecture</h4>
          <p style="margin:0;font-size:0.9rem">Minimal HTML/CSS/JS to power the UI, cached on first visit. Content loads dynamically.</p>
        </div>
      </div>

      <div class="info-box concept">
        <div class="info-box-title">üí° Key Concept</div>
        <p style="margin:0">PWAs are NOT a framework. They're a <strong>set of best practices and APIs</strong> that any web app can adopt progressively. You can add PWA features to an existing site incrementally!</p>
      </div>

      <h3>üîç PWA vs Native Apps vs Traditional Web</h3>

      <table class="comparison-table">
        <thead>
          <tr>
            <th>Feature</th>
            <th>Traditional Web</th>
            <th>PWA</th>
            <th>Native App</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Offline Support</td>
            <td><span class="chip chip-bad">No</span></td>
            <td><span class="chip chip-good">Yes</span></td>
            <td><span class="chip chip-good">Yes</span></td>
          </tr>
          <tr>
            <td>Installable</td>
            <td><span class="chip chip-bad">No</span></td>
            <td><span class="chip chip-good">Yes</span></td>
            <td><span class="chip chip-good">Yes</span></td>
          </tr>
          <tr>
            <td>Push Notifications</td>
            <td><span class="chip chip-bad">No</span></td>
            <td><span class="chip chip-good">Yes</span></td>
            <td><span class="chip chip-good">Yes</span></td>
          </tr>
          <tr>
            <td>App Store Required</td>
            <td><span class="chip chip-good">No</span></td>
            <td><span class="chip chip-good">No</span></td>
            <td><span class="chip chip-bad">Yes</span></td>
          </tr>
          <tr>
            <td>Auto Updates</td>
            <td><span class="chip chip-good">Yes</span></td>
            <td><span class="chip chip-good">Yes</span></td>
            <td><span class="chip chip-bad">Manual</span></td>
          </tr>
          <tr>
            <td>Discoverability (SEO)</td>
            <td><span class="chip chip-good">High</span></td>
            <td><span class="chip chip-good">High</span></td>
            <td><span class="chip chip-bad">Low</span></td>
          </tr>
          <tr>
            <td>Development Cost</td>
            <td><span class="chip chip-good">Low</span></td>
            <td><span class="chip chip-good">Low</span></td>
            <td><span class="chip chip-bad">High</span></td>
          </tr>
        </tbody>
      </table>

      <!-- Mini Quiz -->
      <div class="quiz-container" id="quiz-intro">
        <div class="quiz-header">
          <span>üß† Quick Check</span>
          <div class="quiz-progress-dots">
            <div class="quiz-dot current"></div>
            <div class="quiz-dot"></div>
          </div>
        </div>
        <div class="quiz-body">
          <div class="quiz-question">Which of the following is NOT a requirement for a Progressive Web App?</div>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-intro-exp')">
              <span class="option-letter">A</span>
              <span>Service Worker</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-intro-exp')">
              <span class="option-letter">B</span>
              <span>HTTPS</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, true, 'quiz-intro-exp')">
              <span class="option-letter">C</span>
              <span>React or Angular framework</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-intro-exp')">
              <span class="option-letter">D</span>
              <span>Web App Manifest</span>
            </div>
          </div>
          <div class="quiz-explanation" id="quiz-intro-exp">
            <strong>Correct! üéâ</strong> PWAs are NOT tied to any framework. They use standard web APIs (Service Workers, Manifest, HTTPS) that work with vanilla JS or any framework.
          </div>
        </div>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>You now understand what PWAs are and why they matter.</p>
        <button class="btn btn-primary" onclick="completeSection('intro'); navigateTo('sw-basics')">Continue to Service Worker Basics ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 2: Service Worker Basics -->
    <!-- ============================== -->
    <div class="section" id="section-sw-basics">
      <div class="section-badge">Chapter 2</div>
      <h2>Service Worker Basics</h2>
      <p class="section-subtitle">Your app's background powerhouse</p>

      <div class="info-box concept">
        <div class="info-box-title">üí° What is a Service Worker?</div>
        <p style="margin:0">A Service Worker is a <strong>JavaScript file that runs in a separate thread</strong> from your main page. It acts as a <strong>programmable network proxy</strong>, intercepting requests and deciding how to respond ‚Äî from cache, network, or a combination.</p>
      </div>

      <h3>üîë Key Characteristics</h3>
      <div class="card">
        <ul>
          <li><strong>Runs in background</strong> ‚Äî separate thread, no DOM access</li>
          <li><strong>Event-driven</strong> ‚Äî wakes up on events, sleeps when idle</li>
          <li><strong>HTTPS only</strong> ‚Äî requires secure context (except localhost)</li>
          <li><strong>No DOM access</strong> ‚Äî communicates via <code>postMessage()</code></li>
          <li><strong>Fully async</strong> ‚Äî cannot use synchronous APIs like <code>localStorage</code></li>
          <li><strong>Scope-based</strong> ‚Äî controls pages within its scope</li>
        </ul>
      </div>

      <h3>üìù Registering a Service Worker</h3>
      <p>Registration happens in your main JavaScript file (not in the service worker itself):</p>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>app.js ‚Äî Main Application File</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="cm">// Always check for support first!</span>
<span class="kw">if</span> (<span class="str">'serviceWorker'</span> <span class="kw">in</span> navigator) {
  <span class="cm">// Register when the window loads</span>
  window.<span class="fn">addEventListener</span>(<span class="str">'load'</span>, <span class="kw">async</span> () <span class="op">=></span> {
    <span class="kw">try</span> {
      <span class="kw">const</span> <span class="const">registration</span> = <span class="kw">await</span> navigator.serviceWorker
        .<span class="fn">register</span>(<span class="str">'/sw.js'</span>, {
          <span class="prop">scope</span>: <span class="str">'/'</span>  <span class="cm">// Controls all pages at root</span>
        });

      console.<span class="fn">log</span>(<span class="str">'SW registered!'</span>, registration.scope);

      <span class="cm">// Check for updates periodically</span>
      <span class="fn">setInterval</span>(() <span class="op">=></span> {
        registration.<span class="fn">update</span>();
      }, <span class="num">60</span> * <span class="num">60</span> * <span class="num">1000</span>); <span class="cm">// Every hour</span>

    } <span class="kw">catch</span> (error) {
      console.<span class="fn">error</span>(<span class="str">'SW registration failed:'</span>, error);
    }
  });
} <span class="kw">else</span> {
  console.<span class="fn">log</span>(<span class="str">'Service Workers not supported'</span>);
}</code></pre>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Common Mistake: Scope Confusion</div>
        <p>The service worker's <strong>scope</strong> is determined by its location. A SW at <code>/js/sw.js</code> can only control pages under <code>/js/</code>. Place your SW file at the root!</p>
        <div class="code-container" style="margin-top:12px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>Scope Rules</span>
          </div>
          <pre><code><span class="cm">// ‚ùå BAD: SW in subdirectory ‚Äî limited scope!</span>
navigator.serviceWorker.<span class="fn">register</span>(<span class="str">'/scripts/sw.js'</span>);
<span class="cm">// Can only control: /scripts/*</span>

<span class="cm">// ‚úÖ GOOD: SW at root</span>
navigator.serviceWorker.<span class="fn">register</span>(<span class="str">'/sw.js'</span>);
<span class="cm">// Controls: /*  (everything)</span>

<span class="cm">// ‚úÖ OR use Service-Worker-Allowed header</span>
<span class="cm">// to override scope (server config needed)</span></code></pre>
        </div>
      </div>

      <h3>‚öôÔ∏è Basic Service Worker File</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>sw.js ‚Äî Service Worker File</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">const</span> <span class="const">CACHE_NAME</span> = <span class="str">'my-app-v1'</span>;
<span class="kw">const</span> <span class="const">ASSETS_TO_CACHE</span> = [
  <span class="str">'/'</span>,
  <span class="str">'/index.html'</span>,
  <span class="str">'/styles.css'</span>,
  <span class="str">'/app.js'</span>,
  <span class="str">'/offline.html'</span>
];

<span class="cm">// INSTALL: Cache core assets</span>
self.<span class="fn">addEventListener</span>(<span class="str">'install'</span>, (event) <span class="op">=></span> {
  console.<span class="fn">log</span>(<span class="str">'[SW] Installing...'</span>);

  event.<span class="fn">waitUntil</span>(
    caches.<span class="fn">open</span>(<span class="const">CACHE_NAME</span>)
      .<span class="fn">then</span>((cache) <span class="op">=></span> {
        console.<span class="fn">log</span>(<span class="str">'[SW] Caching app shell'</span>);
        <span class="kw">return</span> cache.<span class="fn">addAll</span>(<span class="const">ASSETS_TO_CACHE</span>);
      })
  );
});

<span class="cm">// ACTIVATE: Clean old caches</span>
self.<span class="fn">addEventListener</span>(<span class="str">'activate'</span>, (event) <span class="op">=></span> {
  console.<span class="fn">log</span>(<span class="str">'[SW] Activating...'</span>);

  event.<span class="fn">waitUntil</span>(
    caches.<span class="fn">keys</span>().<span class="fn">then</span>((keys) <span class="op">=></span> {
      <span class="kw">return</span> Promise.<span class="fn">all</span>(
        keys
          .<span class="fn">filter</span>((key) <span class="op">=></span> key !== <span class="const">CACHE_NAME</span>)
          .<span class="fn">map</span>((key) <span class="op">=></span> caches.<span class="fn">delete</span>(key))
      );
    })
  );
});

<span class="cm">// FETCH: Intercept network requests</span>
self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    caches.<span class="fn">match</span>(event.request)
      .<span class="fn">then</span>((cached) <span class="op">=></span> {
        <span class="kw">return</span> cached || <span class="fn">fetch</span>(event.request);
      })
      .<span class="fn">catch</span>(() <span class="op">=></span> {
        <span class="cm">// If both cache and network fail</span>
        <span class="kw">if</span> (event.request.mode === <span class="str">'navigate'</span>) {
          <span class="kw">return</span> caches.<span class="fn">match</span>(<span class="str">'/offline.html'</span>);
        }
      })
  );
});</code></pre>
      </div>

      <h3>üñ•Ô∏è Interactive Demo: Service Worker Registration</h3>

      <div class="demo-container">
        <div class="demo-header">üî¨ Simulated SW Registration</div>
        <div class="demo-body">
          <div class="demo-controls">
            <button class="btn btn-primary" onclick="simulateSWRegistration()">Register Service Worker</button>
            <button class="btn btn-secondary" onclick="simulateSWUpdate()">Simulate Update</button>
            <button class="btn btn-danger btn-small" onclick="clearDemoLog('sw-reg-log')">Clear</button>
          </div>
          <div class="demo-output" id="sw-reg-log">
            <div class="log-line" style="color:var(--text-dim)">Click "Register Service Worker" to begin simulation...</div>
          </div>
        </div>
      </div>

      <!-- Exercise -->
      <div class="exercise-container">
        <div class="exercise-header">
          <span>üí™</span>
          <span style="font-weight:700">Exercise: Write the Registration Code</span>
        </div>
        <div class="exercise-body">
          <div class="exercise-prompt">
            Write the code to register a service worker located at <code>/service-worker.js</code> with a scope of <code>/app/</code>. Include error handling with try/catch. Use async/await syntax.
          </div>
          <textarea class="code-editor" id="exercise-sw-reg" placeholder="// Write your service worker registration code here...
// Remember: check for support, use async/await, handle errors"></textarea>
          <div class="exercise-actions">
            <button class="btn btn-success" onclick="checkExercise1()">Check Solution ‚úì</button>
            <button class="btn btn-secondary btn-small" onclick="showHint('exercise-sw-reg')">Show Hint</button>
            <button class="btn btn-secondary btn-small" onclick="showSolution1()">Show Solution</button>
          </div>
          <div class="exercise-result" id="exercise-sw-reg-result"></div>
        </div>
      </div>

      <div class="info-box pitfall">
        <div class="info-box-title">‚ö†Ô∏è Pitfall: Using localStorage in Service Workers</div>
        <p>Service Workers are <strong>fully asynchronous</strong>. You CANNOT use:</p>
        <ul>
          <li><code>localStorage</code> / <code>sessionStorage</code></li>
          <li>Synchronous XHR</li>
          <li><code>document</code> or any DOM API</li>
        </ul>
        <p style="margin:0">Instead, use <code>IndexedDB</code>, <code>Cache API</code>, or <code>postMessage()</code> to communicate with the page.</p>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>You understand the fundamentals of service workers.</p>
        <button class="btn btn-primary" onclick="completeSection('sw-basics'); navigateTo('sw-lifecycle')">Continue to SW Lifecycle ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 3: Service Worker Lifecycle -->
    <!-- ============================== -->
    <div class="section" id="section-sw-lifecycle">
      <div class="section-badge">Chapter 3</div>
      <h2>Service Worker Lifecycle</h2>
      <p class="section-subtitle">Understanding the states and events that drive your SW</p>

      <p>The service worker lifecycle is one of the most <strong>confusing</strong> yet <strong>critical</strong> concepts. Let's break it down step by step.</p>

      <h3>üîÑ Interactive Lifecycle Diagram</h3>
      <p>Click each stage to learn more:</p>

      <div class="lifecycle-diagram">
        <div class="lifecycle-flow">
          <div class="lifecycle-node" onclick="showLifecycleDetail('parsed')" id="lc-parsed">
            <div class="node-title">üìÑ Parsed/Downloaded</div>
            <div class="node-event">register() called</div>
          </div>
          <div class="lifecycle-arrow">‚Üì</div>
          <div class="lifecycle-node" onclick="showLifecycleDetail('installing')" id="lc-installing">
            <div class="node-title">üì¶ Installing</div>
            <div class="node-event">install event fires</div>
          </div>
          <div class="lifecycle-arrow">‚Üì</div>
          <div class="lifecycle-node" onclick="showLifecycleDetail('waiting')" id="lc-waiting">
            <div class="node-title">‚è≥ Waiting</div>
            <div class="node-event">Old SW still active</div>
          </div>
          <div class="lifecycle-arrow">‚Üì</div>
          <div class="lifecycle-node" onclick="showLifecycleDetail('activating')" id="lc-activating">
            <div class="node-title">‚ö° Activating</div>
            <div class="node-event">activate event fires</div>
          </div>
          <div class="lifecycle-arrow">‚Üì</div>
          <div class="lifecycle-node" onclick="showLifecycleDetail('activated')" id="lc-activated">
            <div class="node-title">‚úÖ Activated / Idle</div>
            <div class="node-event">fetch, push, sync events</div>
          </div>
          <div class="lifecycle-arrow">‚Üì</div>
          <div class="lifecycle-node" onclick="showLifecycleDetail('redundant')" id="lc-redundant" style="border-color:var(--danger);opacity:0.7">
            <div class="node-title">üóëÔ∏è Redundant</div>
            <div class="node-event">Replaced or failed</div>
          </div>
        </div>

        <div class="lifecycle-detail" id="lc-detail-parsed">
          <h4 style="color:var(--primary);margin-top:0">üìÑ Parsed/Downloaded</h4>
          <p>When you call <code>navigator.serviceWorker.register()</code>, the browser downloads the SW file and parses it. If parsing fails (syntax error), the SW becomes redundant immediately.</p>
          <ul>
            <li>Browser checks for byte-differences with existing SW</li>
            <li>If identical to current SW, nothing happens</li>
            <li>If different (even 1 byte), a new install begins</li>
          </ul>
        </div>
        <div class="lifecycle-detail" id="lc-detail-installing">
          <h4 style="color:var(--primary);margin-top:0">üì¶ Installing</h4>
          <p>The <code>install</code> event fires. This is your chance to <strong>pre-cache essential resources</strong>.</p>
          <div class="code-container" style="margin:12px 0">
            <div class="code-header">
              <div class="code-dots"><span></span><span></span><span></span></div>
              <span>Install Event</span>
            </div>
            <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'install'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">waitUntil</span>(
    caches.<span class="fn">open</span>(<span class="str">'v1'</span>).<span class="fn">then</span>((cache) <span class="op">=></span> {
      <span class="kw">return</span> cache.<span class="fn">addAll</span>([<span class="str">'/'</span>, <span class="str">'/app.js'</span>]);
    })
  );
  <span class="cm">// Optional: skip waiting</span>
  <span class="cm">// self.skipWaiting();</span>
});</code></pre>
          </div>
          <p><strong>Important:</strong> If <code>event.waitUntil()</code> promise rejects, installation fails ‚Üí SW becomes redundant.</p>
        </div>
        <div class="lifecycle-detail" id="lc-detail-waiting">
          <h4 style="color:var(--warning);margin-top:0">‚è≥ Waiting</h4>
          <p>If there's already an active SW controlling pages, the new SW <strong>waits</strong> until all tabs using the old SW are closed.</p>
          <p><strong>This is the most confusing part!</strong> Your new code is ready but NOT active.</p>
          <p>Ways to bypass waiting:</p>
          <ul>
            <li><code>self.skipWaiting()</code> in the install event</li>
            <li>User closes all tabs and reopens</li>
            <li>DevTools ‚Üí Application ‚Üí "Skip waiting" button</li>
          </ul>
        </div>
        <div class="lifecycle-detail" id="lc-detail-activating">
          <h4 style="color:var(--secondary);margin-top:0">‚ö° Activating</h4>
          <p>The <code>activate</code> event fires when the SW takes control. This is the perfect time to <strong>clean up old caches</strong>.</p>
          <div class="code-container" style="margin:12px 0">
            <div class="code-header">
              <div class="code-dots"><span></span><span></span><span></span></div>
              <span>Activate Event ‚Äî Cache Cleanup</span>
            </div>
            <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'activate'</span>, (event) <span class="op">=></span> {
  <span class="kw">const</span> <span class="const">CURRENT</span> = <span class="str">'v2'</span>;
  event.<span class="fn">waitUntil</span>(
    caches.<span class="fn">keys</span>().<span class="fn">then</span>((names) <span class="op">=></span> {
      <span class="kw">return</span> Promise.<span class="fn">all</span>(
        names
          .<span class="fn">filter</span>((n) <span class="op">=></span> n !== <span class="const">CURRENT</span>)
          .<span class="fn">map</span>((n) <span class="op">=></span> caches.<span class="fn">delete</span>(n))
      );
    })
  );
  <span class="cm">// Take control of uncontrolled pages</span>
  <span class="kw">return</span> self.clients.<span class="fn">claim</span>();
});</code></pre>
          </div>
        </div>
        <div class="lifecycle-detail" id="lc-detail-activated">
          <h4 style="color:var(--success);margin-top:0">‚úÖ Activated / Idle</h4>
          <p>Now the SW is in control! It handles functional events:</p>
          <ul>
            <li><code>fetch</code> ‚Äî Intercept network requests</li>
            <li><code>push</code> ‚Äî Handle push notifications</li>
            <li><code>sync</code> ‚Äî Background sync when connectivity is restored</li>
            <li><code>message</code> ‚Äî Receive messages from pages</li>
          </ul>
          <p>The SW may be terminated at any time to save memory. It wakes up when events occur.</p>
        </div>
        <div class="lifecycle-detail" id="lc-detail-redundant">
          <h4 style="color:var(--danger);margin-top:0">üóëÔ∏è Redundant</h4>
          <p>A SW becomes redundant when:</p>
          <ul>
            <li>Installation failed (caching error, syntax error)</li>
            <li>A newer SW replaced it</li>
            <li>It was manually unregistered</li>
          </ul>
        </div>
      </div>

      <h3>üß™ Lifecycle Simulation</h3>

      <div class="demo-container">
        <div class="demo-header">üî¨ Watch the Lifecycle Unfold</div>
        <div class="demo-body">
          <div class="demo-controls">
            <button class="btn btn-primary" onclick="simulateLifecycle('fresh')">Fresh Install</button>
            <button class="btn btn-secondary" onclick="simulateLifecycle('update')">SW Update</button>
            <button class="btn btn-success btn-small" onclick="simulateLifecycle('skipWaiting')">Skip Waiting</button>
            <button class="btn btn-danger btn-small" onclick="clearDemoLog('lifecycle-log')">Clear</button>
          </div>
          <div class="demo-output" id="lifecycle-log">
            <div class="log-line" style="color:var(--text-dim)">Choose a scenario to simulate...</div>
          </div>
        </div>
      </div>

      <h3>ü§î The Update Flow ‚Äî Deep Dive</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>Handling Updates Properly</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="cm">// In your main app.js ‚Äî Notify users about updates</span>
<span class="kw">async function</span> <span class="fn">registerSW</span>() {
  <span class="kw">const</span> <span class="const">reg</span> = <span class="kw">await</span> navigator.serviceWorker.<span class="fn">register</span>(<span class="str">'/sw.js'</span>);

  <span class="cm">// Detect when a new SW is waiting</span>
  reg.<span class="fn">addEventListener</span>(<span class="str">'updatefound'</span>, () <span class="op">=></span> {
    <span class="kw">const</span> <span class="const">newSW</span> = reg.installing;

    newSW.<span class="fn">addEventListener</span>(<span class="str">'statechange'</span>, () <span class="op">=></span> {
      <span class="kw">if</span> (newSW.state === <span class="str">'installed'</span>) {
        <span class="kw">if</span> (navigator.serviceWorker.controller) {
          <span class="cm">// New SW waiting, old one still active</span>
          <span class="fn">showUpdateBanner</span>(); <span class="cm">// "Update available!"</span>
        } <span class="kw">else</span> {
          <span class="cm">// First install, content cached</span>
          <span class="fn">showOfflineReady</span>(); <span class="cm">// "App ready offline!"</span>
        }
      }
    });
  });

  <span class="cm">// Handle controller change (new SW took over)</span>
  <span class="kw">let</span> refreshing = <span class="bool">false</span>;
  navigator.serviceWorker.<span class="fn">addEventListener</span>(
    <span class="str">'controllerchange'</span>, () <span class="op">=></span> {
      <span class="kw">if</span> (!refreshing) {
        refreshing = <span class="bool">true</span>;
        window.location.<span class="fn">reload</span>();
      }
    }
  );
}

<span class="cm">// In sw.js ‚Äî When user clicks "Update Now"</span>
self.<span class="fn">addEventListener</span>(<span class="str">'message'</span>, (event) <span class="op">=></span> {
  <span class="kw">if</span> (event.data === <span class="str">'SKIP_WAITING'</span>) {
    self.<span class="fn">skipWaiting</span>();
  }
});</code></pre>
      </div>

      <!-- Quiz -->
      <div class="quiz-container" id="quiz-lifecycle">
        <div class="quiz-header">
          <span>üß† Lifecycle Quiz</span>
          <div class="quiz-progress-dots">
            <div class="quiz-dot current"></div>
            <div class="quiz-dot"></div>
            <div class="quiz-dot"></div>
          </div>
        </div>
        <div class="quiz-body" id="quiz-lifecycle-body">
          <div class="quiz-question">A new service worker has been installed, but the old one is still controlling the page. What state is the new SW in?</div>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-lc-exp')">
              <span class="option-letter">A</span>
              <span>Installing</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, true, 'quiz-lc-exp')">
              <span class="option-letter">B</span>
              <span>Waiting (installed)</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-lc-exp')">
              <span class="option-letter">C</span>
              <span>Activating</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-lc-exp')">
              <span class="option-letter">D</span>
              <span>Redundant</span>
            </div>
          </div>
          <div class="quiz-explanation" id="quiz-lc-exp">
            <strong>Correct! üéâ</strong> After successful installation, if an old SW is still active, the new one enters the <strong>waiting</strong> state. It won't activate until all tabs using the old SW are closed, or <code>skipWaiting()</code> is called.
          </div>
        </div>
      </div>

      <div class="info-box pitfall">
        <div class="info-box-title">‚ö†Ô∏è Pitfall: Forgetting event.waitUntil()</div>
        <p>Without <code>event.waitUntil()</code>, the browser may terminate your SW before async operations complete!</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>‚ùå vs ‚úÖ</span>
          </div>
          <pre><code><span class="cm">// ‚ùå BAD: SW might terminate before caching completes!</span>
self.<span class="fn">addEventListener</span>(<span class="str">'install'</span>, () <span class="op">=></span> {
  caches.<span class="fn">open</span>(<span class="str">'v1'</span>).<span class="fn">then</span>(c <span class="op">=></span> c.<span class="fn">addAll</span>([<span class="str">'/'</span>]));
});

<span class="cm">// ‚úÖ GOOD: Browser waits for caching to complete</span>
self.<span class="fn">addEventListener</span>(<span class="str">'install'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">waitUntil</span>(
    caches.<span class="fn">open</span>(<span class="str">'v1'</span>).<span class="fn">then</span>(c <span class="op">=></span> c.<span class="fn">addAll</span>([<span class="str">'/'</span>]))
  );
});</code></pre>
        </div>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>You've mastered the service worker lifecycle!</p>
        <button class="btn btn-primary" onclick="completeSection('sw-lifecycle'); navigateTo('caching')">Continue to Caching Strategies ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 4: Caching Strategies -->
    <!-- ============================== -->
    <div class="section" id="section-caching">
      <div class="section-badge">Chapter 4</div>
      <h2>Caching Strategies</h2>
      <p class="section-subtitle">Choose the right strategy for every resource type</p>

      <p>Different resources need different caching approaches. There are <strong>5 main strategies</strong>. Click each card to explore:</p>

      <h3>üì¶ The Five Strategies</h3>

      <div class="strategy-grid" id="strategyGrid">
        <div class="strategy-card" onclick="toggleStrategy(this, 'cache-first')">
          <div class="strategy-name">1. Cache First</div>
          <div class="strategy-desc">Check cache ‚Üí fall back to network</div>
          <div class="strategy-detail" id="detail-cache-first">
            <div class="strategy-visual">
              <div class="visual-step">üì± Request</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step">üíæ Cache?</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step" style="border-color:var(--success)">‚úÖ Return</div>
              <div class="visual-arrow">or ‚Üí</div>
              <div class="visual-step">üåê Network</div>
            </div>
            <p><strong>Best for:</strong> Static assets (CSS, JS, images, fonts) that don't change often.</p>
            <span class="chip chip-good">Fast</span>
            <span class="chip chip-neutral">May be stale</span>
            <div class="code-container" style="margin-top:12px">
              <div class="code-header">
                <div class="code-dots"><span></span><span></span><span></span></div>
                <span>Cache First</span>
              </div>
              <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    caches.<span class="fn">match</span>(event.request)
      .<span class="fn">then</span>((cached) <span class="op">=></span> {
        <span class="kw">return</span> cached || <span class="fn">fetch</span>(event.request);
      })
  );
});</code></pre>
            </div>
          </div>
        </div>

        <div class="strategy-card" onclick="toggleStrategy(this, 'network-first')">
          <div class="strategy-name">2. Network First</div>
          <div class="strategy-desc">Try network ‚Üí fall back to cache</div>
          <div class="strategy-detail" id="detail-network-first">
            <div class="strategy-visual">
              <div class="visual-step">üì± Request</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step">üåê Network?</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step" style="border-color:var(--success)">‚úÖ Return + Cache</div>
              <div class="visual-arrow">or ‚Üí</div>
              <div class="visual-step">üíæ Cache</div>
            </div>
            <p><strong>Best for:</strong> API requests, dynamic content that should be fresh but work offline.</p>
            <span class="chip chip-good">Always fresh</span>
            <span class="chip chip-neutral">Slower when online</span>
            <div class="code-container" style="margin-top:12px">
              <div class="code-header">
                <div class="code-dots"><span></span><span></span><span></span></div>
                <span>Network First</span>
              </div>
              <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    <span class="fn">fetch</span>(event.request)
      .<span class="fn">then</span>((response) <span class="op">=></span> {
        <span class="cm">// Clone and cache the response</span>
        <span class="kw">const</span> <span class="const">clone</span> = response.<span class="fn">clone</span>();
        caches.<span class="fn">open</span>(<span class="str">'dynamic-v1'</span>)
          .<span class="fn">then</span>(c <span class="op">=></span> c.<span class="fn">put</span>(event.request, clone));
        <span class="kw">return</span> response;
      })
      .<span class="fn">catch</span>(() <span class="op">=></span> caches.<span class="fn">match</span>(event.request))
  );
});</code></pre>
            </div>
          </div>
        </div>

        <div class="strategy-card" onclick="toggleStrategy(this, 'stale-while')">
          <div class="strategy-name">3. Stale While Revalidate</div>
          <div class="strategy-desc">Return cache immediately, update in background</div>
          <div class="strategy-detail" id="detail-stale-while">
            <div class="strategy-visual">
              <div class="visual-step">üì± Request</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step">üíæ Return cached</div>
              <div class="visual-arrow">+ async</div>
              <div class="visual-step">üåê Fetch & Update cache</div>
            </div>
            <p><strong>Best for:</strong> Resources that should load fast but stay relatively fresh ‚Äî user avatars, articles, frequently accessed APIs.</p>
            <span class="chip chip-good">Very fast</span>
            <span class="chip chip-good">Eventually consistent</span>
            <div class="code-container" style="margin-top:12px">
              <div class="code-header">
                <div class="code-dots"><span></span><span></span><span></span></div>
                <span>Stale While Revalidate</span>
              </div>
              <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    caches.<span class="fn">match</span>(event.request).<span class="fn">then</span>((cached) <span class="op">=></span> {
      <span class="kw">const</span> <span class="const">fetchPromise</span> = <span class="fn">fetch</span>(event.request)
        .<span class="fn">then</span>((response) <span class="op">=></span> {
          caches.<span class="fn">open</span>(<span class="str">'dynamic-v1'</span>)
            .<span class="fn">then</span>(c <span class="op">=></span> c.<span class="fn">put</span>(event.request, response.<span class="fn">clone</span>()));
          <span class="kw">return</span> response;
        });

      <span class="cm">// Return cached immediately, update in bg</span>
      <span class="kw">return</span> cached || fetchPromise;
    })
  );
});</code></pre>
            </div>
          </div>
        </div>

        <div class="strategy-card" onclick="toggleStrategy(this, 'cache-only')">
          <div class="strategy-name">4. Cache Only</div>
          <div class="strategy-desc">Only serve from cache, never network</div>
          <div class="strategy-detail" id="detail-cache-only">
            <div class="strategy-visual">
              <div class="visual-step">üì± Request</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step">üíæ Cache</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step" style="border-color:var(--success)">‚úÖ Return</div>
            </div>
            <p><strong>Best for:</strong> Pre-cached static assets that are versioned (hashed filenames).</p>
            <span class="chip chip-good">Fastest</span>
            <span class="chip chip-bad">No network fallback</span>
            <div class="code-container" style="margin-top:12px">
              <div class="code-header">
                <div class="code-dots"><span></span><span></span><span></span></div>
                <span>Cache Only</span>
              </div>
              <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    caches.<span class="fn">match</span>(event.request)
  );
});</code></pre>
            </div>
          </div>
        </div>

        <div class="strategy-card" onclick="toggleStrategy(this, 'network-only')">
          <div class="strategy-name">5. Network Only</div>
          <div class="strategy-desc">Always go to network, no caching</div>
          <div class="strategy-detail" id="detail-network-only">
            <div class="strategy-visual">
              <div class="visual-step">üì± Request</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step">üåê Network</div>
              <div class="visual-arrow">‚Üí</div>
              <div class="visual-step" style="border-color:var(--success)">‚úÖ Return</div>
            </div>
            <p><strong>Best for:</strong> Non-GET requests (POST, PUT), analytics pings, real-time data.</p>
            <span class="chip chip-good">Always fresh</span>
            <span class="chip chip-bad">No offline</span>
            <div class="code-container" style="margin-top:12px">
              <div class="code-header">
                <div class="code-dots"><span></span><span></span><span></span></div>
                <span>Network Only</span>
              </div>
              <pre><code>self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    <span class="fn">fetch</span>(event.request)
  );
});</code></pre>
            </div>
          </div>
        </div>
      </div>

      <h3>üéØ Real-World Strategy Router</h3>
      <p>In practice, you combine multiple strategies based on the request type:</p>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>sw.js ‚Äî Complete Strategy Router</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">const</span> <span class="const">CACHE_STATIC</span> = <span class="str">'static-v2'</span>;
<span class="kw">const</span> <span class="const">CACHE_DYNAMIC</span> = <span class="str">'dynamic-v1'</span>;
<span class="kw">const</span> <span class="const">CACHE_IMAGES</span> = <span class="str">'images-v1'</span>;
<span class="kw">const</span> <span class="const">MAX_DYNAMIC</span> = <span class="num">50</span>;

<span class="cm">// Limit cache size utility</span>
<span class="kw">async function</span> <span class="fn">trimCache</span>(cacheName, maxItems) {
  <span class="kw">const</span> <span class="const">cache</span> = <span class="kw">await</span> caches.<span class="fn">open</span>(cacheName);
  <span class="kw">const</span> <span class="const">keys</span> = <span class="kw">await</span> cache.<span class="fn">keys</span>();
  <span class="kw">if</span> (keys.length > maxItems) {
    <span class="kw">await</span> cache.<span class="fn">delete</span>(keys[<span class="num">0</span>]);
    <span class="kw">return</span> <span class="fn">trimCache</span>(cacheName, maxItems);
  }
}

self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  <span class="kw">const</span> { request } = event;
  <span class="kw">const</span> <span class="const">url</span> = <span class="kw">new</span> <span class="fn">URL</span>(request.url);

  <span class="cm">// Strategy 1: Cache First for static assets</span>
  <span class="kw">if</span> (request.destination === <span class="str">'style'</span> ||
      request.destination === <span class="str">'script'</span> ||
      request.destination === <span class="str">'font'</span>) {
    event.<span class="fn">respondWith</span>(<span class="fn">cacheFirst</span>(request, <span class="const">CACHE_STATIC</span>));
    <span class="kw">return</span>;
  }

  <span class="cm">// Strategy 2: Stale-While-Revalidate for images</span>
  <span class="kw">if</span> (request.destination === <span class="str">'image'</span>) {
    event.<span class="fn">respondWith</span>(<span class="fn">staleWhileRevalidate</span>(request, <span class="const">CACHE_IMAGES</span>));
    <span class="kw">return</span>;
  }

  <span class="cm">// Strategy 3: Network First for API calls</span>
  <span class="kw">if</span> (url.pathname.<span class="fn">startsWith</span>(<span class="str">'/api/'</span>)) {
    event.<span class="fn">respondWith</span>(<span class="fn">networkFirst</span>(request, <span class="const">CACHE_DYNAMIC</span>));
    <span class="kw">return</span>;
  }

  <span class="cm">// Strategy 4: Network First for HTML pages</span>
  <span class="kw">if</span> (request.mode === <span class="str">'navigate'</span>) {
    event.<span class="fn">respondWith</span>(
      <span class="fn">networkFirst</span>(request, <span class="const">CACHE_DYNAMIC</span>)
        .<span class="fn">catch</span>(() <span class="op">=></span> caches.<span class="fn">match</span>(<span class="str">'/offline.html'</span>))
    );
    <span class="kw">return</span>;
  }
});

<span class="cm">// Strategy implementations</span>
<span class="kw">async function</span> <span class="fn">cacheFirst</span>(request, cacheName) {
  <span class="kw">const</span> <span class="const">cached</span> = <span class="kw">await</span> caches.<span class="fn">match</span>(request);
  <span class="kw">if</span> (cached) <span class="kw">return</span> cached;

  <span class="kw">const</span> <span class="const">response</span> = <span class="kw">await</span> <span class="fn">fetch</span>(request);
  <span class="kw">const</span> <span class="const">cache</span> = <span class="kw">await</span> caches.<span class="fn">open</span>(cacheName);
  cache.<span class="fn">put</span>(request, response.<span class="fn">clone</span>());
  <span class="kw">return</span> response;
}

<span class="kw">async function</span> <span class="fn">networkFirst</span>(request, cacheName) {
  <span class="kw">try</span> {
    <span class="kw">const</span> <span class="const">response</span> = <span class="kw">await</span> <span class="fn">fetch</span>(request);
    <span class="kw">const</span> <span class="const">cache</span> = <span class="kw">await</span> caches.<span class="fn">open</span>(cacheName);
    cache.<span class="fn">put</span>(request, response.<span class="fn">clone</span>());
    <span class="kw">return</span> response;
  } <span class="kw">catch</span> (err) {
    <span class="kw">return</span> caches.<span class="fn">match</span>(request);
  }
}

<span class="kw">async function</span> <span class="fn">staleWhileRevalidate</span>(request, cacheName) {
  <span class="kw">const</span> <span class="const">cache</span> = <span class="kw">await</span> caches.<span class="fn">open</span>(cacheName);
  <span class="kw">const</span> <span class="const">cached</span> = <span class="kw">await</span> cache.<span class="fn">match</span>(request);

  <span class="kw">const</span> <span class="const">networkFetch</span> = <span class="fn">fetch</span>(request).<span class="fn">then</span>((response) <span class="op">=></span> {
    cache.<span class="fn">put</span>(request, response.<span class="fn">clone</span>());
    <span class="kw">return</span> response;
  });

  <span class="kw">return</span> cached || networkFetch;
}</code></pre>
      </div>

      <h3>üß™ Strategy Simulator</h3>

      <div class="demo-container">
        <div class="demo-header">üî¨ Test Different Caching Strategies</div>
        <div class="demo-body">
          <p style="font-size:0.85rem;margin-bottom:12px">Select a strategy and simulate requests in online/offline mode:</p>
          <div class="demo-controls">
            <select id="strategySelect" style="background:var(--bg-code);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;font-size:0.85rem">
              <option value="cache-first">Cache First</option>
              <option value="network-first">Network First</option>
              <option value="stale-while-revalidate">Stale While Revalidate</option>
            </select>
            <button class="btn btn-primary btn-small" onclick="simulateCacheStrategy(true)">Request (Online)</button>
            <button class="btn btn-danger btn-small" onclick="simulateCacheStrategy(false)">Request (Offline)</button>
            <button class="btn btn-secondary btn-small" onclick="clearSimCache()">Clear Cache</button>
            <button class="btn btn-secondary btn-small" onclick="clearDemoLog('cache-sim-log')">Clear Log</button>
          </div>
          <div class="demo-output" id="cache-sim-log">
            <div class="log-line" style="color:var(--text-dim)">Try making requests with different strategies...</div>
          </div>
        </div>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Common Mistake: Forgetting to Clone Responses</div>
        <p>A <code>Response</code> body can only be read <strong>once</strong>. If you want to cache it AND return it, you must <code>.clone()</code> it:</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>‚ùå vs ‚úÖ</span>
          </div>
          <pre><code><span class="cm">// ‚ùå BAD: Response body already consumed!</span>
cache.<span class="fn">put</span>(request, response);
<span class="kw">return</span> response; <span class="cm">// Error! Body already read</span>

<span class="cm">// ‚úÖ GOOD: Clone before caching</span>
cache.<span class="fn">put</span>(request, response.<span class="fn">clone</span>());
<span class="kw">return</span> response; <span class="cm">// Works fine!</span></code></pre>
        </div>
      </div>

      <!-- Quiz -->
      <div class="quiz-container" id="quiz-caching">
        <div class="quiz-header">
          <span>üß† Strategy Quiz</span>
          <div class="quiz-progress-dots">
            <div class="quiz-dot current"></div>
            <div class="quiz-dot"></div>
          </div>
        </div>
        <div class="quiz-body">
          <div class="quiz-question">You're building a news app. Which strategy is best for the article list API endpoint?</div>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-cache-exp')">
              <span class="option-letter">A</span>
              <span>Cache Only ‚Äî fastest possible</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, true, 'quiz-cache-exp')">
              <span class="option-letter">B</span>
              <span>Network First ‚Äî fresh data with offline fallback</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-cache-exp')">
              <span class="option-letter">C</span>
              <span>Cache First ‚Äî show cached articles</span>
            </div>
            <div class="quiz-option" onclick="checkQuizAnswer(this, false, 'quiz-cache-exp')">
              <span class="option-letter">D</span>
              <span>Network Only ‚Äî no caching needed</span>
            </div>
          </div>
          <div class="quiz-explanation" id="quiz-cache-exp">
            <strong>Correct! üéâ</strong> For API endpoints with dynamic data like a news feed, <strong>Network First</strong> ensures users see the latest content when online, but can still read cached articles when offline.
          </div>
        </div>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>You've mastered all 5 caching strategies!</p>
        <button class="btn btn-primary" onclick="completeSection('caching'); navigateTo('offline')">Continue to Offline Support ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 5: Offline Support -->
    <!-- ============================== -->
    <div class="section" id="section-offline">
      <div class="section-badge">Chapter 5</div>
      <h2>Offline Support</h2>
      <p class="section-subtitle">Making your app work without an internet connection</p>

      <div class="info-box concept">
        <div class="info-box-title">üí° The Offline-First Mindset</div>
        <p style="margin:0">Instead of treating offline as an error state, <strong>design for offline first</strong> and treat network as an enhancement. This creates more resilient, faster apps.</p>
      </div>

      <h3>üì° Detecting Online/Offline Status</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>Online/Offline Detection</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="cm">// Check current status</span>
console.<span class="fn">log</span>(navigator.onLine); <span class="cm">// true or false</span>

<span class="cm">// Listen for changes</span>
window.<span class="fn">addEventListener</span>(<span class="str">'online'</span>, () <span class="op">=></span> {
  console.<span class="fn">log</span>(<span class="str">'Back online!'</span>);
  <span class="fn">syncPendingData</span>();  <span class="cm">// Sync queued actions</span>
  <span class="fn">showToast</span>(<span class="str">'You\'re back online! üåê'</span>);
});

window.<span class="fn">addEventListener</span>(<span class="str">'offline'</span>, () <span class="op">=></span> {
  console.<span class="fn">log</span>(<span class="str">'Gone offline!'</span>);
  <span class="fn">showToast</span>(<span class="str">'You\'re offline. Changes will sync later. üì°'</span>);
});

<span class="cm">// ‚ö†Ô∏è WARNING: navigator.onLine is not always reliable!</span>
<span class="cm">// It only tells you if there's a network connection,</span>
<span class="cm">// NOT if that connection has internet access.</span>
<span class="cm">// Always handle fetch errors gracefully.</span></code></pre>
      </div>

      <h3>üñ•Ô∏è Online Status Demo</h3>

      <div class="demo-container">
        <div class="demo-header">üì° Real-Time Connection Status</div>
        <div class="demo-body">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
            <div id="onlineStatus" style="display:flex;align-items:center;gap:8px;padding:10px 20px;border-radius:10px;background:rgba(0,184,148,0.15);border:1px solid rgba(0,184,148,0.3)">
              <div style="width:12px;height:12px;border-radius:50%;background:var(--success);animation:pulse 2s infinite"></div>
              <span style="font-weight:600">Online</span>
            </div>
            <span style="color:var(--text-dim);font-size:0.85rem">Try disconnecting your WiFi!</span>
          </div>
          <p style="font-size:0.85rem;color:var(--text-dim)">This demo uses real browser events to detect your connection status.</p>
        </div>
      </div>

      <style>
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.4; }
        }
      </style>

      <h3>üìù Offline Data with IndexedDB</h3>
      <p>For storing structured data offline, use <strong>IndexedDB</strong>. Here's a practical wrapper:</p>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>IndexedDB Offline Queue</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="cm">// Simple IndexedDB wrapper for offline queue</span>
<span class="kw">class</span> <span class="obj">OfflineQueue</span> {
  <span class="fn">constructor</span>(dbName = <span class="str">'offlineQueue'</span>) {
    <span class="kw">this</span>.dbName = dbName;
    <span class="kw">this</span>.db = <span class="bool">null</span>;
  }

  <span class="kw">async</span> <span class="fn">init</span>() {
    <span class="kw">return new</span> <span class="fn">Promise</span>((resolve, reject) <span class="op">=></span> {
      <span class="kw">const</span> <span class="const">request</span> = indexedDB.<span class="fn">open</span>(<span class="kw">this</span>.dbName, <span class="num">1</span>);

      request.<span class="prop">onupgradeneeded</span> = (e) <span class="op">=></span> {
        <span class="kw">const</span> <span class="const">db</span> = e.target.result;
        <span class="kw">if</span> (!db.objectStoreNames.<span class="fn">contains</span>(<span class="str">'pending'</span>)) {
          db.<span class="fn">createObjectStore</span>(<span class="str">'pending'</span>, {
            <span class="prop">keyPath</span>: <span class="str">'id'</span>,
            <span class="prop">autoIncrement</span>: <span class="bool">true</span>
          });
        }
      };

      request.<span class="prop">onsuccess</span> = (e) <span class="op">=></span> {
        <span class="kw">this</span>.db = e.target.result;
        <span class="fn">resolve</span>(<span class="kw">this</span>.db);
      };

      request.<span class="prop">onerror</span> = () <span class="op">=></span> <span class="fn">reject</span>(request.error);
    });
  }

  <span class="cm">// Queue a request for later sync</span>
  <span class="kw">async</span> <span class="fn">enqueue</span>(url, method, body) {
    <span class="kw">const</span> <span class="const">tx</span> = <span class="kw">this</span>.db.<span class="fn">transaction</span>(<span class="str">'pending'</span>, <span class="str">'readwrite'</span>);
    <span class="kw">const</span> <span class="const">store</span> = tx.<span class="fn">objectStore</span>(<span class="str">'pending'</span>);
    store.<span class="fn">add</span>({ url, method, body, <span class="prop">timestamp</span>: Date.<span class="fn">now</span>() });
  }

  <span class="cm">// Process all pending requests</span>
  <span class="kw">async</span> <span class="fn">processQueue</span>() {
    <span class="kw">const</span> <span class="const">items</span> = <span class="kw">await</span> <span class="kw">this</span>.<span class="fn">getAll</span>();

    <span class="kw">for</span> (<span class="kw">const</span> <span class="const">item</span> <span class="kw">of</span> items) {
      <span class="kw">try</span> {
        <span class="kw">await</span> <span class="fn">fetch</span>(item.url, {
          <span class="prop">method</span>: item.method,
          <span class="prop">body</span>: JSON.<span class="fn">stringify</span>(item.body),
          <span class="prop">headers</span>: { <span class="str">'Content-Type'</span>: <span class="str">'application/json'</span> }
        });
        <span class="kw">await</span> <span class="kw">this</span>.<span class="fn">remove</span>(item.id);
        console.<span class="fn">log</span>(<span class="str">`Synced: ${item.url}`</span>);
      } <span class="kw">catch</span> (err) {
        console.<span class="fn">log</span>(<span class="str">`Still offline, keeping: ${item.url}`</span>);
        <span class="kw">break</span>; <span class="cm">// Stop if still offline</span>
      }
    }
  }
}</code></pre>
      </div>

      <h3>üîÑ Background Sync API</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>Background Sync</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="cm">// In your app.js ‚Äî Register a sync event</span>
<span class="kw">async function</span> <span class="fn">saveDataOffline</span>(data) {
  <span class="cm">// Store data in IndexedDB first</span>
  <span class="kw">await</span> offlineQueue.<span class="fn">enqueue</span>(<span class="str">'/api/posts'</span>, <span class="str">'POST'</span>, data);

  <span class="cm">// Register for background sync</span>
  <span class="kw">const</span> <span class="const">reg</span> = <span class="kw">await</span> navigator.serviceWorker.ready;

  <span class="kw">if</span> (<span class="str">'sync'</span> <span class="kw">in</span> reg) {
    <span class="kw">await</span> reg.sync.<span class="fn">register</span>(<span class="str">'sync-posts'</span>);
    console.<span class="fn">log</span>(<span class="str">'Sync registered! Will sync when online.'</span>);
  } <span class="kw">else</span> {
    <span class="cm">// Fallback: try immediately</span>
    <span class="kw">if</span> (navigator.onLine) {
      <span class="kw">await</span> offlineQueue.<span class="fn">processQueue</span>();
    }
  }
}

<span class="cm">// In sw.js ‚Äî Handle the sync event</span>
self.<span class="fn">addEventListener</span>(<span class="str">'sync'</span>, (event) <span class="op">=></span> {
  <span class="kw">if</span> (event.tag === <span class="str">'sync-posts'</span>) {
    event.<span class="fn">waitUntil</span>(
      <span class="fn">syncPosts</span>() <span class="cm">// Process the IndexedDB queue</span>
    );
  }
});

<span class="kw">async function</span> <span class="fn">syncPosts</span>() {
  <span class="kw">const</span> <span class="const">queue</span> = <span class="kw">new</span> <span class="obj">OfflineQueue</span>();
  <span class="kw">await</span> queue.<span class="fn">init</span>();
  <span class="kw">await</span> queue.<span class="fn">processQueue</span>();
}</code></pre>
      </div>

      <h3>üìÑ Custom Offline Page</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>offline.html ‚Äî Make it Useful!</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="tag">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attr">lang</span>=<span class="val">"en"</span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">charset</span>=<span class="val">"UTF-8"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;title&gt;</span>Offline - MyApp<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;style&gt;</span>
    <span class="cm">/* Inline all styles ‚Äî can't load external CSS offline! */</span>
    body { text-align: center; padding: 50px; font-family: sans-serif; }
    .offline-icon { font-size: 80px; }
    button { padding: 12px 24px; margin-top: 20px; }
  <span class="tag">&lt;/style&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span>
  <span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="val">"offline-icon"</span><span class="tag">&gt;</span>üì°<span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;h1&gt;</span>You're Offline<span class="tag">&lt;/h1&gt;</span>
  <span class="tag">&lt;p&gt;</span>Check your connection and try again.<span class="tag">&lt;/p&gt;</span>

  <span class="tag">&lt;div</span> <span class="attr">id</span>=<span class="val">"cachedPages"</span><span class="tag">&gt;</span>
    <span class="tag">&lt;h3&gt;</span>Available offline:<span class="tag">&lt;/h3&gt;</span>
    <span class="tag">&lt;ul</span> <span class="attr">id</span>=<span class="val">"pageList"</span><span class="tag">&gt;&lt;/ul&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;button</span> <span class="attr">onclick</span>=<span class="val">"location.reload()"</span><span class="tag">&gt;</span>
    Try Again
  <span class="tag">&lt;/button&gt;</span>

  <span class="tag">&lt;script&gt;</span>
    <span class="cm">// Show cached pages the user can still visit</span>
    <span class="kw">async function</span> <span class="fn">showCachedPages</span>() {
      <span class="kw">const</span> <span class="const">cache</span> = <span class="kw">await</span> caches.<span class="fn">open</span>(<span class="str">'dynamic-v1'</span>);
      <span class="kw">const</span> <span class="const">keys</span> = <span class="kw">await</span> cache.<span class="fn">keys</span>();
      <span class="kw">const</span> <span class="const">list</span> = document.<span class="fn">getElementById</span>(<span class="str">'pageList'</span>);

      keys.<span class="fn">filter</span>(r <span class="op">=></span> r.url.<span class="fn">endsWith</span>(<span class="str">'.html'</span>) || r.mode === <span class="str">'navigate'</span>)
        .<span class="fn">forEach</span>((request) <span class="op">=></span> {
          <span class="kw">const</span> <span class="const">li</span> = document.<span class="fn">createElement</span>(<span class="str">'li'</span>);
          <span class="kw">const</span> <span class="const">a</span> = document.<span class="fn">createElement</span>(<span class="str">'a'</span>);
          a.href = request.url;
          a.textContent = request.url;
          li.<span class="fn">appendChild</span>(a);
          list.<span class="fn">appendChild</span>(li);
        });
    }
    <span class="fn">showCachedPages</span>();
  <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
      </div>

      <!-- Exercise -->
      <div class="exercise-container">
        <div class="exercise-header">
          <span>üí™</span>
          <span style="font-weight:700">Exercise: Build an Offline-Aware Fetch Wrapper</span>
        </div>
        <div class="exercise-body">
          <div class="exercise-prompt">
            Write a function called <code>offlineFetch</code> that:
            <ol>
              <li>Tries to <code>fetch()</code> the URL normally</li>
              <li>If fetch fails (offline), checks the Cache API</li>
              <li>If nothing in cache, stores the request in a queue array</li>
              <li>Returns an appropriate response or error message</li>
            </ol>
          </div>
          <textarea class="code-editor" id="exercise-offline" placeholder="async function offlineFetch(url, options = {}) {
  // Your code here...
}"></textarea>
          <div class="exercise-actions">
            <button class="btn btn-success" onclick="checkExercise2()">Check Solution ‚úì</button>
            <button class="btn btn-secondary btn-small" onclick="showSolution2()">Show Solution</button>
          </div>
          <div class="exercise-result" id="exercise-offline-result"></div>
        </div>
      </div>

      <div class="info-box pitfall">
        <div class="info-box-title">‚ö†Ô∏è Pitfall: Caching POST Requests</div>
        <p>The Cache API only works with GET requests by default. You <strong>cannot cache POST requests</strong> directly. Instead:</p>
        <ul>
          <li>Store POST data in IndexedDB</li>
          <li>Use Background Sync to replay when online</li>
          <li>Implement optimistic UI updates</li>
        </ul>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>Your app can now work without internet!</p>
        <button class="btn btn-primary" onclick="completeSection('offline'); navigateTo('manifest')">Continue to App Manifest ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 6: App Manifest -->
    <!-- ============================== -->
    <div class="section" id="section-manifest">
      <div class="section-badge">Chapter 6</div>
      <h2>Web App Manifest</h2>
      <p class="section-subtitle">Making your web app installable</p>

      <div class="info-box concept">
        <div class="info-box-title">üí° What is a Web App Manifest?</div>
        <p style="margin:0">A <code>manifest.json</code> file tells the browser about your web application ‚Äî its name, icons, colors, how it should behave when installed. It enables the <strong>"Add to Home Screen"</strong> prompt.</p>
      </div>

      <h3>üìã Complete Manifest Example</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>manifest.json</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code>{
  <span class="prop">"name"</span>: <span class="str">"My Awesome PWA"</span>,
  <span class="prop">"short_name"</span>: <span class="str">"MyPWA"</span>,
  <span class="prop">"description"</span>: <span class="str">"A progressive web app that does awesome things"</span>,
  <span class="prop">"start_url"</span>: <span class="str">"/"</span>,
  <span class="prop">"scope"</span>: <span class="str">"/"</span>,
  <span class="prop">"display"</span>: <span class="str">"standalone"</span>,
  <span class="prop">"orientation"</span>: <span class="str">"portrait"</span>,
  <span class="prop">"background_color"</span>: <span class="str">"#ffffff"</span>,
  <span class="prop">"theme_color"</span>: <span class="str">"#6c5ce7"</span>,
  <span class="prop">"lang"</span>: <span class="str">"en-US"</span>,
  <span class="prop">"dir"</span>: <span class="str">"ltr"</span>,
  <span class="prop">"categories"</span>: [<span class="str">"productivity"</span>, <span class="str">"utilities"</span>],
  <span class="prop">"icons"</span>: [
    {
      <span class="prop">"src"</span>: <span class="str">"/icons/icon-72x72.png"</span>,
      <span class="prop">"sizes"</span>: <span class="str">"72x72"</span>,
      <span class="prop">"type"</span>: <span class="str">"image/png"</span>,
      <span class="prop">"purpose"</span>: <span class="str">"any"</span>
    },
    {
      <span class="prop">"src"</span>: <span class="str">"/icons/icon-192x192.png"</span>,
      <span class="prop">"sizes"</span>: <span class="str">"192x192"</span>,
      <span class="prop">"type"</span>: <span class="str">"image/png"</span>,
      <span class="prop">"purpose"</span>: <span class="str">"any"</span>
    },
    {
      <span class="prop">"src"</span>: <span class="str">"/icons/icon-512x512.png"</span>,
      <span class="prop">"sizes"</span>: <span class="str">"512x512"</span>,
      <span class="prop">"type"</span>: <span class="str">"image/png"</span>,
      <span class="prop">"purpose"</span>: <span class="str">"any maskable"</span>
    }
  ],
  <span class="prop">"screenshots"</span>: [
    {
      <span class="prop">"src"</span>: <span class="str">"/screenshots/home.png"</span>,
      <span class="prop">"sizes"</span>: <span class="str">"1280x720"</span>,
      <span class="prop">"type"</span>: <span class="str">"image/png"</span>,
      <span class="prop">"form_factor"</span>: <span class="str">"wide"</span>,
      <span class="prop">"label"</span>: <span class="str">"Home Screen"</span>
    }
  ],
  <span class="prop">"shortcuts"</span>: [
    {
      <span class="prop">"name"</span>: <span class="str">"New Task"</span>,
      <span class="prop">"short_name"</span>: <span class="str">"Task"</span>,
      <span class="prop">"url"</span>: <span class="str">"/new-task"</span>,
      <span class="prop">"icons"</span>: [{ <span class="prop">"src"</span>: <span class="str">"/icons/new-task.png"</span>, <span class="prop">"sizes"</span>: <span class="str">"192x192"</span> }]
    }
  ],
  <span class="prop">"related_applications"</span>: [],
  <span class="prop">"prefer_related_applications"</span>: <span class="bool">false</span>
}</code></pre>
      </div>

      <h3>üîó Linking the Manifest</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>index.html ‚Äî Head Section</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="tag">&lt;head&gt;</span>
  <span class="cm">&lt;!-- Link manifest --&gt;</span>
  <span class="tag">&lt;link</span> <span class="attr">rel</span>=<span class="val">"manifest"</span> <span class="attr">href</span>=<span class="val">"/manifest.json"</span><span class="tag">&gt;</span>

  <span class="cm">&lt;!-- Theme color (matches manifest) --&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">name</span>=<span class="val">"theme-color"</span> <span class="attr">content</span>=<span class="val">"#6c5ce7"</span><span class="tag">&gt;</span>

  <span class="cm">&lt;!-- iOS-specific meta tags (Safari needs these) --&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">name</span>=<span class="val">"apple-mobile-web-app-capable"</span> <span class="attr">content</span>=<span class="val">"yes"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">name</span>=<span class="val">"apple-mobile-web-app-status-bar-style"</span>
        <span class="attr">content</span>=<span class="val">"black-translucent"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attr">name</span>=<span class="val">"apple-mobile-web-app-title"</span> <span class="attr">content</span>=<span class="val">"MyPWA"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;link</span> <span class="attr">rel</span>=<span class="val">"apple-touch-icon"</span> <span class="attr">href</span>=<span class="val">"/icons/icon-192x192.png"</span><span class="tag">&gt;</span>
<span class="tag">&lt;/head&gt;</span></code></pre>
      </div>

      <h3>üì± Display Modes Explained</h3>

      <table class="comparison-table">
        <thead>
          <tr>
            <th>Mode</th>
            <th>Description</th>
            <th>Browser UI</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>fullscreen</code></td>
            <td>Entire screen, no browser UI</td>
            <td>None (like a game)</td>
          </tr>
          <tr>
            <td><code>standalone</code></td>
            <td>Looks like a native app</td>
            <td>No URL bar ‚≠ê Most common</td>
          </tr>
          <tr>
            <td><code>minimal-ui</code></td>
            <td>Minimal browser controls</td>
            <td>Back/reload buttons only</td>
          </tr>
          <tr>
            <td><code>browser</code></td>
            <td>Normal browser tab</td>
            <td>Full browser UI (default)</td>
          </tr>
        </tbody>
      </table>

      <h3>üé® Interactive Manifest Builder</h3>
      <p>Fill in the fields and see the manifest JSON update in real-time:</p>

      <div class="manifest-builder">
        <div class="demo-header">üîß Manifest Generator</div>
        <div class="manifest-fields">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
            <div class="field-group">
              <label>App Name</label>
              <input type="text" id="mf-name" value="My PWA App" oninput="updateManifestPreview()">
            </div>
            <div class="field-group">
              <label>Short Name (‚â§12 chars)</label>
              <input type="text" id="mf-short" value="MyPWA" maxlength="12" oninput="updateManifestPreview()">
            </div>
            <div class="field-group">
              <label>Start URL</label>
              <input type="text" id="mf-start" value="/" oninput="updateManifestPreview()">
            </div>
            <div class="field-group">
              <label>Display Mode</label>
              <select id="mf-display" onchange="updateManifestPreview()">
                <option value="standalone" selected>standalone</option>
                <option value="fullscreen">fullscreen</option>
                <option value="minimal-ui">minimal-ui</option>
                <option value="browser">browser</option>
              </select>
            </div>
            <div class="field-group">
              <label>Theme Color</label>
              <input type="color" id="mf-theme" value="#6c5ce7" oninput="updateManifestPreview()">
            </div>
            <div class="field-group">
              <label>Background Color</label>
              <input type="color" id="mf-bg" value="#ffffff" oninput="updateManifestPreview()">
            </div>
            <div class="field-group" style="grid-column:1/-1">
              <label>Description</label>
              <input type="text" id="mf-desc" value="An awesome progressive web application" oninput="updateManifestPreview()">
            </div>
          </div>
        </div>
        <div class="manifest-preview">
          <div class="code-container" style="margin:0;border:0;border-radius:0">
            <div class="code-header">
              <div class="code-dots"><span></span><span></span><span></span></div>
              <span>Generated manifest.json</span>
              <button class="code-copy" onclick="copyManifest()">Copy</button>
            </div>
            <pre id="manifestOutput" style="min-height:200px"></pre>
          </div>
        </div>
      </div>

      <h3>üì≤ Handling the Install Prompt</h3>

      <div class="code-container">
        <div class="code-header">
          <div class="code-dots"><span></span><span></span><span></span></div>
          <span>Custom Install Button</span>
          <button class="code-copy" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">let</span> deferredPrompt;

<span class="cm">// Capture the install prompt</span>
window.<span class="fn">addEventListener</span>(<span class="str">'beforeinstallprompt'</span>, (e) <span class="op">=></span> {
  e.<span class="fn">preventDefault</span>(); <span class="cm">// Don't show default prompt</span>
  deferredPrompt = e;
  <span class="fn">showInstallButton</span>(); <span class="cm">// Show your custom button</span>
});

<span class="cm">// When user clicks your install button</span>
installBtn.<span class="fn">addEventListener</span>(<span class="str">'click'</span>, <span class="kw">async</span> () <span class="op">=></span> {
  <span class="kw">if</span> (!deferredPrompt) <span class="kw">return</span>;

  deferredPrompt.<span class="fn">prompt</span>(); <span class="cm">// Show the native prompt</span>

  <span class="kw">const</span> { outcome } = <span class="kw">await</span> deferredPrompt.userChoice;
  console.<span class="fn">log</span>(<span class="str">`Install: ${outcome}`</span>);
  <span class="cm">// outcome: 'accepted' or 'dismissed'</span>

  deferredPrompt = <span class="bool">null</span>; <span class="cm">// Can only be used once</span>
  <span class="fn">hideInstallButton</span>();
});

<span class="cm">// Detect when app is installed</span>
window.<span class="fn">addEventListener</span>(<span class="str">'appinstalled'</span>, () <span class="op">=></span> {
  console.<span class="fn">log</span>(<span class="str">'App installed! üéâ'</span>);
  deferredPrompt = <span class="bool">null</span>;
  <span class="cm">// Track installation analytics</span>
});

<span class="cm">// Detect if running as installed PWA</span>
<span class="kw">if</span> (window.<span class="fn">matchMedia</span>(<span class="str">'(display-mode: standalone)'</span>).matches) {
  console.<span class="fn">log</span>(<span class="str">'Running as installed PWA'</span>);
}</code></pre>
      </div>

      <h3>‚úÖ PWA Installability Checklist</h3>
      <p>Click to check off requirements:</p>

      <ul class="checklist" id="pwaChecklist">
        <li onclick="toggleCheck(this)">Served over HTTPS (or localhost)</li>
        <li onclick="toggleCheck(this)">Has a registered service worker with a fetch handler</li>
        <li onclick="toggleCheck(this)">Web app manifest with <code>name</code> or <code>short_name</code></li>
        <li onclick="toggleCheck(this)">Manifest has <code>start_url</code></li>
        <li onclick="toggleCheck(this)">Manifest has <code>display</code> set to standalone, fullscreen, or minimal-ui</li>
        <li onclick="toggleCheck(this)">Manifest has at least one icon (192x192 and 512x512)</li>
        <li onclick="toggleCheck(this)">App has not already been installed</li>
        <li onclick="toggleCheck(this)">iOS: Added apple-touch-icon and apple-mobile-web-app-capable meta tags</li>
      </ul>

      <div class="info-box pitfall">
        <div class="info-box-title">‚ö†Ô∏è Pitfall: iOS Safari Limitations</div>
        <p>Safari on iOS has limited PWA support:</p>
        <ul>
          <li>No <code>beforeinstallprompt</code> event ‚Äî must use "Add to Home Screen" manually</li>
          <li>Service worker storage can be evicted after 7 days of inactivity</li>
          <li>No push notifications (until iOS 16.4+)</li>
          <li>No Background Sync</li>
          <li>Must add iOS-specific meta tags manually</li>
        </ul>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>You know how to make your app installable!</p>
        <button class="btn btn-primary" onclick="completeSection('manifest'); navigateTo('pitfalls')">Continue to Pitfalls & Mistakes ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 7: Pitfalls & Mistakes -->
    <!-- ============================== -->
    <div class="section" id="section-pitfalls">
      <div class="section-badge">Chapter 7</div>
      <h2>Pitfalls & Common Mistakes</h2>
      <p class="section-subtitle">Avoid these traps that catch even experienced developers</p>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #1: Caching Too Aggressively</div>
        <p>Caching your <code>sw.js</code> file or caching everything with no versioning strategy leads to users getting stuck on old versions forever.</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>‚ùå BAD vs ‚úÖ GOOD</span>
          </div>
          <pre><code><span class="cm">// ‚ùå BAD: Caching the service worker itself!</span>
<span class="kw">const</span> <span class="const">ASSETS</span> = [<span class="str">'/'</span>, <span class="str">'/app.js'</span>, <span class="str">'/sw.js'</span>]; <span class="cm">// Never cache sw.js!</span>

<span class="cm">// ‚ùå BAD: No cache versioning</span>
<span class="kw">const</span> <span class="const">CACHE</span> = <span class="str">'my-cache'</span>; <span class="cm">// Same name forever</span>

<span class="cm">// ‚úÖ GOOD: Versioned cache names</span>
<span class="kw">const</span> <span class="const">CACHE</span> = <span class="str">'my-cache-v2'</span>;
<span class="cm">// When you change to v3, old v2 gets cleaned up</span>

<span class="cm">// ‚úÖ GOOD: Set appropriate cache headers for sw.js</span>
<span class="cm">// Server: Cache-Control: max-age=0 for sw.js</span>
<span class="cm">// Browser checks for updates on each navigation</span></code></pre>
        </div>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #2: The "Stuck on Old Version" Problem</div>
        <p>Users open your app, get the old cached version, and never see updates because the SW is waiting.</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>The Fix</span>
          </div>
          <pre><code><span class="cm">// Option 1: Skip waiting (use carefully)</span>
self.<span class="fn">addEventListener</span>(<span class="str">'install'</span>, () <span class="op">=></span> {
  self.<span class="fn">skipWaiting</span>(); <span class="cm">// ‚ö†Ô∏è Can break in-flight requests!</span>
});

<span class="cm">// Option 2: Prompt user (recommended)</span>
<span class="cm">// Show "Update available" banner</span>
<span class="cm">// User clicks "Update" ‚Üí postMessage('SKIP_WAITING')</span>
<span class="cm">// Page reloads with new SW</span>

<span class="cm">// Option 3: Auto-update on navigation</span>
<span class="cm">// Check for updates every time user navigates</span>
navigator.serviceWorker.ready.<span class="fn">then</span>((reg) <span class="op">=></span> {
  reg.<span class="fn">update</span>();
});</code></pre>
        </div>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #3: Not Handling Failed Caching</div>
        <p>If ANY file in <code>cache.addAll()</code> fails to fetch, the entire install fails! The SW becomes redundant.</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>Resilient Caching</span>
          </div>
          <pre><code><span class="cm">// ‚ùå BAD: One failure kills everything</span>
cache.<span class="fn">addAll</span>([
  <span class="str">'/'</span>, <span class="str">'/app.js'</span>, <span class="str">'/missing-image.png'</span> <span class="cm">// 404 ‚Üí install fails!</span>
]);

<span class="cm">// ‚úÖ GOOD: Separate critical and optional assets</span>
<span class="kw">const</span> <span class="const">CRITICAL</span> = [<span class="str">'/'</span>, <span class="str">'/app.js'</span>, <span class="str">'/styles.css'</span>];
<span class="kw">const</span> <span class="const">OPTIONAL</span> = [<span class="str">'/images/hero.jpg'</span>, <span class="str">'/fonts/custom.woff2'</span>];

event.<span class="fn">waitUntil</span>(
  caches.<span class="fn">open</span>(<span class="const">CACHE</span>).<span class="fn">then</span>(<span class="kw">async</span> (cache) <span class="op">=></span> {
    <span class="cm">// Critical assets must succeed</span>
    <span class="kw">await</span> cache.<span class="fn">addAll</span>(<span class="const">CRITICAL</span>);
    <span class="cm">// Optional assets can fail silently</span>
    <span class="kw">for</span> (<span class="kw">const</span> <span class="const">url</span> <span class="kw">of</span> <span class="const">OPTIONAL</span>) {
      cache.<span class="fn">add</span>(url).<span class="fn">catch</span>(() <span class="op">=></span> {
        console.<span class="fn">warn</span>(<span class="str">`Optional: ${url} not cached`</span>);
      });
    }
  })
);</code></pre>
        </div>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #4: Serving Opaque Responses</div>
        <p>Cross-origin requests without CORS return <strong>opaque responses</strong> (status 0). Caching them wastes up to <strong>7MB each</strong> due to padding!</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>Handle Opaque Responses</span>
          </div>
          <pre><code><span class="cm">// ‚úÖ Only cache successful responses</span>
self.<span class="fn">addEventListener</span>(<span class="str">'fetch'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">respondWith</span>(
    <span class="fn">fetch</span>(event.request).<span class="fn">then</span>((response) <span class="op">=></span> {
      <span class="cm">// Only cache successful, same-origin responses</span>
      <span class="kw">if</span> (!response || response.status !== <span class="num">200</span>
          || response.type !== <span class="str">'basic'</span>) {
        <span class="kw">return</span> response;
      }
      <span class="kw">const</span> <span class="const">clone</span> = response.<span class="fn">clone</span>();
      caches.<span class="fn">open</span>(<span class="const">CACHE</span>).<span class="fn">then</span>(c <span class="op">=></span> c.<span class="fn">put</span>(event.request, clone));
      <span class="kw">return</span> response;
    })
  );
});</code></pre>
        </div>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #5: Not Cleaning Up Old Caches</div>
        <p>If you never delete old cache versions, storage grows indefinitely. Browsers may evict your data!</p>
        <div class="code-container" style="margin-top:8px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>Always Clean Up in Activate</span>
          </div>
          <pre><code><span class="kw">const</span> <span class="const">CURRENT_CACHES</span> = [<span class="str">'static-v3'</span>, <span class="str">'dynamic-v2'</span>, <span class="str">'images-v1'</span>];

self.<span class="fn">addEventListener</span>(<span class="str">'activate'</span>, (event) <span class="op">=></span> {
  event.<span class="fn">waitUntil</span>(
    caches.<span class="fn">keys</span>().<span class="fn">then</span>((cacheNames) <span class="op">=></span> {
      <span class="kw">return</span> Promise.<span class="fn">all</span>(
        cacheNames
          .<span class="fn">filter</span>(name <span class="op">=></span> !<span class="const">CURRENT_CACHES</span>.<span class="fn">includes</span>(name))
          .<span class="fn">map</span>(name <span class="op">=></span> {
            console.<span class="fn">log</span>(<span class="str">`Deleting old cache: ${name}`</span>);
            <span class="kw">return</span> caches.<span class="fn">delete</span>(name);
          })
      );
    })
  );
});</code></pre>
        </div>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #6: Ignoring the scope</div>
        <p>If your <code>start_url</code> in the manifest is outside the service worker's scope, your app won't work as expected when installed.</p>
      </div>

      <div class="info-box warning">
        <div class="info-box-title">üö® Pitfall #7: Testing Only Online</div>
        <p>Always test your PWA with:</p>
        <ul>
          <li>DevTools ‚Üí Network tab ‚Üí "Offline" checkbox</li>
          <li>DevTools ‚Üí Application tab ‚Üí Service Workers</li>
          <li>Lighthouse PWA audit</li>
          <li>Slow 3G throttling</li>
          <li>Multiple tabs open (update scenarios)</li>
        </ul>
      </div>

      <h3>üõ†Ô∏è Debugging Tips</h3>

      <div class="card">
        <h4 style="margin-top:0;color:var(--secondary)">Chrome DevTools ‚Äî Application Tab</h4>
        <ul>
          <li><strong>Service Workers</strong> ‚Äî See status, update, unregister, offline simulation</li>
          <li><strong>Cache Storage</strong> ‚Äî Browse all cached resources</li>
          <li><strong>Manifest</strong> ‚Äî Validate your manifest file</li>
          <li><strong>Storage</strong> ‚Äî See total storage usage</li>
        </ul>

        <div class="code-container" style="margin-top:16px">
          <div class="code-header">
            <div class="code-dots"><span></span><span></span><span></span></div>
            <span>Useful Debug Code</span>
          </div>
          <pre><code><span class="cm">// See all cached resources</span>
<span class="kw">async function</span> <span class="fn">debugCache</span>() {
  <span class="kw">const</span> <span class="const">names</span> = <span class="kw">await</span> caches.<span class="fn">keys</span>();
  <span class="kw">for</span> (<span class="kw">const</span> <span class="const">name</span> <span class="kw">of</span> names) {
    <span class="kw">const</span> <span class="const">cache</span> = <span class="kw">await</span> caches.<span class="fn">open</span>(name);
    <span class="kw">const</span> <span class="const">keys</span> = <span class="kw">await</span> cache.<span class="fn">keys</span>();
    console.<span class="fn">group</span>(<span class="str">`Cache: ${name} (${keys.length} items)`</span>);
    keys.<span class="fn">forEach</span>(k <span class="op">=></span> console.<span class="fn">log</span>(k.url));
    console.<span class="fn">groupEnd</span>();
  }
}

<span class="cm">// Check storage quota</span>
<span class="kw">async function</span> <span class="fn">checkStorage</span>() {
  <span class="kw">if</span> (<span class="str">'storage'</span> <span class="kw">in</span> navigator && <span class="str">'estimate'</span> <span class="kw">in</span> navigator.storage) {
    <span class="kw">const</span> { usage, quota } = <span class="kw">await</span> navigator.storage.<span class="fn">estimate</span>();
    console.<span class="fn">log</span>(<span class="str">`Using ${(usage / <span class="num">1024</span> / <span class="num">1024</span>).toFixed(2)} MB`</span>);
    console.<span class="fn">log</span>(<span class="str">`Quota: ${(quota / <span class="num">1024</span> / <span class="num">1024</span>).toFixed(2)} MB`</span>);
  }
}

<span class="cm">// Unregister all service workers (nuclear option)</span>
<span class="kw">async function</span> <span class="fn">nukeSW</span>() {
  <span class="kw">const</span> <span class="const">regs</span> = <span class="kw">await</span> navigator.serviceWorker.<span class="fn">getRegistrations</span>();
  <span class="kw">for</span> (<span class="kw">const</span> <span class="const">reg</span> <span class="kw">of</span> regs) {
    <span class="kw">await</span> reg.<span class="fn">unregister</span>();
  }
  <span class="kw">const</span> <span class="const">cacheNames</span> = <span class="kw">await</span> caches.<span class="fn">keys</span>();
  <span class="kw">for</span> (<span class="kw">const</span> <span class="const">name</span> <span class="kw">of</span> cacheNames) {
    <span class="kw">await</span> caches.<span class="fn">delete</span>(name);
  }
  console.<span class="fn">log</span>(<span class="str">'All SWs and caches nuked!'</span>);
  window.location.<span class="fn">reload</span>();
}</code></pre>
        </div>
      </div>

      <div class="section-complete-banner">
        <h3>‚úÖ Section Complete!</h3>
        <p>You know the traps to avoid ‚Äî you're ahead of most developers!</p>
        <button class="btn btn-primary" onclick="completeSection('pitfalls'); navigateTo('quiz-final')">Take the Final Challenge ‚Üí</button>
      </div>
    </div>

    <!-- ============================== -->
    <!-- SECTION 8: Final Challenge -->
    <!-- ============================== -->
    <div class="section" id="section-quiz-final">
      <div class="section-badge">Final Challenge</div>
      <h2>üèÜ PWA Mastery Challenge</h2>
      <p class="section-subtitle">Test everything you've learned ‚Äî 10 questions</p>

      <div class="quiz-container" id="finalQuiz">
        <div class="quiz-header">
          <span>üèÜ Final Challenge</span>
          <div class="quiz-progress-dots" id="finalQuizDots"></div>
        </div>
        <div class="quiz-body" id="finalQuizBody">
          <!-- Populated by JS -->
        </div>
        <div class="quiz-actions" id="finalQuizActions">
          <div class="quiz-score" id="finalQuizScore">Question 1 of 10</div>
          <button class="btn btn-primary" id="finalQuizNext" onclick="nextFinalQuestion()" disabled>Next Question ‚Üí</button>
        </div>
      </div>

      <div id="finalResults" style="display:none">
        <div class="finish-screen">
          <div class="finish-trophy">üèÜ</div>
          <div class="finish-title" id="finishTitle">Congratulations!</div>
          <p id="finishSubtitle" style="color:var(--text-dim);font-size:1.1rem"></p>

          <div class="finish-stats">
            <div class="stat-card">
              <div class="stat-value" id="finalScoreValue">0/10</div>
              <div class="stat-label">Correct Answers</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="finalXPValue">0</div>
              <div class="stat-label">XP Earned</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="finalGrade">-</div>
              <div class="stat-label">Grade</div>
            </div>
          </div>

          <button class="btn btn-primary" onclick="resetFinalQuiz()" style="margin-top:20px">Retry Challenge</button>
          <button class="btn btn-secondary" onclick="completeSection('quiz-final'); showCompletionScreen()" style="margin-top:20px;margin-left:10px">Complete Course üéì</button>
        </div>
      </div>

      <div id="courseComplete" style="display:none">
        <div class="finish-screen">
          <div class="finish-trophy">üéì</div>
          <div class="finish-title">Course Complete!</div>
          <p style="color:var(--text-dim);font-size:1.1rem">You've mastered Progressive Web Apps!</p>
          <div class="finish-stats">
            <div class="stat-card">
              <div class="stat-value" id="totalXP">0</div>
              <div class="stat-label">Total XP</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="completedSections">0/8</div>
              <div class="stat-label">Sections</div>
            </div>
          </div>
          <div class="card" style="text-align:left;margin-top:24px">
            <h4 style="margin-top:0">üìö Next Steps</h4>
            <ul>
              <li>Build a real PWA project from scratch</li>
              <li>Explore <strong>Workbox</strong> ‚Äî Google's SW library</li>
              <li>Learn about <strong>Push Notifications</strong> in depth</li>
              <li>Study the <strong>Web Share API</strong> and other PWA APIs</li>
              <li>Run Lighthouse audits on your projects</li>
              <li>Deploy a PWA and test installation on real devices</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
// ============================================================
// STATE MANAGEMENT
// ============================================================
const state = {
  currentSection: 'intro',
  completedSections: new Set(),
  xp: 0,
  streak: 0,
  quizAnswered: new Set(),
  simCache: new Map(),
  finalQuiz: {
    current: 0,
    correct: 0,
    answered: false
  }
};

// ============================================================
// PARTICLES
// ============================================================
function createParticles() {
  const container = document.getElementById('particles');
  const colors = ['#6c5ce7', '#00cec9', '#fd79a8', '#fdcb6e'];
  for (let i = 0; i < 25; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = Math.random() * 6 + 2;
    p.style.width = size + 'px';
    p.style.height = size + 'px';
    p.style.left = Math.random() * 100 + '%';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.animationDuration = (Math.random() * 15 + 10) + 's';
    p.style.animationDelay = (Math.random() * 10) + 's';
    container.appendChild(p);
  }
}
createParticles();

// ============================================================
// NAVIGATION
// ============================================================
function navigateTo(sectionId) {
  state.currentSection = sectionId;

  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const target = document.getElementById('section-' + sectionId);
  if (target) target.classList.add('active');

  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
  if (navItem) navItem.classList.add('active');

  window.scrollTo({ top: 0, behavior: 'smooth' });
  closeSidebar();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
}

// ============================================================
// PROGRESS & XP
// ============================================================
function completeSection(sectionId) {
  if (state.completedSections.has(sectionId)) return;

  state.completedSections.add(sectionId);
  state.streak++;
  addXP(50);

  const navItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
  if (navItem) {
    navItem.classList.add('completed');
    const check = navItem.querySelector('.nav-check');
    if (check) check.style.display = 'inline';
  }

  updateProgress();
}

function updateProgress() {
  const total = 8;
  const completed = state.completedSections.size;
  const percent = Math.round((completed / total) * 100);

  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressPercent').textContent = percent + '%';
  document.getElementById('streakBadge').textContent = 'üî• ' + state.streak;
}

function addXP(amount) {
  state.xp += amount;
  document.getElementById('xpDisplay').textContent = state.xp + ' XP';
  showXPPopup(amount);
}

function showXPPopup(amount) {
  const popup = document.createElement('div');
  popup.className = 'xp-popup';
  popup.textContent = `+${amount} XP ‚ö°`;
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 2000);
}

// ============================================================
// QUIZ SYSTEM
// ============================================================
function checkQuizAnswer(element, isCorrect, explanationId) {
  if (element.classList.contains('disabled')) return;

  const quizId = element.closest('.quiz-container')?.id || 'generic';
  if (state.quizAnswered.has(quizId + explanationId)) return;
  state.quizAnswered.add(quizId + explanationId);

  const options = element.parentElement.querySelectorAll('.quiz-option');
  options.forEach(opt => opt.classList.add('disabled'));

  if (isCorrect) {
    element.classList.add('correct');
    addXP(25);
    const exp = document.getElementById(explanationId);
    if (exp) {
      exp.classList.add('visible', 'correct-exp');
    }
  } else {
    element.classList.add('wrong');
    options.forEach(opt => {
      if (!opt.classList.contains('wrong')) {
        // Find the correct one
      }
    });
    const exp = document.getElementById(explanationId);
    if (exp) {
      exp.classList.add('visible', 'wrong-exp');
      exp.innerHTML = `<strong>Not quite! üòï</strong> ` + exp.innerHTML.replace(/<strong>.*?<\/strong>\s*/, '');
    }
  }
}

// ============================================================
// CODE COPY
// ============================================================
function copyCode(btn) {
  const container = btn.closest('.code-container');
  const code = container.querySelector('pre').textContent;
  navigator.clipboard.writeText(code).then(() => {
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.color = 'var(--success)';
    btn.style.borderColor = 'var(--success)';
    setTimeout(() => {
      btn.textContent = original;
      btn.style.color = '';
      btn.style.borderColor = '';
    }, 2000);
  });
}

function copyManifest() {
  const pre = document.getElementById('manifestOutput');
  navigator.clipboard.writeText(pre.textContent).then(() => {
    showXPPopup(5);
  });
}

// ============================================================
// DEMO: SW REGISTRATION
// ============================================================
function addLogLine(containerId, message, type = 'info') {
  const container = document.getElementById(containerId);
  if (container.querySelector('.log-line:only-child')?.style.color) {
    container.innerHTML = '';
  }
  const line = document.createElement('div');
  line.className = 'log-line';
  const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  line.innerHTML = `
    <span class="log-time">${time}</span>
    <span class="log-type ${type}">${type.toUpperCase()}</span>
    <span>${message}</span>
  `;
  container.appendChild(line);
  container.scrollTop = container.scrollHeight;
}

function clearDemoLog(id) {
  document.getElementById(id).innerHTML = '<div class="log-line" style="color:var(--text-dim)">Log cleared. Ready for new simulation...</div>';
}

async function simulateSWRegistration() {
  const log = 'sw-reg-log';
  addLogLine(log, 'Checking for Service Worker support...', 'info');
  await delay(500);
  addLogLine(log, '‚úÖ "serviceWorker" found in navigator', 'success');
  await delay(400);
  addLogLine(log, 'Calling navigator.serviceWorker.register("/sw.js")...', 'info');
  await delay(800);
  addLogLine(log, 'Browser downloading sw.js...', 'info');
  await delay(600);
  addLogLine(log, 'sw.js parsed successfully, no syntax errors', 'success');
  await delay(300);
  addLogLine(log, 'üì¶ Install event fired in service worker', 'info');
  await delay(500);
  addLogLine(log, 'Opening cache "my-app-v1"...', 'info');
  await delay(400);
  addLogLine(log, 'Caching: /, /index.html, /styles.css, /app.js', 'info');
  await delay(700);
  addLogLine(log, '‚úÖ All assets cached successfully', 'success');
  await delay(300);
  addLogLine(log, '‚ö° Activate event fired', 'info');
  await delay(400);
  addLogLine(log, 'Cleaning old caches... none found', 'info');
  await delay(300);
  addLogLine(log, '‚úÖ Service Worker activated and controlling the page!', 'success');
  addLogLine(log, 'üéâ Registration complete! Scope: "/"', 'success');
  addXP(10);
}

async function simulateSWUpdate() {
  const log = 'sw-reg-log';
  addLogLine(log, 'üîÑ Checking for SW updates...', 'info');
  await delay(600);
  addLogLine(log, 'Browser found byte-difference in sw.js', 'warn');
  await delay(400);
  addLogLine(log, 'New SW downloading...', 'info');
  await delay(500);
  addLogLine(log, 'üì¶ New SW Install event fired', 'info');
  await delay(600);
  addLogLine(log, 'Caching new assets in "my-app-v2"', 'info');
  await delay(500);
  addLogLine(log, '‚è≥ New SW in WAITING state ‚Äî old SW still active', 'warn');
  addLogLine(log, 'New SW will activate when all tabs are closed', 'warn');
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ============================================================
// LIFECYCLE DIAGRAM
// ============================================================
function showLifecycleDetail(stage) {
  document.querySelectorAll('.lifecycle-node').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.lifecycle-detail').forEach(d => d.classList.remove('visible'));

  document.getElementById('lc-' + stage)?.classList.add('active');
  document.getElementById('lc-detail-' + stage)?.classList.add('visible');
}

// ============================================================
// LIFECYCLE SIMULATION
// ============================================================
async function simulateLifecycle(scenario) {
  const log = 'lifecycle-log';
  clearDemoLog(log);

  if (scenario === 'fresh') {
    addLogLine(log, 'üöÄ === FRESH INSTALL SCENARIO ===', 'info');
    await delay(500);
    addLogLine(log, '1. register() called ‚Üí Browser downloads sw.js', 'info');
    await delay(600);
    addLogLine(log, '2. SW parsed ‚Üí No existing SW found', 'info');
    await delay(500);
    addLogLine(log, '3. State: INSTALLING ‚Üí install event fires', 'info');
    await delay(700);
    addLogLine(log, '   ‚Üí Pre-caching assets with cache.addAll()', 'info');
    await delay(600);
    addLogLine(log, '   ‚Üí All assets cached ‚úÖ', 'success');
    await delay(500);
    addLogLine(log, '4. State: INSTALLED ‚Üí No old SW, skip waiting', 'success');
    await delay(400);
    addLogLine(log, '5. State: ACTIVATING ‚Üí activate event fires', 'info');
    await delay(500);
    addLogLine(log, '   ‚Üí No old caches to clean', 'info');
    await delay(400);
    addLogLine(log, '6. State: ACTIVATED ‚Üí Ready for fetch events! üéâ', 'success');
    addXP(10);
  } else if (scenario === 'update') {
    addLogLine(log, 'üîÑ === UPDATE SCENARIO ===', 'info');
    await delay(500);
    addLogLine(log, '1. Browser checks sw.js ‚Üí byte difference found', 'warn');
    await delay(600);
    addLogLine(log, '2. New SW downloaded and parsed', 'info');
    await delay(500);
    addLogLine(log, '3. New SW State: INSTALLING ‚Üí install event fires', 'info');
    await delay(600);
    addLogLine(log, '   ‚Üí Caching new assets in "app-v2"', 'info');
    await delay(700);
    addLogLine(log, '4. New SW State: INSTALLED', 'success');
    await delay(400);
    addLogLine(log, '‚è≥ Old SW is still ACTIVATED and controlling pages', 'warn');
    await delay(500);
    addLogLine(log, '5. New SW State: WAITING ‚Üê stuck here!', 'warn');
    await delay(600);
    addLogLine(log, '   ‚Üí Will not activate until ALL tabs are closed', 'warn');
    await delay(500);
    addLogLine(log, '   ‚Üí Or call self.skipWaiting()', 'info');
    addXP(10);
  } else if (scenario === 'skipWaiting') {
    addLogLine(log, '‚ö° === SKIP WAITING SCENARIO ===', 'info');
    await delay(500);
    addLogLine(log, '1. New SW calls self.skipWaiting()', 'info');
    await delay(600);
    addLogLine(log, '2. New SW immediately goes to ACTIVATING', 'success');
    await delay(500);
    addLogLine(log, '3. activate event fires ‚Üí cleaning old caches', 'info');
    await delay(400);
    addLogLine(log, '   ‚Üí Deleted cache "app-v1" ‚úÖ', 'success');
    await delay(500);
    addLogLine(log, '4. clients.claim() ‚Üí Taking control NOW', 'info');
    await delay(400);
    addLogLine(log, '5. New SW is ACTIVATED and controlling all tabs!', 'success');
    await delay(300);
    addLogLine(log, '‚ö†Ô∏è Warning: In-flight requests may get mixed responses', 'warn');
    addXP(10);
  }
}

// ============================================================
// CACHING STRATEGY SIMULATOR
// ============================================================
let simRequestCount = 0;

function simulateCacheStrategy(isOnline) {
  const strategy = document.getElementById('strategySelect').value;
  const log = 'cache-sim-log';
  simRequestCount++;
  const resource = `/api/data-${simRequestCount}`;

  addLogLine(log, `üì± Request #${simRequestCount}: GET ${resource} [${isOnline ? 'üü¢ Online' : 'üî¥ Offline'}]`, 'info');

  if (strategy === 'cache-first') {
    if (state.simCache.has(resource)) {
      addLogLine(log, `üíæ Cache HIT ‚Üí Returning cached response (instant)`, 'success');
    } else if (isOnline) {
      addLogLine(log, `üíæ Cache MISS ‚Üí Fetching from network...`, 'warn');
      state.simCache.set(resource, `Response for ${resource}`);
      addLogLine(log, `üåê Network ‚Üí Got response ‚Üí Cached for next time`, 'success');
    } else {
      addLogLine(log, `üíæ Cache MISS + üî¥ Offline ‚Üí REQUEST FAILED!`, 'error');
    }
  } else if (strategy === 'network-first') {
    if (isOnline) {
      addLogLine(log, `üåê Network ‚Üí Got fresh response`, 'success');
      state.simCache.set(resource, `Response for ${resource}`);
      addLogLine(log, `üíæ Updated cache with fresh response`, 'info');
    } else if (state.simCache.has(resource)) {
      addLogLine(log, `üî¥ Network failed ‚Üí üíæ Cache HIT ‚Üí Serving stale`, 'warn');
    } else {
      addLogLine(log, `üî¥ Network failed + üíæ Cache MISS ‚Üí FAILED!`, 'error');
    }
  } else if (strategy === 'stale-while-revalidate') {
    if (state.simCache.has(resource)) {
      addLogLine(log, `üíæ Cache HIT ‚Üí Returning cached immediately`, 'success');
      if (isOnline) {
        addLogLine(log, `üîÑ Background: Fetching fresh copy...`, 'info');
        addLogLine(log, `üíæ Background: Cache updated with fresh data`, 'info');
      }
    } else if (isOnline) {
      addLogLine(log, `üíæ Cache MISS ‚Üí Fetching from network...`, 'warn');
      state.simCache.set(resource, `Response for ${resource}`);
      addLogLine(log, `üåê Network ‚Üí Got response ‚Üí Cached`, 'success');
    } else {
      addLogLine(log, `üíæ Cache MISS + üî¥ Offline ‚Üí FAILED!`, 'error');
    }
  }
}

function clearSimCache() {
  state.simCache.clear();
  simRequestCount = 0;
  addLogLine('cache-sim-log', 'üóëÔ∏è Cache cleared! All entries removed.', 'warn');
}

// ============================================================
// STRATEGY CARDS
// ============================================================
function toggleStrategy(card, id) {
  const wasExpanded = card.classList.contains('expanded');

  document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('expanded'));

  if (!wasExpanded) {
    card.classList.add('expanded');
  }
}

// ============================================================
// EXERCISES
// ============================================================
function checkExercise1() {
  const code = document.getElementById('exercise-sw-reg').value;
  const result = document.getElementById('exercise-sw-reg-result');

  const checks = [
    { test: /serviceWorker/.test(code) && /navigator/.test(code), msg: '‚úÖ Checks for serviceWorker in navigator' },
    { test: /register/.test(code), msg: '‚úÖ Calls register()' },
    { test: /service-worker\.js/.test(code), msg: '‚úÖ Correct file path' },
    { test: /scope/.test(code) && /\/app\//.test(code), msg: '‚úÖ Sets scope to /app/' },
    { test: /async|await/.test(code), msg: '‚úÖ Uses async/await' },
    { test: /try/.test(code) && /catch/.test(code), msg: '‚úÖ Has try/catch error handling' },
  ];

  const passed = checks.filter(c => c.test);
  const failed = checks.filter(c => !c.test);

  let html = `<strong>${passed.length}/${checks.length} checks passed</strong><br><br>`;
  html += passed.map(c => c.msg).join('<br>');
  if (failed.length) {
    html += '<br><br><strong style="color:var(--danger)">Missing:</strong><br>';
    html += failed.map(c => '‚ùå ' + c.msg.replace('‚úÖ ', '')).join('<br>');
  }

  result.innerHTML = html;
  result.className = 'exercise-result visible ' + (passed.length >= 5 ? 'pass' : 'fail');

  if (passed.length >= 5) addXP(30);
}

function showSolution1() {
  document.getElementById('exercise-sw-reg').value = `if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const registration = await navigator.serviceWorker
        .register('/service-worker.js', {
          scope: '/app/'
        });
      console.log('SW registered!', registration.scope);
    } catch (error) {
      console.error('SW registration failed:', error);
    }
  });
}`;
}

function checkExercise2() {
  const code = document.getElementById('exercise-offline').value;
  const result = document.getElementById('exercise-offline-result');

  const checks = [
    { test: /async/.test(code), msg: '‚úÖ Uses async function' },
    { test: /fetch/.test(code), msg: '‚úÖ Uses fetch()' },
    { test: /caches/.test(code) && /match/.test(code), msg: '‚úÖ Checks Cache API' },
    { test: /try/.test(code) && /catch/.test(code), msg: '‚úÖ Has error handling' },
    { test: /queue|pending|store/i.test(code), msg: '‚úÖ Has queue mechanism' },
  ];

  const passed = checks.filter(c => c.test);
  let html = `<strong>${passed.length}/${checks.length} checks passed</strong><br><br>`;
  html += passed.map(c => c.msg).join('<br>');

  result.innerHTML = html;
  result.className = 'exercise-result visible ' + (passed.length >= 4 ? 'pass' : 'fail');

  if (passed.length >= 4) addXP(30);
}

function showSolution2() {
  document.getElementById('exercise-offline').value = `const pendingQueue = [];

async function offlineFetch(url, options = {}) {
  try {
    // Try network first
    const response = await fetch(url, options);
    
    // Cache successful GET responses
    if (options.method === undefined || options.method === 'GET') {
      const cache = await caches.open('offline-v1');
      cache.put(url, response.clone());
    }
    
    return response;
  } catch (error) {
    // Network failed ‚Äî try cache
    const cached = await caches.match(url);
    if (cached) {
      console.log('Serving from cache:', url);
      return cached;
    }
    
    // Nothing in cache ‚Äî queue for later
    pendingQueue.push({ url, options, timestamp: Date.now() });
    console.log('Queued for later sync:', url);
    
    return new Response(
      JSON.stringify({ error: 'offline', queued: true }),
      { status: 503, headers: { 'Content-Type': 'application/json' } }
    );
  }
}`;
}

function showHint(exerciseId) {
  const editor = document.getElementById(exerciseId);
  if (exerciseId === 'exercise-sw-reg') {
    editor.value = `// Start with checking for support
if ('serviceWorker' in navigator) {
  // Use window 'load' event
  // Inside: use async/await with try/catch
  // Call navigator.serviceWorker.register(path, { scope })
}`;
  }
}

// ============================================================
// MANIFEST BUILDER
// ============================================================
function updateManifestPreview() {
  const manifest = {
    name: document.getElementById('mf-name').value,
    short_name: document.getElementById('mf-short').value,
    description: document.getElementById('mf-desc').value,
    start_url: document.getElementById('mf-start').value,
    display: document.getElementById('mf-display').value,
    background_color: document.getElementById('mf-bg').value,
    theme_color: document.getElementById('mf-theme').value,
    icons: [
      { src: '/icons/icon-192x192.png', sizes: '192x192', type: 'image/png' },
      { src: '/icons/icon-512x512.png', sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
    ]
  };

  const json = JSON.stringify(manifest, null, 2);
  const highlighted = json
    .replace(/"([^"]+)":/g, '<span class="prop">"$1"</span>:')
    .replace(/: "([^"]+)"/g, ': <span class="str">"$1"</span>')
    .replace(/: (\d+)/g, ': <span class="num">$1</span>');

  document.getElementById('manifestOutput').innerHTML = highlighted;
}

updateManifestPreview();

// ============================================================
// CHECKLIST
// ============================================================
function toggleCheck(li) {
  li.classList.toggle('checked');
  const checked = document.querySelectorAll('#pwaChecklist li.checked').length;
  if (checked === 8) addXP(20);
}

// ============================================================
// ONLINE STATUS
// ============================================================
function updateOnlineStatus() {
  const el = document.getElementById('onlineStatus');
  if (navigator.onLine) {
    el.innerHTML = '<div style="width:12px;height:12px;border-radius:50%;background:var(--success);animation:pulse 2s infinite"></div><span style="font-weight:600">Online</span>';
    el.style.background = 'rgba(0,184,148,0.15)';
    el.style.borderColor = 'rgba(0,184,148,0.3)';
  } else {
    el.innerHTML = '<div style="width:12px;height:12px;border-radius:50%;background:var(--danger);animation:pulse 1s infinite"></div><span style="font-weight:600">Offline</span>';
    el.style.background = 'rgba(214,48,49,0.15)';
    el.style.borderColor = 'rgba(214,48,49,0.3)';
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// ============================================================
// FINAL QUIZ
// ============================================================
const finalQuestions = [
  {
    q: 'What is the PRIMARY purpose of a service worker?',
    options: [
      'To speed up JavaScript execution',
      'To act as a programmable network proxy between the app and the network',
      'To provide server-side rendering',
      'To compile TypeScript to JavaScript'
    ],
    correct: 1,
    explanation: 'Service workers act as a programmable network proxy, intercepting requests and deciding how to respond ‚Äî from cache, network, or a combination.'
  },
  {
    q: 'Which API can a service worker NOT access?',
    options: [
      'Cache API',
      'Fetch API',
      'DOM (document object)',
      'IndexedDB'
    ],
    correct: 2,
    explanation: 'Service workers run in a separate thread and have NO access to the DOM. They cannot access document, window, or any DOM APIs.'
  },
  {
    q: 'What happens if one file in <code>cache.addAll()</code> fails to fetch?',
    options: [
      'Other files are still cached successfully',
      'The failed file is skipped silently',
      'The entire caching operation fails and the SW becomes redundant',
      'The browser retries automatically'
    ],
    correct: 2,
    explanation: 'cache.addAll() is all-or-nothing. If ANY file fails, the promise rejects, the install event fails, and the service worker becomes redundant.'
  },
  {
    q: 'A new service worker is installed but an old one is still active. What must happen for the new SW to activate?',
    options: [
      'The page must be refreshed',
      'All tabs controlled by the old SW must be closed (or skipWaiting is called)',
      'The browser cache must be cleared',
      'The server must restart'
    ],
    correct: 1,
    explanation: 'The new SW waits until all clients (tabs) controlled by the old SW are closed. Alternatively, calling self.skipWaiting() bypasses this.'
  },
  {
    q: 'Which caching strategy returns the cached version immediately AND updates the cache in the background?',
    options: [
      'Cache First',
      'Network First',
      'Stale While Revalidate',
      'Cache Only'
    ],
    correct: 2,
    explanation: 'Stale While Revalidate returns the cached response instantly for speed, while fetching a fresh copy from the network to update the cache for next time.'
  },
  {
    q: 'Why must you call <code>response.clone()</code> before caching a response?',
    options: [
      'To convert it to JSON',
      'Because response bodies are streams that can only be read once',
      'To remove CORS headers',
      'To compress the response'
    ],
    correct: 1,
    explanation: 'Response bodies are streams. Once read (consumed), they cannot be read again. Cloning creates a copy so you can both cache it AND return it to the page.'
  },
  {
    q: 'What is the <code>display: "standalone"</code> manifest property?',
    options: [
      'It runs the app in a separate process',
      'It makes the app look like a native app with no browser UI',
      'It prevents the app from being indexed',
      'It enables full-screen mode'
    ],
    correct: 1,
    explanation: 'standalone display mode makes the PWA look like a native app ‚Äî no URL bar or browser navigation. This is the most commonly used display mode for PWAs.'
  },
  {
    q: 'What does <code>event.waitUntil(promise)</code> do in a service worker?',
    options: [
      'Delays the page load until the promise resolves',
      'Tells the browser to keep the SW alive until the promise settles',
      'Pauses JavaScript execution',
      'Queues the event for later processing'
    ],
    correct: 1,
    explanation: 'event.waitUntil() extends the lifetime of the event (install/activate) and prevents the browser from terminating the SW until the promise resolves or rejects.'
  },
  {
    q: 'What is the purpose of <code>clients.claim()</code> in the activate event?',
    options: [
      'To claim storage quota from the browser',
      'To take control of all open pages immediately without waiting for navigation',
      'To register push notification permissions',
      'To claim ownership of the cache'
    ],
    correct: 1,
    explanation: 'clients.claim() makes the newly activated service worker take control of all open pages in its scope immediately, without waiting for them to navigate.'
  },
  {
    q: 'Which of these is a REAL limitation of PWAs on iOS Safari?',
    options: [
      'Service workers don\'t work at all on iOS',
      'PWAs cannot use localStorage on iOS',
      'SW storage may be evicted after 7 days of inactivity',
      'iOS doesn\'t support the Cache API'
    ],
    correct: 2,
    explanation: 'iOS Safari has a controversial policy where service worker registrations and cached data can be evicted after approximately 7 days if the user doesn\'t interact with the PWA.'
  }
];

function initFinalQuiz() {
  const dotsContainer = document.getElementById('finalQuizDots');
  dotsContainer.innerHTML = '';
  for (let i = 0; i < finalQuestions.length; i++) {
    const dot = document.createElement('div');
    dot.className = 'quiz-dot' + (i === 0 ? ' current' : '');
    dotsContainer.appendChild(dot);
  }
  renderFinalQuestion();
}

function renderFinalQuestion() {
  const q = finalQuestions[state.finalQuiz.current];
  const body = document.getElementById('finalQuizBody');

  let html = `<div class="quiz-question">${q.q}</div><div class="quiz-options">`;
  const letters = ['A', 'B', 'C', 'D'];
  q.options.forEach((opt, i) => {
    html += `<div class="quiz-option" onclick="answerFinal(this, ${i})">
      <span class="option-letter">${letters[i]}</span>
      <span>${opt}</span>
    </div>`;
  });
  html += `</div>`;
  html += `<div class="quiz-explanation" id="finalExp">${q.explanation}</div>`;

  body.innerHTML = html;
  document.getElementById('finalQuizScore').textContent = `Question ${state.finalQuiz.current + 1} of ${finalQuestions.length}`;
  document.getElementById('finalQuizNext').disabled = true;
  state.finalQuiz.answered = false;
}

function answerFinal(element, index) {
  if (state.finalQuiz.answered) return;
  state.finalQuiz.answered = true;

  const q = finalQuestions[state.finalQuiz.current];
  const options = element.parentElement.querySelectorAll('.quiz-option');
  options.forEach(opt => opt.classList.add('disabled'));

  const dots = document.querySelectorAll('#finalQuizDots .quiz-dot');
  const exp = document.getElementById('finalExp');

  if (index === q.correct) {
    element.classList.add('correct');
    options[q.correct].classList.add('correct');
    dots[state.finalQuiz.current].classList.add('correct');
    state.finalQuiz.correct++;
    addXP(15);
    exp.classList.add('visible', 'correct-exp');
    exp.innerHTML = `<strong>Correct! üéâ</strong> ${q.explanation}`;
  } else {
    element.classList.add('wrong');
    options[q.correct].classList.add('correct');
    dots[state.finalQuiz.current].classList.add('wrong');
    exp.classList.add('visible', 'wrong-exp');
    exp.innerHTML = `<strong>Not quite! üòï</strong> ${q.explanation}`;
  }

  const nextBtn = document.getElementById('finalQuizNext');
  nextBtn.disabled = false;
  if (state.finalQuiz.current === finalQuestions.length - 1) {
    nextBtn.textContent = 'See Results üèÜ';
  }
}

function nextFinalQuestion() {
  state.finalQuiz.current++;

  if (state.finalQuiz.current >= finalQuestions.length) {
    showFinalResults();
    return;
  }

  const dots = document.querySelectorAll('#finalQuizDots .quiz-dot');
  dots.forEach(d => d.classList.remove('current'));
  dots[state.finalQuiz.current].classList.add('current');

  renderFinalQuestion();
}

function showFinalResults() {
  document.getElementById('finalQuiz').style.display = 'none';
  document.getElementById('finalResults').style.display = 'block';

  const score = state.finalQuiz.correct;
  const total = finalQuestions.length;

  document.getElementById('finalScoreValue').textContent = `${score}/${total}`;
  document.getElementById('finalXPValue').textContent = (score * 15) + ' XP';

  let grade, title, subtitle;
  if (score >= 9) { grade = 'A+'; title = 'üèÜ PWA Master!'; subtitle = 'You absolutely crushed it!'; }
  else if (score >= 7) { grade = 'A'; title = 'üåü Excellent!'; subtitle = 'You have a strong understanding of PWAs!'; }
  else if (score >= 5) { grade = 'B'; title = 'üëç Good Job!'; subtitle = 'Solid foundation ‚Äî review the topics you missed.'; }
  else { grade = 'C'; title = 'üìö Keep Learning!'; subtitle = 'Review the chapters and try again.'; }

  document.getElementById('finalGrade').textContent = grade;
  document.getElementById('finishTitle').textContent = title;
  document.getElementById('finishSubtitle').textContent = subtitle;
}

function resetFinalQuiz() {
  state.finalQuiz = { current: 0, correct: 0, answered: false };
  document.getElementById('finalQuiz').style.display = 'block';
  document.getElementById('finalResults').style.display = 'none';
  initFinalQuiz();
}

function showCompletionScreen() {
  document.getElementById('finalResults').style.display = 'none';
  document.getElementById('courseComplete').style.display = 'block';
  document.getElementById('totalXP').textContent = state.xp + ' XP';
  document.getElementById('completedSections').textContent = state.completedSections.size + '/8';
}

// ============================================================
// TAB HANDLING FOR EXERCISE EDITORS
// ============================================================
document.querySelectorAll('.code-editor').forEach(editor => {
  editor.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + 2;
    }
  });
});

// ============================================================
// INIT
// ============================================================
initFinalQuiz();
updateProgress();
</script>
</body>
</html>