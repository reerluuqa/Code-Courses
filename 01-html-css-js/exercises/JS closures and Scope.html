<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Closures & Scope Masterclass</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0b0;
            --accent-blue: #4fc3f7;
            --accent-purple: #ce93d8;
            --accent-green: #81c784;
            --accent-orange: #ffb74d;
            --accent-red: #e57373;
            --scope-global: rgba(79, 195, 247, 0.2);
            --scope-function: rgba(206, 147, 216, 0.2);
            --scope-block: rgba(129, 199, 132, 0.2);
            --border-global: #4fc3f7;
            --border-function: #ce93d8;
            --border-block: #81c784;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Navigation */
        .nav-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-container {
            margin-bottom: 30px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            transition: width 0.3s ease;
            width: 0%;
        }

        .nav-item {
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            border-left-color: var(--accent-blue);
        }

        .nav-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
        }

        .nav-item.completed .nav-icon {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 40px;
            max-width: 1000px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: var(--accent-blue);
        }

        h2 {
            font-size: 1.8em;
            margin: 30px 0 15px;
            color: var(--accent-purple);
        }

        h3 {
            color: var(--accent-orange);
            margin: 25px 0 10px;
        }

        .intro-text {
            font-size: 1.2em;
            color: var(--text-secondary);
            margin-bottom: 30px;
            line-height: 1.8;
        }

        /* Cards */
        .concept-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid var(--bg-tertiary);
            position: relative;
            overflow: hidden;
        }

        .concept-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
        }

        .concept-card.warning::before {
            background: var(--accent-red);
        }

        .concept-card.success::before {
            background: var(--accent-green);
        }

        /* Scope Visualizer */
        .scope-visualizer {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
            position: relative;
            border: 2px dashed var(--bg-tertiary);
        }

        .scope-box {
            position: absolute;
            border: 2px solid;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .scope-box:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .scope-box.global {
            border-color: var(--border-global);
            background: var(--scope-global);
            width: 90%;
            height: 250px;
            top: 20px;
            left: 5%;
        }

        .scope-box.function {
            border-color: var(--border-function);
            background: var(--scope-function);
            width: 70%;
            height: 180px;
            top: 50px;
            left: 15%;
        }

        .scope-box.block {
            border-color: var(--border-block);
            background: var(--scope-block);
            width: 50%;
            height: 100px;
            top: 90px;
            left: 25%;
        }

        .scope-label {
            position: absolute;
            top: -12px;
            left: 10px;
            background: var(--bg-secondary);
            padding: 0 10px;
            font-size: 0.9em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .variable {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .variable.highlight {
            background: var(--accent-orange);
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        .arrow {
            position: absolute;
            width: 2px;
            background: var(--accent-orange);
            transform-origin: top;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .arrow.visible {
            opacity: 1;
        }

        /* Code Playground */
        .playground {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            border: 1px solid var(--bg-tertiary);
        }

        .playground-header {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playground-title {
            font-size: 0.9em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .playground-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: #29b6f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
        }

        .code-editor {
            position: relative;
            background: #1e1e1e;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            min-height: 200px;
        }

        .code-input {
            width: 100%;
            min-height: 150px;
            background: transparent;
            border: none;
            color: #d4d4d4;
            font-family: inherit;
            font-size: inherit;
            resize: vertical;
            outline: none;
            tab-size: 2;
        }

        .console-output {
            background: #0d0d0d;
            color: #4fc3f7;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-top: 1px solid var(--bg-tertiary);
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }

        .console-line {
            margin: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .console-line::before {
            content: '>';
            position: absolute;
            left: 0;
            color: var(--accent-green);
        }

        .console-line.error {
            color: var(--accent-red);
        }

        .console-line.error::before {
            content: '‚úñ';
            color: var(--accent-red);
        }

        /* Interactive Demos */
        .demo-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .demo-box {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--bg-tertiary);
        }

        .counter-demo {
            text-align: center;
            padding: 30px;
        }

        .counter-value {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent-blue);
            margin: 20px 0;
        }

        /* Quiz Styles */
        .quiz-option {
            background: var(--bg-tertiary);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quiz-option:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-blue);
            transform: translateX(10px);
        }

        .quiz-option.selected {
            border-color: var(--accent-blue);
            background: rgba(79, 195, 247, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--accent-green);
            background: rgba(129, 199, 132, 0.2);
        }

        .quiz-option.wrong {
            border-color: var(--accent-red);
            background: rgba(229, 115, 115, 0.2);
        }

        .quiz-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .quiz-option.correct .quiz-indicator {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-primary);
        }

        .quiz-option.wrong .quiz-indicator {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        /* Pitfall Warning Box */
        .pitfall-box {
            background: linear-gradient(135deg, rgba(229, 115, 115, 0.1), rgba(229, 115, 115, 0.05));
            border: 2px solid var(--accent-red);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .pitfall-title {
            color: var(--accent-red);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        /* Animation utilities */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Backpack visualization for closures */
        .backpack-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 40px;
            background: var(--bg-primary);
            border-radius: 15px;
            margin: 20px 0;
        }

        .function-figure {
            width: 100px;
            height: 100px;
            background: var(--accent-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .backpack {
            width: 80px;
            height: 100px;
            background: var(--accent-orange);
            border-radius: 10px 10px 30px 30px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px;
        }

        .backpack::before {
            content: '';
            position: absolute;
            top: -20px;
            width: 40px;
            height: 20px;
            border: 4px solid var(--accent-orange);
            border-bottom: none;
            border-radius: 20px 20px 0 0;
        }

        .backpack-item {
            background: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-family: monospace;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .nav-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            .demo-container {
                grid-template-columns: 1fr;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 2px dotted var(--accent-blue);
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 5px;
            width: 250px;
            font-size: 0.9em;
            z-index: 10;
            border: 1px solid var(--accent-blue);
        }

        /* Memory leak visual */
        .memory-visual {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 10px;
            min-height: 150px;
            align-content: flex-start;
        }

        .memory-cell {
            width: 60px;
            height: 60px;
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .memory-cell.leaked {
            background: var(--accent-red);
            border-color: var(--accent-red);
            animation: pulse 1s infinite;
        }

        .memory-label {
            width: 100%;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <nav class="nav-sidebar">
        <div class="logo">
            <span>üéí</span>
            <span>Closure Master</span>
        </div>
        
        <div class="progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Progress</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <div class="nav-item active" onclick="navigateTo(0)">
            <div class="nav-icon">1</div>
            <div>
                <div style="font-weight: 600;">Lexical Scope</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">Where variables live</div>
            </div>
        </div>

        <div class="nav-item" onclick="navigateTo(1)">
            <div class="nav-icon">2</div>
            <div>
                <div style="font-weight: 600;">Scope Chain</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">How JS finds variables</div>
            </div>
        </div>

        <div class="nav-item" onclick="navigateTo(2)">
            <div class="nav-icon">3</div>
            <div>
                <div style="font-weight: 600;">Closures</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">The backpack analogy</div>
            </div>
        </div>

        <div class="nav-item" onclick="navigateTo(3)">
            <div class="nav-icon">4</div>
            <div>
                <div style="font-weight: 600;">Practical Patterns</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">Data privacy & factories</div>
            </div>
        </div>

        <div class="nav-item" onclick="navigateTo(4)">
            <div class="nav-icon">5</div>
            <div>
                <div style="font-weight: 600;">Common Pitfalls</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">Loops & memory leaks</div>
            </div>
        </div>

        <div class="nav-item" onclick="navigateTo(5)">
            <div class="nav-icon">‚òÖ</div>
            <div>
                <div style="font-weight: 600;">Master Quiz</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">Test your knowledge</div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <!-- Section 1: Lexical Scope -->
        <section class="section active" id="section-0">
            <h1>Lexical Scope</h1>
            <p class="intro-text">
                Scope determines where variables are accessible in your code. <span class="tooltip" data-tip="Lexical means 'relating to the words or vocabulary of a language'">Lexical</span> scope means the scope is determined by where variables and functions are declared in the source code, not where they are run.
            </p>

            <div class="concept-card">
                <h3>üèóÔ∏è The Three Levels of Scope</h3>
                <p style="margin: 15px 0; color: var(--text-secondary);">
                    Click on the boxes below to see what variables each scope can access:
                </p>
                
                <div class="scope-visualizer" id="scope-viz-1">
                    <div class="scope-box global" onclick="highlightScope('global')">
                        <span class="scope-label" style="color: var(--border-global);">Global Scope</span>
                        <div style="margin-top: 20px;">
                            <span class="variable" id="var-global">const app = "MyApp"</span>
                            <span class="variable" id="var-global2">let user = "Alice"</span>
                        </div>
                        
                        <div class="scope-box function" onclick="highlightScope('function', event)">
                            <span class="scope-label" style="color: var(--border-function);">Function Scope</span>
                            <div style="margin-top: 20px;">
                                <span class="variable" id="var-func">const secret = "xyz123"</span>
                                <span class="variable" id="var-func2">let count = 0</span>
                            </div>
                            
                            <div class="scope-box block" onclick="highlightScope('block', event)">
                                <span class="scope-label" style="color: var(--border-block);">Block Scope (if/for)</span>
                                <div style="margin-top: 15px;">
                                    <span class="variable" id="var-block">let temp = 42</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="scope-explanation" style="margin-top: 20px; padding: 15px; background: var(--bg-primary); border-radius: 8px; min-height: 60px;">
                    <strong style="color: var(--accent-blue);">üëÜ Click on a scope box above</strong> to see which variables it can access.
                </div>
            </div>

            <div class="concept-card">
                <h3>üîë Key Rule</h3>
                <p>Inner scopes can access outer scope variables, but outer scopes <strong>cannot</strong> access inner scope variables.</p>
                <div style="margin-top: 15px; padding: 15px; background: rgba(229, 115, 115, 0.1); border-left: 4px solid var(--accent-red); border-radius: 4px;">
                    <strong>Remember:</strong> This is a one-way street! Think of it like a one-way mirror in an interrogation room.
                </div>
            </div>

            <div class="playground">
                <div class="playground-header">
                    <span class="playground-title">Try It Yourself</span>
                    <div class="playground-actions">
                        <button class="btn btn-secondary" onclick="resetCode(0)">Reset</button>
                        <button class="btn btn-primary" onclick="runCode(0)">‚ñ∂ Run Code</button>
                    </div>
                </div>
                <div class="code-editor">
                    <textarea class="code-input" id="code-0">// Global scope
const name = "Alice";

function greet() {
  // Function scope
  const greeting = "Hello";
  console.log(greeting + " " + name); // Can access 'name' from outer scope
  
  if (true) {
    // Block scope
    const emoji = "üëã";
    console.log(emoji); // Works fine
  }
  
  // console.log(emoji); // Error! 'emoji' is not defined here
}

greet();</textarea>
                </div>
                <div class="console-output" id="console-0">
                    <div style="color: var(--text-secondary);">// Console output will appear here...</div>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: right;">
                <button class="btn btn-primary" onclick="completeSection(0); navigateTo(1)">Next: Scope Chain ‚Üí</button>
            </div>
        </section>

        <!-- Section 2: Scope Chain -->
        <section class="section" id="section-1">
            <h1>The Scope Chain</h1>
            <p class="intro-text">
                When JavaScript looks for a variable, it doesn't just look in the current scope. It follows the <strong>Scope Chain</strong> - climbing up through parent scopes until it finds the variable or reaches the global scope.
            </p>

            <div class="concept-card">
                <h3>üîç Variable Lookup Simulation</h3>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    Watch how JavaScript searches for variables. Click "Start Lookup" to trace the path:
                </p>

                <div class="scope-visualizer" style="height: 350px;">
                    <div class="scope-box global" style="z-index: 1;">
                        <span class="scope-label" style="color: var(--border-global);">Global</span>
                        <div style="margin-top: 30px;">
                            <span class="variable" id="chain-global-var">let x = "global"</span>
                        </div>
                    </div>
                    
                    <div class="scope-box function" style="z-index: 2; background: rgba(206, 147, 216, 0.3);">
                        <span class="scope-label" style="color: var(--border-function);">Outer Function</span>
                        <div style="margin-top: 30px;">
                            <span class="variable" id="chain-outer-var">let x = "outer"</span>
                        </div>
                    </div>
                    
                    <div class="scope-box block" style="z-index: 3; width: 40%; left: 30%; background: rgba(129, 199, 132, 0.3);">
                        <span class="scope-label" style="color: var(--border-block);">Inner Function</span>
                        <div style="margin-top: 20px; text-align: center;">
                            <div style="margin-bottom: 10px; font-family: monospace; color: var(--accent-orange);">
                                console.log(x);
                            </div>
                            <button class="btn btn-primary" id="lookup-btn" onclick="simulateLookup()">Start Lookup</button>
                            <div id="lookup-status" style="margin-top: 10px; font-size: 0.9em; color: var(--text-secondary);"></div>
                        </div>
                    </div>

                    <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#ffb74d" />
                            </marker>
                        </defs>
                        <line id="chain-line" x1="50%" y1="60%" x2="50%" y2="30%" stroke="#ffb74d" stroke-width="3" marker-end="url(#arrowhead)" opacity="0" />
                    </svg>
                </div>
            </div>

            <div class="concept-card warning">
                <h3>‚ö†Ô∏è Shadowing</h3>
                <p>When an inner variable has the same name as an outer variable, it <strong>shadows</strong> (hides) the outer one. The inner variable is used instead.</p>
                
                <div class="playground" style="margin-top: 20px;">
                    <div class="playground-header">
                        <span class="playground-title">Shadowing Example</span>
                        <button class="btn btn-primary" onclick="runCode(1)">‚ñ∂ Run</button>
                    </div>
                    <div class="code-editor">
                        <textarea class="code-input" id="code-1">let color = "blue";

function paint() {
  let color = "red"; // This shadows the global 'color'
  console.log("Inside: " + color); // "red"
  
  if (true) {
    let color = "green"; // Shadows again!
    console.log("Block: " + color); // "green"
  }
  
  console.log("Still inside: " + color); // Still "red"
}

paint();
console.log("Outside: " + color); // "blue"</textarea>
                    </div>
                    <div class="console-output" id="console-1"></div>
                </div>
            </div>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="navigateTo(0)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="completeSection(1); navigateTo(2)">Next: Closures ‚Üí</button>
            </div>
        </section>

        <!-- Section 3: Closures -->
        <section class="section" id="section-2">
            <h1>Closures</h1>
            <p class="intro-text">
                A <strong>closure</strong> is a function that remembers the scope where it was created, even when called outside that scope. It carries its variables like a backpack!
            </p>

            <div class="backpack-visual">
                <div style="text-align: center;">
                    <div class="function-figure">∆í</div>
                    <div style="margin-top: 10px; color: var(--text-secondary);">Function</div>
                </div>
                
                <div style="font-size: 2em; color: var(--accent-orange);">+</div>
                
                <div class="backpack">
                    <div class="backpack-item">count: 5</div>
                    <div class="backpack-item">name: "Alice"</div>
                    <div class="backpack-item">secret</div>
                </div>
                
                <div style="font-size: 2em; color: var(--accent-orange);">=</div>
                
                <div style="text-align: center;">
                    <div class="function-figure" style="background: var(--accent-green); animation: none; border: 3px solid var(--accent-orange);">
                        <span style="font-size: 0.5em; position: absolute; top: 5px; right: 5px;">üéí</span>
                        ∆í
                    </div>
                    <div style="margin-top: 10px; color: var(--accent-green); font-weight: bold;">Closure</div>
                </div>
            </div>

            <div class="concept-card success">
                <h3>‚ú® The Magic Explained</h3>
                <p>When you return a function from another function, the inner function keeps a reference to the outer function's variables. This is a closure.</p>
            </div>

            <div class="demo-container">
                <div class="demo-box">
                    <h3>Basic Closure</h3>
                    <div class="code-editor" style="min-height: auto; padding: 15px; font-size: 12px;">
<pre style="color: #d4d4d4;">function makeCounter() {
  let count = 0; // Enclosed variable
  
  return function() {
    count++; // Accessing enclosed variable
    return count;
  };
}

const counter = makeCounter();
console.log(counter()); // 1
console.log(counter()); // 2
console.log(counter()); // 3</pre>
                    </div>
                    <button class="btn btn-primary" onclick="runCounterDemo()" style="width: 100%; margin-top: 10px;">Test Counter</button>
                </div>

                <div class="demo-box counter-demo">
                    <div style="color: var(--text-secondary); font-size: 0.9em;">Closure Counter Value:</div>
                    <div class="counter-value" id="counter-value">0</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-primary" onclick="incrementClosure()">Increment</button>
                        <button class="btn btn-secondary" onclick="resetClosure()">Reset</button>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em; color: var(--text-secondary);">
                        Each click remembers the previous count!
                    </div>
                </div>
            </div>

            <div class="concept-card">
                <h3>üîí Why Closures Matter</h3>
                <ul style="margin-left: 20px; color: var(--text-secondary); line-height: 2;">
                    <li><strong>Data Privacy:</strong> Variables can't be accessed directly from outside</li>
                    <li><strong>State Preservation:</strong> Functions remember their state between calls</li>
                    <li><strong>Function Factories:</strong> Create customized functions on the fly</li>
                    <li><strong>Event Handlers:</strong> Maintain reference to configuration data</li>
                </ul>
            </div>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="navigateTo(1)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="completeSection(2); navigateTo(3)">Next: Practical Patterns ‚Üí</button>
            </div>
        </section>

        <!-- Section 4: Practical Patterns -->
        <section class="section" id="section-3">
            <h1>Practical Closure Patterns</h1>
            <p class="intro-text">
                Closures aren't just theoretical‚Äîthey solve real problems. Here are the three most common patterns you'll encounter.
            </p>

            <div class="concept-card">
                <h3>üè¶ Pattern 1: The Module Pattern (Data Privacy)</h3>
                <p>Before ES6 classes with private fields, closures were the only way to create truly private variables in JavaScript.</p>
                
                <div class="playground">
                    <div class="playground-header">
                        <span class="playground-title">Bank Account Module</span>
                        <button class="btn btn-primary" onclick="runBankDemo()">‚ñ∂ Run Demo</button>
                    </div>
                    <div class="code-editor">
                        <textarea class="code-input" id="code-bank">function createBankAccount(initialBalance) {
  // Private variable - can't be accessed from outside!
  let balance = initialBalance;
  
  return {
    deposit: function(amount) {
      if (amount > 0) {
        balance += amount;
        return "Deposited $" + amount + ". New balance: $" + balance;
      }
      return "Invalid amount";
    },
    withdraw: function(amount) {
      if (amount <= balance) {
        balance -= amount;
        return "Withdrew $" + amount + ". Remaining: $" + balance;
      }
      return "Insufficient funds!";
    },
    getBalance: function() {
      return "Current balance: $" + balance;
    }
    // Notice: no direct way to set balance!
  };
}

const myAccount = createBankAccount(100);
console.log(myAccount.getBalance());
console.log(myAccount.deposit(50));
console.log(myAccount.withdraw(30));
// console.log(myAccount.balance); // Undefined! Private!</textarea>
                    </div>
                    <div class="console-output" id="console-bank"></div>
                </div>
            </div>

            <div class="concept-card">
                <h3>üè≠ Pattern 2: Function Factory</h3>
                <p>Create specialized functions based on configuration.</p>
                
                <div class="playground">
                    <div class="playground-header">
                        <span class="playground-title">Multiplier Factory</span>
                        <button class="btn btn-primary" onclick="runCode(3)">‚ñ∂ Test Factory</button>
                    </div>
                    <div class="code-editor">
                        <textarea class="code-input" id="code-3">function makeMultiplier(factor) {
  // 'factor' is remembered via closure
  return function(number) {
    return number * factor;
  };
}

const double = makeMultiplier(2);
const triple = makeMultiplier(3);
const tenX = makeMultiplier(10);

console.log("Double 5:", double(5));   // 10
console.log("Triple 4:", triple(4));   // 12
console.log("TenX 7:", tenX(7));       // 70

// Each function has its own 'factor' in its backpack!</textarea>
                    </div>
                    <div class="console-output" id="console-3"></div>
                </div>
            </div>

            <div class="concept-card">
                <h3>üíæ Pattern 3: Memoization (Performance)</h3>
                <p>Cache expensive function results using closures.</p>
                
                <div class="playground">
                    <div class="playground-header">
                        <span class="playground-title">Memoized Fibonacci</span>
                        <button class="btn btn-primary" onclick="runMemoDemo()">‚ñ∂ See Caching</button>
                    </div>
                    <div class="code-editor">
                        <textarea class="code-input" id="code-memo">function memoize(fn) {
  const cache = {}; // Private cache!
  
  return function(n) {
    if (n in cache) {
      console.log("Fetching from cache for", n);
      return cache[n];
    }
    
    console.log("Computing for", n);
    const result = fn(n);
    cache[n] = result;
    return result;
  };
}

const fibonacci = memoize(function(n) {
  if (n <= 1) return n;
  return fibonacci(n - 1) + fibonacci(n - 2);
});

console.log(fibonacci(5));
console.log(fibonacci(5)); // Second call is instant!</textarea>
                    </div>
                    <div class="console-output" id="console-memo"></div>
                </div>
            </div>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="navigateTo(2)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="completeSection(3); navigateTo(4)">Next: Pitfalls ‚Üí</button>
            </div>
        </section>

        <!-- Section 5: Common Pitfalls -->
        <section class="section" id="section-4">
            <h1>Common Closure Pitfalls</h1>
            <p class="intro-text">
                Closures are powerful but can lead to subtle bugs. Here are the traps every JavaScript developer falls into (at least once).
            </p>

            <div class="pitfall-box">
                <div class="pitfall-title">
                    <span>‚ö†Ô∏è</span>
                    <span>The Classic Loop Trap (var vs let)</span>
                </div>
                <p style="margin-bottom: 15px;">
                    This is the most infamous closure bug. When using <code>var</code> in a loop, all closures share the same variable reference!
                </p>
                
                <div class="demo-container">
                    <div class="demo-box" style="border: 2px solid var(--accent-red);">
                        <h4 style="color: var(--accent-red); margin-bottom: 10px;">‚ùå The Bug (var)</h4>
                        <div class="code-editor" style="min-height: auto; padding: 10px; font-size: 12px;">
<pre style="color: #d4d4d4;">for (var i = 0; i < 3; i++) {
  setTimeout(() => {
    console.log(i); // What will this print?
  }, 100);
}
// Prints: 3, 3, 3 (Not 0, 1, 2!)</pre>
                        </div>
                        <button class="btn btn-secondary" onclick="runLoopBug()" style="width: 100%; margin-top: 10px;">See the Bug</button>
                        <div id="loop-bug-output" style="margin-top: 10px; font-family: monospace; font-size: 0.9em; color: var(--accent-red);"></div>
                    </div>

                    <div class="demo-box" style="border: 2px solid var(--accent-green);">
                        <h4 style="color: var(--accent-green); margin-bottom: 10px;">‚úÖ The Fix (let)</h4>
                        <div class="code-editor" style="min-height: auto; padding: 10px; font-size: 12px;">
<pre style="color: #d4d4d4;">for (let i = 0; i < 3; i++) {
  setTimeout(() => {
    console.log(i); // Block scoped!
  }, 100);
}
// Prints: 0, 1, 2 (Correct!)</pre>
                        </div>
                        <button class="btn btn-secondary" onclick="runLoopFix()" style="width: 100%; margin-top: 10px;">See the Fix</button>
                        <div id="loop-fix-output" style="margin-top: 10px; font-family: monospace; font-size: 0.9em; color: var(--accent-green);"></div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: var(--bg-primary); border-radius: 5px; font-size: 0.9em;">
                    <strong>Why?</strong> <code>var</code> is function-scoped, so all iterations share the same <code>i</code>. By the time callbacks run, the loop finished and <code>i</code> is 3. <code>let</code> is block-scoped, creating a new binding for each iteration.
                </div>
            </div>

            <div class="pitfall-box">
                <div class="pitfall-title">
                    <span>üß†</span>
                    <span>Memory Leaks</span>
                </div>
                <p>
                    Closures keep references to outer variables, preventing garbage collection. If a closure holds a large object you don't need anymore, it leaks memory.
                </p>
                
                <div class="memory-visual" id="memory-viz">
                    <div class="memory-label">Memory Visualization (click button to simulate):</div>
                    <button class="btn btn-primary" onclick="simulateMemoryLeak()" style="margin-bottom: 10px;">Create Leaky Closure</button>
                    <div id="memory-cells" style="display: flex; gap: 5px; flex-wrap: wrap;"></div>
                </div>
                
                <div style="margin-top: 15px; font-size: 0.9em; color: var(--text-secondary);">
                    <strong>Solution:</strong> Set variables to <code>null</code> when done, or avoid capturing large objects in closures that live long (like event listeners).
                </div>
            </div>

            <div class="pitfall-box">
                <div class="pitfall-title">
                    <span>üîÑ</span>
                    <span>Accidental Shared Scope</span>
                </div>
                
                <div class="playground">
                    <div class="playground-header">
                        <span class="playground-title">Shared Reference Bug</span>
                        <button class="btn btn-primary" onclick="runSharedScopeDemo()">‚ñ∂ Run Demo</button>
                    </div>
                    <div class="code-editor">
                        <textarea class="code-input" id="code-shared">// Accidentally sharing the same object reference
function createFunctions() {
  const funcs = [];
  let data = { count: 0 }; // Shared reference!
  
  for (let i = 0; i < 3; i++) {
    funcs.push(function() {
      data.count = i;
      return data.count;
    });
  }
  
  return funcs;
}

const functions = createFunctions();
console.log(functions[0]()); // Expect 0, but get...
console.log(functions[1]()); // Expect 1, but get...
console.log(functions[2]()); // Expect 2, and get 2

// All return 2 because they share 'data' and the final value of 'i'!</textarea>
                    </div>
                    <div class="console-output" id="console-shared"></div>
                </div>
            </div>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="navigateTo(3)">‚Üê Back</button>
                <button class="btn btn-primary" onclick="completeSection(4); navigateTo(5)">Take the Master Quiz ‚Üí</button>
            </div>
        </section>

        <!-- Section 6: Quiz -->
        <section class="section" id="section-5">
            <h1>üéì Master Quiz</h1>
            <p class="intro-text">
                Test your understanding of closures and scope. Score 4/5 to earn your Closure Master badge!
            </p>

            <div id="quiz-container">
                <div class="concept-card" id="quiz-1">
                    <h3>Question 1 of 5</h3>
                    <p style="font-size: 1.1em; margin: 20px 0;">What will the following code output?</p>
                    <div class="code-editor" style="margin: 15px 0; padding: 15px;">
                        <pre style="color: #d4d4d4;">function outer() {
  let x = 10;
  function inner() {
    console.log(x);
  }
  x = 20;
  return inner;
}

const fn = outer();
fn();</pre>
                    </div>
                    
                    <div class="quiz-option" onclick="selectOption(1, 'a', false)">
                        <div class="quiz-indicator">A</div>
                        <div>10</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(1, 'b', true)">
                        <div class="quiz-indicator">B</div>
                        <div>20</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(1, 'c', false)">
                        <div class="quiz-indicator">C</div>
                        <div>undefined</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(1, 'd', false)">
                        <div class="quiz-indicator">D</div>
                        <div>ReferenceError</div>
                    </div>
                    
                    <div id="explanation-1" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; color: var(--text-secondary);"></div>
                </div>

                <div class="concept-card" id="quiz-2" style="display: none;">
                    <h3>Question 2 of 5</h3>
                    <p style="font-size: 1.1em; margin: 20px 0;">Which variables does the closure <code>inner()</code> have access to?</p>
                    <div class="code-editor" style="margin: 15px 0; padding: 15px;">
                        <pre style="color: #d4d4d4;">const global = "G";

function outer() {
  const a = "A";
  
  function middle() {
    const b = "B";
    
    function inner() {
      const c = "C";
      // What can I access?
    }
  }
}</pre>
                    </div>
                    
                    <div class="quiz-option" onclick="selectOption(2, 'a', false)">
                        <div class="quiz-indicator">A</div>
                        <div>Only c</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(2, 'b', false)">
                        <div class="quiz-indicator">B</div>
                        <div>b and c</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(2, 'c', true)">
                        <div class="quiz-indicator">C</div>
                        <div>global, a, b, and c</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(2, 'd', false)">
                        <div class="quiz-indicator">D</div>
                        <div>a, b, and c (not global)</div>
                    </div>
                    
                    <div id="explanation-2" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; color: var(--text-secondary);"></div>
                </div>

                <div class="concept-card" id="quiz-3" style="display: none;">
                    <h3>Question 3 of 5</h3>
                    <p style="font-size: 1.1em; margin: 20px 0;">What's the best way to fix the "loop closure bug" without changing <code>var</code> to <code>let</code>?</p>
                    
                    <div class="quiz-option" onclick="selectOption(3, 'a', true)">
                        <div class="quiz-indicator">A</div>
                        <div>Use an IIFE (Immediately Invoked Function Expression) to capture the current value</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(3, 'b', false)">
                        <div class="quiz-indicator">B</div>
                        <div>Use <code>const</code> instead of <code>var</code></div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(3, 'c', false)">
                        <div class="quiz-indicator">C</div>
                        <div>Move the setTimeout outside the loop</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(3, 'd', false)">
                        <div class="quiz-indicator">D</div>
                        <div>Use <code>setInterval</code> instead</div>
                    </div>
                    
                    <div id="explanation-3" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; color: var(--text-secondary);"></div>
                </div>

                <div class="concept-card" id="quiz-4" style="display: none;">
                    <h3>Question 4 of 5</h3>
                    <p style="font-size: 1.1em; margin: 20px 0;">In the Module Pattern, why don't we just use objects instead of closures?</p>
                    
                    <div class="quiz-option" onclick="selectOption(4, 'a', false)">
                        <div class="quiz-indicator">A</div>
                        <div>Objects are slower than closures</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(4, 'b', true)">
                        <div class="quiz-indicator">B</div>
                        <div>Objects can't have truly private data without closures</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(4, 'c', false)">
                        <div class="quiz-indicator">C</div>
                        <div>Objects don't support methods</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(4, 'd', false)">
                        <div class="quiz-indicator">D</div>
                        <div>Closures use less memory</div>
                    </div>
                    
                    <div id="explanation-4" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; color: var(--text-secondary);"></div>
                </div>

                <div class="concept-card" id="quiz-5" style="display: none;">
                    <h3>Question 5 of 5</h3>
                    <p style="font-size: 1.1em; margin: 20px 0;">What will this code output?</p>
                    <div class="code-editor" style="margin: 15px 0; padding: 15px;">
                        <pre style="color: #d4d4d4;">const fns = [];
for (let i = 0; i < 3; i++) {
  fns.push(() => i);
}
console.log(fns.map(fn => fn()));</pre>
                    </div>
                    
                    <div class="quiz-option" onclick="selectOption(5, 'a', false)">
                        <div class="quiz-indicator">A</div>
                        <div>[3, 3, 3]</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(5, 'b', true)">
                        <div class="quiz-indicator">B</div>
                        <div>[0, 1, 2]</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(5, 'c', false)">
                        <div class="quiz-indicator">C</div>
                        <div>[undefined, undefined, undefined]</div>
                    </div>
                    <div class="quiz-option" onclick="selectOption(5, 'd', false)">
                        <div class="quiz-indicator">D</div>
                        <div>Error</div>
                    </div>
                    
                    <div id="explanation-5" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-primary); border-radius: 8px; color: var(--text-secondary);"></div>
                </div>

                <div class="concept-card" id="quiz-results" style="display: none; text-align: center;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üèÜ</div>
                    <h2>Quiz Complete!</h2>
                    <div style="font-size: 3em; color: var(--accent-blue); margin: 20px 0;">
                        <span id="score-display">0</span>/5
                    </div>
                    <p id="result-message" style="font-size: 1.2em; margin-bottom: 20px;"></p>
                    <button class="btn btn-primary" onclick="location.reload()">Start Over</button>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: center; color: var(--text-secondary);">
                <button class="btn btn-secondary" onclick="navigateTo(4)">‚Üê Review Pitfalls</button>
            </div>
        </section>
    </main>

    <script>
        // State Management
        let currentSection = 0;
        const totalSections = 6;
        let completedSections = JSON.parse(localStorage.getItem('closureMasterProgress') || '[]');
        let quizScore = 0;
        let currentQuiz = 1;
        let closureCounter = null;
        let closureCount = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            updateNavState();
        });

        function navigateTo(index) {
            if (index > 0 && !completedSections.includes(index - 1) && index !== 5) {
                // Allow navigation to quiz if all previous completed, or to any previous section
                if (index < currentSection) {
                    // Allow going back
                } else {
                    alert("Complete the previous section first!");
                    return;
                }
            }

            document.querySelectorAll('.section').forEach((sec, i) => {
                sec.classList.remove('active');
                if (i === index) sec.classList.add('active');
            });

            document.querySelectorAll('.nav-item').forEach((item, i) => {
                item.classList.remove('active');
                if (i === index) item.classList.add('active');
            });

            currentSection = index;
            window.scrollTo(0, 0);
        }

        function completeSection(index) {
            if (!completedSections.includes(index)) {
                completedSections.push(index);
                localStorage.setItem('closureMasterProgress', JSON.stringify(completedSections));
                updateProgress();
                updateNavState();
                
                // Visual feedback
                const btn = event.target;
                btn.textContent = "‚úì Completed";
                btn.style.background = "var(--accent-green)";
            }
        }

        function updateProgress() {
            const progress = (completedSections.length / (totalSections - 1)) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress) + '%';
        }

        function updateNavState() {
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                if (completedSections.includes(index)) {
                    item.classList.add('completed');
                    item.querySelector('.nav-icon').textContent = '‚úì';
                }
            });
        }

        // Scope Visualizer
        function highlightScope(type, event) {
            if (event) event.stopPropagation();
            
            const explanation = document.getElementById('scope-explanation');
            const vars = document.querySelectorAll('.variable');
            vars.forEach(v => v.classList.remove('highlight'));
            
            switch(type) {
                case 'global':
                    explanation.innerHTML = '<strong style="color: var(--accent-blue);">Global Scope:</strong> Can access: <span class="variable highlight">app</span>, <span class="variable highlight">user</span>. <br><span style="color: var(--accent-red);">Cannot access: secret, count, temp</span>';
                    document.getElementById('var-global').classList.add('highlight');
                    document.getElementById('var-global2').classList.add('highlight');
                    break;
                case 'function':
                    explanation.innerHTML = '<strong style="color: var(--accent-purple);">Function Scope:</strong> Can access: <span class="variable highlight">secret</span>, <span class="variable highlight">count</span> (local) + <span class="variable highlight">app</span>, <span class="variable highlight">user</span> (outer). <br><span style="color: var(--accent-red);">Cannot access: temp</span>';
                    ['var-func', 'var-func2', 'var-global', 'var-global2'].forEach(id => {
                        document.getElementById(id)?.classList.add('highlight');
                    });
                    break;
                case 'block':
                    explanation.innerHTML = '<strong style="color: var(--accent-green);">Block Scope:</strong> Can access: <span class="variable highlight">temp</span> (local) + <span class="variable highlight">secret</span>, <span class="variable highlight">count</span> (outer) + <span class="variable highlight">app</span>, <span class="variable highlight">user</span> (global).<br>Inner scopes can see out, but outer cannot see in!';
                    document.querySelectorAll('.variable').forEach(v => v.classList.add('highlight'));
                    break;
            }
        }

        // Code Execution Simulator
        function runCode(index) {
            const code = document.getElementById(`code-${index}`).value;
            const consoleOutput = document.getElementById(`console-${index}`);
            
            // Clear previous output
            consoleOutput.innerHTML = '';
            
            // Capture console.log
            const logs = [];
            const mockConsole = {
                log: (...args) => {
                    logs.push(args.map(arg => {
                        if (typeof arg === 'object') return JSON.stringify(arg);
                        return String(arg);
                    }).join(' '));
                },
                error: (...args) => {
                    logs.push('ERROR: ' + args.join(' '));
                }
            };

            try {
                // Create safe-ish execution environment
                const func = new Function('console', '"use strict"; ' + code);
                func(mockConsole);
                
                // Display output
                if (logs.length === 0) {
                    consoleOutput.innerHTML = '<div class="console-line" style="color: var(--text-secondary);">// Code executed (no output)</div>';
                } else {
                    logs.forEach(log => {
                        const line = document.createElement('div');
                        line.className = 'console-line';
                        line.textContent = log;
                        consoleOutput.appendChild(line);
                    });
                }
            } catch (error) {
                const line = document.createElement('div');
                line.className = 'console-line error';
                line.textContent = error.message;
                consoleOutput.appendChild(line);
            }
        }

        function resetCode(index) {
            const defaults = [
                `// Global scope
const name = "Alice";

function greet() {
  // Function scope
  const greeting = "Hello";
  console.log(greeting + " " + name); // Can access 'name' from outer scope
  
  if (true) {
    // Block scope
    const emoji = "üëã";
    console.log(emoji); // Works fine
  }
  
  // console.log(emoji); // Error! 'emoji' is not defined here
}

greet();`,
                `let color = "blue";

function paint() {
  let color = "red"; // This shadows the global 'color'
  console.log("Inside: " + color); // "red"
  
  if (true) {
    let color = "green"; // Shadows again!
    console.log("Block: " + color); // "green"
  }
  
  console.log("Still inside: " + color); // Still "red"
}

paint();
console.log("Outside: " + color); // "blue"`,
                null, null,
                `function makeMultiplier(factor) {
  // 'factor' is remembered via closure
  return function(number) {
    return number * factor;
  };
}

const double = makeMultiplier(2);
const triple = makeMultiplier(3);
const tenX = makeMultiplier(10);

console.log("Double 5:", double(5));   // 10
console.log("Triple 4:", triple(4));   // 12
console.log("TenX 7:", tenX(7));       // 70

// Each function has its own 'factor' in its backpack!`
            ];
            
            if (defaults[index]) {
                document.getElementById(`code-${index}`).value = defaults[index];
                document.getElementById(`console-${index}`).innerHTML = '<div style="color: var(--text-secondary);">// Console output will appear here...</div>';
            }
        }

        // Scope Chain Animation
        function simulateLookup() {
            const btn = document.getElementById('lookup-btn');
            const status = document.getElementById('lookup-status');
            const line = document.getElementById('chain-line');
            const innerVar = document.querySelector('#section-1 .scope-box.block');
            const outerVar = document.querySelector('#section-1 .scope-box.function .variable');
            const globalVar = document.querySelector('#section-1 .scope-box.global .variable');
            
            btn.disabled = true;
            status.textContent = "Looking in Local Scope...";
            status.style.color = "var(--text-secondary)";
            
            setTimeout(() => {
                innerVar.style.borderColor = "var(--accent-red)";
                innerVar.style.background = "rgba(229, 115, 115, 0.3)";
                
                setTimeout(() => {
                    status.textContent = "Not found! Climbing up...";
                    line.style.opacity = "1";
                    
                    setTimeout(() => {
                        outerVar.classList.add('highlight');
                        status.textContent = "Found 'x' in Outer Function: 'outer'";
                        status.style.color = "var(--accent-green)";
                        
                        setTimeout(() => {
                            // Reset
                            innerVar.style.borderColor = "";
                            innerVar.style.background = "";
                            outerVar.classList.remove('highlight');
                            line.style.opacity = "0";
                            btn.disabled = false;
                            status.textContent = "";
                        }, 2000);
                    }, 800);
                }, 800);
            }, 500);
        }

        // Closure Counter Demo
        function runCounterDemo() {
            if (!closureCounter) {
                closureCount = 0;
                closureCounter = function() {
                    return ++closureCount;
                };
            }
            document.getElementById('counter-value').textContent = closureCounter();
        }

        function incrementClosure() {
            if (!closureCounter) {
                closureCount = 0;
                closureCounter = function() {
                    return ++closureCount;
                };
            }
            document.getElementById('counter-value').textContent = closureCounter();
        }

        function resetClosure() {
            closureCount = 0;
            closureCounter = function() {
                return ++closureCount;
            };
            document.getElementById('counter-value').textContent = "0";
        }

        // Specific Demos
        function runBankDemo() {
            const code = document.getElementById('code-bank').value;
            const consoleOutput = document.getElementById('console-bank');
            consoleOutput.innerHTML = '';
            
            try {
                const logs = [];
                const mockConsole = {
                    log: (...args) => {
                        logs.push(args.join(' '));
                    }
                };
                
                // Safe execution
                eval(`
                    (function(console) {
                        ${code}
                    })(mockConsole)
                `);
                
                logs.forEach(log => {
                    const line = document.createElement('div');
                    line.className = 'console-line';
                    line.textContent = log;
                    consoleOutput.appendChild(line);
                });
            } catch (e) {
                consoleOutput.innerHTML = `<div class="console-line error">${e.message}</div>`;
            }
        }

        function runMemoDemo() {
            const consoleOutput = document.getElementById('console-memo');
            consoleOutput.innerHTML = '';
            
            // Simulate the output
            const outputs = [
                "Computing for 5",
                "Fetching from cache for 3",
                "Fetching from cache for 2",
                "Fetching from cache for 1",
                "Fetching from cache for 0",
                "5",
                "Fetching from cache for 5",
                "5"
            ];
            
            let i = 0;
            function addLine() {
                if (i < outputs.length) {
                    const line = document.createElement('div');
                    line.className = 'console-line';
                    if (outputs[i].includes("cache")) {
                        line.style.color = "var(--accent-green)";
                    }
                    line.textContent = outputs[i];
                    consoleOutput.appendChild(line);
                    i++;
                    setTimeout(addLine, 300);
                }
            }
            addLine();
        }

        // Loop Bug Demo
        function runLoopBug() {
            const output = document.getElementById('loop-bug-output');
            output.innerHTML = 'Starting...<br>';
            
            for (var i = 0; i < 3; i++) {
                setTimeout(() => {
                    output.innerHTML += `i = ${i}<br>`;
                }, 100 + (i * 50));
            }
        }

        function runLoopFix() {
            const output = document.getElementById('loop-fix-output');
            output.innerHTML = 'Starting...<br>';
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    output.innerHTML += `i = ${i}<br>`;
                }, 100 + (i * 50));
            }
        }

        // Memory Leak Simulation
        function simulateMemoryLeak() {
            const container = document.getElementById('memory-cells');
            container.innerHTML = '';
            
            // Create big data cells
            for (let i = 0; i < 5; i++) {
                const cell = document.createElement('div');
                cell.className = 'memory-cell';
                cell.textContent = `Data ${i}`;
                container.appendChild(cell);
            }
            
            // Show leak warning
            const warning = document.createElement('div');
            warning.style.width = '100%';
            warning.style.color = 'var(--accent-red)';
            warning.style.marginTop = '10px';
            warning.innerHTML = '‚ö†Ô∏è These objects are trapped in closure and cannot be garbage collected!';
            container.appendChild(warning);
            
            // Animate them getting stuck
            setTimeout(() => {
                document.querySelectorAll('.memory-cell').forEach(cell => {
                    cell.classList.add('leaked');
                });
            }, 500);
        }

        function runSharedScopeDemo() {
            const consoleOutput = document.getElementById('console-shared');
            consoleOutput.innerHTML = '';
            
            // Simulate the confusing behavior
            const lines = [
                "2", // functions[0]() - expects 0, gets 2
                "2", // functions[1]() - expects 1, gets 2  
                "2"  // functions[2]() - expects 2, gets 2
            ];
            
            lines.forEach((line, idx) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = 'console-line';
                    div.textContent = line;
                    consoleOutput.appendChild(div);
                }, idx * 200);
            });
            
            setTimeout(() => {
                const note = document.createElement('div');
                note.className = 'console-line';
                note.style.color = 'var(--accent-orange)';
                note.textContent = '// All show 2 because they share the same "i" reference!';
                consoleOutput.appendChild(note);
            }, 800);
        }

        // Quiz System
        const explanations = {
            1: "Correct! The closure captures the variable 'x' by reference, not by value. When outer() runs, x starts as 10, but is changed to 20 before inner is returned. The closure sees the current value (20), not the value at the time inner was defined.",
            2: "Correct! Closures have access to the entire scope chain: their own scope, outer functions' scopes, and the global scope. 'inner()' can access c (own), b (middle), a (outer), and global (global).",
            3: "Correct! Before ES6, developers used IIFEs to capture the loop variable: for (var i = 0; i < 3; i++) { (function(capturedI) { setTimeout(() => console.log(capturedI), 100); })(i); }",
            4: "Correct! In JavaScript, object properties are always public. Closures are the only way (pre-private class fields) to hide data using lexical scoping. The variables in the outer function are inaccessible from outside.",
            5: "Correct! Because we used 'let', each iteration gets its own binding of 'i'. The arrow function captures that specific iteration's value. Result: [0, 1, 2]. With 'var', it would be [3, 3, 3]."
        };

        function selectOption(question, option, isCorrect) {
            const card = document.getElementById(`quiz-${question}`);
            const options = card.querySelectorAll('.quiz-option');
            const explanation = document.getElementById(`explanation-${question}`);
            
            // Prevent multiple selections
            if (card.dataset.answered) return;
            card.dataset.answered = "true";
            
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.onclick.toString().includes(`'${option}'`)) {
                    opt.classList.add(isCorrect ? 'correct' : 'wrong');
                } else if (!isCorrect && opt.onclick.toString().includes('true')) {
                    opt.classList.add('correct');
                }
            });
            
            if (isCorrect) quizScore++;
            
            explanation.textContent = (isCorrect ? "‚úÖ " : "‚ùå ") + explanations[question];
            explanation.style.display = 'block';
            
            // Next question button
            setTimeout(() => {
                if (question < 5) {
                    document.getElementById(`quiz-${question}`).style.display = 'none';
                    document.getElementById(`quiz-${question + 1}`).style.display = 'block';
                } else {
                    showResults();
                }
            }, 2500);
        }

        function showResults() {
            document.getElementById('quiz-5').style.display = 'none';
            document.getElementById('quiz-results').style.display = 'block';
            document.getElementById('score-display').textContent = quizScore;
            
            const msg = document.getElementById('result-message');
            if (quizScore === 5) {
                msg.textContent = "Perfect score! You're a Closure Master! üéâ";
                msg.style.color = "var(--accent-green)";
                completeSection(5);
            } else if (quizScore >= 4) {
                msg.textContent = "Great job! You understand closures well.";
                msg.style.color = "var(--accent-blue)";
                completeSection(5);
            } else if (quizScore >= 3) {
                msg.textContent = "Good effort! Review the pitfalls section and try again.";
                msg.style.color = "var(--accent-orange)";
            } else {
                msg.textContent = "Keep learning! Go back through the sections and practice the examples.";
                msg.style.color = "var(--accent-red)";
            }
        }
    </script>
</body>
</html>