<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FP Mastery: The Functional Programming Dojo</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-pure: #10b981;
            --accent-impure: #ef4444;
            --accent-warn: #f59e0b;
            --accent-info: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #475569;
            --success: #22c55e;
            --error: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.2), transparent);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(to right, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .stats-bar {
            display: flex;
            gap: 2rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(0,0,0,0.3);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-weight: bold;
            color: var(--accent-info);
            font-size: 1.2rem;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }

        @media (max-width: 968px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .nav-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-info);
            color: #60a5fa;
        }

        .nav-item.completed::after {
            content: '‚úì';
            position: absolute;
            right: 10px;
            color: var(--accent-pure);
            font-weight: bold;
        }

        .content-area {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 2rem;
            min-height: 600px;
        }

        .module-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .module-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--accent-info);
        }

        .concept-box {
            background: var(--bg-primary);
            border-left: 4px solid var(--accent-info);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            position: relative;
        }

        .code-block.pure {
            border-left: 4px solid var(--accent-pure);
        }

        .code-block.impure {
            border-left: 4px solid var(--accent-impure);
        }

        .code-label {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 0 0 0 8px;
        }

        .code-label.pure {
            background: var(--accent-pure);
            color: white;
        }

        .code-label.impure {
            background: var(--accent-impure);
            color: white;
        }

        .visual-container {
            background: var(--bg-primary);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .interactive-demo {
            margin: 2rem 0;
        }

        .btn {
            background: var(--accent-info);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            font-weight: 600;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn.success {
            background: var(--accent-pure);
        }

        .btn.danger {
            background: var(--accent-impure);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid var(--border);
        }

        .quiz-option {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quiz-option:hover {
            border-color: var(--accent-info);
            background: var(--bg-tertiary);
        }

        .quiz-option.correct {
            border-color: var(--accent-pure);
            background: rgba(16, 185, 129, 0.1);
        }

        .quiz-option.wrong {
            border-color: var(--accent-impure);
            background: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .pitfall {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1));
            border: 2px solid var(--accent-warn);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            position: relative;
        }

        .pitfall::before {
            content: '‚ö†Ô∏è PITFALL';
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--accent-warn);
            color: black;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
            border: 2px solid var(--accent-pure);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .code-editor {
            width: 100%;
            min-height: 150px;
            background: #0d1117;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            margin: 1rem 0;
        }

        .output-box {
            background: #000;
            color: #0f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 1rem;
            min-height: 50px;
            border: 1px solid #333;
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            margin: 1rem 0;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .function-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .func-box {
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-info);
            padding: 1rem 2rem;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s;
        }

        .func-box.active {
            background: var(--accent-info);
            color: white;
            transform: scale(1.1);
        }

        .arrow {
            font-size: 2rem;
            color: var(--accent-info);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }

        .data-flow {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            overflow-x: auto;
        }

        .data-node {
            min-width: 100px;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
        }

        .data-node.transformed {
            border-color: var(--accent-pure);
            background: rgba(16, 185, 129, 0.2);
        }

        .connector {
            flex: 1;
            height: 2px;
            background: var(--border);
            position: relative;
            min-width: 50px;
        }

        .connector::after {
            content: '‚Üí';
            position: absolute;
            right: -10px;
            top: -10px;
            color: var(--border);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-info), var(--accent-pure));
            transition: width 0.5s ease;
        }

        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 2px dotted var(--accent-info);
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            white-space: nowrap;
            z-index: 1000;
            font-size: 0.9rem;
        }

        .composition-playground {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .pipe-segment {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            padding: 1rem;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s;
        }

        .pipe-segment:hover {
            border-color: var(--accent-info);
            transform: translateY(-2px);
        }

        .pipe-segment.dragging {
            opacity: 0.5;
        }

        .maybe-box {
            display: inline-block;
            padding: 2rem;
            margin: 1rem;
            border: 3px solid var(--accent-warn);
            border-radius: 12px;
            background: var(--bg-primary);
            position: relative;
            transition: all 0.3s;
        }

        .maybe-box.null {
            border-color: var(--accent-impure);
            background: rgba(239, 68, 68, 0.1);
        }

        .maybe-box.value {
            border-color: var(--accent-pure);
            background: rgba(16, 185, 129, 0.1);
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confetti-fall 3s linear forwards;
            z-index: 9999;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>ü•∑ FP Mastery Dojo</h1>
            <p class="subtitle">Master Functional Programming to conquer technical interviews</p>
            <div class="stats-bar">
                <div class="stat">
                    <span>XP:</span>
                    <span class="stat-value" id="xp">0</span>
                </div>
                <div class="stat">
                    <span>Level:</span>
                    <span class="stat-value" id="level">Padawan</span>
                </div>
                <div class="stat">
                    <span>Progress:</span>
                    <div class="progress-bar" style="width: 150px; margin: 0;">
                        <div class="progress-fill" id="main-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-layout">
            <nav class="sidebar">
                <div class="nav-item active" onclick="app.loadModule(0)">
                    <span>1Ô∏è‚É£</span> Pure Functions
                </div>
                <div class="nav-item" onclick="app.loadModule(1)">
                    <span>2Ô∏è‚É£</span> Immutability
                </div>
                <div class="nav-item" onclick="app.loadModule(2)">
                    <span>3Ô∏è‚É£</span> Composition
                </div>
                <div class="nav-item" onclick="app.loadModule(3)">
                    <span>4Ô∏è‚É£</span> Functors & Monads
                </div>
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button class="btn" onclick="app.resetProgress()" style="width: 100%; font-size: 0.9rem;">
                        Reset Progress
                    </button>
                </div>
            </nav>

            <main class="content-area" id="content">
                <!-- Content injected by JS -->
            </main>
        </div>
    </div>

    <script>
        // Main Application Class
        class FPApp {
            constructor() {
                this.currentModule = 0;
                this.xp = parseInt(localStorage.getItem('fp_xp')) || 0;
                this.completedModules = JSON.parse(localStorage.getItem('fp_completed')) || [];
                this.moduleProgress = JSON.parse(localStorage.getItem('fp_progress')) || {};
                this.init();
            }

            init() {
                this.updateStats();
                this.loadModule(0);
            }

            updateStats() {
                document.getElementById('xp').textContent = this.xp;
                const level = this.xp < 100 ? 'Padawan' : 
                             this.xp < 300 ? 'Ninja' : 
                             this.xp < 600 ? 'Master' : 'Grandmaster';
                document.getElementById('level').textContent = level;
                
                const progress = (this.completedModules.length / 4) * 100;
                document.getElementById('main-progress').style.width = progress + '%';
            }

            addXP(amount) {
                this.xp += amount;
                localStorage.setItem('fp_xp', this.xp);
                this.updateStats();
                this.celebrate();
            }

            celebrate() {
                for(let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.backgroundColor = ['#ff0', '#f0f', '#0ff', '#0f0'][Math.floor(Math.random() * 4)];
                        document.body.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 50);
                }
            }

            completeModule(moduleIndex) {
                if(!this.completedModules.includes(moduleIndex)) {
                    this.completedModules.push(moduleIndex);
                    localStorage.setItem('fp_completed', JSON.stringify(this.completedModules));
                    this.addXP(100);
                    
                    // Update sidebar
                    const navItems = document.querySelectorAll('.nav-item');
                    navItems[moduleIndex].classList.add('completed');
                }
            }

            loadModule(index) {
                this.currentModule = index;
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });

                const content = document.getElementById('content');
                content.innerHTML = '';
                content.classList.remove('fade-in');
                void content.offsetWidth; // Trigger reflow
                content.classList.add('fade-in');

                switch(index) {
                    case 0: this.renderPureFunctions(content); break;
                    case 1: this.renderImmutability(content); break;
                    case 2: this.renderComposition(content); break;
                    case 3: this.renderFunctorsMonads(content); break;
                }
            }

            // Module 1: Pure Functions
            renderPureFunctions(container) {
                container.innerHTML = `
                    <div class="module-header">
                        <h2 class="module-title">Pure Functions</h2>
                        <p>The foundation of Functional Programming. Same input ‚Üí Same output. Always.</p>
                    </div>

                    <div class="concept-box">
                        <h3>üéØ What makes a function pure?</h3>
                        <ul style="margin: 1rem 0; padding-left: 1.5rem;">
                            <li><strong>Deterministic:</strong> Same input always produces same output</li>
                            <li><strong>No Side Effects:</strong> Doesn't modify external state or depend on it</li>
                            <li><strong>Referentially Transparent:</strong> Can be replaced with its result</li>
                        </ul>
                    </div>

                    <div class="visual-container">
                        <h3>Visual: Pure vs Impure</h3>
                        <div class="function-visualizer">
                            <div class="func-box" id="pure-func" onclick="app.demoPureFunction()">
                                <div>f(x) = x * 2</div>
                                <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">Click me!</small>
                            </div>
                            <div class="arrow">‚Üí</div>
                            <div class="data-node" id="pure-output">?</div>
                        </div>
                        <div class="function-visualizer" style="margin-top: 2rem;">
                            <div class="func-box" style="border-color: var(--accent-impure)" onclick="app.demoImpureFunction()">
                                <div>random() * x</div>
                                <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">Click me!</small>
                            </div>
                            <div class="arrow" style="color: var(--accent-impure)">‚Üí</div>
                            <div class="data-node" id="impure-output">?</div>
                        </div>
                        <p style="margin-top: 1rem; color: var(--text-secondary)">
                            Notice how the pure function always returns 20 (if input is 10), 
                            while the impure one returns random values!
                        </p>
                    </div>

                    <div class="code-block pure">
                        <span class="code-label pure">PURE ‚úÖ</span>
                        <pre>// Pure: Always returns same output for same input
// No external dependencies, no mutation
const calculateTotal = (price, quantity) => {
    return price * quantity;
};

calculateTotal(10, 2); // Always 20
calculateTotal(10, 2); // Always 20
calculateTotal(10, 2); // Always 20</pre>
                    </div>

                    <div class="code-block impure">
                        <span class="code-label impure">IMPURE ‚ùå</span>
                        <pre>// Impure: Depends on external state (taxRate)
// Side effect: console.log
let taxRate = 0.2;

const calculateTotalImpure = (price) => {
    console.log('Calculating...'); // Side effect!
    return price * (1 + taxRate); // External dependency
};

calculateTotalImpure(100); // Result changes if taxRate changes</pre>
                    </div>

                    <div class="pitfall">
                        <h4>Common Interview Traps:</h4>
                        <ul style="margin-top: 1rem; padding-left: 1.5rem;">
                            <li><code>Date.now()</code> and <code>Math.random()</code> make functions impure</li>
                            <li>DOM manipulation is a side effect</li>
                            <li>Mutating input parameters breaks purity</li>
                            <li>API calls are inherently impure (handle them carefully)</li>
                        </ul>
                    </div>

                    <div class="quiz-container">
                        <h3>üéÆ Quiz: Spot the Impurity</h3>
                        <p>Which of these functions is PURE?</p>
                        <div class="quiz-option" onclick="app.checkQuiz(this, false, 'A')">
                            <code>const add = (x) => x + externalVar;</code>
                        </div>
                        <div class="quiz-option" onclick="app.checkQuiz(this, true, 'B')">
                            <code>const add = (x, y) => x + y;</code>
                        </div>
                        <div class="quiz-option" onclick="app.checkQuiz(this, false, 'C')">
                            <code>const add = (arr) => { arr.push(1); return arr; };</code>
                        </div>
                        <div class="quiz-option" onclick="app.checkQuiz(this, false, 'D')">
                            <code>const add = (x) => { console.log(x); return x + 1; };</code>
                        </div>
                        <div id="quiz-feedback" style="margin-top: 1rem; font-weight: bold;"></div>
                    </div>

                    <div class="interactive-demo">
                        <h3>üí™ Coding Challenge: Refactor to Pure</h3>
                        <p>Convert this impure function into a pure one:</p>
                        <div class="code-block">
                            <pre>let discount = 0.1;
const applyDiscount = (price) => {
    return price - (price * discount);
};</pre>
                        </div>
                        <textarea class="code-editor" id="pure-challenge" placeholder="// Write your pure function here
const applyDiscount = (price, discount) => {
    
};"></textarea>
                        <button class="btn" onclick="app.checkPureChallenge()">Run Tests</button>
                        <div id="pure-test-results" class="output-box"></div>
                    </div>

                    <div class="success-box">
                        <h4>üéì Pro Interview Tip</h4>
                        <p>In interviews, mention: <em>"I prefer pure functions because they're easier to test, parallelize, and reason about. When I need side effects, I isolate them at the edges of my application."</em></p>
                    </div>

                    <button class="btn success" onclick="app.completeModule(0)" style="width: 100%; margin-top: 2rem;">
                        Complete Module (+100 XP)
                    </button>
                `;
            }

            demoPureFunction() {
                const output = document.getElementById('pure-output');
                const func = document.getElementById('pure-func');
                func.classList.add('active');
                output.textContent = '20';
                output.classList.add('transformed');
                setTimeout(() => {
                    func.classList.remove('active');
                }, 300);
            }

            demoImpureFunction() {
                const output = document.getElementById('impure-output');
                output.textContent = Math.floor(Math.random() * 100);
                output.style.borderColor = 'var(--accent-impure)';
            }

            checkQuiz(element, isCorrect, option) {
                // Reset others
                element.parentElement.querySelectorAll('.quiz-option').forEach(el => {
                    el.classList.remove('correct', 'wrong');
                    el.onclick = null;
                });

                if(isCorrect) {
                    element.classList.add('correct');
                    document.getElementById('quiz-feedback').innerHTML = 
                        '<span style="color: var(--accent-pure)">Correct! It has no side effects and depends only on inputs.</span>';
                    this.addXP(25);
                } else {
                    element.classList.add('wrong');
                    const reasons = {
                        'A': 'Depends on external variable externalVar',
                        'C': 'Mutates input array (side effect!)',
                        'D': 'Has side effect: console.log'
                    };
                    document.getElementById('quiz-feedback').innerHTML = 
                        `<span style="color: var(--accent-impure)">Incorrect! ${reasons[option]}</span>`;
                }
            }

            checkPureChallenge() {
                const code = document.getElementById('pure-challenge').value;
                const results = document.getElementById('pure-test-results');
                
                // Simple validation
                const hasDiscountParam = code.includes('discount') && code.includes('=>');
                const noExternalRef = !code.includes('let discount') && !code.includes('var discount');
                const returnsValue = code.includes('return');
                
                if(hasDiscountParam && noExternalRef && returnsValue) {
                    results.innerHTML = `<span style="color: var(--accent-pure)">
                        ‚úÖ Perfect! Your function is now pure.<br>
                        applyDiscount(100, 0.1) always returns 90<br>
                        applyDiscount(100, 0.2) always returns 80
                    </span>`;
                    this.addXP(50);
                } else {
                    results.innerHTML = `<span style="color: var(--accent-impure)">
                        ‚ùå Not quite. Make sure:<br>
                        1. discount is a parameter, not external variable<br>
                        2. You return the calculated value<br>
                        3. No external dependencies
                    </span>`;
                }
            }

            // Module 2: Immutability
            renderImmutability(container) {
                container.innerHTML = `
                    <div class="module-header">
                        <h2 class="module-title">Immutability Patterns</h2>
                        <p>Data that never changes. Predictable state management.</p>
                    </div>

                    <div class="concept-box">
                        <h3>üîí The Golden Rule</h3>
                        <p>Once created, data cannot be changed. Instead, we create new data structures with the modifications.</p>
                    </div>

                    <div class="visual-container">
                        <h3>Memory Reference Visualization</h3>
                        <div style="display: flex; justify-content: space-around; align-items: center; margin: 2rem 0;">
                            <div style="text-align: center;">
                                <div class="maybe-box value" id="orig-data">
                                    <div>Original</div>
                                    <code>{ count: 0 }</code>
                                    <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--accent-info);">0x1A2B</div>
                                </div>
                            </div>
                            <div style="font-size: 2rem;">‚Üí</div>
                            <div style="text-align: center;">
                                <div class="maybe-box null" id="mutated-data" style="display: none;">
                                    <div>Mutated (Bad!)</div>
                                    <code>{ count: 1 }</code>
                                    <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--accent-impure);">0x1A2B (same)</div>
                                </div>
                                <div class="maybe-box value" id="new-data">
                                    <div>New Copy (Good!)</div>
                                    <code>{ count: 1 }</code>
                                    <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--accent-pure);">0x3C4D (new)</div>
                                </div>
                            </div>
                        </div>
                        <button class="btn" onclick="app.toggleMutationDemo()">Toggle Mutation</button>
                    </div>

                    <div class="code-block impure">
                        <span class="code-label impure">MUTATION ‚ùå</span>
                        <pre>const user = { name: 'Alice', scores: [10, 20] };

// Don't do this!
user.name = 'Bob';                    // Direct mutation
user.scores.push(30);                 // Array mutation
Object.assign(user, { age: 25 });     // Object mutation</pre>
                    </div>

                    <div class="code-block pure">
                        <span class="code-label pure">IMMUTABLE ‚úÖ</span>
                        <pre>const user = { name: 'Alice', scores: [10, 20] };

// Do this instead!
const newUser = {
    ...user,
    name: 'Bob',
    scores: [...user.scores, 30],  // Spread creates new array
    age: 25
};

// Or use Object.freeze for deep protection (shallow only!)
const frozen = Object.freeze({ ...user });</pre>
                    </div>

                    <div class="pitfall">
                        <h4>‚ö†Ô∏è The Shallow Copy Trap</h4>
                        <div class="code-block">
                            <pre>const state = { 
    user: { name: 'Alice', prefs: { theme: 'dark' } } 
};

// This looks immutable but isn't!
const newState = { ...state };
newState.user.prefs.theme = 'light'; 
// Oops! state.user.prefs.theme is now 'light' too!</pre>
                        </div>
                        <p><strong>Solution:</strong> Use deep copy utilities or libraries like Immer, or manually spread at each level.</p>
                    </div>

                    <div class="interactive-demo">
                        <h3>üîç Exercise: Fix the Mutation</h3>
                        <p>This Redux reducer has a bug. Find and fix the mutation:</p>
                        <div class="code-block">
                            <pre>const todoReducer = (state, action) => {
    switch(action.type) {
        case 'ADD_TODO':
            state.todos.push(action.payload);
            return state;
        case 'TOGGLE_TODO':
            const todo = state.todos.find(t => t.id === action.id);
            todo.completed = !todo.completed;
            return state;
        default:
            return state;
    }
};</pre>
                        </div>
                        <button class="btn" onclick="document.getElementById('mutation-answer').classList.toggle('hidden')">
                            Show Solution
                        </button>
                        <div id="mutation-answer" class="hidden code-block pure" style="margin-top: 1rem;">
                            <pre>const todoReducer = (state, action) => {
    switch(action.type) {
        case 'ADD_TODO':
            return {
                ...state,
                todos: [...state.todos, action.payload]
            };
        case 'TOGGLE_TODO':
            return {
                ...state,
                todos: state.todos.map(t => 
                    t.id === action.id 
                        ? { ...t, completed: !t.completed }
                        : t
                )
            };
        default:
            return state;
    }
};</pre>
                        </div>
                    </div>

                    <div class="quiz-container">
                        <h3>üß© Quiz: Deep vs Shallow</h3>
                        <p>What's the output?</p>
                        <div class="code-block" style="text-align: left;">
                            <pre>const original = { a: { b: 1 } };
const copy = { ...original };
copy.a.b = 2;
console.log(original.a.b);</pre>
                        </div>
                        <div class="quiz-option" onclick="app.checkImmutabilityQuiz(this, false)">
                            1 (Unchanged)
                        </div>
                        <div class="quiz-option" onclick="app.checkImmutabilityQuiz(this, true)">
                            2 (Changed - shallow copy!)
                        </div>
                        <div id="immutability-feedback"></div>
                    </div>

                    <button class="btn success" onclick="app.completeModule(1)" style="width: 100%; margin-top: 2rem;">
                        Complete Module (+100 XP)
                    </button>
                `;
            }

            toggleMutationDemo() {
                const mutated = document.getElementById('mutated-data');
                const newData = document.getElementById('new-data');
                if(mutated.style.display === 'none') {
                    mutated.style.display = 'block';
                    newData.style.display = 'none';
                } else {
                    mutated.style.display = 'none';
                    newData.style.display = 'block';
                }
            }

            checkImmutabilityQuiz(element, isCorrect) {
                element.parentElement.querySelectorAll('.quiz-option').forEach(el => {
                    el.classList.remove('correct', 'wrong');
                    el.onclick = null;
                });
                
                if(isCorrect) {
                    element.classList.add('correct');
                    document.getElementById('immutability-feedback').innerHTML = 
                        '<span style="color: var(--accent-pure)">Right! Spread operator only does shallow copy. Nested objects are still referenced.</span>';
                    this.addXP(25);
                } else {
                    element.classList.add('wrong');
                    document.getElementById('immutability-feedback').innerHTML = 
                        '<span style="color: var(--accent-impure)">Nope! { ...original } only copies the first level. original.a and copy.a still point to same object.</span>';
                }
            }

            // Module 3: Composition
            renderComposition(container) {
                container.innerHTML = `
                    <div class="module-header">
                        <h2 class="module-title">Function Composition</h2>
                        <p>Building complex logic from simple, reusable pieces.</p>
                    </div>

                    <div class="concept-box">
                        <h3>üîó Unix Philosophy</h3>
                        <p>Small functions that do one thing well, combined to do complex things.</p>
                        <code>cat file.txt | grep "error" | wc -l</code>
                        <p style="margin-top: 1rem;">In JS: <code>countErrors(readFile('logs.txt'))</code></p>
                    </div>

                    <div class="visual-container">
                        <h3>Data Pipeline Visualization</h3>
                        <div class="data-flow">
                            <div class="data-node">"hello"</div>
                            <div class="connector"></div>
                            <div class="data-node">toUpper</div>
                            <div class="connector"></div>
                            <div class="data-node">"HELLO"</div>
                            <div class="connector"></div>
                            <div class="data-node">exclaim</div>
                            <div class="connector"></div>
                            <div class="data-node">"HELLO!"</div>
                            <div class="connector"></div>
                            <div class="data-node">repeat(2)</div>
                            <div class="connector"></div>
                            <div class="data-node transformed">"HELLO! HELLO!"</div>
                        </div>
                        <button class="btn" onclick="app.animatePipeline()">Animate Flow</button>
                    </div>

                    <div class="code-block pure">
                        <span class="code-label pure">COMPOSE (Right to Left)</span>
                        <pre>// Mathematical composition: f(g(x))
const compose = (...fns) => (x) => 
    fns.reduceRight((acc, fn) => fn(acc), x);

const scream = compose(
    repeat(2),      // Last
    exclaim,
    toUpper         // First
);

scream('hello'); // "HELLO! HELLO!"</pre>
                    </div>

                    <div class="code-block pure">
                        <span class="code-label pure">PIPE (Left to Right)</span>
                        <pre>// More readable for JS devs (like Unix pipes)
const pipe = (...fns) => (x) => 
    fns.reduce((acc, fn) => fn(acc), x);

const scream = pipe(
    toUpper,        // First
    exclaim,
    repeat(2)       // Last
);

// Or using lodash/fp or Ramda...</pre>
                    </div>

                    <div class="pitfall">
                        <h4>‚ö†Ô∏è Arity Mismatch</h4>
                        <p>Composition works best with unary functions (one argument). What happens when functions expect different numbers of arguments?</p>
                        <div class="code-block">
                            <pre>// Bad: map expects 3 args (value, index, array)
const badCompose = pipe(
    arr => arr.map(parseInt), // parseInt('10', 0) -> 10, parseInt('10', 1) -> NaN!
    sum
);

// Good: Make it unary
const goodCompose = pipe(
    arr => arr.map(x => parseInt(x, 10)),
    sum
);</pre>
                        </div>
                    </div>

                    <div class="interactive-demo">
                        <h3>üéÆ Composition Builder</h3>
                        <p>Drag to reorder these functions to transform: <code>"functional"</code> ‚Üí <code>"FUNCTIONAL!!!"</code></p>
                        <div class="composition-playground" id="pipe-container">
                            <div class="pipe-segment" draggable="true" data-fn="toUpper">toUpper</div>
                            <div class="pipe-segment" draggable="true" data-fn="addExclamation">addExclamation(3)</div>
                            <div class="pipe-segment" draggable="true" data-fn="trim">trim</div>
                        </div>
                        <button class="btn" onclick="app.checkComposition()">Test Pipeline</button>
                        <div id="composition-result" class="output-box"></div>
                    </div>

                    <div class="success-box">
                        <h4>üéØ Point-Free Style (Tacit Programming)</h4>
                        <p>Functions without explicitly mentioning their arguments:</p>
                        <div class="code-block">
                            <pre>// Not point-free
const isValid = (user) => hasName(user) && hasEmail(user);

// Point-free (cleaner!)
const isValid = both(hasName, hasEmail);</pre>
                        </div>
                        <p>Warning: Don't overdo it! Readability > Brevity in interviews.</p>
                    </div>

                    <button class="btn success" onclick="app.completeModule(2)" style="width: 100%; margin-top: 2rem;">
                        Complete Module (+100 XP)
                    </button>
                `;

                this.initDragAndDrop();
            }

            animatePipeline() {
                const nodes = document.querySelectorAll('.data-node');
                nodes.forEach((node, index) => {
                    setTimeout(() => {
                        node.style.transform = 'scale(1.2)';
                        node.style.borderColor = 'var(--accent-pure)';
                        setTimeout(() => {
                            node.style.transform = 'scale(1)';
                        }, 300);
                    }, index * 400);
                });
            }

            initDragAndDrop() {
                setTimeout(() => {
                    const items = document.querySelectorAll('.pipe-segment');
                    items.forEach(item => {
                        item.addEventListener('dragstart', (e) => {
                            e.target.classList.add('dragging');
                        });
                        item.addEventListener('dragend', (e) => {
                            e.target.classList.remove('dragging');
                        });
                        item.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            const container = document.getElementById('pipe-container');
                            const afterElement = this.getDragAfterElement(container, e.clientY);
                            const draggable = document.querySelector('.dragging');
                            if(afterElement == null) {
                                container.appendChild(draggable);
                            } else {
                                container.insertBefore(draggable, afterElement);
                            }
                        });
                    });
                }, 100);
            }

            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.pipe-segment:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if(offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            checkComposition() {
                const items = document.querySelectorAll('.pipe-segment');
                const order = Array.from(items).map(item => item.getAttribute('data-fn'));
                const result = document.getElementById('composition-result');
                
                if(order[0] === 'trim' && order[1] === 'toUpper' && order[2] === 'addExclamation') {
                    result.innerHTML = '<span style="color: var(--accent-pure)">‚úÖ Correct! "functional" ‚Üí "FUNCTIONAL!!!"</span>';
                    this.addXP(50);
                } else {
                    result.innerHTML = '<span style="color: var(--accent-impure)">‚ùå Try again. Hint: Trim first, then uppercase, then exclaim.</span>';
                }
            }

            // Module 4: Functors & Monads
            renderFunctorsMonads(container) {
                container.innerHTML = `
                    <div class="module-header">
                        <h2 class="module-title">Functors & Monads</h2>
                        <p>Handling nulls, errors, and context without try/catch hell.</p>
                    </div>

                    <div class="concept-box">
                        <h3>üì¶ The Box Analogy</h3>
                        <p>A <strong>Functor</strong> is a container that implements <code>map</code>.</p>
                        <p>A <strong>Monad</strong> is a functor that implements <code>flatMap</code> (or <code>chain</code>).</p>
                    </div>

                    <div class="visual-container">
                        <h3>Maybe Monad: Null Safety</h3>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 2rem; flex-wrap: wrap; margin: 2rem 0;">
                            <div class="maybe-box value">
                                <div>Just(5)</div>
                                <div style="font-size: 0.8rem; margin-top: 0.5rem;">.map(x => x * 2)</div>
                                <div style="font-size: 1.5rem; margin-top: 0.5rem;">‚Üí</div>
                                <div>Just(10)</div>
                            </div>
                            <div class="maybe-box null">
                                <div>Nothing</div>
                                <div style="font-size: 0.8rem; margin-top: 0.5rem;">.map(x => x * 2)</div>
                                <div style="font-size: 1.5rem; margin-top: 0.5rem;">‚Üí</div>
                                <div>Nothing</div>
                            </div>
                        </div>
                        <p>No null pointer exceptions!</p>
                    </div>

                    <div class="code-block pure">
                        <span class="code-label pure">MAYBE IMPLEMENTATION</span>
                        <pre>class Maybe {
    constructor(value) {
        this.value = value;
    }
    
    static of(value) {
        return new Maybe(value);
    }
    
    isNothing() {
        return this.value === null || this.value === undefined;
    }
    
    map(fn) {
        return this.isNothing() 
            ? Maybe.of(null) 
            : Maybe.of(fn(this.value));
    }
    
    // Monad method
    chain(fn) {
        return this.map(fn).join();
    }
    
    join() {
        return this.isNothing() ? Maybe.of(null) : this.value;
    }
}

// Usage
const user = { address: { street: { name: 'Main St' } } };

Maybe.of(user)
    .map(u => u.address)
    .map(a => a.street)
    .map(s => s.name)
    .map(console.log); // 'Main St' or graceful nothing</pre>
                    </div>

                    <div class="code-block pure">
                        <span class="code-label pure">EITHER MONAD (Error Handling)</span>
                        <pre>class Either {
    constructor(left, right) {
        this.left = left;
        this.right = right;
    }
    
    static Right(value) {
        return new Either(null, value);
    }
    
    static Left(error) {
        return new Either(error, null);
    }
    
    map(fn) {
        return this.right 
            ? Either.Right(fn(this.right))
            : this;
    }
    
    fold(leftFn, rightFn) {
        return this.right ? rightFn(this.right) : leftFn(this.left);
    }
}

// Instead of try/catch
const parseJSON = (str) => {
    try {
        return Either.Right(JSON.parse(str));
    } catch(e) {
        return Either.Left('Invalid JSON');
    }
};

parseJSON('{"a":1}')
    .map(x => x.a)
    .fold(
        err => console.error(err),
        val => console.log(val)
    );</pre>
                    </div>

                    <div class="pitfall">
                        <h4>‚ö†Ô∏è Monad Laws (Don't break them!)</h4>
                        <ol style="margin-top: 1rem; padding-left: 1.5rem;">
                            <li><strong>Left Identity:</strong> <code>Monad.of(x).chain(f)</code> ‚â° <code>f(x)</code></li>
                            <li><strong>Right Identity:</strong> <code>m.chain(Monad.of)</code> ‚â° <code>m</code></li>
                            <li><strong>Associativity:</strong> Chaining order shouldn't matter</li>
                        </ol>
                        <p>Breaking these makes your monads unpredictable!</p>
                    </div>

                    <div class="interactive-demo">
                        <h3>üéÆ Safe Navigation Challenge</h3>
                        <p>Refactor this unsafe code using Maybe:</p>
                        <div class="code-block impure">
                            <pre>const getStreetName = (user) => {
    return user.address.street.name; // Crashes if any part is null!
};</pre>
                        </div>
                        <textarea class="code-editor" id="monad-challenge" placeholder="// Use Maybe to safely get street name
const getStreetName = (user) => {
    
};"></textarea>
                        <button class="btn" onclick="app.checkMonadChallenge()">Validate</button>
                        <div id="monad-result" class="output-box"></div>
                    </div>

                    <div class="quiz-container">
                        <h3>üß† Monad vs Functor</h3>
                        <p>What distinguishes a Monad from a Functor?</p>
                        <div class="quiz-option" onclick="app.checkMonadQuiz(this, false)">
                            Monads can hold multiple values, Functors only one
                        </div>
                        <div class="quiz-option" onclick="app.checkMonadQuiz(this, true)">
                            Monads have flatMap/chain to flatten nested contexts
                        </div>
                        <div class="quiz-option" onclick="app.checkMonadQuiz(this, false)">
                            Functors are synchronous, Monads are asynchronous
                        </div>
                        <div id="monad-quiz-feedback"></div>
                    </div>

                    <div class="success-box">
                        <h4>üèÜ Interview Gold</h4>
                        <p>When asked about error handling, mention: <em>"I prefer using Either monads or Maybe types over throwing exceptions because they make error handling explicit in the type signature and prevent runtime surprises."</em></p>
                        <p>Real-world: <code>Promise</code> is a monad! It has <code>then</code> (map) and <code>then</code> (chain/flatMap).</p>
                    </div>

                    <button class="btn success" onclick="app.completeModule(3)" style="width: 100%; margin-top: 2rem;">
                        Complete Module (+100 XP)
                    </button>
                `;
            }

            checkMonadChallenge() {
                const code = document.getElementById('monad-challenge').value;
                const result = document.getElementById('monad-result');
                
                const hasMaybe = code.includes('Maybe') || code.includes('map');
                const hasChain = code.includes('chain') || code.includes('flatMap');
                const returnsSomething = code.includes('return');
                
                if(hasMaybe && returnsSomething) {
                    result.innerHTML = `<span style="color: var(--accent-pure)">
                        ‚úÖ Excellent! You handled null safety functionally.<br>
                        Remember: getStreetName(null) now returns Maybe(null) instead of throwing!
                    </span>`;
                    this.addXP(50);
                } else {
                    result.innerHTML = `<span style="color: var(--accent-impure)">
                        ‚ùå Hint: Use Maybe.of(user).map(u => u.address)...
                    </span>`;
                }
            }

            checkMonadQuiz(element, isCorrect) {
                element.parentElement.querySelectorAll('.quiz-option').forEach(el => {
                    el.classList.remove('correct', 'wrong');
                    el.onclick = null;
                });
                
                if(isCorrect) {
                    element.classList.add('correct');
                    document.getElementById('monad-quiz-feedback').innerHTML = 
                        '<span style="color: var(--accent-pure)">Exactly! Monads can flatten nested contexts like Maybe(Maybe(5)) into Maybe(5).</span>';
                    this.addXP(25);
                } else {
                    element.classList.add('wrong');
                    document.getElementById('monad-quiz-feedback').innerHTML = 
                        '<span style="color: var(--accent-impure)">Not quite. Arrays are Functors (map) and Monads (flatMap), so it\'s not about multiple values.</span>';
                }
            }

            resetProgress() {
                if(confirm('Reset all progress?')) {
                    localStorage.removeItem('fp_xp');
                    localStorage.removeItem('fp_completed');
                    localStorage.removeItem('fp_progress');
                    location.reload();
                }
            }
        }

        // Initialize app
        const app = new FPApp();
    </script>
</body>
</html>