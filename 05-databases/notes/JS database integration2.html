<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JS Database Mastery - Interactive Learning</title>
<style>
/* ============ CSS RESET & VARIABLES ============ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2235;
  --bg-code: #0d1117;
  --accent-mongo: #00ed64;
  --accent-postgres: #336791;
  --accent-orange: #f97316;
  --accent-purple: #a855f7;
  --accent-cyan: #06b6d4;
  --accent-pink: #ec4899;
  --accent-red: #ef4444;
  --accent-yellow: #eab308;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #1e293b;
  --border-active: #334155;
  --success: #22c55e;
  --error: #ef4444;
  --warning: #f59e0b;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --transition: all 0.3s ease;
}
html { scroll-behavior: smooth; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.7;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ============ SCROLLBAR ============ */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border-active); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ============ HEADER ============ */
.header {
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
  border-bottom: 1px solid var(--border);
  padding: 20px 0;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(20px);
}
.header-inner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 30px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 1.4rem;
  font-weight: 800;
}
.logo-icon {
  width: 42px; height: 42px;
  background: linear-gradient(135deg, var(--accent-mongo), var(--accent-cyan));
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}
.progress-bar-header {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.85rem;
  color: var(--text-secondary);
}
.progress-track {
  width: 200px;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-mongo), var(--accent-cyan));
  border-radius: 4px;
  transition: width 0.5s ease;
  width: 0%;
}
.xp-badge {
  background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
  padding: 4px 14px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 0.85rem;
}

/* ============ LAYOUT ============ */
.app-layout {
  display: flex;
  max-width: 1400px;
  margin: 0 auto;
  min-height: calc(100vh - 82px);
}

/* ============ SIDEBAR NAV ============ */
.sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  padding: 20px 0;
  overflow-y: auto;
  max-height: calc(100vh - 82px);
  position: sticky;
  top: 82px;
}
.nav-section-title {
  padding: 8px 24px;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  font-weight: 700;
  margin-top: 16px;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 24px;
  cursor: pointer;
  transition: var(--transition);
  border-left: 3px solid transparent;
  font-size: 0.9rem;
  color: var(--text-secondary);
  position: relative;
}
.nav-item:hover {
  background: rgba(255,255,255,0.03);
  color: var(--text-primary);
}
.nav-item.active {
  background: rgba(0, 237, 100, 0.05);
  border-left-color: var(--accent-mongo);
  color: var(--accent-mongo);
}
.nav-item.completed::after {
  content: '‚úì';
  position: absolute;
  right: 16px;
  color: var(--success);
  font-weight: 700;
}
.nav-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  flex-shrink: 0;
}
.nav-icon.mongo { background: rgba(0, 237, 100, 0.15); }
.nav-icon.postgres { background: rgba(51, 103, 145, 0.3); }
.nav-icon.general { background: rgba(168, 85, 247, 0.15); }
.nav-icon.quiz { background: rgba(249, 115, 22, 0.15); }
.nav-icon.pitfall { background: rgba(239, 68, 68, 0.15); }
.nav-icon.exercise { background: rgba(6, 182, 212, 0.15); }

/* ============ MAIN CONTENT ============ */
.main-content {
  flex: 1;
  padding: 30px 40px;
  overflow-y: auto;
  max-height: calc(100vh - 82px);
}
.section { display: none; animation: fadeIn 0.4s ease; }
.section.active { display: block; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============ SECTION HEADERS ============ */
.section-header {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}
.section-header h1 {
  font-size: 2rem;
  font-weight: 800;
  margin-bottom: 8px;
  background: linear-gradient(135deg, var(--text-primary), var(--accent-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.section-header p {
  color: var(--text-secondary);
  font-size: 1.05rem;
}
.badge-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
.badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
}
.badge.mongo { background: rgba(0,237,100,0.15); color: var(--accent-mongo); }
.badge.postgres { background: rgba(51,103,145,0.3); color: #5b9bd5; }
.badge.intermediate { background: rgba(249,115,22,0.15); color: var(--accent-orange); }
.badge.advanced { background: rgba(168,85,247,0.15); color: var(--accent-purple); }
.badge.beginner { background: rgba(6,182,212,0.15); color: var(--accent-cyan); }

/* ============ CARDS ============ */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 24px;
  transition: var(--transition);
}
.card:hover { border-color: var(--border-active); }
.card h2 {
  font-size: 1.3rem;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.card h3 {
  font-size: 1.1rem;
  margin: 20px 0 12px;
  color: var(--accent-cyan);
}
.card p, .card li {
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.card ul, .card ol {
  padding-left: 20px;
  margin-bottom: 16px;
}
.card li { margin-bottom: 6px; }

/* ============ CODE BLOCKS ============ */
.code-block {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin: 16px 0;
  overflow-x: auto;
  position: relative;
}
.code-block pre {
  font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  line-height: 1.8;
  white-space: pre;
  color: var(--text-primary);
}
.code-label {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 700;
}
.code-label.mongo { background: rgba(0,237,100,0.2); color: var(--accent-mongo); }
.code-label.postgres { background: rgba(51,103,145,0.4); color: #5b9bd5; }
.code-label.js { background: rgba(234,179,8,0.2); color: var(--accent-yellow); }
.code-label.sql { background: rgba(168,85,247,0.2); color: var(--accent-purple); }
.code-label.bad { background: rgba(239,68,68,0.2); color: var(--accent-red); }
.code-label.good { background: rgba(34,197,94,0.2); color: var(--success); }

/* Syntax highlighting */
.kw { color: #c678dd; }
.str { color: #98c379; }
.num { color: #d19a66; }
.cm { color: #5c6370; font-style: italic; }
.fn { color: #61afef; }
.op { color: #56b6c2; }
.var { color: #e5c07b; }
.prop { color: #e06c75; }
.type { color: #e5c07b; }
.key { color: #e06c75; }
.builtin { color: #56b6c2; }

/* ============ INTERACTIVE CODE EDITOR ============ */
.editor-container {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin: 16px 0;
}
.editor-header {
  background: rgba(255,255,255,0.03);
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.editor-title {
  font-size: 0.8rem;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 8px;
}
.editor-dots {
  display: flex;
  gap: 6px;
}
.editor-dots span {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.editor-dots span:nth-child(1) { background: #ef4444; }
.editor-dots span:nth-child(2) { background: #eab308; }
.editor-dots span:nth-child(3) { background: #22c55e; }
.code-textarea {
  width: 100%;
  min-height: 200px;
  background: transparent;
  border: none;
  padding: 20px;
  font-family: 'Cascadia Code', 'Fira Code', monospace;
  font-size: 0.85rem;
  color: var(--text-primary);
  resize: vertical;
  outline: none;
  line-height: 1.8;
  tab-size: 2;
}
.editor-actions {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
  align-items: center;
}
.btn {
  padding: 8px 20px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-run {
  background: linear-gradient(135deg, var(--accent-mongo), #10b981);
  color: #000;
}
.btn-run:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,237,100,0.3); }
.btn-reset {
  background: var(--border);
  color: var(--text-secondary);
}
.btn-reset:hover { background: var(--border-active); }
.btn-hint {
  background: rgba(249,115,22,0.15);
  color: var(--accent-orange);
}
.btn-hint:hover { background: rgba(249,115,22,0.25); }
.btn-check {
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
  color: #fff;
}
.btn-check:hover { transform: translateY(-1px); }
.output-panel {
  background: rgba(0,0,0,0.3);
  border-top: 1px solid var(--border);
  padding: 16px 20px;
  font-family: 'Cascadia Code', monospace;
  font-size: 0.82rem;
  min-height: 60px;
  white-space: pre-wrap;
  color: var(--text-secondary);
  max-height: 250px;
  overflow-y: auto;
}
.output-panel .output-success { color: var(--success); }
.output-panel .output-error { color: var(--error); }
.output-panel .output-info { color: var(--accent-cyan); }
.output-panel .output-data { color: var(--accent-yellow); }
.output-panel .output-warn { color: var(--warning); }

/* ============ DB SIMULATOR ============ */
.db-simulator {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  margin: 16px 0;
}
.db-sim-header {
  background: rgba(0,237,100,0.05);
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.db-sim-title {
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--accent-mongo);
  display: flex;
  align-items: center;
  gap: 8px;
}
.db-sim-status {
  font-size: 0.75rem;
  padding: 3px 10px;
  border-radius: 12px;
  background: rgba(34,197,94,0.15);
  color: var(--success);
}
.db-tables {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  padding: 16px;
}
.db-table-card {
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px;
}
.db-table-name {
  font-weight: 700;
  font-size: 0.85rem;
  color: var(--accent-cyan);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.db-record {
  font-size: 0.75rem;
  color: var(--text-muted);
  padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.03);
  font-family: monospace;
}
.db-record:last-child { border-bottom: none; }
.db-record-count {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 6px;
}

/* ============ QUIZ ============ */
.quiz-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  margin: 16px 0;
}
.quiz-progress {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  font-size: 0.8rem;
  color: var(--text-muted);
}
.quiz-progress-dots {
  display: flex;
  gap: 4px;
}
.quiz-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--border);
  transition: var(--transition);
}
.quiz-dot.current { background: var(--accent-cyan); box-shadow: 0 0 8px rgba(6,182,212,0.4); }
.quiz-dot.correct { background: var(--success); }
.quiz-dot.wrong { background: var(--error); }
.quiz-question {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 20px;
  line-height: 1.6;
}
.quiz-question code {
  background: var(--bg-code);
  padding: 2px 8px;
  border-radius: 4px;
  font-family: 'Cascadia Code', monospace;
  font-size: 0.9rem;
  color: var(--accent-yellow);
}
.quiz-options { display: flex; flex-direction: column; gap: 10px; }
.quiz-option {
  padding: 14px 18px;
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}
.quiz-option:hover { border-color: var(--accent-cyan); background: rgba(6,182,212,0.05); }
.quiz-option.selected { border-color: var(--accent-cyan); background: rgba(6,182,212,0.1); }
.quiz-option.correct { border-color: var(--success); background: rgba(34,197,94,0.1); }
.quiz-option.wrong { border-color: var(--error); background: rgba(239,68,68,0.1); }
.quiz-option.disabled { pointer-events: none; }
.quiz-option-letter {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background: var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.75rem;
  flex-shrink: 0;
}
.quiz-option.correct .quiz-option-letter { background: var(--success); color: #000; }
.quiz-option.wrong .quiz-option-letter { background: var(--error); color: #fff; }
.quiz-explanation {
  margin-top: 16px;
  padding: 14px 18px;
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  line-height: 1.6;
  display: none;
}
.quiz-explanation.show { display: block; }
.quiz-explanation.correct-exp {
  background: rgba(34,197,94,0.1);
  border: 1px solid rgba(34,197,94,0.3);
  color: #86efac;
}
.quiz-explanation.wrong-exp {
  background: rgba(239,68,68,0.1);
  border: 1px solid rgba(239,68,68,0.3);
  color: #fca5a5;
}
.quiz-nav {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}
.quiz-score {
  text-align: center;
  padding: 30px;
}
.quiz-score h2 { font-size: 1.5rem; margin-bottom: 10px; }
.quiz-score .score-number {
  font-size: 3rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--accent-mongo), var(--accent-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ============ PITFALL BOX ============ */
.pitfall-box {
  background: rgba(239,68,68,0.05);
  border: 1px solid rgba(239,68,68,0.2);
  border-left: 4px solid var(--accent-red);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin: 16px 0;
}
.pitfall-box h4 {
  color: var(--accent-red);
  font-size: 0.95rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.pitfall-box p { color: var(--text-secondary); font-size: 0.9rem; }

.tip-box {
  background: rgba(34,197,94,0.05);
  border: 1px solid rgba(34,197,94,0.2);
  border-left: 4px solid var(--success);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin: 16px 0;
}
.tip-box h4 {
  color: var(--success);
  font-size: 0.95rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.tip-box p { color: var(--text-secondary); font-size: 0.9rem; }

.info-box {
  background: rgba(6,182,212,0.05);
  border: 1px solid rgba(6,182,212,0.2);
  border-left: 4px solid var(--accent-cyan);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin: 16px 0;
}
.info-box h4 {
  color: var(--accent-cyan);
  font-size: 0.95rem;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.info-box p { color: var(--text-secondary); font-size: 0.9rem; }

.warning-box {
  background: rgba(245,158,11,0.05);
  border: 1px solid rgba(245,158,11,0.2);
  border-left: 4px solid var(--warning);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin: 16px 0;
}
.warning-box h4 {
  color: var(--warning);
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}

/* ============ COMPARISON TABLE ============ */
.comparison-table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  font-size: 0.85rem;
}
.comparison-table th {
  background: rgba(255,255,255,0.05);
  padding: 12px 16px;
  text-align: left;
  border-bottom: 2px solid var(--border);
  color: var(--accent-cyan);
  font-weight: 700;
}
.comparison-table td {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  color: var(--text-secondary);
}
.comparison-table tr:hover td {
  background: rgba(255,255,255,0.02);
}
.comparison-table code {
  background: var(--bg-code);
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.8rem;
  color: var(--accent-yellow);
}

/* ============ TABS ============ */
.tab-container { margin: 16px 0; }
.tab-buttons {
  display: flex;
  border-bottom: 1px solid var(--border);
  gap: 0;
  overflow-x: auto;
}
.tab-btn {
  padding: 10px 20px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: var(--transition);
  white-space: nowrap;
}
.tab-btn:hover { color: var(--text-primary); }
.tab-btn.active {
  color: var(--accent-cyan);
  border-bottom-color: var(--accent-cyan);
}
.tab-panel { display: none; padding-top: 16px; }
.tab-panel.active { display: block; }

/* ============ SCHEMA VISUALIZER ============ */
.schema-viz {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin: 16px 0;
  justify-content: center;
}
.schema-entity {
  background: var(--bg-code);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  min-width: 220px;
  overflow: hidden;
}
.schema-entity-header {
  padding: 10px 16px;
  font-weight: 700;
  font-size: 0.9rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
}
.schema-entity-header.mongo-h { background: rgba(0,237,100,0.1); color: var(--accent-mongo); }
.schema-entity-header.pg-h { background: rgba(51,103,145,0.2); color: #5b9bd5; }
.schema-field {
  padding: 6px 16px;
  font-family: monospace;
  font-size: 0.8rem;
  display: flex;
  justify-content: space-between;
  gap: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.schema-field-name { color: var(--accent-yellow); }
.schema-field-type { color: var(--text-muted); }
.schema-field.pk { background: rgba(249,115,22,0.08); }
.schema-field.fk { background: rgba(168,85,247,0.08); }
.schema-relation {
  display: flex;
  align-items: center;
  font-size: 2rem;
  color: var(--text-muted);
  align-self: center;
}

/* ============ EXERCISE CHALLENGE ============ */
.challenge-box {
  background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(6,182,212,0.1));
  border: 1px solid rgba(168,85,247,0.2);
  border-radius: var(--radius);
  padding: 24px;
  margin: 16px 0;
}
.challenge-box h3 {
  color: var(--accent-purple);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.challenge-requirements {
  list-style: none;
  padding: 0;
}
.challenge-requirements li {
  padding: 6px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  color: var(--text-secondary);
}
.challenge-requirements li::before {
  content: '‚óã';
  color: var(--text-muted);
  font-weight: 700;
}
.challenge-requirements li.done::before {
  content: '‚óè';
  color: var(--success);
}

/* ============ STEP LIST ============ */
.steps {
  counter-reset: step;
  list-style: none;
  padding: 0;
}
.steps li {
  counter-increment: step;
  padding: 12px 0 12px 48px;
  position: relative;
  color: var(--text-secondary);
  border-left: 2px solid var(--border);
  margin-left: 14px;
}
.steps li::before {
  content: counter(step);
  position: absolute;
  left: -14px;
  top: 10px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 2px solid var(--accent-cyan);
  color: var(--accent-cyan);
  font-size: 0.75rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ============ NOTIFICATION / TOAST ============ */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-size: 0.9rem;
  font-weight: 600;
  z-index: 1000;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
}
.toast.show {
  transform: translateY(0);
  opacity: 1;
}
.toast.success { background: var(--success); color: #000; }
.toast.error { background: var(--error); color: #fff; }
.toast.info { background: var(--accent-cyan); color: #000; }
.toast.xp { background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink)); color: #fff; }

/* ============ MOBILE ============ */
.sidebar-toggle {
  display: none;
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 200;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--accent-mongo);
  color: #000;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,237,100,0.3);
}
@media (max-width: 900px) {
  .sidebar {
    position: fixed;
    left: -300px;
    top: 0;
    height: 100vh;
    z-index: 150;
    transition: left 0.3s ease;
    padding-top: 100px;
  }
  .sidebar.open { left: 0; }
  .sidebar-toggle { display: flex; align-items: center; justify-content: center; }
  .main-content { padding: 20px; }
  .header-inner { padding: 0 16px; }
  .progress-track { width: 100px; }
  .schema-viz { flex-direction: column; align-items: center; }
  .schema-relation { transform: rotate(90deg); }
}

/* ============ INTERACTIVE FILL IN ============ */
.fill-blank {
  display: inline-block;
  min-width: 120px;
  border-bottom: 2px dashed var(--accent-cyan);
  padding: 2px 4px;
  margin: 0 4px;
  font-family: monospace;
  font-size: 0.9rem;
}
.fill-blank input {
  background: transparent;
  border: none;
  color: var(--accent-yellow);
  font-family: monospace;
  font-size: 0.85rem;
  width: 100%;
  outline: none;
}
.fill-blank.correct { border-bottom-color: var(--success); }
.fill-blank.wrong { border-bottom-color: var(--error); }

/* ============ ANIMATED DB FLOW ============ */
.flow-diagram {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin: 20px 0;
  flex-wrap: wrap;
  padding: 20px;
  background: var(--bg-code);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}
.flow-box {
  padding: 12px 20px;
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  font-weight: 700;
  text-align: center;
  min-width: 100px;
}
.flow-box.app { background: rgba(168,85,247,0.2); color: var(--accent-purple); border: 1px solid rgba(168,85,247,0.3); }
.flow-box.driver { background: rgba(6,182,212,0.2); color: var(--accent-cyan); border: 1px solid rgba(6,182,212,0.3); }
.flow-box.db { background: rgba(0,237,100,0.2); color: var(--accent-mongo); border: 1px solid rgba(0,237,100,0.3); }
.flow-arrow {
  font-size: 1.2rem;
  color: var(--text-muted);
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

/* ============ SECTION-SPECIFIC ============ */
.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
@media (max-width: 800px) {
  .two-col { grid-template-columns: 1fr; }
}
.highlight { color: var(--accent-mongo); font-weight: 600; }
.highlight-pg { color: #5b9bd5; font-weight: 600; }
.highlight-warn { color: var(--accent-orange); font-weight: 600; }
.inline-code {
  background: var(--bg-code);
  padding: 2px 8px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 0.85rem;
  color: var(--accent-yellow);
}

/* Completion animation */
@keyframes celebrate {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
.celebrate { animation: celebrate 0.5s ease; }
</style>
</head>
<body>

<!-- ============ HEADER ============ -->
<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">üóÑÔ∏è</div>
      <span>DB Mastery</span>
    </div>
    <div class="progress-bar-header">
      <span id="progressText">0% Complete</span>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="xp-badge" id="xpBadge">0 XP</div>
    </div>
  </div>
</header>

<!-- ============ SIDEBAR TOGGLE (MOBILE) ============ -->
<button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- ============ APP LAYOUT ============ -->
<div class="app-layout">

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="nav-section-title">üìñ Foundations</div>
    <div class="nav-item active" data-section="intro" onclick="navigateTo('intro', this)">
      <div class="nav-icon general">üìã</div>
      Overview & Setup
    </div>
    <div class="nav-item" data-section="connection" onclick="navigateTo('connection', this)">
      <div class="nav-icon general">üîå</div>
      Database Connection
    </div>

    <div class="nav-section-title">üçÉ MongoDB</div>
    <div class="nav-item" data-section="mongo-setup" onclick="navigateTo('mongo-setup', this)">
      <div class="nav-icon mongo">‚öôÔ∏è</div>
      MongoDB Setup
    </div>
    <div class="nav-item" data-section="mongo-crud" onclick="navigateTo('mongo-crud', this)">
      <div class="nav-icon mongo">üìù</div>
      MongoDB CRUD
    </div>
    <div class="nav-item" data-section="mongo-schema" onclick="navigateTo('mongo-schema', this)">
      <div class="nav-icon mongo">üìê</div>
      Mongoose Schema
    </div>
    <div class="nav-item" data-section="mongo-advanced" onclick="navigateTo('mongo-advanced', this)">
      <div class="nav-icon mongo">üöÄ</div>
      Aggregation & Indexing
    </div>

    <div class="nav-section-title">üêò PostgreSQL</div>
    <div class="nav-item" data-section="pg-setup" onclick="navigateTo('pg-setup', this)">
      <div class="nav-icon postgres">‚öôÔ∏è</div>
      PostgreSQL Setup
    </div>
    <div class="nav-item" data-section="pg-crud" onclick="navigateTo('pg-crud', this)">
      <div class="nav-icon postgres">üìù</div>
      PostgreSQL CRUD
    </div>
    <div class="nav-item" data-section="pg-schema" onclick="navigateTo('pg-schema', this)">
      <div class="nav-icon postgres">üìê</div>
      Schema & Migrations
    </div>
    <div class="nav-item" data-section="pg-advanced" onclick="navigateTo('pg-advanced', this)">
      <div class="nav-icon postgres">üöÄ</div>
      Joins & Query Optimization
    </div>

    <div class="nav-section-title">üß† Design Patterns</div>
    <div class="nav-item" data-section="schema-design" onclick="navigateTo('schema-design', this)">
      <div class="nav-icon general">üèóÔ∏è</div>
      Schema Design Patterns
    </div>
    <div class="nav-item" data-section="optimization" onclick="navigateTo('optimization', this)">
      <div class="nav-icon general">‚ö°</div>
      Query Optimization
    </div>

    <div class="nav-section-title">üéØ Practice</div>
    <div class="nav-item" data-section="exercise1" onclick="navigateTo('exercise1', this)">
      <div class="nav-icon exercise">üí™</div>
      Exercise: Build API
    </div>
    <div class="nav-item" data-section="exercise2" onclick="navigateTo('exercise2', this)">
      <div class="nav-icon exercise">üí™</div>
      Exercise: Schema Design
    </div>
    <div class="nav-item" data-section="simulator" onclick="navigateTo('simulator', this)">
      <div class="nav-icon exercise">üñ•Ô∏è</div>
      DB Simulator
    </div>

    <div class="nav-section-title">‚ö†Ô∏è Pitfalls & Quizzes</div>
    <div class="nav-item" data-section="pitfalls" onclick="navigateTo('pitfalls', this)">
      <div class="nav-icon pitfall">üíÄ</div>
      Common Mistakes
    </div>
    <div class="nav-item" data-section="quiz1" onclick="navigateTo('quiz1', this)">
      <div class="nav-icon quiz">‚ùì</div>
      Quiz: MongoDB
    </div>
    <div class="nav-item" data-section="quiz2" onclick="navigateTo('quiz2', this)">
      <div class="nav-icon quiz">‚ùì</div>
      Quiz: PostgreSQL
    </div>
    <div class="nav-item" data-section="quiz3" onclick="navigateTo('quiz3', this)">
      <div class="nav-icon quiz">‚ùì</div>
      Quiz: Design & Optimization
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main-content" id="mainContent">

    <!-- ==================== SECTION: INTRO ==================== -->
    <div class="section active" id="section-intro">
      <div class="section-header">
        <h1>Database Integration with JavaScript</h1>
        <p>Master connecting, querying, and designing databases for production-grade applications</p>
        <div class="badge-row">
          <span class="badge mongo">MongoDB</span>
          <span class="badge postgres">PostgreSQL</span>
          <span class="badge beginner">Beginner ‚Üí Advanced</span>
        </div>
      </div>

      <div class="card">
        <h2>üéØ What You'll Master</h2>
        <div class="two-col">
          <div>
            <h3>Core Skills</h3>
            <ul>
              <li>Database connections & connection pooling</li>
              <li>Full CRUD operations (Create, Read, Update, Delete)</li>
              <li>Schema design patterns for both SQL & NoSQL</li>
              <li>Query optimization & indexing strategies</li>
              <li>Error handling & security best practices</li>
            </ul>
          </div>
          <div>
            <h3>Technologies Covered</h3>
            <ul>
              <li><span class="highlight">MongoDB</span> with Mongoose ODM</li>
              <li><span class="highlight-pg">PostgreSQL</span> with node-postgres & Knex</li>
              <li>Prisma ORM (modern approach)</li>
              <li>Connection pooling & transactions</li>
              <li>Migration strategies</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üèóÔ∏è Architecture: How JS Connects to Databases</h2>
        <div class="flow-diagram">
          <div class="flow-box app">Node.js App<br><small>Express/Fastify</small></div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box driver">Driver/ORM<br><small>Mongoose/pg/Prisma</small></div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box db">Database<br><small>MongoDB/PostgreSQL</small></div>
        </div>
        <p>JavaScript (Node.js) communicates with databases through <strong>drivers</strong> (low-level) or <strong>ORMs/ODMs</strong> (high-level abstractions). The driver manages connections, translates queries, and returns results as JavaScript objects.</p>
      </div>

      <div class="card">
        <h2>üìä MongoDB vs PostgreSQL ‚Äî When to Use What</h2>
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Feature</th>
              <th>MongoDB üçÉ</th>
              <th>PostgreSQL üêò</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Data Model</td>
              <td>Document (JSON/BSON)</td>
              <td>Relational (Tables)</td>
            </tr>
            <tr>
              <td>Schema</td>
              <td>Flexible / Schema-less</td>
              <td>Strict / Enforced</td>
            </tr>
            <tr>
              <td>Query Language</td>
              <td>MongoDB Query Language (MQL)</td>
              <td>SQL</td>
            </tr>
            <tr>
              <td>Best For</td>
              <td>Rapid prototyping, varying data shapes, content management</td>
              <td>Complex relations, transactions, analytics</td>
            </tr>
            <tr>
              <td>Joins</td>
              <td><code>$lookup</code> (limited)</td>
              <td>Native JOINs (powerful)</td>
            </tr>
            <tr>
              <td>Transactions</td>
              <td>Multi-doc since v4.0</td>
              <td>Full ACID support</td>
            </tr>
            <tr>
              <td>Scaling</td>
              <td>Horizontal (sharding)</td>
              <td>Vertical (read replicas)</td>
            </tr>
            <tr>
              <td>JS Driver</td>
              <td><code>mongodb</code> / <code>mongoose</code></td>
              <td><code>pg</code> / <code>knex</code> / <code>prisma</code></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="info-box">
        <h4>üí° Pro Tip</h4>
        <p>In interviews at top companies, you'll often be asked <em>"Why did you choose this database?"</em> ‚Äî Always frame your answer around the <strong>data access patterns</strong> and <strong>consistency requirements</strong> of your application, not just personal preference.</p>
      </div>

      <div class="card">
        <h2>üõ†Ô∏è Prerequisites & Setup</h2>
        <div class="code-block">
          <span class="code-label js">Terminal</span>
<pre><span class="cm"># Initialize a Node.js project</span>
<span class="fn">mkdir</span> db-mastery && <span class="fn">cd</span> db-mastery
<span class="fn">npm</span> init -y

<span class="cm"># Install MongoDB driver & Mongoose</span>
<span class="fn">npm</span> install mongodb mongoose

<span class="cm"># Install PostgreSQL driver & query builder</span>
<span class="fn">npm</span> install pg knex

<span class="cm"># Install Prisma (modern ORM - works with both)</span>
<span class="fn">npm</span> install prisma @prisma/client

<span class="cm"># Install dotenv for environment variables</span>
<span class="fn">npm</span> install dotenv</pre>
        </div>

        <div class="pitfall-box">
          <h4>‚ö†Ô∏è Never Hardcode Credentials!</h4>
          <p>Always use environment variables (<code>.env</code> file) for database URIs and credentials. Add <code>.env</code> to your <code>.gitignore</code> immediately.</p>
        </div>

        <div class="code-block">
          <span class="code-label good">.env</span>
<pre><span class="cm"># .env file ‚Äî NEVER commit this to Git!</span>
<span class="var">MONGODB_URI</span>=mongodb+srv://user:pass@cluster.mongodb.net/mydb
<span class="var">POSTGRES_URL</span>=postgresql://user:pass@localhost:5432/mydb
<span class="var">NODE_ENV</span>=development</pre>
        </div>
      </div>

      <button class="btn btn-run" onclick="navigateToNext('connection')" style="margin-top: 10px;">
        Start Learning ‚Üí Database Connection
      </button>
    </div>

    <!-- ==================== SECTION: CONNECTION ==================== -->
    <div class="section" id="section-connection">
      <div class="section-header">
        <h1>üîå Database Connection</h1>
        <p>Learn how to establish, manage, and handle database connections properly</p>
        <div class="badge-row">
          <span class="badge beginner">Beginner</span>
          <span class="badge mongo">MongoDB</span>
          <span class="badge postgres">PostgreSQL</span>
        </div>
      </div>

      <div class="card">
        <h2>üîë Connection Fundamentals</h2>
        <p>Every database connection involves these critical components:</p>
        <ol class="steps">
          <li><strong>Connection String / URI</strong> ‚Äî The address of your database including protocol, host, port, credentials, and database name</li>
          <li><strong>Driver Initialization</strong> ‚Äî The Node.js library creates a client instance</li>
          <li><strong>Connection Pooling</strong> ‚Äî Multiple reusable connections are maintained for performance</li>
          <li><strong>Error Handling</strong> ‚Äî Graceful handling of connection failures and reconnection logic</li>
          <li><strong>Graceful Shutdown</strong> ‚Äî Properly closing connections when the app shuts down</li>
        </ol>
      </div>

      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-btn active" onclick="switchTab(event, 'conn-mongo')">üçÉ MongoDB</button>
          <button class="tab-btn" onclick="switchTab(event, 'conn-pg')">üêò PostgreSQL</button>
          <button class="tab-btn" onclick="switchTab(event, 'conn-prisma')">‚óÜ Prisma</button>
        </div>

        <div class="tab-panel active" id="tab-conn-mongo">
          <h3>MongoDB Connection with Mongoose</h3>
          <div class="code-block">
            <span class="code-label mongo">MongoDB</span>
<pre><span class="cm">// db/mongodb.js</span>
<span class="kw">const</span> mongoose = <span class="fn">require</span>(<span class="str">'mongoose'</span>);
<span class="kw">require</span>(<span class="str">'dotenv'</span>).<span class="fn">config</span>();

<span class="cm">// Connection options ‚Äî critical for production!</span>
<span class="kw">const</span> options = {
  <span class="prop">maxPoolSize</span>: <span class="num">10</span>,        <span class="cm">// Max connections in pool</span>
  <span class="prop">serverSelectionTimeoutMS</span>: <span class="num">5000</span>, <span class="cm">// Timeout after 5s</span>
  <span class="prop">socketTimeoutMS</span>: <span class="num">45000</span>,  <span class="cm">// Close sockets after 45s</span>
  <span class="prop">family</span>: <span class="num">4</span>,               <span class="cm">// Use IPv4</span>
};

<span class="cm">// The connection function</span>
<span class="kw">async function</span> <span class="fn">connectDB</span>() {
  <span class="kw">try</span> {
    <span class="kw">await</span> mongoose.<span class="fn">connect</span>(process.env.<span class="var">MONGODB_URI</span>, options);
    console.<span class="fn">log</span>(<span class="str">'‚úÖ MongoDB connected successfully'</span>);
  } <span class="kw">catch</span> (error) {
    console.<span class="fn">error</span>(<span class="str">'‚ùå MongoDB connection failed:'</span>, error.message);
    process.<span class="fn">exit</span>(<span class="num">1</span>); <span class="cm">// Exit with failure</span>
  }
}

<span class="cm">// Listen for connection events</span>
mongoose.connection.<span class="fn">on</span>(<span class="str">'disconnected'</span>, () => {
  console.<span class="fn">warn</span>(<span class="str">'‚ö†Ô∏è MongoDB disconnected. Attempting reconnect...'</span>);
});

mongoose.connection.<span class="fn">on</span>(<span class="str">'error'</span>, (err) => {
  console.<span class="fn">error</span>(<span class="str">'MongoDB error:'</span>, err);
});

<span class="cm">// Graceful shutdown</span>
process.<span class="fn">on</span>(<span class="str">'SIGINT'</span>, <span class="kw">async</span> () => {
  <span class="kw">await</span> mongoose.connection.<span class="fn">close</span>();
  console.<span class="fn">log</span>(<span class="str">'MongoDB connection closed (app shutdown)'</span>);
  process.<span class="fn">exit</span>(<span class="num">0</span>);
});

module.exports = <span class="fn">connectDB</span>;</pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-conn-pg">
          <h3>PostgreSQL Connection with pg (node-postgres)</h3>
          <div class="code-block">
            <span class="code-label postgres">PostgreSQL</span>
<pre><span class="cm">// db/postgres.js</span>
<span class="kw">const</span> { Pool } = <span class="fn">require</span>(<span class="str">'pg'</span>);
<span class="kw">require</span>(<span class="str">'dotenv'</span>).<span class="fn">config</span>();

<span class="cm">// Connection pool ‚Äî reuses connections for performance</span>
<span class="kw">const</span> pool = <span class="kw">new</span> <span class="fn">Pool</span>({
  <span class="prop">connectionString</span>: process.env.<span class="var">POSTGRES_URL</span>,
  <span class="prop">max</span>: <span class="num">20</span>,                <span class="cm">// Max connections in pool</span>
  <span class="prop">idleTimeoutMillis</span>: <span class="num">30000</span>,  <span class="cm">// Close idle connections after 30s</span>
  <span class="prop">connectionTimeoutMillis</span>: <span class="num">2000</span>, <span class="cm">// Return error after 2s</span>
  <span class="prop">ssl</span>: process.env.<span class="var">NODE_ENV</span> === <span class="str">'production'</span>
    ? { <span class="prop">rejectUnauthorized</span>: <span class="num">false</span> }
    : <span class="num">false</span>,
});

<span class="cm">// Test the connection</span>
pool.<span class="fn">on</span>(<span class="str">'connect'</span>, () => {
  console.<span class="fn">log</span>(<span class="str">'‚úÖ PostgreSQL pool connected'</span>);
});

pool.<span class="fn">on</span>(<span class="str">'error'</span>, (err) => {
  console.<span class="fn">error</span>(<span class="str">'‚ùå Unexpected PG pool error:'</span>, err);
  process.<span class="fn">exit</span>(<span class="num">-1</span>);
});

<span class="cm">// Helper: query wrapper with error handling</span>
<span class="kw">async function</span> <span class="fn">query</span>(text, params) {
  <span class="kw">const</span> start = Date.<span class="fn">now</span>();
  <span class="kw">try</span> {
    <span class="kw">const</span> result = <span class="kw">await</span> pool.<span class="fn">query</span>(text, params);
    <span class="kw">const</span> duration = Date.<span class="fn">now</span>() - start;
    console.<span class="fn">log</span>(<span class="str">`Query executed in ${duration}ms`</span>);
    <span class="kw">return</span> result;
  } <span class="kw">catch</span> (error) {
    console.<span class="fn">error</span>(<span class="str">'Query error:'</span>, { text, error: error.message });
    <span class="kw">throw</span> error;
  }
}

<span class="cm">// Graceful shutdown</span>
process.<span class="fn">on</span>(<span class="str">'SIGINT'</span>, <span class="kw">async</span> () => {
  <span class="kw">await</span> pool.<span class="fn">end</span>();
  console.<span class="fn">log</span>(<span class="str">'PG pool closed'</span>);
  process.<span class="fn">exit</span>(<span class="num">0</span>);
});

module.exports = { query, pool };</pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-conn-prisma">
          <h3>Prisma ‚Äî Modern ORM (Works with Both!)</h3>
          <div class="code-block">
            <span class="code-label js">Prisma</span>
<pre><span class="cm">// prisma/schema.prisma</span>
generator client {
  provider = <span class="str">"prisma-client-js"</span>
}

datasource db {
  provider = <span class="str">"postgresql"</span>  <span class="cm">// or "mongodb"</span>
  url      = <span class="fn">env</span>(<span class="str">"DATABASE_URL"</span>)
}

<span class="cm">// db/prisma.js ‚Äî Singleton pattern (important!)</span>
<span class="kw">const</span> { PrismaClient } = <span class="fn">require</span>(<span class="str">'@prisma/client'</span>);

<span class="kw">let</span> prisma;

<span class="kw">if</span> (process.env.<span class="var">NODE_ENV</span> === <span class="str">'production'</span>) {
  prisma = <span class="kw">new</span> <span class="fn">PrismaClient</span>();
} <span class="kw">else</span> {
  <span class="cm">// Prevent multiple instances in development (hot reload)</span>
  <span class="kw">if</span> (!global.__prisma) {
    global.__prisma = <span class="kw">new</span> <span class="fn">PrismaClient</span>({
      <span class="prop">log</span>: [<span class="str">'query'</span>, <span class="str">'warn'</span>, <span class="str">'error'</span>],
    });
  }
  prisma = global.__prisma;
}

module.exports = prisma;</pre>
          </div>
        </div>
      </div>

      <div class="pitfall-box">
        <h4>‚ö†Ô∏è Pitfall: Creating New Connections Per Request</h4>
        <p>A <strong>very common mistake</strong> is creating a new database connection for every incoming request. This will exhaust your connection pool and crash your app under load. <strong>Always use connection pooling</strong> and create the pool ONCE when your app starts.</p>
      </div>

      <div class="code-block">
        <span class="code-label bad">‚ùå BAD</span>
<pre><span class="cm">// DON'T do this ‚Äî new connection per request!</span>
app.<span class="fn">get</span>(<span class="str">'/users'</span>, <span class="kw">async</span> (req, res) => {
  <span class="kw">const</span> client = <span class="kw">new</span> <span class="fn">Client</span>(connectionString); <span class="cm">// ‚ùå New connection!</span>
  <span class="kw">await</span> client.<span class="fn">connect</span>();                       <span class="cm">// ‚ùå Opens a new conn!</span>
  <span class="kw">const</span> result = <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'SELECT * FROM users'</span>);
  <span class="kw">await</span> client.<span class="fn">end</span>();                             <span class="cm">// ‚ùå Wastes resources</span>
  res.<span class="fn">json</span>(result.rows);
});</pre>
      </div>

      <div class="code-block">
        <span class="code-label good">‚úÖ GOOD</span>
<pre><span class="cm">// DO this ‚Äî use the shared pool</span>
<span class="kw">const</span> { query } = <span class="fn">require</span>(<span class="str">'./db/postgres'</span>); <span class="cm">// ‚úÖ Shared pool</span>

app.<span class="fn">get</span>(<span class="str">'/users'</span>, <span class="kw">async</span> (req, res) => {
  <span class="kw">const</span> result = <span class="kw">await</span> <span class="fn">query</span>(<span class="str">'SELECT * FROM users'</span>); <span class="cm">// ‚úÖ Reuses conn</span>
  res.<span class="fn">json</span>(result.rows);
});</pre>
      </div>

      <div class="tip-box">
        <h4>‚úÖ Best Practice: Connection Pool Sizing</h4>
        <p>A good rule of thumb: <code>pool size = (CPU cores * 2) + number of disks</code>. For most Node.js apps, 10-20 connections is ideal. Too many connections can actually <em>decrease</em> performance due to context switching overhead.</p>
      </div>

      <button class="btn btn-run" onclick="completeSection('connection'); navigateToNext('mongo-setup')">
        Continue ‚Üí MongoDB Setup
      </button>
    </div>

    <!-- ==================== SECTION: MONGO SETUP ==================== -->
    <div class="section" id="section-mongo-setup">
      <div class="section-header">
        <h1>‚öôÔ∏è MongoDB Setup & Configuration</h1>
        <p>Get MongoDB running and connected to your Node.js application</p>
        <div class="badge-row">
          <span class="badge mongo">MongoDB</span>
          <span class="badge beginner">Beginner</span>
        </div>
      </div>

      <div class="card">
        <h2>üçÉ MongoDB Architecture Basics</h2>
        <p>MongoDB stores data as <strong>documents</strong> (JSON-like objects) inside <strong>collections</strong>, which live in a <strong>database</strong>.</p>
        <div class="flow-diagram">
          <div class="flow-box db">Database<br><small>"myApp"</small></div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box driver">Collection<br><small>"users"</small></div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box app">Document<br><small>{ name, email }</small></div>
        </div>

        <div class="code-block">
          <span class="code-label mongo">Document Example</span>
<pre><span class="cm">// A MongoDB document ‚Äî it's just JSON!</span>
{
  <span class="key">"_id"</span>: <span class="fn">ObjectId</span>(<span class="str">"64a7b2c3d4e5f6789012345"</span>),
  <span class="key">"name"</span>: <span class="str">"Sarah Chen"</span>,
  <span class="key">"email"</span>: <span class="str">"sarah@example.com"</span>,
  <span class="key">"role"</span>: <span class="str">"developer"</span>,
  <span class="key">"skills"</span>: [<span class="str">"JavaScript"</span>, <span class="str">"MongoDB"</span>, <span class="str">"React"</span>],
  <span class="key">"address"</span>: {
    <span class="key">"city"</span>: <span class="str">"San Francisco"</span>,
    <span class="key">"state"</span>: <span class="str">"CA"</span>
  },
  <span class="key">"createdAt"</span>: <span class="fn">ISODate</span>(<span class="str">"2024-01-15T10:30:00Z"</span>)
}</pre>
        </div>
      </div>

      <div class="card">
        <h2>üîß Setting Up Mongoose</h2>
        <p>Mongoose is the most popular ODM (Object Document Mapper) for MongoDB in Node.js. It provides schema validation, middleware, and a powerful query API.</p>
        <div class="code-block">
          <span class="code-label mongo">Complete Setup</span>
<pre><span class="cm">// app.js ‚Äî Full application setup</span>
<span class="kw">const</span> express = <span class="fn">require</span>(<span class="str">'express'</span>);
<span class="kw">const</span> connectDB = <span class="fn">require</span>(<span class="str">'./db/mongodb'</span>);

<span class="kw">const</span> app = <span class="fn">express</span>();
app.<span class="fn">use</span>(express.<span class="fn">json</span>());

<span class="cm">// Connect to MongoDB BEFORE starting the server</span>
<span class="fn">connectDB</span>().<span class="fn">then</span>(() => {
  app.<span class="fn">listen</span>(<span class="num">3000</span>, () => {
    console.<span class="fn">log</span>(<span class="str">'Server running on port 3000'</span>);
  });
});</pre>
        </div>
      </div>

      <div class="info-box">
        <h4>üÜì Free MongoDB Hosting</h4>
        <p>Use <strong>MongoDB Atlas</strong> (free tier) for learning. It gives you a 512MB cloud database with no credit card required. Go to <code>mongodb.com/atlas</code> to get started.</p>
      </div>

      <button class="btn btn-run" onclick="completeSection('mongo-setup'); navigateToNext('mongo-crud')">
        Continue ‚Üí MongoDB CRUD Operations
      </button>
    </div>

    <!-- ==================== SECTION: MONGO CRUD ==================== -->
    <div class="section" id="section-mongo-crud">
      <div class="section-header">
        <h1>üìù MongoDB CRUD Operations</h1>
        <p>Master Create, Read, Update, and Delete with Mongoose</p>
        <div class="badge-row">
          <span class="badge mongo">MongoDB</span>
          <span class="badge intermediate">Intermediate</span>
        </div>
      </div>

      <div class="card">
        <h2>üìå First: Define a Schema & Model</h2>
        <div class="code-block">
          <span class="code-label mongo">models/User.js</span>
<pre><span class="kw">const</span> mongoose = <span class="fn">require</span>(<span class="str">'mongoose'</span>);

<span class="kw">const</span> userSchema = <span class="kw">new</span> mongoose.<span class="fn">Schema</span>({
  <span class="prop">name</span>: {
    <span class="prop">type</span>: String,
    <span class="prop">required</span>: [<span class="num">true</span>, <span class="str">'Name is required'</span>],
    <span class="prop">trim</span>: <span class="num">true</span>,
    <span class="prop">minlength</span>: [<span class="num">2</span>, <span class="str">'Name must be at least 2 characters'</span>],
    <span class="prop">maxlength</span>: [<span class="num">50</span>, <span class="str">'Name cannot exceed 50 characters'</span>],
  },
  <span class="prop">email</span>: {
    <span class="prop">type</span>: String,
    <span class="prop">required</span>: <span class="num">true</span>,
    <span class="prop">unique</span>: <span class="num">true</span>,
    <span class="prop">lowercase</span>: <span class="num">true</span>,
    <span class="prop">match</span>: [<span class="str">/^\S+@\S+\.\S+$/</span>, <span class="str">'Please enter a valid email'</span>],
  },
  <span class="prop">age</span>: {
    <span class="prop">type</span>: Number,
    <span class="prop">min</span>: [<span class="num">0</span>, <span class="str">'Age cannot be negative'</span>],
    <span class="prop">max</span>: [<span class="num">150</span>, <span class="str">'Age seems unrealistic'</span>],
  },
  <span class="prop">role</span>: {
    <span class="prop">type</span>: String,
    <span class="prop">enum</span>: [<span class="str">'user'</span>, <span class="str">'admin'</span>, <span class="str">'moderator'</span>],
    <span class="prop">default</span>: <span class="str">'user'</span>,
  },
  <span class="prop">isActive</span>: {
    <span class="prop">type</span>: Boolean,
    <span class="prop">default</span>: <span class="num">true</span>,
  },
}, {
  <span class="prop">timestamps</span>: <span class="num">true</span>, <span class="cm">// Adds createdAt & updatedAt automatically</span>
});

module.exports = mongoose.<span class="fn">model</span>(<span class="str">'User'</span>, userSchema);</pre>
        </div>
      </div>

      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-btn active" onclick="switchTab(event, 'crud-create')">Create</button>
          <button class="tab-btn" onclick="switchTab(event, 'crud-read')">Read</button>
          <button class="tab-btn" onclick="switchTab(event, 'crud-update')">Update</button>
          <button class="tab-btn" onclick="switchTab(event, 'crud-delete')">Delete</button>
        </div>

        <div class="tab-panel active" id="tab-crud-create">
          <h3>CREATE ‚Äî Inserting Documents</h3>
          <div class="code-block">
            <span class="code-label mongo">Create Operations</span>
<pre><span class="kw">const</span> User = <span class="fn">require</span>(<span class="str">'./models/User'</span>);

<span class="cm">// Method 1: create() ‚Äî shorthand</span>
<span class="kw">const</span> user = <span class="kw">await</span> User.<span class="fn">create</span>({
  <span class="prop">name</span>: <span class="str">'Alice Johnson'</span>,
  <span class="prop">email</span>: <span class="str">'alice@example.com'</span>,
  <span class="prop">age</span>: <span class="num">28</span>,
  <span class="prop">role</span>: <span class="str">'admin'</span>,
});

<span class="cm">// Method 2: new + save() ‚Äî more control</span>
<span class="kw">const</span> user2 = <span class="kw">new</span> <span class="fn">User</span>({
  <span class="prop">name</span>: <span class="str">'Bob Smith'</span>,
  <span class="prop">email</span>: <span class="str">'bob@example.com'</span>,
  <span class="prop">age</span>: <span class="num">34</span>,
});
<span class="cm">// Can modify before saving</span>
user2.role = <span class="str">'moderator'</span>;
<span class="kw">await</span> user2.<span class="fn">save</span>();

<span class="cm">// Method 3: insertMany() ‚Äî bulk insert</span>
<span class="kw">const</span> users = <span class="kw">await</span> User.<span class="fn">insertMany</span>([
  { <span class="prop">name</span>: <span class="str">'Carol'</span>, <span class="prop">email</span>: <span class="str">'carol@ex.com'</span>, <span class="prop">age</span>: <span class="num">25</span> },
  { <span class="prop">name</span>: <span class="str">'Dave'</span>, <span class="prop">email</span>: <span class="str">'dave@ex.com'</span>, <span class="prop">age</span>: <span class="num">31</span> },
  { <span class="prop">name</span>: <span class="str">'Eve'</span>, <span class="prop">email</span>: <span class="str">'eve@ex.com'</span>, <span class="prop">age</span>: <span class="num">22</span> },
]);
console.<span class="fn">log</span>(<span class="str">`Inserted ${users.length} users`</span>);</pre>
          </div>

          <div class="pitfall-box">
            <h4>‚ö†Ô∏è Pitfall: Not Handling Duplicate Key Errors</h4>
            <p>If <code>email</code> has <code>unique: true</code> and you insert a duplicate, Mongoose throws error code <code>11000</code>. Always catch this specifically!</p>
          </div>
          <div class="code-block">
            <span class="code-label good">Error Handling</span>
<pre><span class="kw">try</span> {
  <span class="kw">const</span> user = <span class="kw">await</span> User.<span class="fn">create</span>(userData);
  res.<span class="fn">status</span>(<span class="num">201</span>).<span class="fn">json</span>(user);
} <span class="kw">catch</span> (error) {
  <span class="kw">if</span> (error.code === <span class="num">11000</span>) {
    <span class="cm">// Duplicate key error</span>
    res.<span class="fn">status</span>(<span class="num">409</span>).<span class="fn">json</span>({
      <span class="prop">error</span>: <span class="str">'Email already exists'</span>
    });
  } <span class="kw">else if</span> (error.name === <span class="str">'ValidationError'</span>) {
    <span class="cm">// Mongoose validation error</span>
    <span class="kw">const</span> messages = Object.<span class="fn">values</span>(error.errors)
      .<span class="fn">map</span>(e => e.message);
    res.<span class="fn">status</span>(<span class="num">400</span>).<span class="fn">json</span>({ <span class="prop">errors</span>: messages });
  } <span class="kw">else</span> {
    res.<span class="fn">status</span>(<span class="num">500</span>).<span class="fn">json</span>({ <span class="prop">error</span>: <span class="str">'Server error'</span> });
  }
}</pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-crud-read">
          <h3>READ ‚Äî Querying Documents</h3>
          <div class="code-block">
            <span class="code-label mongo">Read Operations</span>
<pre><span class="cm">// Find ALL users</span>
<span class="kw">const</span> allUsers = <span class="kw">await</span> User.<span class="fn">find</span>();

<span class="cm">// Find with FILTER</span>
<span class="kw">const</span> admins = <span class="kw">await</span> User.<span class="fn">find</span>({ <span class="prop">role</span>: <span class="str">'admin'</span> });

<span class="cm">// Find ONE document</span>
<span class="kw">const</span> user = <span class="kw">await</span> User.<span class="fn">findOne</span>({ <span class="prop">email</span>: <span class="str">'alice@example.com'</span> });

<span class="cm">// Find by ID</span>
<span class="kw">const</span> user = <span class="kw">await</span> User.<span class="fn">findById</span>(<span class="str">'64a7b2c3d4e5f6789012345'</span>);

<span class="cm">// Complex queries with operators</span>
<span class="kw">const</span> results = <span class="kw">await</span> User.<span class="fn">find</span>({
  <span class="prop">age</span>: { <span class="key">$gte</span>: <span class="num">18</span>, <span class="key">$lte</span>: <span class="num">35</span> },  <span class="cm">// Between 18-35</span>
  <span class="prop">role</span>: { <span class="key">$in</span>: [<span class="str">'admin'</span>, <span class="str">'moderator'</span>] },
  <span class="prop">isActive</span>: <span class="num">true</span>,
})
  .<span class="fn">select</span>(<span class="str">'name email age'</span>)   <span class="cm">// Only these fields</span>
  .<span class="fn">sort</span>({ <span class="prop">age</span>: -<span class="num">1</span> })          <span class="cm">// Sort by age descending</span>
  .<span class="fn">limit</span>(<span class="num">10</span>)                   <span class="cm">// Limit results</span>
  .<span class="fn">skip</span>(<span class="num">0</span>)                     <span class="cm">// Pagination offset</span>
  .<span class="fn">lean</span>();                     <span class="cm">// Plain JS objects (faster!)</span>

<span class="cm">// Count documents</span>
<span class="kw">const</span> count = <span class="kw">await</span> User.<span class="fn">countDocuments</span>({ <span class="prop">role</span>: <span class="str">'admin'</span> });

<span class="cm">// Check if exists</span>
<span class="kw">const</span> exists = <span class="kw">await</span> User.<span class="fn">exists</span>({ <span class="prop">email</span>: <span class="str">'alice@example.com'</span> });

<span class="cm">// MongoDB query operators:</span>
<span class="cm">// $eq, $ne, $gt, $gte, $lt, $lte</span>
<span class="cm">// $in, $nin, $or, $and, $not</span>
<span class="cm">// $regex, $exists, $type</span></pre>
          </div>

          <div class="tip-box">
            <h4>‚úÖ Performance Tip: Use .lean()</h4>
            <p>Adding <code>.lean()</code> to queries returns plain JavaScript objects instead of Mongoose documents. This is <strong>5-10x faster</strong> for read-only operations because Mongoose skips creating full document instances with change tracking.</p>
          </div>
        </div>

        <div class="tab-panel" id="tab-crud-update">
          <h3>UPDATE ‚Äî Modifying Documents</h3>
          <div class="code-block">
            <span class="code-label mongo">Update Operations</span>
<pre><span class="cm">// findByIdAndUpdate ‚Äî returns the updated doc</span>
<span class="kw">const</span> updated = <span class="kw">await</span> User.<span class="fn">findByIdAndUpdate</span>(
  id,
  { <span class="key">$set</span>: { <span class="prop">name</span>: <span class="str">'Alice Chen'</span>, <span class="prop">age</span>: <span class="num">29</span> } },
  {
    <span class="prop">new</span>: <span class="num">true</span>,          <span class="cm">// Return the UPDATED document</span>
    <span class="prop">runValidators</span>: <span class="num">true</span>, <span class="cm">// Run schema validators</span>
  }
);

<span class="cm">// updateOne ‚Äî doesn't return the doc</span>
<span class="kw">await</span> User.<span class="fn">updateOne</span>(
  { <span class="prop">email</span>: <span class="str">'bob@example.com'</span> },
  { <span class="key">$set</span>: { <span class="prop">role</span>: <span class="str">'admin'</span> } }
);

<span class="cm">// updateMany ‚Äî bulk update</span>
<span class="kw">const</span> result = <span class="kw">await</span> User.<span class="fn">updateMany</span>(
  { <span class="prop">isActive</span>: <span class="num">false</span> },
  { <span class="key">$set</span>: { <span class="prop">role</span>: <span class="str">'user'</span> } }
);
console.<span class="fn">log</span>(<span class="str">`Modified ${result.modifiedCount} users`</span>);

<span class="cm">// Useful update operators:</span>
<span class="cm">// $set ‚Äî set field values</span>
<span class="cm">// $unset ‚Äî remove a field</span>
<span class="cm">// $inc ‚Äî increment a number</span>
<span class="cm">// $push ‚Äî add to array</span>
<span class="cm">// $pull ‚Äî remove from array</span>
<span class="cm">// $addToSet ‚Äî add to array only if unique</span>

<span class="cm">// Example: increment & push</span>
<span class="kw">await</span> User.<span class="fn">findByIdAndUpdate</span>(id, {
  <span class="key">$inc</span>: { <span class="prop">loginCount</span>: <span class="num">1</span> },
  <span class="key">$push</span>: { <span class="prop">loginHistory</span>: <span class="kw">new</span> <span class="fn">Date</span>() },
  <span class="key">$set</span>: { <span class="prop">lastLogin</span>: <span class="kw">new</span> <span class="fn">Date</span>() },
});</pre>
          </div>

          <div class="pitfall-box">
            <h4>‚ö†Ô∏è Pitfall: runValidators Defaults to FALSE</h4>
            <p>By default, Mongoose does NOT run schema validators on update operations! Always pass <code>{ runValidators: true }</code> or your data integrity will silently break.</p>
          </div>
        </div>

        <div class="tab-panel" id="tab-crud-delete">
          <h3>DELETE ‚Äî Removing Documents</h3>
          <div class="code-block">
            <span class="code-label mongo">Delete Operations</span>
<pre><span class="cm">// Delete one document by ID</span>
<span class="kw">const</span> deleted = <span class="kw">await</span> User.<span class="fn">findByIdAndDelete</span>(id);
<span class="kw">if</span> (!deleted) {
  <span class="kw">throw new</span> <span class="fn">Error</span>(<span class="str">'User not found'</span>);
}

<span class="cm">// Delete one by filter</span>
<span class="kw">await</span> User.<span class="fn">deleteOne</span>({ <span class="prop">email</span>: <span class="str">'bob@example.com'</span> });

<span class="cm">// Delete many</span>
<span class="kw">const</span> result = <span class="kw">await</span> User.<span class="fn">deleteMany</span>({
  <span class="prop">isActive</span>: <span class="num">false</span>,
  <span class="prop">lastLogin</span>: { <span class="key">$lt</span>: <span class="kw">new</span> <span class="fn">Date</span>(<span class="str">'2023-01-01'</span>) }
});
console.<span class="fn">log</span>(<span class="str">`Deleted ${result.deletedCount} inactive users`</span>);

<span class="cm">// ‚≠ê SOFT DELETE pattern (recommended for production)</span>
<span class="cm">// Instead of actually deleting, mark as deleted:</span>
<span class="kw">const</span> softDelete = <span class="kw">await</span> User.<span class="fn">findByIdAndUpdate</span>(id, {
  <span class="key">$set</span>: {
    <span class="prop">isDeleted</span>: <span class="num">true</span>,
    <span class="prop">deletedAt</span>: <span class="kw">new</span> <span class="fn">Date</span>(),
  }
}, { <span class="prop">new</span>: <span class="num">true</span> });

<span class="cm">// Then filter out deleted docs in all queries:</span>
userSchema.<span class="fn">pre</span>(<span class="str">'find'</span>, <span class="kw">function</span>() {
  <span class="kw">this</span>.<span class="fn">where</span>({ <span class="prop">isDeleted</span>: { <span class="key">$ne</span>: <span class="num">true</span> } });
});</pre>
          </div>

          <div class="tip-box">
            <h4>‚úÖ Soft Delete > Hard Delete</h4>
            <p>In production, prefer <strong>soft deletes</strong> (setting an <code>isDeleted</code> flag) over hard deletes. This gives you data recovery ability, audit trails, and prevents accidental data loss. All major companies use this pattern.</p>
          </div>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('mongo-crud'); navigateToNext('mongo-schema')">
        Continue ‚Üí Mongoose Schema Design
      </button>
    </div>

    <!-- ==================== SECTION: MONGO SCHEMA ==================== -->
    <div class="section" id="section-mongo-schema">
      <div class="section-header">
        <h1>üìê Mongoose Schema Design</h1>
        <p>Design robust schemas with validation, middleware, virtuals, and relationships</p>
        <div class="badge-row">
          <span class="badge mongo">MongoDB</span>
          <span class="badge intermediate">Intermediate</span>
        </div>
      </div>

      <div class="card">
        <h2>üèóÔ∏è Advanced Schema Features</h2>
        <div class="code-block">
          <span class="code-label mongo">Complete Schema Example</span>
<pre><span class="kw">const</span> mongoose = <span class="fn">require</span>(<span class="str">'mongoose'</span>);
<span class="kw">const</span> bcrypt = <span class="fn">require</span>(<span class="str">'bcryptjs'</span>);

<span class="kw">const</span> userSchema = <span class="kw">new</span> mongoose.<span class="fn">Schema</span>({
  <span class="prop">firstName</span>: { <span class="prop">type</span>: String, <span class="prop">required</span>: <span class="num">true</span>, <span class="prop">trim</span>: <span class="num">true</span> },
  <span class="prop">lastName</span>: { <span class="prop">type</span>: String, <span class="prop">required</span>: <span class="num">true</span>, <span class="prop">trim</span>: <span class="num">true</span> },
  <span class="prop">email</span>: { <span class="prop">type</span>: String, <span class="prop">required</span>: <span class="num">true</span>, <span class="prop">unique</span>: <span class="num">true</span> },
  <span class="prop">password</span>: { <span class="prop">type</span>: String, <span class="prop">required</span>: <span class="num">true</span>, <span class="prop">minlength</span>: <span class="num">8</span> },
  <span class="prop">posts</span>: [{
    <span class="prop">type</span>: mongoose.Schema.Types.ObjectId,
    <span class="prop">ref</span>: <span class="str">'Post'</span>  <span class="cm">// Reference to Post model</span>
  }],
}, { <span class="prop">timestamps</span>: <span class="num">true</span> });

<span class="cm">// ‚îÄ‚îÄ‚îÄ‚îÄ VIRTUAL PROPERTIES ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class="cm">// Computed field, not stored in DB</span>
userSchema.<span class="fn">virtual</span>(<span class="str">'fullName'</span>).<span class="fn">get</span>(<span class="kw">function</span>() {
  <span class="kw">return</span> <span class="str">`${this.firstName} ${this.lastName}`</span>;
});

<span class="cm">// ‚îÄ‚îÄ‚îÄ‚îÄ PRE-SAVE MIDDLEWARE ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class="cm">// Hash password before saving</span>
userSchema.<span class="fn">pre</span>(<span class="str">'save'</span>, <span class="kw">async function</span>(next) {
  <span class="kw">if</span> (!<span class="kw">this</span>.<span class="fn">isModified</span>(<span class="str">'password'</span>)) <span class="kw">return</span> <span class="fn">next</span>();

  <span class="kw">const</span> salt = <span class="kw">await</span> bcrypt.<span class="fn">genSalt</span>(<span class="num">12</span>);
  <span class="kw">this</span>.password = <span class="kw">await</span> bcrypt.<span class="fn">hash</span>(<span class="kw">this</span>.password, salt);
  <span class="fn">next</span>();
});

<span class="cm">// ‚îÄ‚îÄ‚îÄ‚îÄ INSTANCE METHODS ‚îÄ‚îÄ‚îÄ‚îÄ</span>
userSchema.methods.<span class="fn">comparePassword</span> = <span class="kw">async function</span>(candidatePassword) {
  <span class="kw">return</span> bcrypt.<span class="fn">compare</span>(candidatePassword, <span class="kw">this</span>.password);
};

<span class="cm">// ‚îÄ‚îÄ‚îÄ‚îÄ STATIC METHODS ‚îÄ‚îÄ‚îÄ‚îÄ</span>
userSchema.statics.<span class="fn">findByEmail</span> = <span class="kw">function</span>(email) {
  <span class="kw">return</span> <span class="kw">this</span>.<span class="fn">findOne</span>({ <span class="prop">email</span>: email.<span class="fn">toLowerCase</span>() });
};

<span class="cm">// ‚îÄ‚îÄ‚îÄ‚îÄ toJSON TRANSFORM ‚îÄ‚îÄ‚îÄ‚îÄ</span>
<span class="cm">// Remove password from API responses</span>
userSchema.<span class="fn">set</span>(<span class="str">'toJSON'</span>, {
  <span class="fn">transform</span>(doc, ret) {
    <span class="kw">delete</span> ret.password;
    <span class="kw">delete</span> ret.__v;
    <span class="kw">return</span> ret;
  }
});

<span class="cm">// ‚îÄ‚îÄ‚îÄ‚îÄ INDEXES ‚îÄ‚îÄ‚îÄ‚îÄ</span>
userSchema.<span class="fn">index</span>({ <span class="prop">email</span>: <span class="num">1</span> }); <span class="cm">// Already done by unique: true</span>
userSchema.<span class="fn">index</span>({ <span class="prop">firstName</span>: <span class="num">1</span>, <span class="prop">lastName</span>: <span class="num">1</span> }); <span class="cm">// Compound index</span>
userSchema.<span class="fn">index</span>({ <span class="prop">createdAt</span>: -<span class="num">1</span> }); <span class="cm">// For sorting by date</span>

module.exports = mongoose.<span class="fn">model</span>(<span class="str">'User'</span>, userSchema);</pre>
        </div>
      </div>

      <div class="card">
        <h2>üîó Relationships: Embedding vs Referencing</h2>
        <div class="two-col">
          <div>
            <h3>Embedding (Denormalized)</h3>
            <div class="code-block">
<pre><span class="cm">// Data lives INSIDE the document</span>
{
  <span class="key">name</span>: <span class="str">"Alice"</span>,
  <span class="key">addresses</span>: [
    {
      <span class="key">street</span>: <span class="str">"123 Main St"</span>,
      <span class="key">city</span>: <span class="str">"NYC"</span>
    },
    {
      <span class="key">street</span>: <span class="str">"456 Oak Ave"</span>,
      <span class="key">city</span>: <span class="str">"LA"</span>
    }
  ]
}</pre>
            </div>
            <p>‚úÖ One query gets all data<br>
            ‚úÖ Atomic updates<br>
            ‚ùå 16MB document limit<br>
            ‚ùå Data duplication</p>
          </div>
          <div>
            <h3>Referencing (Normalized)</h3>
            <div class="code-block">
<pre><span class="cm">// Separate collections with refs</span>
<span class="cm">// User:</span>
{
  <span class="key">name</span>: <span class="str">"Alice"</span>,
  <span class="key">posts</span>: [
    <span class="fn">ObjectId</span>(<span class="str">"abc123"</span>),
    <span class="fn">ObjectId</span>(<span class="str">"def456"</span>)
  ]
}

<span class="cm">// Post (separate collection):</span>
{
  <span class="key">_id</span>: <span class="fn">ObjectId</span>(<span class="str">"abc123"</span>),
  <span class="key">title</span>: <span class="str">"My Post"</span>,
  <span class="key">author</span>: <span class="fn">ObjectId</span>(<span class="str">"user1"</span>)
}</pre>
            </div>
            <p>‚úÖ No data duplication<br>
            ‚úÖ No size limits<br>
            ‚ùå Requires populate() (extra query)<br>
            ‚ùå Not atomic across collections</p>
          </div>
        </div>

        <div class="info-box">
          <h4>üìê Rule of Thumb</h4>
          <p><strong>Embed</strong> when data is accessed together, doesn't grow unboundedly, and belongs to the parent (1:few). <strong>Reference</strong> when data is large, shared between documents, or grows unboundedly (1:many, many:many).</p>
        </div>
      </div>

      <div class="card">
        <h2>üîó Populate ‚Äî Joining Referenced Data</h2>
        <div class="code-block">
          <span class="code-label mongo">Populate</span>
<pre><span class="cm">// Get user with their posts loaded</span>
<span class="kw">const</span> user = <span class="kw">await</span> User
  .<span class="fn">findById</span>(userId)
  .<span class="fn">populate</span>({
    <span class="prop">path</span>: <span class="str">'posts'</span>,
    <span class="prop">select</span>: <span class="str">'title createdAt'</span>,  <span class="cm">// Only these fields</span>
    <span class="prop">options</span>: { <span class="prop">sort</span>: { <span class="prop">createdAt</span>: -<span class="num">1</span> }, <span class="prop">limit</span>: <span class="num">5</span> },
    <span class="prop">populate</span>: {  <span class="cm">// Nested populate!</span>
      <span class="prop">path</span>: <span class="str">'comments'</span>,
      <span class="prop">select</span>: <span class="str">'text author'</span>,
    }
  });</pre>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('mongo-schema'); navigateToNext('mongo-advanced')">
        Continue ‚Üí Aggregation & Indexing
      </button>
    </div>

    <!-- ==================== SECTION: MONGO ADVANCED ==================== -->
    <div class="section" id="section-mongo-advanced">
      <div class="section-header">
        <h1>üöÄ MongoDB Aggregation & Indexing</h1>
        <p>Advanced querying with the aggregation pipeline and performance optimization with indexes</p>
        <div class="badge-row">
          <span class="badge mongo">MongoDB</span>
          <span class="badge advanced">Advanced</span>
        </div>
      </div>

      <div class="card">
        <h2>üîÑ Aggregation Pipeline</h2>
        <p>The aggregation pipeline processes documents through a series of stages. Think of it like piping data through transformations, similar to Unix pipes.</p>
        <div class="code-block">
          <span class="code-label mongo">Aggregation Examples</span>
<pre><span class="cm">// Example 1: Get user stats by role</span>
<span class="kw">const</span> stats = <span class="kw">await</span> User.<span class="fn">aggregate</span>([
  <span class="cm">// Stage 1: Filter active users</span>
  { <span class="key">$match</span>: { <span class="prop">isActive</span>: <span class="num">true</span> } },

  <span class="cm">// Stage 2: Group by role</span>
  { <span class="key">$group</span>: {
    <span class="prop">_id</span>: <span class="str">'$role'</span>,
    <span class="prop">count</span>: { <span class="key">$sum</span>: <span class="num">1</span> },
    <span class="prop">avgAge</span>: { <span class="key">$avg</span>: <span class="str">'$age'</span> },
    <span class="prop">minAge</span>: { <span class="key">$min</span>: <span class="str">'$age'</span> },
    <span class="prop">maxAge</span>: { <span class="key">$max</span>: <span class="str">'$age'</span> },
  }},

  <span class="cm">// Stage 3: Sort by count</span>
  { <span class="key">$sort</span>: { <span class="prop">count</span>: -<span class="num">1</span> } },

  <span class="cm">// Stage 4: Reshape output</span>
  { <span class="key">$project</span>: {
    <span class="prop">role</span>: <span class="str">'$_id'</span>,
    <span class="prop">count</span>: <span class="num">1</span>,
    <span class="prop">avgAge</span>: { <span class="key">$round</span>: [<span class="str">'$avgAge'</span>, <span class="num">1</span>] },
    <span class="prop">_id</span>: <span class="num">0</span>,
  }},
]);

<span class="cm">// Example 2: Monthly signups report</span>
<span class="kw">const</span> monthly = <span class="kw">await</span> User.<span class="fn">aggregate</span>([
  { <span class="key">$match</span>: {
    <span class="prop">createdAt</span>: {
      <span class="key">$gte</span>: <span class="kw">new</span> <span class="fn">Date</span>(<span class="str">'2024-01-01'</span>),
      <span class="key">$lt</span>: <span class="kw">new</span> <span class="fn">Date</span>(<span class="str">'2025-01-01'</span>),
    }
  }},
  { <span class="key">$group</span>: {
    <span class="prop">_id</span>: {
      <span class="prop">year</span>: { <span class="key">$year</span>: <span class="str">'$createdAt'</span> },
      <span class="prop">month</span>: { <span class="key">$month</span>: <span class="str">'$createdAt'</span> },
    },
    <span class="prop">signups</span>: { <span class="key">$sum</span>: <span class="num">1</span> },
  }},
  { <span class="key">$sort</span>: { <span class="str">'_id.month'</span>: <span class="num">1</span> } },
]);

<span class="cm">// Example 3: $lookup (LEFT JOIN)</span>
<span class="kw">const</span> usersWithPosts = <span class="kw">await</span> User.<span class="fn">aggregate</span>([
  { <span class="key">$lookup</span>: {
    <span class="prop">from</span>: <span class="str">'posts'</span>,           <span class="cm">// Collection name</span>
    <span class="prop">localField</span>: <span class="str">'_id'</span>,      <span class="cm">// Field in users</span>
    <span class="prop">foreignField</span>: <span class="str">'author'</span>,  <span class="cm">// Field in posts</span>
    <span class="prop">as</span>: <span class="str">'userPosts'</span>,         <span class="cm">// Output array name</span>
  }},
  { <span class="key">$addFields</span>: {
    <span class="prop">postCount</span>: { <span class="key">$size</span>: <span class="str">'$userPosts'</span> }
  }},
]);</pre>
        </div>
      </div>

      <div class="card">
        <h2>üìä Indexing Strategies</h2>
        <div class="code-block">
          <span class="code-label mongo">Indexes</span>
<pre><span class="cm">// Single field index</span>
userSchema.<span class="fn">index</span>({ <span class="prop">email</span>: <span class="num">1</span> });  <span class="cm">// 1 = ascending</span>

<span class="cm">// Compound index (order matters!)</span>
userSchema.<span class="fn">index</span>({ <span class="prop">role</span>: <span class="num">1</span>, <span class="prop">createdAt</span>: -<span class="num">1</span> });

<span class="cm">// Text index for full-text search</span>
userSchema.<span class="fn">index</span>({ <span class="prop">name</span>: <span class="str">'text'</span>, <span class="prop">bio</span>: <span class="str">'text'</span> });

<span class="cm">// Partial index (only index active users)</span>
userSchema.<span class="fn">index</span>(
  { <span class="prop">email</span>: <span class="num">1</span> },
  { <span class="prop">partialFilterExpression</span>: { <span class="prop">isActive</span>: <span class="num">true</span> } }
);

<span class="cm">// TTL index (auto-delete after 30 days)</span>
sessionSchema.<span class="fn">index</span>(
  { <span class="prop">createdAt</span>: <span class="num">1</span> },
  { <span class="prop">expireAfterSeconds</span>: <span class="num">2592000</span> }  <span class="cm">// 30 days</span>
);

<span class="cm">// Explain a query to see index usage</span>
<span class="kw">const</span> explanation = <span class="kw">await</span> User
  .<span class="fn">find</span>({ <span class="prop">role</span>: <span class="str">'admin'</span> })
  .<span class="fn">explain</span>(<span class="str">'executionStats'</span>);
<span class="cm">// Look for: IXSCAN (good) vs COLLSCAN (bad = full scan)</span></pre>
        </div>

        <div class="pitfall-box">
          <h4>‚ö†Ô∏è Pitfall: Over-Indexing</h4>
          <p>Each index slows down writes (inserts, updates, deletes) and consumes RAM. Only index fields you actually query on. A collection with 20+ indexes will have terrible write performance. Use <code>.explain()</code> to verify indexes are being used.</p>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('mongo-advanced'); navigateToNext('pg-setup')">
        Continue ‚Üí PostgreSQL Setup
      </button>
    </div>

    <!-- ==================== SECTION: PG SETUP ==================== -->
    <div class="section" id="section-pg-setup">
      <div class="section-header">
        <h1>‚öôÔ∏è PostgreSQL Setup</h1>
        <p>Connect to PostgreSQL from Node.js using pg driver and query builders</p>
        <div class="badge-row">
          <span class="badge postgres">PostgreSQL</span>
          <span class="badge beginner">Beginner</span>
        </div>
      </div>

      <div class="card">
        <h2>üêò PostgreSQL Architecture</h2>
        <p>PostgreSQL stores data in <strong>tables</strong> with strict <strong>schemas</strong> (columns + types), inside a <strong>database</strong>.</p>
        <div class="flow-diagram">
          <div class="flow-box db">Database<br><small>"myapp_db"</small></div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box driver">Table<br><small>"users"</small></div>
          <div class="flow-arrow">‚Üí</div>
          <div class="flow-box app">Rows<br><small>id, name, email...</small></div>
        </div>
      </div>

      <div class="card">
        <h2>üîß Setting Up node-postgres (pg)</h2>
        <div class="code-block">
          <span class="code-label postgres">db/postgres.js</span>
<pre><span class="kw">const</span> { Pool } = <span class="fn">require</span>(<span class="str">'pg'</span>);

<span class="kw">const</span> pool = <span class="kw">new</span> <span class="fn">Pool</span>({
  <span class="prop">user</span>: process.env.<span class="var">PG_USER</span>,
  <span class="prop">host</span>: process.env.<span class="var">PG_HOST</span>,
  <span class="prop">database</span>: process.env.<span class="var">PG_DATABASE</span>,
  <span class="prop">password</span>: process.env.<span class="var">PG_PASSWORD</span>,
  <span class="prop">port</span>: <span class="fn">parseInt</span>(process.env.<span class="var">PG_PORT</span>) || <span class="num">5432</span>,
  <span class="prop">max</span>: <span class="num">20</span>,
  <span class="prop">idleTimeoutMillis</span>: <span class="num">30000</span>,
});

<span class="cm">// Test connection on startup</span>
(<span class="kw">async</span> () => {
  <span class="kw">try</span> {
    <span class="kw">const</span> client = <span class="kw">await</span> pool.<span class="fn">connect</span>();
    console.<span class="fn">log</span>(<span class="str">'‚úÖ PostgreSQL connected'</span>);
    client.<span class="fn">release</span>(); <span class="cm">// Return connection to pool!</span>
  } <span class="kw">catch</span> (err) {
    console.<span class="fn">error</span>(<span class="str">'‚ùå PostgreSQL connection failed'</span>, err);
  }
})();

module.exports = pool;</pre>
        </div>

        <div class="pitfall-box">
          <h4>‚ö†Ô∏è Pitfall: Forgetting to Release Client</h4>
          <p>When using <code>pool.connect()</code> to get a client for transactions, you MUST call <code>client.release()</code> in a <code>finally</code> block, or you'll leak connections and eventually exhaust the pool.</p>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('pg-setup'); navigateToNext('pg-crud')">
        Continue ‚Üí PostgreSQL CRUD
      </button>
    </div>

    <!-- ==================== SECTION: PG CRUD ==================== -->
    <div class="section" id="section-pg-crud">
      <div class="section-header">
        <h1>üìù PostgreSQL CRUD Operations</h1>
        <p>Perform SQL queries safely with parameterized queries</p>
        <div class="badge-row">
          <span class="badge postgres">PostgreSQL</span>
          <span class="badge intermediate">Intermediate</span>
        </div>
      </div>

      <div class="card">
        <h2>üìå Create Table First</h2>
        <div class="code-block">
          <span class="code-label sql">SQL</span>
<pre><span class="kw">CREATE TABLE</span> users (
  id          <span class="type">SERIAL PRIMARY KEY</span>,
  name        <span class="type">VARCHAR(100) NOT NULL</span>,
  email       <span class="type">VARCHAR(255) UNIQUE NOT NULL</span>,
  age         <span class="type">INTEGER CHECK</span> (age >= <span class="num">0</span> <span class="kw">AND</span> age <= <span class="num">150</span>),
  role        <span class="type">VARCHAR(20) DEFAULT</span> <span class="str">'user'</span>,
  is_active   <span class="type">BOOLEAN DEFAULT</span> <span class="num">true</span>,
  created_at  <span class="type">TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>,
  updated_at  <span class="type">TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
);</pre>
        </div>
      </div>

      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-btn active" onclick="switchTab(event, 'pg-create')">Create</button>
          <button class="tab-btn" onclick="switchTab(event, 'pg-read')">Read</button>
          <button class="tab-btn" onclick="switchTab(event, 'pg-update')">Update</button>
          <button class="tab-btn" onclick="switchTab(event, 'pg-delete')">Delete</button>
          <button class="tab-btn" onclick="switchTab(event, 'pg-transactions')">Transactions</button>
        </div>

        <div class="tab-panel active" id="tab-pg-create">
          <div class="code-block">
            <span class="code-label postgres">Create</span>
<pre><span class="kw">const</span> pool = <span class="fn">require</span>(<span class="str">'./db/postgres'</span>);

<span class="cm">// Insert one row ‚Äî ALWAYS use parameterized queries ($1, $2...)</span>
<span class="kw">async function</span> <span class="fn">createUser</span>(name, email, age) {
  <span class="kw">const</span> query = <span class="str">`
    INSERT INTO users (name, email, age)
    VALUES ($1, $2, $3)
    RETURNING *
  `</span>;
  <span class="kw">const</span> result = <span class="kw">await</span> pool.<span class="fn">query</span>(query, [name, email, age]);
  <span class="kw">return</span> result.rows[<span class="num">0</span>]; <span class="cm">// RETURNING * gives us the created row</span>
}

<span class="cm">// Insert many rows</span>
<span class="kw">async function</span> <span class="fn">createManyUsers</span>(users) {
  <span class="kw">const</span> values = users.<span class="fn">map</span>((u, i) => {
    <span class="kw">const</span> offset = i * <span class="num">3</span>;
    <span class="kw">return</span> <span class="str">`($${offset+1}, $${offset+2}, $${offset+3})`</span>;
  }).<span class="fn">join</span>(<span class="str">', '</span>);

  <span class="kw">const</span> params = users.<span class="fn">flatMap</span>(u => [u.name, u.email, u.age]);

  <span class="kw">const</span> query = <span class="str">`
    INSERT INTO users (name, email, age)
    VALUES ${values}
    RETURNING *
  `</span>;
  <span class="kw">const</span> result = <span class="kw">await</span> pool.<span class="fn">query</span>(query, params);
  <span class="kw">return</span> result.rows;
}</pre>
          </div>

          <div class="pitfall-box">
            <h4>üíÄ CRITICAL: SQL Injection Prevention</h4>
            <p>NEVER concatenate user input into SQL strings. This is the #1 security vulnerability in web apps.</p>
          </div>
          <div class="code-block">
            <span class="code-label bad">‚ùå SQL INJECTION VULNERABILITY</span>
<pre><span class="cm">// NEVER DO THIS ‚Äî attacker can input: '; DROP TABLE users; --</span>
<span class="kw">const</span> query = <span class="str">`SELECT * FROM users WHERE email = '${email}'`</span>;
<span class="kw">await</span> pool.<span class="fn">query</span>(query); <span class="cm">// ‚ùå DANGEROUS!</span></pre>
          </div>
          <div class="code-block">
            <span class="code-label good">‚úÖ SAFE ‚Äî Parameterized Query</span>
<pre><span class="kw">const</span> query = <span class="str">'SELECT * FROM users WHERE email = $1'</span>;
<span class="kw">await</span> pool.<span class="fn">query</span>(query, [email]); <span class="cm">// ‚úÖ Input is escaped</span></pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-pg-read">
          <div class="code-block">
            <span class="code-label postgres">Read</span>
<pre><span class="cm">// Find all</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(<span class="str">'SELECT * FROM users'</span>);

<span class="cm">// Find with conditions</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">'SELECT * FROM users WHERE role = $1 AND is_active = $2'</span>,
  [<span class="str">'admin'</span>, <span class="num">true</span>]
);

<span class="cm">// Find one</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">'SELECT * FROM users WHERE id = $1'</span>, [userId]
);
<span class="kw">const</span> user = rows[<span class="num">0</span>]; <span class="cm">// May be undefined</span>

<span class="cm">// Pagination</span>
<span class="kw">const</span> page = <span class="num">1</span>, limit = <span class="num">20</span>;
<span class="kw">const</span> offset = (page - <span class="num">1</span>) * limit;
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">`SELECT * FROM users
   ORDER BY created_at DESC
   LIMIT $1 OFFSET $2`</span>,
  [limit, offset]
);

<span class="cm">// Search with LIKE</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">'SELECT * FROM users WHERE name ILIKE $1'</span>,
  [<span class="str">`%${searchTerm}%`</span>] <span class="cm">// ILIKE = case-insensitive</span>
);

<span class="cm">// Aggregation</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(<span class="str">`
  SELECT role, COUNT(*) as count, AVG(age) as avg_age
  FROM users
  WHERE is_active = true
  GROUP BY role
  ORDER BY count DESC
`</span>);</pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-pg-update">
          <div class="code-block">
            <span class="code-label postgres">Update</span>
<pre><span class="cm">// Update one</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">`UPDATE users
   SET name = $1, age = $2, updated_at = NOW()
   WHERE id = $3
   RETURNING *`</span>,
  [<span class="str">'Alice Chen'</span>, <span class="num">29</span>, userId]
);

<span class="cm">// Conditional update</span>
<span class="kw">const</span> { rowCount } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">`UPDATE users
   SET is_active = false, updated_at = NOW()
   WHERE last_login < $1 AND is_active = true`</span>,
  [<span class="kw">new</span> <span class="fn">Date</span>(<span class="str">'2023-01-01'</span>)]
);
console.<span class="fn">log</span>(<span class="str">`Deactivated ${rowCount} users`</span>);

<span class="cm">// Upsert (INSERT or UPDATE if exists)</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(<span class="str">`
  INSERT INTO users (email, name, age)
  VALUES ($1, $2, $3)
  ON CONFLICT (email)
  DO UPDATE SET name = $2, age = $3, updated_at = NOW()
  RETURNING *
`</span>, [email, name, age]);</pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-pg-delete">
          <div class="code-block">
            <span class="code-label postgres">Delete</span>
<pre><span class="cm">// Delete one</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">'DELETE FROM users WHERE id = $1 RETURNING *'</span>,
  [userId]
);

<span class="cm">// Delete many</span>
<span class="kw">const</span> { rowCount } = <span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">'DELETE FROM users WHERE is_active = false'</span>
);

<span class="cm">// Soft delete (recommended)</span>
<span class="kw">await</span> pool.<span class="fn">query</span>(
  <span class="str">`UPDATE users
   SET is_deleted = true, deleted_at = NOW()
   WHERE id = $1`</span>,
  [userId]
);</pre>
          </div>
        </div>

        <div class="tab-panel" id="tab-pg-transactions">
          <h3>üîí Transactions ‚Äî All-or-Nothing</h3>
          <div class="code-block">
            <span class="code-label postgres">Transaction</span>
<pre><span class="cm">// Transfer money between accounts ‚Äî must be atomic!</span>
<span class="kw">async function</span> <span class="fn">transferMoney</span>(fromId, toId, amount) {
  <span class="kw">const</span> client = <span class="kw">await</span> pool.<span class="fn">connect</span>();

  <span class="kw">try</span> {
    <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'BEGIN'</span>); <span class="cm">// Start transaction</span>

    <span class="cm">// Debit from sender</span>
    <span class="kw">const</span> debit = <span class="kw">await</span> client.<span class="fn">query</span>(
      <span class="str">`UPDATE accounts SET balance = balance - $1
       WHERE id = $2 AND balance >= $1
       RETURNING *`</span>,
      [amount, fromId]
    );

    <span class="kw">if</span> (debit.rowCount === <span class="num">0</span>) {
      <span class="kw">throw new</span> <span class="fn">Error</span>(<span class="str">'Insufficient funds'</span>);
    }

    <span class="cm">// Credit to receiver</span>
    <span class="kw">await</span> client.<span class="fn">query</span>(
      <span class="str">'UPDATE accounts SET balance = balance + $1 WHERE id = $2'</span>,
      [amount, toId]
    );

    <span class="cm">// Log the transaction</span>
    <span class="kw">await</span> client.<span class="fn">query</span>(
      <span class="str">`INSERT INTO transactions (from_id, to_id, amount)
       VALUES ($1, $2, $3)`</span>,
      [fromId, toId, amount]
    );

    <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'COMMIT'</span>); <span class="cm">// ‚úÖ All succeeded</span>
  } <span class="kw">catch</span> (error) {
    <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'ROLLBACK'</span>); <span class="cm">// ‚ùå Undo everything</span>
    <span class="kw">throw</span> error;
  } <span class="kw">finally</span> {
    client.<span class="fn">release</span>(); <span class="cm">// ‚ö†Ô∏è ALWAYS release back to pool!</span>
  }
}</pre>
          </div>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('pg-crud'); navigateToNext('pg-schema')">
        Continue ‚Üí Schema & Migrations
      </button>
    </div>

    <!-- ==================== SECTION: PG SCHEMA ==================== -->
    <div class="section" id="section-pg-schema">
      <div class="section-header">
        <h1>üìê PostgreSQL Schema & Migrations</h1>
        <p>Design relational schemas and manage changes with migrations</p>
        <div class="badge-row">
          <span class="badge postgres">PostgreSQL</span>
          <span class="badge intermediate">Intermediate</span>
        </div>
      </div>

      <div class="card">
        <h2>üèóÔ∏è Relational Schema Design</h2>
        <div class="schema-viz">
          <div class="schema-entity">
            <div class="schema-entity-header pg-h">üêò users</div>
            <div class="schema-field pk"><span class="schema-field-name">id</span><span class="schema-field-type">SERIAL PK</span></div>
            <div class="schema-field"><span class="schema-field-name">name</span><span class="schema-field-type">VARCHAR(100)</span></div>
            <div class="schema-field"><span class="schema-field-name">email</span><span class="schema-field-type">VARCHAR(255)</span></div>
            <div class="schema-field"><span class="schema-field-name">created_at</span><span class="schema-field-type">TIMESTAMP</span></div>
          </div>
          <div class="schema-relation">‚Üê‚Üí</div>
          <div class="schema-entity">
            <div class="schema-entity-header pg-h">üêò posts</div>
            <div class="schema-field pk"><span class="schema-field-name">id</span><span class="schema-field-type">SERIAL PK</span></div>
            <div class="schema-field fk"><span class="schema-field-name">author_id</span><span class="schema-field-type">INT FK ‚Üí users</span></div>
            <div class="schema-field"><span class="schema-field-name">title</span><span class="schema-field-type">VARCHAR(200)</span></div>
            <div class="schema-field"><span class="schema-field-name">content</span><span class="schema-field-type">TEXT</span></div>
          </div>
          <div class="schema-relation">‚Üê‚Üí</div>
          <div class="schema-entity">
            <div class="schema-entity-header pg-h">üêò comments</div>
            <div class="schema-field pk"><span class="schema-field-name">id</span><span class="schema-field-type">SERIAL PK</span></div>
            <div class="schema-field fk"><span class="schema-field-name">post_id</span><span class="schema-field-type">INT FK ‚Üí posts</span></div>
            <div class="schema-field fk"><span class="schema-field-name">user_id</span><span class="schema-field-type">INT FK ‚Üí users</span></div>
            <div class="schema-field"><span class="schema-field-name">body</span><span class="schema-field-type">TEXT</span></div>
          </div>
        </div>

        <div class="code-block">
          <span class="code-label sql">Full Schema</span>
<pre><span class="cm">-- Complete relational schema with constraints</span>

<span class="kw">CREATE TABLE</span> users (
  id          <span class="type">SERIAL PRIMARY KEY</span>,
  name        <span class="type">VARCHAR(100) NOT NULL</span>,
  email       <span class="type">VARCHAR(255) UNIQUE NOT NULL</span>,
  password    <span class="type">VARCHAR(255) NOT NULL</span>,
  role        <span class="type">VARCHAR(20) DEFAULT</span> <span class="str">'user'</span>
              <span class="type">CHECK</span> (role <span class="kw">IN</span> (<span class="str">'user'</span>, <span class="str">'admin'</span>, <span class="str">'mod'</span>)),
  is_active   <span class="type">BOOLEAN DEFAULT</span> <span class="num">true</span>,
  created_at  <span class="type">TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>,
  updated_at  <span class="type">TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
);

<span class="kw">CREATE TABLE</span> posts (
  id          <span class="type">SERIAL PRIMARY KEY</span>,
  author_id   <span class="type">INTEGER NOT NULL</span>
              <span class="type">REFERENCES</span> users(id) <span class="kw">ON DELETE CASCADE</span>,
  title       <span class="type">VARCHAR(200) NOT NULL</span>,
  content     <span class="type">TEXT</span>,
  status      <span class="type">VARCHAR(20) DEFAULT</span> <span class="str">'draft'</span>,
  created_at  <span class="type">TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
);

<span class="cm">-- Many-to-many: tags ‚Üî posts</span>
<span class="kw">CREATE TABLE</span> tags (
  id    <span class="type">SERIAL PRIMARY KEY</span>,
  name  <span class="type">VARCHAR(50) UNIQUE NOT NULL</span>
);

<span class="kw">CREATE TABLE</span> post_tags (
  post_id  <span class="type">INTEGER REFERENCES</span> posts(id) <span class="kw">ON DELETE CASCADE</span>,
  tag_id   <span class="type">INTEGER REFERENCES</span> tags(id) <span class="kw">ON DELETE CASCADE</span>,
  <span class="kw">PRIMARY KEY</span> (post_id, tag_id)
);

<span class="cm">-- Indexes for common queries</span>
<span class="kw">CREATE INDEX</span> idx_posts_author <span class="kw">ON</span> posts(author_id);
<span class="kw">CREATE INDEX</span> idx_posts_status <span class="kw">ON</span> posts(status);
<span class="kw">CREATE INDEX</span> idx_posts_created <span class="kw">ON</span> posts(created_at <span class="kw">DESC</span>);</pre>
        </div>
      </div>

      <div class="card">
        <h2>üîÑ Migrations with Knex.js</h2>
        <div class="code-block">
          <span class="code-label js">Knex Migration</span>
<pre><span class="cm">// knexfile.js</span>
module.exports = {
  <span class="prop">development</span>: {
    <span class="prop">client</span>: <span class="str">'pg'</span>,
    <span class="prop">connection</span>: process.env.<span class="var">POSTGRES_URL</span>,
    <span class="prop">migrations</span>: { <span class="prop">directory</span>: <span class="str">'./migrations'</span> },
    <span class="prop">seeds</span>: { <span class="prop">directory</span>: <span class="str">'./seeds'</span> },
  }
};

<span class="cm">// Migration: 20240115_create_users.js</span>
exports.<span class="fn">up</span> = <span class="kw">function</span>(knex) {
  <span class="kw">return</span> knex.schema.<span class="fn">createTable</span>(<span class="str">'users'</span>, (table) => {
    table.<span class="fn">increments</span>(<span class="str">'id'</span>).<span class="fn">primary</span>();
    table.<span class="fn">string</span>(<span class="str">'name'</span>, <span class="num">100</span>).<span class="fn">notNullable</span>();
    table.<span class="fn">string</span>(<span class="str">'email'</span>, <span class="num">255</span>).<span class="fn">unique</span>().<span class="fn">notNullable</span>();
    table.<span class="fn">string</span>(<span class="str">'password'</span>, <span class="num">255</span>).<span class="fn">notNullable</span>();
    table.<span class="fn">enu</span>(<span class="str">'role'</span>, [<span class="str">'user'</span>, <span class="str">'admin'</span>, <span class="str">'mod'</span>]).<span class="fn">defaultTo</span>(<span class="str">'user'</span>);
    table.<span class="fn">boolean</span>(<span class="str">'is_active'</span>).<span class="fn">defaultTo</span>(<span class="num">true</span>);
    table.<span class="fn">timestamps</span>(<span class="num">true</span>, <span class="num">true</span>);
  });
};

exports.<span class="fn">down</span> = <span class="kw">function</span>(knex) {
  <span class="kw">return</span> knex.schema.<span class="fn">dropTable</span>(<span class="str">'users'</span>);
};

<span class="cm">// Run: npx knex migrate:latest</span>
<span class="cm">// Undo: npx knex migrate:rollback</span></pre>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('pg-schema'); navigateToNext('pg-advanced')">
        Continue ‚Üí Joins & Query Optimization
      </button>
    </div>

    <!-- ==================== SECTION: PG ADVANCED ==================== -->
    <div class="section" id="section-pg-advanced">
      <div class="section-header">
        <h1>üöÄ Joins & Query Optimization</h1>
        <p>Master SQL joins, subqueries, and performance tuning</p>
        <div class="badge-row">
          <span class="badge postgres">PostgreSQL</span>
          <span class="badge advanced">Advanced</span>
        </div>
      </div>

      <div class="card">
        <h2>üîó SQL Joins Explained</h2>
        <div class="code-block">
          <span class="code-label sql">Joins</span>
<pre><span class="cm">-- INNER JOIN: Only matching rows from both tables</span>
<span class="kw">SELECT</span> u.name, p.title
<span class="kw">FROM</span> users u
<span class="kw">INNER JOIN</span> posts p <span class="kw">ON</span> u.id = p.author_id;

<span class="cm">-- LEFT JOIN: All users + their posts (NULL if no posts)</span>
<span class="kw">SELECT</span> u.name, <span class="fn">COUNT</span>(p.id) <span class="kw">AS</span> post_count
<span class="kw">FROM</span> users u
<span class="kw">LEFT JOIN</span> posts p <span class="kw">ON</span> u.id = p.author_id
<span class="kw">GROUP BY</span> u.id, u.name
<span class="kw">ORDER BY</span> post_count <span class="kw">DESC</span>;

<span class="cm">-- Complex: Users with their posts and tags</span>
<span class="kw">SELECT</span>
  u.name,
  p.title,
  <span class="fn">ARRAY_AGG</span>(t.name) <span class="kw">AS</span> tags
<span class="kw">FROM</span> users u
<span class="kw">JOIN</span> posts p <span class="kw">ON</span> u.id = p.author_id
<span class="kw">LEFT JOIN</span> post_tags pt <span class="kw">ON</span> p.id = pt.post_id
<span class="kw">LEFT JOIN</span> tags t <span class="kw">ON</span> pt.tag_id = t.id
<span class="kw">WHERE</span> p.status = <span class="str">'published'</span>
<span class="kw">GROUP BY</span> u.name, p.title
<span class="kw">ORDER BY</span> p.created_at <span class="kw">DESC</span>
<span class="kw">LIMIT</span> <span class="num">20</span>;</pre>
        </div>
      </div>

      <div class="card">
        <h2>‚ö° Query Optimization with EXPLAIN</h2>
        <div class="code-block">
          <span class="code-label sql">Optimization</span>
<pre><span class="cm">-- See how PostgreSQL executes your query</span>
<span class="kw">EXPLAIN ANALYZE</span>
<span class="kw">SELECT</span> * <span class="kw">FROM</span> users <span class="kw">WHERE</span> email = <span class="str">'alice@example.com'</span>;

<span class="cm">-- Output you WANT to see:</span>
<span class="cm">-- Index Scan using users_email_key on users</span>
<span class="cm">--   Index Cond: (email = 'alice@example.com')</span>
<span class="cm">--   Execution Time: 0.045 ms ‚úÖ</span>

<span class="cm">-- Output you DON'T want to see:</span>
<span class="cm">-- Seq Scan on users  ‚Üê FULL TABLE SCAN! ‚ùå</span>
<span class="cm">--   Filter: (email = 'alice@example.com')</span>
<span class="cm">--   Execution Time: 234.5 ms</span>

<span class="cm">-- Fix: Add an index!</span>
<span class="kw">CREATE INDEX</span> idx_users_email <span class="kw">ON</span> users(email);

<span class="cm">-- Composite index for common query pattern</span>
<span class="kw">CREATE INDEX</span> idx_posts_author_status
<span class="kw">ON</span> posts(author_id, status)
<span class="kw">WHERE</span> status = <span class="str">'published'</span>; <span class="cm">-- Partial index!</span></pre>
        </div>

        <div class="warning-box">
          <h4>‚ö° Performance Rules</h4>
          <p>1. Index columns used in WHERE, JOIN, and ORDER BY clauses<br>
          2. Use <code>EXPLAIN ANALYZE</code> before and after adding indexes<br>
          3. Avoid <code>SELECT *</code> ‚Äî only select needed columns<br>
          4. Use pagination (LIMIT/OFFSET or cursor-based)<br>
          5. Don't index columns with low cardinality (e.g., boolean)</p>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('pg-advanced'); navigateToNext('schema-design')">
        Continue ‚Üí Schema Design Patterns
      </button>
    </div>

    <!-- ==================== SECTION: SCHEMA DESIGN ==================== -->
    <div class="section" id="section-schema-design">
      <div class="section-header">
        <h1>üèóÔ∏è Schema Design Patterns</h1>
        <p>Design decisions that make or break your application</p>
        <div class="badge-row">
          <span class="badge advanced">Advanced</span>
          <span class="badge mongo">MongoDB</span>
          <span class="badge postgres">PostgreSQL</span>
        </div>
      </div>

      <div class="card">
        <h2>üìê Pattern 1: Attribute Pattern (MongoDB)</h2>
        <p>When documents have many similar fields with different characteristics. Instead of creating a field for each attribute, use an array of key-value pairs.</p>
        <div class="two-col">
          <div>
            <div class="code-block">
              <span class="code-label bad">‚ùå Before</span>
<pre>{
  <span class="key">"color"</span>: <span class="str">"red"</span>,
  <span class="key">"size"</span>: <span class="str">"XL"</span>,
  <span class="key">"material"</span>: <span class="str">"cotton"</span>,
  <span class="key">"weight_kg"</span>: <span class="num">0.5</span>,
  <span class="key">"weight_lb"</span>: <span class="num">1.1</span>
  <span class="cm">// Hard to index!</span>
}</pre>
            </div>
          </div>
          <div>
            <div class="code-block">
              <span class="code-label good">‚úÖ After</span>
<pre>{
  <span class="key">"specs"</span>: [
    { <span class="key">"k"</span>: <span class="str">"color"</span>, <span class="key">"v"</span>: <span class="str">"red"</span> },
    { <span class="key">"k"</span>: <span class="str">"size"</span>, <span class="key">"v"</span>: <span class="str">"XL"</span> },
    { <span class="key">"k"</span>: <span class="str">"weight"</span>,
      <span class="key">"v"</span>: <span class="num">0.5</span>, <span class="key">"u"</span>: <span class="str">"kg"</span> }
  ]
}
<span class="cm">// Index: { "specs.k": 1, "specs.v": 1 }</span></pre>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>üìê Pattern 2: Bucket Pattern (MongoDB)</h2>
        <p>For time-series data (IoT, logs, analytics), group related measurements into "buckets" to reduce document count and improve query performance.</p>
        <div class="code-block">
          <span class="code-label mongo">Bucket Pattern</span>
<pre><span class="cm">// Instead of 1 document per reading (millions of docs!):</span>
{ <span class="key">"sensor"</span>: <span class="str">"temp-1"</span>, <span class="key">"time"</span>: <span class="str">"10:00:01"</span>, <span class="key">"value"</span>: <span class="num">22.5</span> }
{ <span class="key">"sensor"</span>: <span class="str">"temp-1"</span>, <span class="key">"time"</span>: <span class="str">"10:00:02"</span>, <span class="key">"value"</span>: <span class="num">22.6</span> }
<span class="cm">// ... millions more</span>

<span class="cm">// Bucket: 1 document per hour with all readings</span>
{
  <span class="key">"sensor"</span>: <span class="str">"temp-1"</span>,
  <span class="key">"bucket_start"</span>: <span class="str">"2024-01-15T10:00:00Z"</span>,
  <span class="key">"count"</span>: <span class="num">3600</span>,
  <span class="key">"sum"</span>: <span class="num">81234.5</span>,
  <span class="key">"avg"</span>: <span class="num">22.56</span>,
  <span class="key">"readings"</span>: [
    { <span class="key">"t"</span>: <span class="num">0</span>, <span class="key">"v"</span>: <span class="num">22.5</span> },
    { <span class="key">"t"</span>: <span class="num">1</span>, <span class="key">"v"</span>: <span class="num">22.6</span> },
    <span class="cm">// ... offset from bucket_start</span>
  ]
}</pre>
        </div>
      </div>

      <div class="card">
        <h2>üìê Pattern 3: Polymorphic Pattern</h2>
        <p>When a collection stores different types of related documents.</p>
        <div class="code-block">
          <span class="code-label mongo">Polymorphic</span>
<pre><span class="cm">// Notifications collection ‚Äî different types, same collection</span>
{
  <span class="key">"type"</span>: <span class="str">"like"</span>,
  <span class="key">"userId"</span>: <span class="fn">ObjectId</span>(<span class="str">"..."</span>),
  <span class="key">"postId"</span>: <span class="fn">ObjectId</span>(<span class="str">"..."</span>),
  <span class="key">"fromUser"</span>: <span class="str">"Alice"</span>
}
{
  <span class="key">"type"</span>: <span class="str">"comment"</span>,
  <span class="key">"userId"</span>: <span class="fn">ObjectId</span>(<span class="str">"..."</span>),
  <span class="key">"postId"</span>: <span class="fn">ObjectId</span>(<span class="str">"..."</span>),
  <span class="key">"fromUser"</span>: <span class="str">"Bob"</span>,
  <span class="key">"commentText"</span>: <span class="str">"Great post!"</span>
}
{
  <span class="key">"type"</span>: <span class="str">"follow"</span>,
  <span class="key">"userId"</span>: <span class="fn">ObjectId</span>(<span class="str">"..."</span>),
  <span class="key">"fromUser"</span>: <span class="str">"Carol"</span>
}

<span class="cm">// Query by type or user ‚Äî single index serves all</span>
db.notifications.<span class="fn">createIndex</span>({ <span class="prop">userId</span>: <span class="num">1</span>, <span class="prop">type</span>: <span class="num">1</span> });</pre>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('schema-design'); navigateToNext('optimization')">
        Continue ‚Üí Query Optimization Deep Dive
      </button>
    </div>

    <!-- ==================== SECTION: OPTIMIZATION ==================== -->
    <div class="section" id="section-optimization">
      <div class="section-header">
        <h1>‚ö° Query Optimization Deep Dive</h1>
        <p>Make your database queries fast, efficient, and scalable</p>
        <div class="badge-row">
          <span class="badge advanced">Advanced</span>
        </div>
      </div>

      <div class="card">
        <h2>üèéÔ∏è The Optimization Checklist</h2>
        <ol>
          <li><strong>Use indexes</strong> on fields in WHERE/filter, JOIN, and ORDER BY</li>
          <li><strong>Select only needed fields</strong> ‚Äî avoid <code>SELECT *</code> / fetching full documents</li>
          <li><strong>Use pagination</strong> ‚Äî never return unbounded result sets</li>
          <li><strong>Avoid N+1 queries</strong> ‚Äî use JOINs or batch loading</li>
          <li><strong>Use connection pooling</strong> ‚Äî reuse database connections</li>
          <li><strong>Cache frequently-read data</strong> ‚Äî Redis for hot data</li>
          <li><strong>Use projections</strong> ‚Äî MongoDB <code>.select()</code> / PG column list</li>
          <li><strong>Denormalize for read-heavy workloads</strong></li>
        </ol>
      </div>

      <div class="card">
        <h2>üíÄ The N+1 Query Problem</h2>
        <p>This is one of the most common performance killers and a <strong>frequent interview question</strong>.</p>
        <div class="code-block">
          <span class="code-label bad">‚ùå N+1 Problem</span>
<pre><span class="cm">// BAD: 1 query to get posts + N queries to get each author</span>
<span class="kw">const</span> posts = <span class="kw">await</span> Post.<span class="fn">find</span>(); <span class="cm">// 1 query</span>

<span class="kw">for</span> (<span class="kw">const</span> post <span class="kw">of</span> posts) {
  <span class="cm">// N queries! One per post!</span>
  post.authorName = (<span class="kw">await</span> User.<span class="fn">findById</span>(post.author))?.name;
}
<span class="cm">// If you have 100 posts = 101 database queries! üò±</span></pre>
        </div>
        <div class="code-block">
          <span class="code-label good">‚úÖ Solution: Single Query</span>
<pre><span class="cm">// GOOD MongoDB: Use populate</span>
<span class="kw">const</span> posts = <span class="kw">await</span> Post
  .<span class="fn">find</span>()
  .<span class="fn">populate</span>(<span class="str">'author'</span>, <span class="str">'name'</span>)  <span class="cm">// 2 queries total</span>
  .<span class="fn">lean</span>();

<span class="cm">// GOOD PostgreSQL: Use JOIN</span>
<span class="kw">const</span> { rows } = <span class="kw">await</span> pool.<span class="fn">query</span>(<span class="str">`
  SELECT p.*, u.name as author_name
  FROM posts p
  JOIN users u ON p.author_id = u.id
`</span>); <span class="cm">// 1 query! üöÄ</span></pre>
        </div>
      </div>

      <div class="card">
        <h2>üìä Cursor-Based Pagination (Better than OFFSET)</h2>
        <div class="code-block">
          <span class="code-label good">Cursor Pagination</span>
<pre><span class="cm">// OFFSET pagination is slow for large datasets</span>
<span class="cm">// OFFSET 1000000 = DB must count through 1M rows first!</span>

<span class="cm">// Cursor-based pagination ‚Äî consistently fast!</span>
<span class="kw">async function</span> <span class="fn">getPostsCursor</span>(cursor, limit = <span class="num">20</span>) {
  <span class="kw">let</span> query;

  <span class="kw">if</span> (cursor) {
    <span class="cm">// PostgreSQL</span>
    query = <span class="kw">await</span> pool.<span class="fn">query</span>(
      <span class="str">`SELECT * FROM posts
       WHERE created_at < $1
       ORDER BY created_at DESC
       LIMIT $2`</span>,
      [cursor, limit]
    );
  } <span class="kw">else</span> {
    query = <span class="kw">await</span> pool.<span class="fn">query</span>(
      <span class="str">`SELECT * FROM posts
       ORDER BY created_at DESC
       LIMIT $1`</span>,
      [limit]
    );
  }

  <span class="kw">const</span> posts = query.rows;
  <span class="kw">const</span> nextCursor = posts.length > <span class="num">0</span>
    ? posts[posts.length - <span class="num">1</span>].created_at
    : <span class="num">null</span>;

  <span class="kw">return</span> { <span class="prop">posts</span>, <span class="prop">nextCursor</span>, <span class="prop">hasMore</span>: posts.length === limit };
}</pre>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('optimization'); navigateToNext('exercise1')">
        Continue ‚Üí Exercise: Build an API
      </button>
    </div>

    <!-- ==================== SECTION: EXERCISE 1 ==================== -->
    <div class="section" id="section-exercise1">
      <div class="section-header">
        <h1>üí™ Exercise: Build a REST API</h1>
        <p>Practice writing database operations by completing the code challenges below</p>
        <div class="badge-row">
          <span class="badge intermediate">Intermediate</span>
          <span class="badge mongo">MongoDB</span>
        </div>
      </div>

      <div class="challenge-box">
        <h3>üéØ Challenge: Complete the User API</h3>
        <p>Fill in the database operations for each endpoint. The Express routes are set up ‚Äî you just need the Mongoose queries.</p>
        <ul class="challenge-requirements" id="ex1-requirements">
          <li>Complete the GET /users endpoint with filtering</li>
          <li>Complete the POST /users endpoint with validation</li>
          <li>Complete the PUT /users/:id endpoint</li>
          <li>Complete the DELETE /users/:id endpoint</li>
        </ul>
      </div>

      <!-- Exercise 1: GET -->
      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-dots"><span></span><span></span><span></span></div>
          <div class="editor-title">üìù Challenge 1: GET /users ‚Äî Find users with optional role filter</div>
        </div>
        <textarea class="code-textarea" id="ex1-code1" spellcheck="false">// Complete this function:
// If `role` query param exists, filter by role
// Sort by createdAt descending
// Return only name, email, role fields
// Use .lean() for performance

async function getUsers(req, res) {
  try {
    const { role } = req.query;
    const filter = {};

    // YOUR CODE HERE:
    // 1. If role exists, add it to filter
    // 2. Build the query with User.find()
    // 3. Add select, sort, and lean

    const users = await User.find(filter);
    res.json(users);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}</textarea>
        <div class="editor-actions">
          <button class="btn btn-check" onclick="checkExercise1a()">Check Answer</button>
          <button class="btn btn-hint" onclick="showHint('ex1-hint1')">üí° Hint</button>
          <button class="btn btn-reset" onclick="resetExercise('ex1-code1', ex1Code1Default)">Reset</button>
        </div>
        <div class="output-panel" id="ex1-output1">Click "Check Answer" to validate your solution...</div>
        <div id="ex1-hint1" style="display:none" class="tip-box">
          <h4>üí° Hint</h4>
          <p>1. Use <code>if (role) filter.role = role;</code><br>
          2. Chain <code>.select('name email role')</code><br>
          3. Chain <code>.sort({ createdAt: -1 })</code><br>
          4. Chain <code>.lean()</code></p>
        </div>
      </div>

      <!-- Exercise 2: POST -->
      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-dots"><span></span><span></span><span></span></div>
          <div class="editor-title">üìù Challenge 2: POST /users ‚Äî Create user with error handling</div>
        </div>
        <textarea class="code-textarea" id="ex1-code2" spellcheck="false">// Complete this function:
// Create a user from req.body
// Handle duplicate email (error code 11000)
// Handle validation errors
// Return 201 status on success

async function createUser(req, res) {
  try {
    // YOUR CODE HERE:
    // 1. Use User.create() with req.body
    // 2. Return status 201 with the user

  } catch (error) {
    // YOUR CODE HERE:
    // 3. Check if error.code === 11000 (duplicate)
    // 4. Check if error.name === 'ValidationError'
    // 5. Default to 500 error

  }
}</textarea>
        <div class="editor-actions">
          <button class="btn btn-check" onclick="checkExercise1b()">Check Answer</button>
          <button class="btn btn-hint" onclick="showHint('ex1-hint2')">üí° Hint</button>
          <button class="btn btn-reset" onclick="resetExercise('ex1-code2', ex1Code2Default)">Reset</button>
        </div>
        <div class="output-panel" id="ex1-output2">Click "Check Answer" to validate your solution...</div>
        <div id="ex1-hint2" style="display:none" class="tip-box">
          <h4>üí° Hint</h4>
          <p>In the try block: <code>const user = await User.create(req.body);</code> then <code>res.status(201).json(user);</code><br>
          In catch: check <code>error.code === 11000</code> for status 409, <code>error.name === 'ValidationError'</code> for status 400.</p>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('exercise1'); navigateToNext('exercise2')">
        Continue ‚Üí Exercise: Schema Design
      </button>
    </div>

    <!-- ==================== SECTION: EXERCISE 2 ==================== -->
    <div class="section" id="section-exercise2">
      <div class="section-header">
        <h1>üí™ Exercise: Schema Design Challenge</h1>
        <p>Design schemas for real-world scenarios</p>
        <div class="badge-row">
          <span class="badge advanced">Advanced</span>
        </div>
      </div>

      <div class="challenge-box">
        <h3>üéØ Challenge: E-Commerce Schema</h3>
        <p>Design a schema for an e-commerce application. Consider: Products, Orders, Users, Reviews. Write the Mongoose schemas or SQL CREATE TABLE statements.</p>
        <ul class="challenge-requirements" id="ex2-requirements">
          <li>Design User schema with addresses</li>
          <li>Design Product schema with variants</li>
          <li>Design Order schema with items</li>
          <li>Handle relationships correctly</li>
        </ul>
      </div>

      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-dots"><span></span><span></span><span></span></div>
          <div class="editor-title">üìù Design the Product Schema (MongoDB/Mongoose)</div>
        </div>
        <textarea class="code-textarea" id="ex2-code1" spellcheck="false">// Design a Product schema for an e-commerce site
// Requirements:
// - name (required, trimmed)
// - price (required, min 0)
// - description
// - category (enum: electronics, clothing, books, home)
// - variants (array of: { size, color, stock })
// - ratings: { average, count }
// - seller (reference to User)
// - tags (array of strings)
// - timestamps

const productSchema = new mongoose.Schema({
  // YOUR CODE HERE

});</textarea>
        <div class="editor-actions">
          <button class="btn btn-check" onclick="checkExercise2()">Check Answer</button>
          <button class="btn btn-hint" onclick="showHint('ex2-hint1')">üí° Hint</button>
          <button class="btn btn-reset" onclick="resetExercise('ex2-code1', ex2Code1Default)">Reset</button>
        </div>
        <div class="output-panel" id="ex2-output1">Click "Check Answer" to validate your schema design...</div>
        <div id="ex2-hint1" style="display:none" class="tip-box">
          <h4>üí° Hint</h4>
          <p>Embed variants since they belong to the product (1:few). Reference the seller since a User can have many products. Use a subdocument for ratings. Don't forget indexes on category and price for filtering!</p>
        </div>
      </div>

      <button class="btn btn-run" onclick="completeSection('exercise2'); navigateToNext('simulator')">
        Continue ‚Üí DB Simulator
      </button>
    </div>

    <!-- ==================== SECTION: SIMULATOR ==================== -->
    <div class="section" id="section-simulator">
      <div class="section-header">
        <h1>üñ•Ô∏è Interactive Database Simulator</h1>
        <p>Practice database operations in a simulated environment</p>
        <div class="badge-row">
          <span class="badge beginner">Practice</span>
          <span class="badge mongo">MongoDB</span>
        </div>
      </div>

      <div class="db-simulator">
        <div class="db-sim-header">
          <div class="db-sim-title">üçÉ MongoDB Simulator</div>
          <div class="db-sim-status" id="dbStatus">‚óè Connected</div>
        </div>
        <div class="db-tables" id="dbTables">
          <div class="db-table-card">
            <div class="db-table-name">üìÅ users</div>
            <div id="usersCollection">
              <div class="db-record">{ name: "Alice", email: "alice@ex.com", age: 28 }</div>
              <div class="db-record">{ name: "Bob", email: "bob@ex.com", age: 34 }</div>
              <div class="db-record">{ name: "Carol", email: "carol@ex.com", age: 25 }</div>
            </div>
            <div class="db-record-count" id="usersCount">3 documents</div>
          </div>
          <div class="db-table-card">
            <div class="db-table-name">üìÅ posts</div>
            <div id="postsCollection">
              <div class="db-record">{ title: "Hello World", author: "Alice" }</div>
              <div class="db-record">{ title: "MongoDB Tips", author: "Bob" }</div>
            </div>
            <div class="db-record-count" id="postsCount">2 documents</div>
          </div>
        </div>
      </div>

      <div class="editor-container">
        <div class="editor-header">
          <div class="editor-dots"><span></span><span></span><span></span></div>
          <div class="editor-title">üçÉ MongoDB Shell ‚Äî Write your queries here</div>
        </div>
        <textarea class="code-textarea" id="sim-code" spellcheck="false">// Try these commands:
// db.users.find()
// db.users.find({ age: { $gt: 25 } })
// db.users.insertOne({ name: "Dave", email: "dave@ex.com", age: 30 })
// db.users.updateOne({ name: "Alice" }, { $set: { age: 29 } })
// db.users.deleteOne({ name: "Bob" })
// db.users.find().sort({ age: -1 })
// db.users.countDocuments()
// db.posts.find({ author: "Alice" })

db.users.find()</textarea>
        <div class="editor-actions">
          <button class="btn btn-run" onclick="runSimulator()">‚ñ∂ Execute</button>
          <button class="btn btn-reset" onclick="resetSimulator()">üîÑ Reset DB</button>
        </div>
        <div class="output-panel" id="sim-output">
<span class="output-info">Ready. Type a command and click Execute.</span>
        </div>
      </div>

      <div class="info-box">
        <h4>üìù Supported Commands</h4>
        <p><code>db.users.find(filter)</code> ¬∑ <code>db.users.insertOne(doc)</code> ¬∑ <code>db.users.updateOne(filter, update)</code> ¬∑ <code>db.users.deleteOne(filter)</code> ¬∑ <code>db.users.countDocuments()</code> ¬∑ <code>db.users.find().sort()</code> ¬∑ Same for <code>db.posts</code></p>
      </div>

      <button class="btn btn-run" onclick="completeSection('simulator'); navigateToNext('pitfalls')">
        Continue ‚Üí Common Mistakes
      </button>
    </div>

    <!-- ==================== SECTION: PITFALLS ==================== -->
    <div class="section" id="section-pitfalls">
      <div class="section-header">
        <h1>üíÄ Common Mistakes & Pitfalls</h1>
        <p>Avoid these critical errors that even experienced developers make</p>
        <div class="badge-row">
          <span class="badge advanced">Must Know</span>
        </div>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 1: Not Using Parameterized Queries (SQL Injection)</h4>
        <p>The #1 security vulnerability. NEVER concatenate user input into SQL strings.</p>
      </div>
      <div class="code-block">
        <span class="code-label bad">‚ùå Vulnerable</span>
<pre><span class="kw">const</span> query = <span class="str">`SELECT * FROM users WHERE id = ${req.params.id}`</span>;
<span class="cm">// Attacker sends: id = "1; DROP TABLE users;"</span></pre>
      </div>
      <div class="code-block">
        <span class="code-label good">‚úÖ Safe</span>
<pre><span class="kw">const</span> query = <span class="str">'SELECT * FROM users WHERE id = $1'</span>;
<span class="kw">await</span> pool.<span class="fn">query</span>(query, [req.params.id]);</pre>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 2: Connection Leaks</h4>
        <p>Forgetting to release connections back to the pool, especially in error paths.</p>
      </div>
      <div class="code-block">
        <span class="code-label bad">‚ùå Connection Leak</span>
<pre><span class="kw">const</span> client = <span class="kw">await</span> pool.<span class="fn">connect</span>();
<span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'BEGIN'</span>);
<span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'INSERT ...'</span>); <span class="cm">// If this throws...</span>
<span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'COMMIT'</span>);
client.<span class="fn">release</span>(); <span class="cm">// ‚ùå Never reached if error above!</span></pre>
      </div>
      <div class="code-block">
        <span class="code-label good">‚úÖ Always Use Finally</span>
<pre><span class="kw">const</span> client = <span class="kw">await</span> pool.<span class="fn">connect</span>();
<span class="kw">try</span> {
  <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'BEGIN'</span>);
  <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'INSERT ...'</span>);
  <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'COMMIT'</span>);
} <span class="kw">catch</span> (e) {
  <span class="kw">await</span> client.<span class="fn">query</span>(<span class="str">'ROLLBACK'</span>);
  <span class="kw">throw</span> e;
} <span class="kw">finally</span> {
  client.<span class="fn">release</span>(); <span class="cm">// ‚úÖ Always runs!</span>
}</pre>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 3: N+1 Query Problem</h4>
        <p>Executing a query inside a loop. Each iteration hits the database separately.</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 4: Mongoose runValidators Default</h4>
        <p><code>findByIdAndUpdate()</code> does NOT run schema validators by default. Pass <code>{ runValidators: true }</code>.</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 5: Returning Passwords in API Responses</h4>
        <p>Always strip sensitive fields. Use Mongoose's <code>toJSON</code> transform or <code>.select('-password')</code>.</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 6: Not Indexing Foreign Keys</h4>
        <p>In PostgreSQL, foreign key columns are NOT automatically indexed. Always add indexes on columns used in JOINs.</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 7: Using OFFSET for Deep Pagination</h4>
        <p><code>OFFSET 1000000</code> makes PostgreSQL scan through 1M rows before returning results. Use cursor-based pagination instead.</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 8: Storing Prices as Floating Point</h4>
        <p>Never use <code>float</code> for money. Use <code>DECIMAL(10,2)</code> in SQL or store as integers (cents) in MongoDB. <code>0.1 + 0.2 !== 0.3</code> in floating point!</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 9: Hardcoding Database Credentials</h4>
        <p>Always use environment variables. Never commit <code>.env</code> to Git. Use <code>.env.example</code> as a template.</p>
      </div>

      <div class="pitfall-box">
        <h4>üíÄ Pitfall 10: No Graceful Shutdown</h4>
        <p>Not closing database connections when the server shuts down can lead to data corruption and connection leaks. Listen for SIGINT/SIGTERM.</p>
      </div>

      <button class="btn btn-run" onclick="completeSection('pitfalls'); navigateToNext('quiz1')">
        Continue ‚Üí Quiz: MongoDB
      </button>
    </div>

    <!-- ==================== SECTION: QUIZ 1 ==================== -->
    <div class="section" id="section-quiz1">
      <div class="section-header">
        <h1>‚ùì Quiz: MongoDB Mastery</h1>
        <p>Test your MongoDB knowledge ‚Äî 8 questions</p>
        <div class="badge-row">
          <span class="badge mongo">MongoDB</span>
          <span class="badge intermediate">Intermediate</span>
        </div>
      </div>

      <div class="quiz-container" id="quiz1-container">
        <div class="quiz-progress">
          <span id="quiz1-progress-text">Question 1 of 8</span>
          <div class="quiz-progress-dots" id="quiz1-dots"></div>
        </div>
        <div id="quiz1-content"></div>
        <div class="quiz-nav">
          <button class="btn btn-reset" id="quiz1-prev" onclick="quiz1Nav(-1)" style="display:none">‚Üê Previous</button>
          <button class="btn btn-run" id="quiz1-next" onclick="quiz1Nav(1)" style="display:none">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- ==================== SECTION: QUIZ 2 ==================== -->
    <div class="section" id="section-quiz2">
      <div class="section-header">
        <h1>‚ùì Quiz: PostgreSQL Mastery</h1>
        <p>Test your PostgreSQL knowledge ‚Äî 8 questions</p>
        <div class="badge-row">
          <span class="badge postgres">PostgreSQL</span>
          <span class="badge intermediate">Intermediate</span>
        </div>
      </div>

      <div class="quiz-container" id="quiz2-container">
        <div class="quiz-progress">
          <span id="quiz2-progress-text">Question 1 of 8</span>
          <div class="quiz-progress-dots" id="quiz2-dots"></div>
        </div>
        <div id="quiz2-content"></div>
        <div class="quiz-nav">
          <button class="btn btn-reset" id="quiz2-prev" onclick="quiz2Nav(-1)" style="display:none">‚Üê Previous</button>
          <button class="btn btn-run" id="quiz2-next" onclick="quiz2Nav(1)" style="display:none">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- ==================== SECTION: QUIZ 3 ==================== -->
    <div class="section" id="section-quiz3">
      <div class="section-header">
        <h1>‚ùì Quiz: Design & Optimization</h1>
        <p>Test your schema design and query optimization knowledge ‚Äî 8 questions</p>
        <div class="badge-row">
          <span class="badge advanced">Advanced</span>
        </div>
      </div>

      <div class="quiz-container" id="quiz3-container">
        <div class="quiz-progress">
          <span id="quiz3-progress-text">Question 1 of 8</span>
          <div class="quiz-progress-dots" id="quiz3-dots"></div>
        </div>
        <div id="quiz3-content"></div>
        <div class="quiz-nav">
          <button class="btn btn-reset" id="quiz3-prev" onclick="quiz3Nav(-1)" style="display:none">‚Üê Previous</button>
          <button class="btn btn-run" id="quiz3-next" onclick="quiz3Nav(1)" style="display:none">Next ‚Üí</button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// STATE MANAGEMENT
// ============================================================
const state = {
  currentSection: 'intro',
  completedSections: new Set(),
  xp: 0,
  quizScores: {},
};

const totalSections = 19;

function saveState() {
  localStorage.setItem('dbMasteryState', JSON.stringify({
    completedSections: [...state.completedSections],
    xp: state.xp,
    quizScores: state.quizScores,
  }));
}

function loadState() {
  try {
    const saved = JSON.parse(localStorage.getItem('dbMasteryState'));
    if (saved) {
      state.completedSections = new Set(saved.completedSections || []);
      state.xp = saved.xp || 0;
      state.quizScores = saved.quizScores || {};
      updateProgress();
      updateNavCompletion();
    }
  } catch(e) {}
}

// ============================================================
// NAVIGATION
// ============================================================
function navigateTo(sectionId, navItem) {
  // Hide all sections
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

  // Show target section
  const target = document.getElementById('section-' + sectionId);
  if (target) target.classList.add('active');

  // Update nav
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (navItem) {
    navItem.classList.add('active');
  } else {
    document.querySelector(`.nav-item[data-section="${sectionId}"]`)?.classList.add('active');
  }

  state.currentSection = sectionId;

  // Init quiz if navigating to quiz
  if (sectionId === 'quiz1') initQuiz1();
  if (sectionId === 'quiz2') initQuiz2();
  if (sectionId === 'quiz3') initQuiz3();

  // Scroll to top of main content
  document.getElementById('mainContent').scrollTop = 0;

  // Close sidebar on mobile
  document.getElementById('sidebar').classList.remove('open');
}

function navigateToNext(sectionId) {
  navigateTo(sectionId);
}

function completeSection(sectionId) {
  if (!state.completedSections.has(sectionId)) {
    state.completedSections.add(sectionId);
    state.xp += 50;
    showToast('üéâ Section Complete! +50 XP', 'xp');
    updateProgress();
    updateNavCompletion();
    saveState();
  }
}

function updateProgress() {
  const progress = Math.round((state.completedSections.size / totalSections) * 100);
  document.getElementById('progressFill').style.width = progress + '%';
  document.getElementById('progressText').textContent = progress + '% Complete';
  document.getElementById('xpBadge').textContent = state.xp + ' XP';
}

function updateNavCompletion() {
  document.querySelectorAll('.nav-item').forEach(item => {
    const section = item.dataset.section;
    if (state.completedSections.has(section)) {
      item.classList.add('completed');
    }
  });
}

// ============================================================
// TABS
// ============================================================
function switchTab(event, tabId) {
  const container = event.target.closest('.tab-container');
  container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  container.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + tabId)?.classList.add('active');
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast ' + type;
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============================================================
// SIDEBAR TOGGLE (Mobile)
// ============================================================
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// ============================================================
// HINTS
// ============================================================
function showHint(hintId) {
  const hint = document.getElementById(hintId);
  if (hint) {
    hint.style.display = hint.style.display === 'none' ? 'block' : 'none';
  }
}

// ============================================================
// EXERCISE DEFAULTS
// ============================================================
const ex1Code1Default = `// Complete this function:
// If \`role\` query param exists, filter by role
// Sort by createdAt descending
// Return only name, email, role fields
// Use .lean() for performance

async function getUsers(req, res) {
  try {
    const { role } = req.query;
    const filter = {};

    // YOUR CODE HERE:
    // 1. If role exists, add it to filter
    // 2. Build the query with User.find()
    // 3. Add select, sort, and lean

    const users = await User.find(filter);
    res.json(users);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}`;

const ex1Code2Default = `// Complete this function:
// Create a user from req.body
// Handle duplicate email (error code 11000)
// Handle validation errors
// Return 201 status on success

async function createUser(req, res) {
  try {
    // YOUR CODE HERE:
    // 1. Use User.create() with req.body
    // 2. Return status 201 with the user

  } catch (error) {
    // YOUR CODE HERE:
    // 3. Check if error.code === 11000 (duplicate)
    // 4. Check if error.name === 'ValidationError'
    // 5. Default to 500 error

  }
}`;

const ex2Code1Default = `// Design a Product schema for an e-commerce site
// Requirements:
// - name (required, trimmed)
// - price (required, min 0)
// - description
// - category (enum: electronics, clothing, books, home)
// - variants (array of: { size, color, stock })
// - ratings: { average, count }
// - seller (reference to User)
// - tags (array of strings)
// - timestamps

const productSchema = new mongoose.Schema({
  // YOUR CODE HERE

});`;

function resetExercise(textareaId, defaultCode) {
  document.getElementById(textareaId).value = defaultCode;
}

// ============================================================
// EXERCISE CHECKERS
// ============================================================
function checkExercise1a() {
  const code = document.getElementById('ex1-code1').value;
  const output = document.getElementById('ex1-output1');
  let score = 0;
  let feedback = [];

  if (code.includes('filter.role') || code.includes("filter['role']")) {
    score++; feedback.push('<span class="output-success">‚úÖ Role filter condition found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: Add role to filter object if it exists</span>'); }

  if (code.includes('.select(')) {
    score++; feedback.push('<span class="output-success">‚úÖ Field selection (.select()) found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: .select() to limit returned fields</span>'); }

  if (code.includes('.sort(')) {
    score++; feedback.push('<span class="output-success">‚úÖ Sorting (.sort()) found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: .sort() for ordering results</span>'); }

  if (code.includes('.lean()')) {
    score++; feedback.push('<span class="output-success">‚úÖ .lean() optimization found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: .lean() for performance</span>'); }

  if (score === 4) {
    feedback.unshift('<span class="output-success">üéâ PERFECT! All requirements met!</span>\n');
    state.xp += 25;
    showToast('‚úÖ Exercise 1a Complete! +25 XP', 'success');
    markRequirement('ex1-requirements', 0);
    saveState();
    updateProgress();
  } else {
    feedback.unshift(`<span class="output-warn">‚ö†Ô∏è ${score}/4 requirements met. Keep going!</span>\n`);
  }

  output.innerHTML = feedback.join('\n');
}

function checkExercise1b() {
  const code = document.getElementById('ex1-code2').value;
  const output = document.getElementById('ex1-output2');
  let score = 0;
  let feedback = [];

  if (code.includes('User.create') || code.includes('new User')) {
    score++; feedback.push('<span class="output-success">‚úÖ User creation found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: User.create() or new User()</span>'); }

  if (code.includes('201')) {
    score++; feedback.push('<span class="output-success">‚úÖ Status 201 found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: res.status(201)</span>'); }

  if (code.includes('11000')) {
    score++; feedback.push('<span class="output-success">‚úÖ Duplicate key error handling found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: Handle error.code === 11000</span>'); }

  if (code.includes('ValidationError')) {
    score++; feedback.push('<span class="output-success">‚úÖ Validation error handling found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: Handle ValidationError</span>'); }

  if (score === 4) {
    feedback.unshift('<span class="output-success">üéâ PERFECT! All requirements met!</span>\n');
    state.xp += 25;
    showToast('‚úÖ Exercise 1b Complete! +25 XP', 'success');
    markRequirement('ex1-requirements', 1);
    saveState();
    updateProgress();
  } else {
    feedback.unshift(`<span class="output-warn">‚ö†Ô∏è ${score}/4 requirements met. Keep going!</span>\n`);
  }

  output.innerHTML = feedback.join('\n');
}

function checkExercise2() {
  const code = document.getElementById('ex2-code1').value;
  const output = document.getElementById('ex2-output1');
  let score = 0;
  let feedback = [];

  if (code.includes('name') && (code.includes('required') || code.includes('String'))) {
    score++; feedback.push('<span class="output-success">‚úÖ Name field found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: name field</span>'); }

  if (code.includes('price') && (code.includes('Number') || code.includes('min'))) {
    score++; feedback.push('<span class="output-success">‚úÖ Price field found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: price field with Number type</span>'); }

  if (code.includes('category') && code.includes('enum')) {
    score++; feedback.push('<span class="output-success">‚úÖ Category with enum found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: category field with enum</span>'); }

  if (code.includes('variants') && (code.includes('[') || code.includes('Array'))) {
    score++; feedback.push('<span class="output-success">‚úÖ Variants array found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: variants array</span>'); }

  if (code.includes('seller') && (code.includes('ObjectId') || code.includes('ref'))) {
    score++; feedback.push('<span class="output-success">‚úÖ Seller reference found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: seller with reference to User</span>'); }

  if (code.includes('timestamps')) {
    score++; feedback.push('<span class="output-success">‚úÖ Timestamps option found</span>');
  } else { feedback.push('<span class="output-error">‚ùå Missing: timestamps: true</span>'); }

  if (score >= 5) {
    feedback.unshift('<span class="output-success">üéâ Excellent schema design!</span>\n');
    state.xp += 50;
    showToast('‚úÖ Schema Design Complete! +50 XP', 'success');
    saveState();
    updateProgress();
  } else {
    feedback.unshift(`<span class="output-warn">‚ö†Ô∏è ${score}/6 requirements met.</span>\n`);
  }

  output.innerHTML = feedback.join('\n');
}

function markRequirement(listId, index) {
  const list = document.getElementById(listId);
  if (list) {
    const items = list.querySelectorAll('li');
    if (items[index]) items[index].classList.add('done');
  }
}

// ============================================================
// DATABASE SIMULATOR
// ============================================================
let simDB = {
  users: [
    { _id: 'u1', name: 'Alice', email: 'alice@ex.com', age: 28, role: 'admin' },
    { _id: 'u2', name: 'Bob', email: 'bob@ex.com', age: 34, role: 'user' },
    { _id: 'u3', name: 'Carol', email: 'carol@ex.com', age: 25, role: 'user' },
  ],
  posts: [
    { _id: 'p1', title: 'Hello World', author: 'Alice', status: 'published' },
    { _id: 'p2', title: 'MongoDB Tips', author: 'Bob', status: 'draft' },
  ],
};

let nextId = { users: 4, posts: 3 };

function resetSimulator() {
  simDB = {
    users: [
      { _id: 'u1', name: 'Alice', email: 'alice@ex.com', age: 28, role: 'admin' },
      { _id: 'u2', name: 'Bob', email: 'bob@ex.com', age: 34, role: 'user' },
      { _id: 'u3', name: 'Carol', email: 'carol@ex.com', age: 25, role: 'user' },
    ],
    posts: [
      { _id: 'p1', title: 'Hello World', author: 'Alice', status: 'published' },
      { _id: 'p2', title: 'MongoDB Tips', author: 'Bob', status: 'draft' },
    ],
  };
  nextId = { users: 4, posts: 3 };
  updateDBDisplay();
  document.getElementById('sim-output').innerHTML = '<span class="output-info">Database reset to initial state.</span>';
  showToast('üîÑ Database Reset', 'info');
}

function updateDBDisplay() {
  // Users
  const usersDiv = document.getElementById('usersCollection');
  usersDiv.innerHTML = simDB.users.map(u =>
    `<div class="db-record">{ name: "${u.name}", email: "${u.email}", age: ${u.age} }</div>`
  ).join('');
  document.getElementById('usersCount').textContent = simDB.users.length + ' documents';

  // Posts
  const postsDiv = document.getElementById('postsCollection');
  postsDiv.innerHTML = simDB.posts.map(p =>
    `<div class="db-record">{ title: "${p.title}", author: "${p.author}" }</div>`
  ).join('');
  document.getElementById('postsCount').textContent = simDB.posts.length + ' documents';
}

function runSimulator() {
  const code = document.getElementById('sim-code').value.trim();
  const output = document.getElementById('sim-output');

  try {
    const result = parseAndExecute(code);
    output.innerHTML = '<span class="output-success">‚úÖ Query executed successfully</span>\n\n' +
      '<span class="output-data">' + JSON.stringify(result, null, 2) + '</span>';
    updateDBDisplay();
  } catch (error) {
    output.innerHTML = '<span class="output-error">‚ùå Error: ' + error.message + '</span>';
  }
}

function parseAndExecute(code) {
  // Remove comments
  code = code.replace(/\/\/.*$/gm, '').trim();

  // Parse db.collection.method pattern
  const match = code.match(/^db\.(\w+)\.(\w+)\(([\s\S]*)\)$/);
  if (!match) {
    // Check for chained .sort()
    const chainMatch = code.match(/^db\.(\w+)\.find\(([\s\S]*?)\)\.sort\(([\s\S]*?)\)$/);
    if (chainMatch) {
      const [, collection, filterStr, sortStr] = chainMatch;
      if (!simDB[collection]) throw new Error(`Collection "${collection}" not found`);
      const filter = filterStr.trim() ? parseJsonLike(filterStr.trim()) : {};
      const sort = parseJsonLike(sortStr.trim());
      let results = filterDocs(simDB[collection], filter);
      const sortKey = Object.keys(sort)[0];
      const sortDir = sort[sortKey];
      results.sort((a, b) => {
        if (a[sortKey] < b[sortKey]) return -sortDir;
        if (a[sortKey] > b[sortKey]) return sortDir;
        return 0;
      });
      return results;
    }

    // Check for countDocuments
    const countMatch = code.match(/^db\.(\w+)\.countDocuments\(([\s\S]*?)\)$/);
    if (countMatch) {
      const [, collection, filterStr] = countMatch;
      if (!simDB[collection]) throw new Error(`Collection "${collection}" not found`);
      const filter = filterStr.trim() ? parseJsonLike(filterStr.trim()) : {};
      return { count: filterDocs(simDB[collection], filter).length };
    }

    throw new Error('Unrecognized command. Try: db.users.find()');
  }

  const [, collection, method, argsStr] = match;

  if (!simDB[collection]) throw new Error(`Collection "${collection}" not found. Available: users, posts`);

  switch (method) {
    case 'find': {
      const filter = argsStr.trim() ? parseJsonLike(argsStr.trim()) : {};
      return filterDocs(simDB[collection], filter);
    }
    case 'findOne': {
      const filter = argsStr.trim() ? parseJsonLike(argsStr.trim()) : {};
      const results = filterDocs(simDB[collection], filter);
      return results[0] || null;
    }
    case 'insertOne': {
      const doc = parseJsonLike(argsStr.trim());
      doc._id = collection[0] + nextId[collection]++;
      simDB[collection].push(doc);
      return { acknowledged: true, insertedId: doc._id };
    }
    case 'updateOne': {
      const parts = splitArgs(argsStr);
      if (parts.length < 2) throw new Error('updateOne requires (filter, update)');
      const filter = parseJsonLike(parts[0]);
      const update = parseJsonLike(parts[1]);
      const idx = simDB[collection].findIndex(doc => matchesFilter(doc, filter));
      if (idx === -1) return { matchedCount: 0, modifiedCount: 0 };
      if (update.$set) {
        Object.assign(simDB[collection][idx], update.$set);
      }
      if (update.$inc) {
        for (const [key, val] of Object.entries(update.$inc)) {
          simDB[collection][idx][key] = (simDB[collection][idx][key] || 0) + val;
        }
      }
      return { matchedCount: 1, modifiedCount: 1 };
    }
    case 'deleteOne': {
      const filter = parseJsonLike(argsStr.trim());
      const idx = simDB[collection].findIndex(doc => matchesFilter(doc, filter));
      if (idx === -1) return { deletedCount: 0 };
      simDB[collection].splice(idx, 1);
      return { deletedCount: 1 };
    }
    case 'countDocuments': {
      const filter = argsStr.trim() ? parseJsonLike(argsStr.trim()) : {};
      return { count: filterDocs(simDB[collection], filter).length };
    }
    default:
      throw new Error(`Method "${method}" not supported. Try: find, findOne, insertOne, updateOne, deleteOne`);
  }
}

function parseJsonLike(str) {
  // Convert MongoDB-like syntax to valid JSON-ish
  try {
    // Handle $gt, $lt, etc.
    str = str.replace(/(\$\w+)/g, '"$1"');
    // Handle unquoted keys
    str = str.replace(/(\w+)\s*:/g, (match, key) => {
      if (key.startsWith('"')) return match;
      return `"${key}":`;
    });
    // Handle single quotes to double quotes
    str = str.replace(/'/g, '"');
    // Remove trailing commas
    str = str.replace(/,\s*([}\]])/g, '$1');
    return JSON.parse(str);
  } catch (e) {
    // Fallback: try eval (safe in this context since it's a simulator)
    try {
      return Function('"use strict"; return (' + str.replace(/(\$\w+)/g, "'$1'") + ')')();
    } catch (e2) {
      throw new Error('Cannot parse: ' + str);
    }
  }
}

function splitArgs(str) {
  let depth = 0;
  let parts = [];
  let current = '';
  for (const char of str) {
    if (char === '{' || char === '[') depth++;
    if (char === '}' || char === ']') depth--;
    if (char === ',' && depth === 0) {
      parts.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  if (current.trim()) parts.push(current.trim());
  return parts;
}

function filterDocs(collection, filter) {
  if (Object.keys(filter).length === 0) return [...collection];
  return collection.filter(doc => matchesFilter(doc, filter));
}

function matchesFilter(doc, filter) {
  for (const [key, value] of Object.entries(filter)) {
    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
      for (const [op, opVal] of Object.entries(value)) {
        switch (op) {
          case '$gt': if (!(doc[key] > opVal)) return false; break;
          case '$gte': if (!(doc[key] >= opVal)) return false; break;
          case '$lt': if (!(doc[key] < opVal)) return false; break;
          case '$lte': if (!(doc[key] <= opVal)) return false; break;
          case '$ne': if (doc[key] === opVal) return false; break;
          case '$in': if (!opVal.includes(doc[key])) return false; break;
        }
      }
    } else {
      if (doc[key] !== value) return false;
    }
  }
  return true;
}

// ============================================================
// QUIZ ENGINE
// ============================================================

// --- QUIZ 1: MongoDB ---
const quiz1Questions = [
  {
    question: 'What does the <code>.lean()</code> method do in Mongoose?',
    options: [
      'Removes empty fields from results',
      'Returns plain JavaScript objects instead of Mongoose documents',
      'Reduces the memory usage of the database',
      'Compresses the query before sending to MongoDB'
    ],
    correct: 1,
    explanation: '.lean() skips creating full Mongoose document instances with change tracking, getters, setters, etc. It returns plain JS objects and is 5-10x faster for read-only operations.'
  },
  {
    question: 'Which update operator adds an element to an array only if it doesn\'t already exist?',
    options: [
      '$push',
      '$addToSet',
      '$append',
      '$pushUnique'
    ],
    correct: 1,
    explanation: '$addToSet adds to an array only if the value is not already present. $push always adds regardless of duplicates.'
  },
  {
    question: 'What error code does MongoDB return for a duplicate key violation?',
    options: [
      '1100',
      '11000',
      '23505',
      'E_DUPLICATE'
    ],
    correct: 1,
    explanation: 'MongoDB error code 11000 indicates a duplicate key error. Always catch this specifically when handling unique constraint violations.'
  },
  {
    question: 'By default, does <code>findByIdAndUpdate()</code> run schema validators?',
    options: [
      'Yes, always',
      'No, you must pass { runValidators: true }',
      'Only for required fields',
      'Only in production mode'
    ],
    correct: 1,
    explanation: 'This is a common pitfall! Mongoose does NOT run validators on update operations by default. You must explicitly pass { runValidators: true }.'
  },
  {
    question: 'When should you EMBED data vs REFERENCE it in MongoDB?',
    options: [
      'Always embed ‚Äî it\'s faster',
      'Always reference ‚Äî it avoids duplication',
      'Embed for 1:few relationships that are accessed together; reference for 1:many or many:many',
      'Embed for large datasets; reference for small ones'
    ],
    correct: 2,
    explanation: 'Embed when data belongs to the parent, is accessed together, and doesn\'t grow unboundedly. Reference when data is shared, large, or has unbounded growth.'
  },
  {
    question: 'What does the <code>$lookup</code> aggregation stage do?',
    options: [
      'Searches for text matches',
      'Performs a LEFT OUTER JOIN with another collection',
      'Creates an index lookup',
      'Validates document structure'
    ],
    correct: 1,
    explanation: '$lookup performs a LEFT OUTER JOIN between two collections. It matches documents from a "foreign" collection and adds them as an array field.'
  },
  {
    question: 'What is the maximum document size in MongoDB?',
    options: [
      '1 MB',
      '4 MB',
      '16 MB',
      '64 MB'
    ],
    correct: 2,
    explanation: 'The maximum BSON document size is 16 megabytes. This is important to consider when deciding whether to embed or reference data.'
  },
  {
    question: 'What happens when you add <code>{ timestamps: true }</code> to a Mongoose schema?',
    options: [
      'It logs every query with a timestamp',
      'It automatically adds and manages createdAt and updatedAt fields',
      'It adds Unix timestamps instead of Date objects',
      'It enables time-series collection features'
    ],
    correct: 1,
    explanation: 'timestamps: true automatically adds createdAt and updatedAt fields to your schema. Mongoose manages updatedAt on every save/update operation.'
  }
];

const quiz2Questions = [
  {
    question: 'What is the correct way to prevent SQL injection in node-postgres?',
    options: [
      'Escape the string with backslashes',
      'Use parameterized queries ($1, $2, ...)',
      'Use encodeURIComponent()',
      'Wrap values in single quotes'
    ],
    correct: 1,
    explanation: 'Parameterized queries ($1, $2...) are the ONLY reliable way to prevent SQL injection. The database driver handles escaping. Never concatenate user input into SQL strings.'
  },
  {
    question: 'What does <code>RETURNING *</code> do in a PostgreSQL INSERT/UPDATE/DELETE?',
    options: [
      'Returns all tables in the database',
      'Returns the affected row(s) as the query result',
      'Rolls back the operation and returns the original data',
      'Returns the execution plan'
    ],
    correct: 1,
    explanation: 'RETURNING * (or RETURNING column_name) returns the affected rows from INSERT, UPDATE, or DELETE operations. This eliminates the need for a separate SELECT query.'
  },
  {
    question: 'Why is <code>client.release()</code> critical in connection pooling?',
    options: [
      'It closes the database permanently',
      'It returns the connection to the pool so others can use it',
      'It commits pending transactions',
      'It clears the query cache'
    ],
    correct: 1,
    explanation: 'release() returns the connection to the pool. Without it, the connection is "leaked" ‚Äî it\'s held but unused. Eventually all pool connections leak and new requests fail.'
  },
  {
    question: 'What does <code>EXPLAIN ANALYZE</code> show you?',
    options: [
      'The database error logs',
      'The actual execution plan with timing for your query',
      'A list of all indexes',
      'The table schema definition'
    ],
    correct: 1,
    explanation: 'EXPLAIN ANALYZE actually runs the query and shows the execution plan with real timing data. Look for "Seq Scan" (bad for large tables) vs "Index Scan" (good).'
  },
  {
    question: 'In PostgreSQL, are foreign key columns automatically indexed?',
    options: [
      // ... (continuing from where it left off)

  'Yes, always',
  'Only for primary keys',
  'Only if you create them manually',
  'No, foreign key columns are not automatically indexed'
  ],
  correct: 2,
  explanation: 'Foreign key columns in PostgreSQL are NOT automatically indexed. You must create an index manually on the foreign key column to improve JOIN performance.'
  },
  {
  question: 'What is the N+1 query problem?',
  options: [
    'A query that takes N+1 seconds to execute',
    'When you execute 1 query for parent data and then N queries for related child data',
    'A query that returns N+1 rows',
    'When the database uses N+1 indexes'
  ],
  correct: 1,
  explanation: 'The N+1 problem occurs when you fetch parent records with one query, and then loop through them to fetch related child data with a separate query for each parent. This results in 1 + N queries, which is inefficient.'
  },
  {
  question: 'Which PostgreSQL data type should you use for currency?',
  options: [
    'FLOAT',
    'DOUBLE PRECISION',
    'DECIMAL or NUMERIC',
    'REAL'
  ],
  correct: 2,
  explanation: 'Never use floating point (FLOAT/DOUBLE) for money due to rounding errors. Use DECIMAL or NUMERIC with specified precision, e.g., DECIMAL(10,2).'
  },
  {
  question: 'What does the ON DELETE CASCADE option do?',
  options: [
    'Deletes all tables in the database',
    'Deletes the parent row and automatically deletes related child rows',
    'Deletes the parent row only if no child rows exist',
    'Prevents deletion of parent rows'
  ],
  correct: 1,
  explanation: 'ON DELETE CASCADE automatically deletes rows in child tables that reference the deleted parent row. Useful for maintaining referential integrity, but use carefully.'
  },
  {
  question: 'Which of the following is a valid way to use a transaction in node-postgres?',
  options: [
    'pool.transaction(async (client) => { ... })',
    'BEGIN; ... COMMIT; using a single client',
    'db.transaction()',
    'pool.query("START TRANSACTION")'
  ],
  correct: 1,
  explanation: 'Transactions require a single client connection. You must use client.query("BEGIN"), then your operations, then client.query("COMMIT") or ROLLBACK, and always release the client in a finally block.'
  }
];

// QUIZ 3: Design & Optimization
const quiz3Questions = [
  {
    question: 'What is the main advantage of denormalization?',
    options: [
      'Reduces data duplication',
      'Improves read performance by reducing joins',
      'Ensures data consistency',
      'Saves storage space'
    ],
    correct: 1,
    explanation: 'Denormalization (embedding data) improves read performance because all required data is in one document/row, eliminating the need for joins or additional queries.'
  },
  {
    question: 'When should you use a compound index?',
    options: [
      'When queries filter on multiple fields',
      'When you have too many single-field indexes',
      'Only for text search',
      'When you want to speed up writes'
    ],
    correct: 0,
    explanation: 'Compound indexes are most useful when queries filter on multiple fields (e.g., WHERE role = "admin" AND created_at > ...). The index can satisfy multiple conditions efficiently.'
  },
  {
    question: 'What is the MongoDB Bucket pattern used for?',
    options: [
      'Storing large files',
      'Grouping time-series data to reduce document count',
      'Organizing users into buckets by role',
      'Encrypting sensitive data'
    ],
    correct: 1,
    explanation: 'The Bucket pattern groups related time-series measurements (like IoT sensor readings) into a single document per time period (e.g., per hour) to reduce the number of documents and improve query performance.'
  },
  {
    question: 'Which of the following is a disadvantage of using OFFSET for pagination?',
    options: [
      'It cannot be used with ORDER BY',
      'It becomes slower as OFFSET increases because the database must scan skipped rows',
      'It is not supported in SQL',
      'It returns random results'
    ],
    correct: 1,
    explanation: 'OFFSET pagination requires the database to scan and discard OFFSET rows. For large offsets (e.g., OFFSET 100000), this is very slow. Cursor-based pagination is more efficient.'
  },
  {
    question: 'In Mongoose, what is the difference between .save() and .updateOne()?',
    options: [
      'They are identical',
      '.save() requires fetching the document first; .updateOne() updates directly in the database',
      '.updateOne() runs validators by default; .save() does not',
      '.save() is for SQL, .updateOne() is for MongoDB'
    ],
    correct: 1,
    explanation: '.save() operates on a Mongoose document instance (you must first fetch or create it). .updateOne() directly updates in the database without loading the document, but by default does not run validators.'
  },
  {
    question: 'What does the EXPLAIN command in PostgreSQL do?',
    options: [
      'Shows the query execution plan',
      'Returns the query results',
      'Explains the table schema',
      'Drops the table'
    ],
    correct: 0,
    explanation: 'EXPLAIN shows the execution plan that PostgreSQL will use for a query, including which indexes are used, join methods, and estimated costs. EXPLAIN ANALYZE actually runs the query and shows real timing.'
  },
  {
    question: 'What is the purpose of a partial index?',
    options: [
      'Index only a subset of rows that satisfy a condition',
      'Index only part of a column',
      'Index that spans multiple tables',
      'Index that is temporarily disabled'
    ],
    correct: 0,
    explanation: 'A partial index indexes only rows that meet a WHERE condition. It is smaller and more efficient than a full index when queries consistently filter on that condition.'
  },
  {
    question: 'When should you use a multi-document transaction in MongoDB?',
    options: [
      'For every write operation',
      'When you need atomic updates across multiple documents or collections',
      'Only when using Mongoose',
      'Transactions are not supported in MongoDB'
    ],
    correct: 1,
    explanation: 'MongoDB supports multi-document transactions (ACID) since version 4.0, but they should be used sparingly because they are more expensive than single-document operations. Use them when you need atomic updates across multiple documents.'
  }
];

// ============================================================
// QUIZ STATE
// ============================================================
const quizState = {
  quiz1: { current: 0, answers: [], score: null },
  quiz2: { current: 0, answers: [], score: null },
  quiz3: { current: 0, answers: [], score: null }
};

function initQuiz1() {
  renderQuiz('quiz1', quiz1Questions, quizState.quiz1);
}

function initQuiz2() {
  renderQuiz('quiz2', quiz2Questions, quizState.quiz2);
}

function initQuiz3() {
  renderQuiz('quiz3', quiz3Questions, quizState.quiz3);
}

function renderQuiz(quizId, questions, stateObj) {
  const container = document.getElementById(quizId + '-container');
  if (!container) return;

  const contentDiv = document.getElementById(quizId + '-content');
  const progressText = document.getElementById(quizId + '-progress-text');
  const dotsDiv = document.getElementById(quizId + '-dots');
  const prevBtn = document.getElementById(quizId + '-prev');
  const nextBtn = document.getElementById(quizId + '-next');

  if (stateObj.score !== null) {
    // Show score screen
    contentDiv.innerHTML = `
      <div class="quiz-score">
        <h2>Quiz Complete!</h2>
        <div class="score-number">${stateObj.score}/${questions.length}</div>
        <p>${stateObj.score === questions.length ? 'üéâ Perfect! You\'re a master!' : 'Keep practicing!'}</p>
      </div>
    `;
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    return;
  }

  const q = questions[stateObj.current];
  progressText.textContent = `Question ${stateObj.current + 1} of ${questions.length}`;

  // Render dots
  let dotsHtml = '';
  for (let i = 0; i < questions.length; i++) {
    let dotClass = 'quiz-dot';
    if (i === stateObj.current) dotClass += ' current';
    else if (stateObj.answers[i] !== undefined) {
  dotClass += stateObj.answers[i] === questions[i].correct ? ' correct' : ' wrong';
}
    dotsHtml += `<span class="${dotClass}"></span>`;
  }
  dotsDiv.innerHTML = dotsHtml;

  // Render question and options
  let optionsHtml = '';
  q.options.forEach((opt, idx) => {
    const letter = String.fromCharCode(65 + idx);
    const selectedClass = stateObj.answers[stateObj.current] === idx ? ' selected' : '';
    optionsHtml += `
      <div class="quiz-option${selectedClass}" onclick="selectQuizOption('${quizId}', ${idx})">
        <span class="quiz-option-letter">${letter}</span>
        <span>${opt}</span>
      </div>
    `;
  });

  // Explanation if already answered
  let explanationHtml = '';
  if (stateObj.answers[stateObj.current] !== undefined) {
    const isCorrect = stateObj.answers[stateObj.current] === q.correct;
    explanationHtml = `
      <div class="quiz-explanation show ${isCorrect ? 'correct-exp' : 'wrong-exp'}">
        ${q.explanation}
      </div>
    `;
  }

  contentDiv.innerHTML = `
    <div class="quiz-question">${q.question}</div>
    <div class="quiz-options">${optionsHtml}</div>
    ${explanationHtml}
  `;

  prevBtn.style.display = stateObj.current > 0 ? 'inline-block' : 'none';
  nextBtn.style.display = 'inline-block';
  nextBtn.textContent = stateObj.current === questions.length - 1 ? 'Finish Quiz' : 'Next ‚Üí';
}

function selectQuizOption(quizId, optionIdx) {
  const stateObj = quizState[quizId];
  const questions = getQuizQuestions(quizId);
  const currentQ = questions[stateObj.current];
  stateObj.answers[stateObj.current] = optionIdx;

  // Automatically show explanation (re-render)
  renderQuiz(quizId, questions, stateObj);
}

function quiz1Nav(direction) {
  navigateQuiz('quiz1', quiz1Questions, direction);
}
function quiz2Nav(direction) {
  navigateQuiz('quiz2', quiz2Questions, direction);
}
function quiz3Nav(direction) {
  navigateQuiz('quiz3', quiz3Questions, direction);
}

function navigateQuiz(quizId, questions, direction) {
  const stateObj = quizState[quizId];
  const newIdx = stateObj.current + direction;

  if (direction === 1 && newIdx >= questions.length) {
    // Finish quiz: calculate score
    let score = 0;
    questions.forEach((q, i) => {
      if (stateObj.answers[i] === q.correct) score++;
    });
    stateObj.score = score;
    state.quizScores[quizId] = score;
    state.xp += score * 10; // 10 XP per correct answer
    showToast(`üéâ Quiz complete! +${score*10} XP`, 'xp');
    saveState();
    updateProgress();
    renderQuiz(quizId, questions, stateObj);
    return;
  }

  if (newIdx >= 0 && newIdx < questions.length) {
    stateObj.current = newIdx;
    renderQuiz(quizId, questions, stateObj);
  }
}

function getQuizQuestions(quizId) {
  if (quizId === 'quiz1') return quiz1Questions;
  if (quizId === 'quiz2') return quiz2Questions;
  return quiz3Questions;
}

// ============================================================
// EXERCISE REQUIREMENT MARKING
// ============================================================
function markRequirement(listId, index) {
  const list = document.getElementById(listId);
  if (list) {
    const items = list.querySelectorAll('li');
    if (items[index]) {
      items[index].classList.add('done');
    }
  }
}

// ============================================================
// TOTAL SECTIONS (update to actual count)
// ============================================================
 // intro, connection, mongo-setup, mongo-crud, mongo-schema, mongo-advanced, pg-setup, pg-crud, pg-schema, pg-advanced, schema-design, optimization, exercise1, exercise2, simulator, pitfalls, quiz1, quiz2, quiz3

// ============================================================
// LOAD STATE ON PAGE LOAD
// ============================================================
window.addEventListener('load', () => {
  loadState();
  // Ensure intro section is active if no saved section (already active by default)
  // If we have saved state, we might want to restore last section? Not needed now.
});
</script>

<!-- Close body and html -->
</body>
</html> 